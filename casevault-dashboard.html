<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseVault Dashboard | Settlement Benchmarks</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://engagement-hooks-site.s3.amazonaws.com/casevault/data/settlements.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        
        .nav { background: rgba(15, 23, 42, 0.95); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #334155; }
        .nav-logo { font-size: 20px; font-weight: 700; color: #4C82E6; text-decoration: none; }
        .nav-links { display: flex; gap: 24px; }
        .nav-links a { color: #94a3b8; text-decoration: none; font-size: 14px; }
        .nav-links a:hover, .nav-links a.active { color: white; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        
        .header { margin-bottom: 32px; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { color: #94a3b8; }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
        .stat-value { font-size: 32px; font-weight: 700; color: #4C82E6; }
        .stat-label { font-size: 13px; color: #64748b; margin-top: 4px; }
        
        .filters { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid #334155; }
        .filters h3 { font-size: 14px; color: #94a3b8; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-row { display: flex; gap: 16px; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; }
        .filter-group select { width: 100%; padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; font-size: 14px; }
        .filter-group select:focus { outline: none; border-color: #4C82E6; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card { background: #1e293b; border-radius: 12px; padding: 24px; border: 1px solid #334155; }
        .card h3 { font-size: 16px; margin-bottom: 20px; color: #e2e8f0; }
        
        .bar-chart { display: flex; flex-direction: column; gap: 12px; }
        .bar-item { display: flex; align-items: center; gap: 12px; }
        .bar-label { width: 100px; font-size: 13px; color: #94a3b8; flex-shrink: 0; }
        .bar-track { flex: 1; height: 24px; background: #0f172a; border-radius: 6px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #4C82E6, #a78bfa); border-radius: 6px; transition: width 0.5s ease; }
        .bar-value { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: 600; }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px; font-size: 12px; color: #64748b; border-bottom: 1px solid #334155; text-transform: uppercase; }
        .table td { padding: 12px; font-size: 14px; border-bottom: 1px solid #1e293b; }
        .table tr:hover td { background: rgba(76, 130, 230, 0.05); }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        .empty-state h3 { color: #94a3b8; margin-bottom: 8px; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-blue { background: rgba(76, 130, 230, 0.2); color: #019BE6; }
        .badge-green { background: rgba(52, 211, 153, 0.2); color: #6ee7b7; }
        .badge-yellow { background: rgba(251, 191, 36, 0.2); color: #fcd34d; }
        
        .cta-banner { background: linear-gradient(135deg, #4f46e5, #0008E6); border-radius: 12px; padding: 24px; text-align: center; margin-top: 32px; }
        .cta-banner h3 { margin-bottom: 8px; }
        .cta-banner p { color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 16px; }
        .cta-btn { display: inline-block; background: white; color: #4f46e5; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; }
        .cta-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <script>
        // Auth check - redirect to intake if not authenticated
        (function() {
            const token = localStorage.getItem('casevault_token');
            const expires = localStorage.getItem('casevault_expires');
            if (!token || !expires || Date.now() >= parseInt(expires)) {
                window.location.href = 'casevault-intake.html';
            }
        })();
        
        // ===== Anti-Scraping Protections =====
        (function() {
            const isBot = navigator.webdriver || window.__nightmare || window.phantom || /HeadlessChrome|PhantomJS/.test(navigator.userAgent);
            if (isBot) { document.body.innerHTML = '<h1 style="text-align:center;margin-top:200px">Access Denied</h1>'; throw new Error('Bot'); }
            
            const now = Date.now(), hourAgo = now - 3600000;
            let loads = JSON.parse(localStorage.getItem('_cv_loads') || '[]').filter(t => t > hourAgo);
            if (loads.length >= 30) { alert('Rate limit exceeded.'); window.location.href = '/'; return; }
            loads.push(now); localStorage.setItem('_cv_loads', JSON.stringify(loads));
            
            console.log('%c‚ö†Ô∏è Scraping prohibited. Access logged.', 'color:red;font-size:16px');
            document.addEventListener('contextmenu', e => { if (e.target.closest('table,.data')) e.preventDefault(); });
        })();
    </script>
    
    <nav class="nav">
        <a href="casevault-intake.html" class="nav-logo">‚öñÔ∏è CaseVault</a>
        <div class="nav-links">
            <a href="casevault-calculator.html">Calculator</a>
            <a href="casevault-dashboard.html" class="active">Dashboard</a>
            <a href="casevault-contribute.html">Contribute</a>
            <a href="/">AIBridges</a>
        </div>
    </nav>

    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1>Settlement Dashboard</h1>
                <p>Real benchmark data from personal injury settlements across New England</p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div id="timerBadge" style="background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); padding: 8px 16px; border-radius: 8px; font-size: 14px;">
                    ‚è±Ô∏è <strong id="timeLeft">--:--</strong>
                </div>
                <button onclick="document.getElementById('contributeModal').style.display='flex'" style="background: #4C82E6; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500;">+ Add Time</button>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalCases">--</div>
                <div class="stat-label">Total Settlements</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="medianValue">--</div>
                <div class="stat-label">Median Settlement</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stateCount">4</div>
                <div class="stat-label">States Covered</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastUpdate">--</div>
                <div class="stat-label">Last Updated</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h3>Filter Data</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label>State</label>
                    <select id="filterState">
                        <option value="all">All States</option>
                        <option value="MA">Massachusetts</option>
                        <option value="CT">Connecticut</option>
                        <option value="RI">Rhode Island</option>
                        <option value="NH">New Hampshire</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Injury Type</label>
                    <select id="filterInjury">
                        <option value="all">All Injuries</option>
                        <option value="soft_tissue">Soft Tissue</option>
                        <option value="fracture">Fracture</option>
                        <option value="surgery_required">Surgery Required</option>
                        <option value="tbi">TBI</option>
                        <option value="spinal">Spinal</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Case Type</label>
                    <select id="filterCase">
                        <option value="all">All Cases</option>
                        <option value="rear_end">Rear-End</option>
                        <option value="t_bone">T-Bone</option>
                        <option value="truck">Truck</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="pedestrian">Pedestrian</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <div class="grid">
                <!-- By State -->
                <div class="card">
                    <h3>Settlements by State</h3>
                    <div class="bar-chart" id="byStateChart"></div>
                </div>

                <!-- By Injury Type -->
                <div class="card">
                    <h3>Median by Injury Type</h3>
                    <div class="bar-chart" id="byInjuryChart"></div>
                </div>
            </div>

            <!-- State Breakdown Table -->
            <div class="card" style="margin-top: 24px;">
                <h3>State Breakdown</h3>
                <table class="table" id="stateTable">
                    <thead>
                        <tr>
                            <th>State</th>
                            <th>Cases</th>
                            <th>25th %ile</th>
                            <th>Median</th>
                            <th>75th %ile</th>
                        </tr>
                    </thead>
                    <tbody id="stateTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>üìä Data Collection In Progress</h3>
            <p>We're actively collecting settlement data. Check back soon for benchmarks.</p>
            <a href="casevault-contribute.html" class="cta-btn" style="margin-top: 20px;">Contribute Data</a>
        </div>

        <!-- CTA -->
        <div class="cta-banner">
            <h3>Have Settlement Data to Share?</h3>
            <p>Contribute anonymized settlement data and help build the most comprehensive PI benchmark database in New England.</p>
            <a href="casevault-contribute.html" class="cta-btn">Contribute Data ‚Üí</a>
        </div>
    </div>

    <script>
        const DATA = window.CASEVAULT_DATA || null;

        function formatCurrency(num) {
            if (!num) return '--';
            if (num >= 1000000) return '$' + (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return '$' + Math.round(num / 1000) + 'K';
            return '$' + num.toLocaleString();
        }

        function renderBarChart(container, items, maxValue) {
            container.innerHTML = '';
            items.forEach(item => {
                const pct = maxValue > 0 ? (item.value / maxValue * 100) : 0;
                container.innerHTML += `
                    <div class="bar-item">
                        <div class="bar-label">${item.label}</div>
                        <div class="bar-track">
                            <div class="bar-fill" style="width: ${pct}%"></div>
                            <span class="bar-value">${item.display}</span>
                        </div>
                    </div>
                `;
            });
        }

        function renderDashboard(stateFilter = 'all', injuryFilter = 'all', caseFilter = 'all') {
            if (!DATA || DATA.totalSettlements === 0) {
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('totalCases').textContent = '0';
                document.getElementById('medianValue').textContent = '--';
                document.getElementById('lastUpdate').textContent = '--';
                return;
            }

            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            // Header stats
            document.getElementById('totalCases').textContent = DATA.totalSettlements.toLocaleString();
            
            // Calculate overall median from states with data
            const statesWithData = Object.values(DATA.states).filter(s => s.stats?.median);
            if (statesWithData.length > 0) {
                const avgMedian = statesWithData.reduce((sum, s) => sum + s.stats.median, 0) / statesWithData.length;
                document.getElementById('medianValue').textContent = formatCurrency(avgMedian);
            }
            
            if (DATA.lastUpdated) {
                const date = new Date(DATA.lastUpdated);
                document.getElementById('lastUpdate').textContent = date.toLocaleDateString();
            }

            // By State Chart
            const stateItems = [];
            let maxCases = 0;
            for (const [code, data] of Object.entries(DATA.states)) {
                if (stateFilter !== 'all' && code !== stateFilter) continue;
                const count = data.sampleSize || 0;
                if (count > maxCases) maxCases = count;
                stateItems.push({
                    label: code,
                    value: count,
                    display: count + ' cases'
                });
            }
            renderBarChart(document.getElementById('byStateChart'), stateItems, maxCases);

            // By Injury Chart
            const injuryItems = [];
            let maxMedian = 0;
            const injuries = ['soft_tissue', 'fracture', 'surgery_required', 'tbi', 'spinal'];
            const injuryLabels = { soft_tissue: 'Soft Tissue', fracture: 'Fracture', surgery_required: 'Surgery', tbi: 'TBI', spinal: 'Spinal' };
            
            for (const injury of injuries) {
                if (injuryFilter !== 'all' && injury !== injuryFilter) continue;
                
                let total = 0, count = 0;
                for (const [code, data] of Object.entries(DATA.states)) {
                    if (stateFilter !== 'all' && code !== stateFilter) continue;
                    if (data.byInjuryType?.[injury]?.typical) {
                        total += data.byInjuryType[injury].typical;
                        count++;
                    }
                }
                
                if (count > 0) {
                    const avg = total / count;
                    if (avg > maxMedian) maxMedian = avg;
                    injuryItems.push({
                        label: injuryLabels[injury] || injury,
                        value: avg,
                        display: formatCurrency(avg)
                    });
                }
            }
            renderBarChart(document.getElementById('byInjuryChart'), injuryItems, maxMedian);

            // State Table
            const tbody = document.getElementById('stateTableBody');
            tbody.innerHTML = '';
            for (const [code, data] of Object.entries(DATA.states)) {
                if (stateFilter !== 'all' && code !== stateFilter) continue;
                if (!data.sampleSize) continue;
                
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${code}</strong></td>
                        <td>${data.sampleSize}</td>
                        <td>${formatCurrency(data.stats?.p25)}</td>
                        <td><strong>${formatCurrency(data.stats?.median)}</strong></td>
                        <td>${formatCurrency(data.stats?.p75)}</td>
                    </tr>
                `;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderDashboard();

            // Filter handlers
            document.getElementById('filterState').addEventListener('change', function() {
                renderDashboard(this.value, document.getElementById('filterInjury').value, document.getElementById('filterCase').value);
            });
            document.getElementById('filterInjury').addEventListener('change', function() {
                renderDashboard(document.getElementById('filterState').value, this.value, document.getElementById('filterCase').value);
            });
            document.getElementById('filterCase').addEventListener('change', function() {
                renderDashboard(document.getElementById('filterState').value, document.getElementById('filterInjury').value, this.value);
            });

            // Timer countdown
            const expires = parseInt(localStorage.getItem('casevault_expires') || '0');
            function updateTimer() {
                const remaining = expires - Date.now();
                if (remaining <= 0) {
                    document.getElementById('timeLeft').textContent = 'EXPIRED';
                    document.getElementById('timerBadge').style.background = 'rgba(239, 68, 68, 0.15)';
                    document.getElementById('timerBadge').style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    setTimeout(() => window.location.href = 'casevault-intake.html', 2000);
                    return;
                }
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                document.getElementById('timeLeft').textContent = mins + ':' + secs.toString().padStart(2, '0');
                
                // Warning color when under 2 minutes
                if (remaining < 120000) {
                    document.getElementById('timerBadge').style.background = 'rgba(239, 68, 68, 0.15)';
                    document.getElementById('timerBadge').style.borderColor = 'rgba(239, 68, 68, 0.3)';
                }
            }
            updateTimer();
            setInterval(updateTimer, 1000);
        });
    </script>
    <!-- Contribute Modal -->
    <div id="contributeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: #1e293b; border-radius: 16px; padding: 32px; max-width: 450px; width: 100%; border: 1px solid #334155;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Add Another Settlement</h3>
                <button onclick="document.getElementById('contributeModal').style.display='none'" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">Submit another case to add 10 more minutes.</p>
            
            <form id="extendForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">State</label>
                        <select id="extState" required style="width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white;">
                            <option value="">Select...</option>
                            <option value="MA">Massachusetts</option>
                            <option value="CT">Connecticut</option>
                            <option value="RI">Rhode Island</option>
                            <option value="NH">New Hampshire</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Year</label>
                        <select id="extYear" required style="width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white;">
                            <option value="">Select...</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Settlement Amount</label>
                    <input type="text" id="extAmount" placeholder="150,000" required style="width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Proof of Settlement</label>
                    <div id="extUploadZone" style="border: 2px dashed #334155; border-radius: 6px; padding: 16px; text-align: center; cursor: pointer;">
                        <input type="file" id="extProofImage" accept="image/*,.pdf" style="display: none;" required>
                        <div id="extUploadPlaceholder" style="color: #64748b; font-size: 13px;">üìÑ Click to upload proof</div>
                        <div id="extUploadPreview" style="display: none; color: #34d399; font-size: 13px;">‚úì <span id="extFileName"></span></div>
                    </div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Redact names. Only amount needed.</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Case Type</label>
                        <select id="extCaseType" required style="width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white;">
                            <option value="">Select...</option>
                            <option value="auto">Auto Accident</option>
                            <option value="truck">Truck</option>
                            <option value="motorcycle">Motorcycle</option>
                            <option value="pedestrian">Pedestrian</option>
                            <option value="slip_fall">Slip & Fall</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Severity</label>
                        <select id="extSeverity" required style="width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white;">
                            <option value="">Select...</option>
                            <option value="soft_tissue">Soft Tissue</option>
                            <option value="fracture">Fracture</option>
                            <option value="surgery">Surgery</option>
                            <option value="tbi">TBI</option>
                            <option value="spinal">Spinal</option>
                            <option value="fatal">Fatal</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4C82E6, #a78bfa); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 600; cursor: pointer;">Submit & Add 10 Minutes</button>
            </form>
        </div>
    </div>

    <script>
        // Extend form file upload
        const extUploadZone = document.getElementById('extUploadZone');
        const extProofInput = document.getElementById('extProofImage');
        extUploadZone.addEventListener('click', () => extProofInput.click());
        extProofInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                document.getElementById('extUploadPlaceholder').style.display = 'none';
                document.getElementById('extUploadPreview').style.display = 'block';
                document.getElementById('extFileName').textContent = e.target.files[0].name;
                extUploadZone.style.borderColor = '#34d399';
            }
        });

        // Extend time form
        document.getElementById('extendForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amt = document.getElementById('extAmount').value.replace(/[,$]/g, '');
            if (isNaN(parseInt(amt)) || parseInt(amt) < 1000) {
                alert('Please enter a valid settlement amount (minimum $1,000)');
                return;
            }
            
            // Check for proof image
            if (!document.getElementById('extProofImage').files.length) {
                alert('Please upload proof of settlement');
                return;
            }
            
            // Log settlement (would send to API)
            console.log('Extension settlement:', {
                state: document.getElementById('extState').value,
                year: document.getElementById('extYear').value,
                amount: amt,
                caseType: document.getElementById('extCaseType').value,
                severity: document.getElementById('extSeverity').value
            });
            
            // Add 10 minutes to timer
            const currentExpires = parseInt(localStorage.getItem('casevault_expires') || Date.now().toString());
            const newExpires = Math.max(currentExpires, Date.now()) + (10 * 60 * 1000);
            localStorage.setItem('casevault_expires', newExpires.toString());
            
            // Reset timer badge color
            document.getElementById('timerBadge').style.background = 'rgba(251, 191, 36, 0.15)';
            document.getElementById('timerBadge').style.borderColor = 'rgba(251, 191, 36, 0.3)';
            
            // Close modal and reset form
            document.getElementById('contributeModal').style.display = 'none';
            this.reset();
            
            // Show confirmation
            alert('‚úÖ 10 minutes added! Thank you for contributing.');
        });
    </script>
</body>
</html>
