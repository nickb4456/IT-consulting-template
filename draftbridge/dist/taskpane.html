<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://appsforoffice.microsoft.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.execute-api.us-east-1.amazonaws.com;">
    <title>DraftBridge</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            font-size: 14px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            font-size: 20px;
            font-weight: 700;
            color: #8B7355;
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header span span { color: #5C4A32; }
        .voice-toggle-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #8B7355;
            background: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .voice-toggle-btn:hover {
            background: #8B7355;
            transform: scale(1.1);
        }
        
        /* Main Tabs */
        .main-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 8px;
            flex-wrap: wrap;
        }
        .main-tab {
            padding: 10px 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .main-tab:hover { color: #8B7355; }
        .main-tab.active {
            color: #8B7355;
            border-bottom-color: #8B7355;
        }
        
        /* Panels */
        .panel {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .panel.active {
            display: flex;
        }
        
        /* Search Box */
        .search-box {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-input:focus {
            outline: none;
            border-color: #8B7355;
        }
        
        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 12px;
        }
        .filter-tab {
            padding: 10px 14px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
        }
        .filter-tab:hover { color: #8B7355; }
        .filter-tab.active {
            color: #8B7355;
            border-bottom-color: #8B7355;
        }
        
        /* Status Bar */
        .status {
            background: #f8f8f8;
            color: #2e7d32;
            padding: 8px 16px;
            font-size: 13px;
            border-bottom: 1px solid #e0e0e0;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Scrollable Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }
        
        /* Clause Cards */
        .clause {
            background: white;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
        }
        .clause-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 10px;
        }
        .clause-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            flex: 1;
        }
        .clause-category {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .clause-category.contracts { background: #e3f2fd; color: #1565c0; }
        .clause-category.litigation { background: #ffebee; color: #c62828; }
        .clause-category.corporate { background: #e8f5e9; color: #2e7d32; }
        .clause-category.ip { background: #f3e5f5; color: #7b1fa2; }
        
        .clause-content {
            color: #555;
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        /* Buttons */
        .btn {
            background: #8B7355;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn:hover { background: #6d5a43; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.success { background: #2e7d32; }
        .btn.secondary {
            background: white;
            color: #8B7355;
            border: 1px solid #8B7355;
        }
        .btn.secondary:hover { background: #f5f5f5; }
        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Generate Panel Options */
        .option-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid #e8e8e8;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }
        .option-card:hover {
            border-color: #8B7355;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .option-icon {
            font-size: 24px;
        }
        .option-text {
            flex: 1;
        }
        .option-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        .option-desc {
            font-size: 12px;
            color: #666;
        }
        .option-arrow {
            color: #999;
            font-size: 18px;
        }
        
        /* Section Headers */
        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .section-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 16px;
        }
        .divider {
            border-top: 1px solid #e0e0e0;
            margin: 20px 0 16px;
            padding-top: 16px;
        }
        .divider-label {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Form Fields */
        .field {
            margin-bottom: 14px;
        }
        .field label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #555;
            margin-bottom: 4px;
        }
        .field input, .field textarea, .field select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .field input:focus, .field textarea:focus, .field select:focus {
            outline: none;
            border-color: #8B7355;
        }
        .field textarea {
            resize: vertical;
            min-height: 80px;
        }
        .field-row {
            display: flex;
            gap: 10px;
        }
        .field-row .field {
            flex: 1;
        }
        
        /* Empty State */
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Coming Soon */
        .coming-soon {
            text-align: center;
            padding: 60px 20px;
        }
        .coming-soon-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .coming-soon-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }
        .coming-soon-sub {
            font-size: 13px;
            color: #999;
        }
        
        /* Sub-panel (for forms) */
        .sub-panel {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .sub-panel.active {
            display: flex;
        }
        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: #8B7355;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .back-btn:hover { background: #f8f8f8; }
        
        /* Actions Footer */
        .actions {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        .actions .btn {
            flex: 1;
        }
        
        /* ========== NUMBERING & TOC PANEL STYLES (MODERN) ========== */
        
        /* Sub-navigation tabs */
        .sub-nav {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 12px;
            gap: 8px;
        }
        .sub-nav-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }
        .sub-nav-btn:hover {
            border-color: #8B7355;
            background: #fff;
        }
        .sub-nav-btn.active {
            border-color: #8B7355;
            background: white;
            color: #8B7355;
            box-shadow: 0 2px 8px rgba(139, 115, 85, 0.15);
        }
        .sub-nav-icon {
            font-size: 18px;
        }
        
        /* Preview Card */
        .preview-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .preview-label {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        .preview-content {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 14px;
            line-height: 2;
            color: #333;
        }
        .preview-line { display: flex; align-items: baseline; }
        .preview-line .num {
            font-weight: 600;
            min-width: 40px;
            color: #8B7355;
        }
        .preview-line.l1 { font-size: 15px; font-weight: 600; }
        .preview-line.l2 { padding-left: 20px; }
        .preview-line.l3 { padding-left: 40px; }
        .preview-line.l4 { padding-left: 60px; font-size: 13px; }
        .preview-line.l5 { padding-left: 80px; font-size: 13px; color: #666; }
        
        /* Section Labels */
        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        /* Scheme Cards Grid */
        .scheme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .scheme-card {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: center;
        }
        .scheme-card:hover {
            border-color: #8B7355;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .scheme-card.selected {
            border-color: #8B7355;
            background: #fdf8f3;
        }
        .scheme-card-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            background: #8B7355;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .scheme-card.selected .scheme-card-check {
            display: flex;
        }
        .scheme-card-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .scheme-card-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }
        .scheme-card-preview {
            font-size: 11px;
            color: #888;
            font-family: monospace;
        }
        
        /* Collapsible Sections */
        .schemes-section {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .schemes-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #555;
            background: #fafafa;
        }
        .schemes-section-header:hover {
            background: #f5f5f5;
        }
        .toggle-arrow {
            font-size: 12px;
            color: #999;
            transition: transform 0.2s;
        }
        .schemes-section.collapsed .toggle-arrow {
            transform: rotate(-90deg);
        }
        .schemes-section.collapsed .schemes-section-body {
            display: none;
        }
        .schemes-section-body {
            padding: 8px 16px 16px;
        }
        .scheme-list-item {
            padding: 12px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            margin-bottom: 6px;
            background: #f8f8f8;
            transition: all 0.15s;
        }
        .scheme-list-item:hover {
            background: #e8f4fd;
            color: #1565c0;
        }
        .scheme-list-item.selected {
            background: #e8f4fd;
            color: #1565c0;
            font-weight: 500;
        }
        .add-scheme-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: transparent;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-scheme-btn:hover {
            border-color: #8B7355;
            color: #8B7355;
            background: #fdf8f3;
        }
        
        /* TOC Cards */
        .toc-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .toc-card {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .toc-card:hover {
            border-color: #8B7355;
        }
        .toc-card.selected {
            border-color: #8B7355;
            background: #fdf8f3;
        }
        .toc-card-check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 22px;
            height: 22px;
            background: #8B7355;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .toc-card.selected .toc-card-check {
            display: flex;
        }
        .toc-card-title {
            font-weight: 600;
            font-size: 15px;
            color: #333;
            margin-bottom: 4px;
        }
        .toc-card-desc {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
        }
        .toc-card-preview {
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            color: #666;
            line-height: 1.8;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
        }
        .toc-card-preview .indent { padding-left: 16px; }
        .toc-card-preview .indent2 { padding-left: 32px; }
        
        /* Options Card */
        .options-card {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .options-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 14px;
            color: #444;
        }
        .option-row:last-of-type {
            border-bottom: none;
        }
        .option-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #8B7355;
        }
        .field-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            font-size: 14px;
            color: #444;
        }
        .small-input {
            width: 70px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .large-input {
            padding: 14px 16px;
            font-size: 16px;
            border-radius: 8px;
        }
        .large-select {
            padding: 12px 14px;
            font-size: 14px;
            border-radius: 8px;
        }
        
        /* Level Cards (Editor) */
        .level-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .level-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            background: #fafafa;
            transition: background 0.15s;
        }
        .level-card-header:hover {
            background: #f0f0f0;
        }
        .level-badge {
            width: 28px;
            height: 28px;
            background: #8B7355;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
        }
        .level-card-title {
            flex: 1;
            font-weight: 500;
            font-size: 15px;
            color: #333;
        }
        .level-card-sample {
            font-family: 'Times New Roman', serif;
            font-size: 15px;
            color: #8B7355;
            font-weight: 600;
            padding: 4px 12px;
            background: #fdf8f3;
            border-radius: 6px;
        }
        .level-expand {
            font-size: 12px;
            color: #999;
            transition: transform 0.2s;
        }
        .level-card:not(.collapsed) .level-expand {
            transform: rotate(0deg);
        }
        .level-card.collapsed .level-expand {
            transform: rotate(-90deg);
        }
        .level-card-body {
            padding: 16px;
            border-top: 1px solid #e8e8e8;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-overlay.hidden {
            display: none;
        }
        .modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e8e8e8;
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid #e8e8e8;
            background: #f8f8f8;
        }
        .modal-footer .btn {
            flex: 1;
        }
        
        /* Save Scheme Modal */
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-content .modal-header {
            border: none;
            padding: 0 0 16px 0;
            font-size: 18px;
        }
        .modal-content .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-content .modal-actions .btn {
            flex: 1;
        }
        .style-assoc-preview {
            margin-top: 8px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 13px;
        }
        .style-assoc-item {
            padding: 4px 0;
            color: #555;
        }
        .style-assoc-item:before {
            content: 'üé® ';
        }
        .style-assoc-empty {
            color: #999;
            font-style: italic;
        }
        .scheme-badge {
            font-size: 11px;
            background: #8B7355;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }
        .scheme-section-header {
            font-size: 12px;
            font-weight: 600;
            color: #8B7355;
            padding: 12px 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .scheme-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .scheme-list-item:hover {
            background: #f5f5f5;
        }
        .scheme-list-item.selected {
            background: #f0ebe4;
            border: 2px solid #8B7355;
        }
        .scheme-icon {
            font-size: 18px;
        }
        .scheme-name {
            flex: 1;
        }
        .scheme-delete {
            background: none;
            border: none;
            color: #999;
            font-size: 18px;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .scheme-list-item:hover .scheme-delete {
            opacity: 1;
        }
        .scheme-delete:hover {
            color: #c00;
        }
        .empty-state {
            color: #999;
            font-size: 13px;
            padding: 8px 0;
            font-style: italic;
        }
        
        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 3000;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast-success { background: #2e7d32; }
        .toast-error { background: #c62828; }
        .toast-warning { background: #f57c00; }
        .toast-info { background: #1565c0; }
        
        /* Voice Control Window */
        .voice-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            overflow: hidden;
            border: 2px solid #8B7355;
        }
        .voice-window.hidden {
            display: none;
        }
        .voice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #8B7355;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .voice-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .voice-close:hover {
            opacity: 1;
        }
        .voice-body {
            padding: 16px;
            min-height: 100px;
        }
        .voice-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 0;
        }
        .voice-icon {
            font-size: 32px;
            animation: none;
        }
        .voice-icon.listening {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .voice-text {
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        .voice-transcript {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            color: #333;
            min-height: 40px;
            margin-top: 12px;
            display: none;
        }
        .voice-transcript.active {
            display: block;
        }
        .voice-action {
            margin-top: 12px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 13px;
            color: #2e7d32;
            display: none;
        }
        .voice-action.active {
            display: block;
        }
        .voice-action.error {
            background: #ffebee;
            color: #c62828;
        }
        .voice-footer {
            padding: 12px 16px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }
        .voice-hint {
            font-size: 11px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <span>Draft<span>Bridge</span></span>
        <button class="voice-toggle-btn" onclick="toggleVoiceWindow()" title="Voice Control (Ctrl+Shift+V)">üé§</button>
    </div>
    
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchPanel('generate')">Generate</button>
        <button class="main-tab" onclick="switchPanel('edit')">Edit</button>
        <button class="main-tab" onclick="switchPanel('numbering')">Numbering</button>
        <button class="main-tab" onclick="switchPanel('library')">Library</button>
        <button class="main-tab" onclick="switchPanel('admin')">Settings</button>
    </div>
    
    <!-- GENERATE PANEL -->
    <div class="panel active" id="panel-generate">
        <div class="sub-panel active" id="generate-main">
            <div class="content">
                <div class="section-header">Create Document</div>
                <div class="section-desc">Choose a template to start</div>
                
                <div class="option-card" onclick="showTemplate('letter')">
                    <span class="option-icon">‚úâÔ∏è</span>
                    <div class="option-text">
                        <div class="option-title">Letter</div>
                        <div class="option-desc">Formal business letter</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </div>
                
                <div class="option-card" onclick="showTemplate('memo')">
                    <span class="option-icon">üìù</span>
                    <div class="option-text">
                        <div class="option-title">Memorandum</div>
                        <div class="option-desc">Internal memo</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </div>
                
                <div class="option-card" onclick="showTemplate('fax')">
                    <span class="option-icon">üì†</span>
                    <div class="option-text">
                        <div class="option-title">Fax Cover</div>
                        <div class="option-desc">Fax cover sheet</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </div>
                
                <div class="divider">
                    <span class="divider-label">Tools</span>
                </div>
                
                <div class="option-card" onclick="alert('Coming soon!')">
                    <span class="option-icon">üîñ</span>
                    <div class="option-text">
                        <div class="option-title">Detect Bookmarks</div>
                        <div class="option-desc">Auto-fill Word bookmarks</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </div>
                
                <div class="option-card" onclick="alert('Coming soon!')">
                    <span class="option-icon">üåê</span>
                    <div class="option-text">
                        <div class="option-title">Global Variables</div>
                        <div class="option-desc">{{Placeholders}} everywhere</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </div>
            </div>
        </div>
        
        <!-- Letter Form -->
        <div class="sub-panel" id="generate-letter">
            <button class="back-btn" onclick="hideTemplate()">‚Üê Back</button>
            <div class="content">
                <div class="section-header">Letter</div>
                <div class="section-desc">Fill in the details</div>
                
                <div class="field">
                    <label>Date</label>
                    <input type="date" id="letter-date">
                </div>
                <div class="field">
                    <label>Recipient Name</label>
                    <input type="text" id="letter-recipient" placeholder="John Smith">
                </div>
                <div class="field">
                    <label>Recipient Address</label>
                    <textarea id="letter-address" placeholder="123 Main St&#10;City, State 12345"></textarea>
                </div>
                <div class="field">
                    <label>RE: Subject</label>
                    <input type="text" id="letter-subject" placeholder="Subject matter">
                </div>
                <div class="field">
                    <label>Closing</label>
                    <select id="letter-closing">
                        <option value="Sincerely">Sincerely</option>
                        <option value="Very truly yours">Very truly yours</option>
                        <option value="Best regards">Best regards</option>
                        <option value="Respectfully">Respectfully</option>
                        <option value="Cordially">Cordially</option>
                        <option value="Regards">Regards</option>
                        <option value="Yours truly">Yours truly</option>
                        <option value="With kind regards">With kind regards</option>
                    </select>
                </div>
                <div class="field">
                    <label>Delivery Method</label>
                    <select id="letter-delivery">
                        <option value="">(None)</option>
                        <option value="Via Email">Via Email</option>
                        <option value="Via Certified Mail">Via Certified Mail</option>
                        <option value="Via Federal Express">Via Federal Express</option>
                        <option value="Via Facsimile">Via Facsimile</option>
                        <option value="Via Hand Delivery">Via Hand Delivery</option>
                        <option value="Via First Class Mail">Via First Class Mail</option>
                        <option value="Via Overnight Delivery">Via Overnight Delivery</option>
                    </select>
                </div>
                <div class="field">
                    <label>Enclosures</label>
                    <select id="letter-enclosures">
                        <option value="">(None)</option>
                        <option value="Enclosure">Enclosure</option>
                        <option value="Enclosures">Enclosures</option>
                        <option value="Enc.">Enc.</option>
                        <option value="Attachment">Attachment</option>
                        <option value="Attachments">Attachments</option>
                        <option value="Enclosures as stated">Enclosures as stated</option>
                    </select>
                </div>
                <div class="field">
                    <label>Author</label>
                    <select id="letter-signer" class="author-select"></select>
                </div>
                <div class="field">
                    <label>Include Job Title</label>
                    <select id="letter-title-option">
                        <option value="yes">Yes - from author profile</option>
                        <option value="no">No</option>
                        <option value="custom">Custom...</option>
                    </select>
                    <input type="text" id="letter-title-custom" placeholder="Custom title" style="display:none; margin-top:8px;">
                </div>
            </div>
            <div class="actions">
                <button class="btn" onclick="generateLetter()">Generate Letter</button>
            </div>
        </div>
        
        <!-- Memo Form -->
        <div class="sub-panel" id="generate-memo">
            <button class="back-btn" onclick="hideTemplate()">‚Üê Back</button>
            <div class="content">
                <div class="section-header">Memorandum</div>
                <div class="section-desc">Fill in the details</div>
                
                <div class="field">
                    <label>Date</label>
                    <input type="date" id="memo-date">
                </div>
                <div class="field">
                    <label>To</label>
                    <input type="text" id="memo-to" placeholder="Recipient name(s)">
                </div>
                <div class="field">
                    <label>From</label>
                    <select id="memo-from" class="author-select"></select>
                </div>
                <div class="field">
                    <label>Subject</label>
                    <input type="text" id="memo-subject" placeholder="Brief description">
                </div>
                <div class="field">
                    <label>CC (optional)</label>
                    <input type="text" id="memo-cc" placeholder="Copy recipients">
                </div>
            </div>
            <div class="actions">
                <button class="btn" onclick="generateMemo()">Generate Memo</button>
            </div>
        </div>
        
        <!-- Fax Form -->
        <div class="sub-panel" id="generate-fax">
            <button class="back-btn" onclick="hideTemplate()">‚Üê Back</button>
            <div class="content">
                <div class="section-header">Fax Cover Sheet</div>
                <div class="section-desc">Fill in the details</div>
                
                <div class="field">
                    <label>Date</label>
                    <input type="date" id="fax-date">
                </div>
                <div class="field">
                    <label>To</label>
                    <input type="text" id="fax-to" placeholder="Recipient name">
                </div>
                <div class="field">
                    <label>Fax Number</label>
                    <input type="text" id="fax-number" placeholder="(555) 123-4567">
                </div>
                <div class="field">
                    <label>From</label>
                    <select id="fax-from" class="author-select"></select>
                </div>
                <div class="field">
                    <label>Phone</label>
                    <input type="text" id="fax-phone" placeholder="(555) 987-6543">
                </div>
                <div class="field">
                    <label>Pages</label>
                    <input type="number" id="fax-pages" placeholder="1" value="1">
                </div>
                <div class="field">
                    <label>RE: Subject</label>
                    <input type="text" id="fax-subject" placeholder="Subject matter">
                </div>
            </div>
            <div class="actions">
                <button class="btn" onclick="generateFax()">Generate Fax Cover</button>
            </div>
        </div>
    </div>
    
    <!-- EDIT PANEL -->
    <div class="panel" id="panel-edit">
        <div class="content">
            <div class="section-header">Edit Tools</div>
            <div class="section-desc">Format and structure your document</div>
            
            <div class="option-card" onclick="switchPanel('numbering')">
                <span class="option-icon">üî¢</span>
                <div class="option-text">
                    <div class="option-title">Numbering</div>
                    <div class="option-desc">Manage numbering schemes</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
            
            <div class="option-card" onclick="alert('Coming soon!')">
                <span class="option-icon">üìë</span>
                <div class="option-text">
                    <div class="option-title">Table of Contents</div>
                    <div class="option-desc">Generate TOC</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
            
            <div class="option-card" onclick="alert('Coming soon!')">
                <span class="option-icon">üìÑ</span>
                <div class="option-text">
                    <div class="option-title">Pleading Format</div>
                    <div class="option-desc">Court document formatting</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
            
            <div class="divider">
                <span class="divider-label">Security</span>
            </div>
            
            <div class="option-card" onclick="showEncryptModal()">
                <span class="option-icon">üîí</span>
                <div class="option-text">
                    <div class="option-title">Export Encrypted Copy</div>
                    <div class="option-desc">AES-256 military-grade encryption</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
            
            <div class="option-card" onclick="showDecryptModal()">
                <span class="option-icon">üîì</span>
                <div class="option-text">
                    <div class="option-title">Decrypt Document</div>
                    <div class="option-desc">Open an encrypted file</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
        </div>
    </div>
    
    <!-- ENCRYPTION MODAL -->
    <div class="modal-overlay hidden" id="encrypt-modal">
        <div class="modal">
            <div class="modal-header">
                <span>üîí Export Encrypted Copy</span>
                <button class="modal-close" onclick="hideEncryptModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: #666; font-size: 13px;">
                    Your document will be encrypted with AES-256-GCM (military-grade encryption). 
                    Only someone with the password can decrypt it.
                </p>
                <div class="field">
                    <label>Password *</label>
                    <input type="password" id="encrypt-password" placeholder="Enter a strong password">
                </div>
                <div class="field">
                    <label>Confirm Password *</label>
                    <input type="password" id="encrypt-password-confirm" placeholder="Confirm password">
                </div>
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-top: 16px;">
                    <strong style="color: #856404;">‚ö†Ô∏è Warning:</strong>
                    <p style="color: #856404; font-size: 12px; margin-top: 4px;">
                        If you forget this password, the document cannot be recovered. 
                        There is no password reset.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="hideEncryptModal()">Cancel</button>
                <button class="btn" onclick="encryptAndExport()">üîí Encrypt & Download</button>
            </div>
        </div>
    </div>
    
    <!-- DECRYPT MODAL -->
    <div class="modal-overlay hidden" id="decrypt-modal">
        <div class="modal">
            <div class="modal-header">
                <span>üîì Decrypt Document</span>
                <button class="modal-close" onclick="hideDecryptModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: #666; font-size: 13px;">
                    Select an encrypted file (.docx.enc) to decrypt and open.
                </p>
                <div class="field">
                    <label>Encrypted File *</label>
                    <input type="file" id="decrypt-file" accept=".enc" style="padding: 8px;">
                </div>
                <div class="field">
                    <label>Password *</label>
                    <input type="password" id="decrypt-password" placeholder="Enter decryption password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="hideDecryptModal()">Cancel</button>
                <button class="btn" onclick="decryptAndOpen()">üîì Decrypt & Insert</button>
            </div>
        </div>
    </div>
    
    <!-- VOICE CONTROL WINDOW -->
    <div id="voice-control" class="voice-window hidden">
        <div class="voice-header">
            <span>üé§ Voice Control</span>
            <button class="voice-close" onclick="closeVoiceControl()">√ó</button>
        </div>
        <div class="voice-body">
            <div id="voice-status" class="voice-status">
                <div class="voice-icon" id="voice-icon">üé§</div>
                <div class="voice-text" id="voice-text">Press to speak...</div>
            </div>
            <div id="voice-transcript" class="voice-transcript"></div>
            <div id="voice-action" class="voice-action"></div>
        </div>
        <div class="voice-footer">
            <button class="btn small" id="voice-btn" onclick="toggleVoiceListening()">Start Listening</button>
            <div class="voice-hint">Ctrl+Shift+V to toggle</div>
        </div>
    </div>
    
    <!-- ========== NUMBERING & TOC PANEL (REDESIGNED) ========== -->
    <div class="panel" id="panel-numbering">
        <!-- Sub-navigation: Numbering vs TOC -->
        <div class="sub-nav">
            <button class="sub-nav-btn active" onclick="switchNumberingMode('numbering')">
                <span class="sub-nav-icon">üî¢</span>
                Numbering
            </button>
            <button class="sub-nav-btn" onclick="switchNumberingMode('toc')">
                <span class="sub-nav-icon">üìë</span>
                Table of Contents
            </button>
        </div>
        
        <!-- NUMBERING SECTION -->
        <div class="sub-panel active" id="numbering-browse">
            <div class="content">
                <!-- Live Preview Card -->
                <div class="preview-card">
                    <div class="preview-label">Preview</div>
                    <div class="preview-content" id="numbering-preview">
                        <div class="preview-line l1"><span class="num">I.</span> Article One</div>
                        <div class="preview-line l2"><span class="num">A.</span> Section Title</div>
                        <div class="preview-line l3"><span class="num">1.</span> Paragraph text</div>
                        <div class="preview-line l4"><span class="num">(a)</span> Sub-paragraph</div>
                        <div class="preview-line l5"><span class="num">(i)</span> Detail item</div>
                    </div>
                </div>
                
                <div class="section-label">Select a Scheme</div>
                
                <!-- Scheme Cards (Modern, Large) -->
                <div class="scheme-grid">
                    <div class="scheme-card selected" onclick="selectSchemeCard('legal-outline', this)">
                        <div class="scheme-card-check">‚úì</div>
                        <div class="scheme-card-icon">‚öñÔ∏è</div>
                        <div class="scheme-card-name">Legal Outline</div>
                        <div class="scheme-card-preview">I ‚Üí A ‚Üí 1 ‚Üí (a) ‚Üí (i)</div>
                    </div>
                    <div class="scheme-card" onclick="selectSchemeCard('contract-sections', this)">
                        <div class="scheme-card-check">‚úì</div>
                        <div class="scheme-card-icon">üìã</div>
                        <div class="scheme-card-name">Contract</div>
                        <div class="scheme-card-preview">Art. I ‚Üí ¬ß1 ‚Üí a ‚Üí (i)</div>
                    </div>
                    <div class="scheme-card" onclick="selectSchemeCard('heading-style', this)">
                        <div class="scheme-card-check">‚úì</div>
                        <div class="scheme-card-icon">üìù</div>
                        <div class="scheme-card-name">Heading</div>
                        <div class="scheme-card-preview">1. ‚Üí 1.1 ‚Üí 1.1.1</div>
                    </div>
                    <div class="scheme-card" onclick="selectSchemeCard('pleading-format', this)">
                        <div class="scheme-card-check">‚úì</div>
                        <div class="scheme-card-icon">üèõÔ∏è</div>
                        <div class="scheme-card-name">Pleading</div>
                        <div class="scheme-card-preview">1 ‚Üí a ‚Üí (1) ‚Üí (a)</div>
                    </div>
                </div>
                
                <!-- Document & Personal Schemes -->
                <div class="schemes-section">
                    <div class="schemes-section-header" onclick="toggleSchemesSection('document')">
                        <span>üìÑ From This Document</span>
                        <span class="toggle-arrow" id="toggle-document">‚ñº</span>
                    </div>
                    <div class="schemes-section-body" id="section-document">
                        <div class="scheme-list-item" onclick="selectSchemeCard('doc-1', this)">
                            Document Scheme
                        </div>
                    </div>
                </div>
                
                <div class="schemes-section">
                    <div class="schemes-section-header" onclick="toggleSchemesSection('personal')">
                        <span>‚≠ê My Saved Schemes</span>
                        <span class="toggle-arrow" id="toggle-personal">‚ñº</span>
                    </div>
                    <div class="schemes-section-body" id="section-personal">
                        <div id="user-schemes-container"></div>
                        <button class="add-scheme-btn" onclick="captureNumberingFromDocument()">üìÑ Save from Document</button>
                        <button class="add-scheme-btn" onclick="showNumberingEditor()">+ Create New Scheme</button>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn secondary" onclick="openWordNumberingDialog()">‚úèÔ∏è Edit</button>
                <button class="btn" onclick="applySelectedScheme()">Apply to Selection</button>
            </div>
        </div>
        
        <!-- TOC SECTION -->
        <div class="sub-panel" id="toc-browse">
            <div class="content">
                <div class="section-label">Table of Contents Style</div>
                
                <!-- TOC Style Cards -->
                <div class="toc-grid">
                    <div class="toc-card selected" onclick="selectTocStyle('level1', this)">
                        <div class="toc-card-check">‚úì</div>
                        <div class="toc-card-title">Level 1 Only</div>
                        <div class="toc-card-desc">Top-level headings</div>
                        <div class="toc-card-preview">
                            <div>I. First Article</div>
                            <div>II. Second Article</div>
                        </div>
                    </div>
                    <div class="toc-card" onclick="selectTocStyle('level12', this)">
                        <div class="toc-card-check">‚úì</div>
                        <div class="toc-card-title">Levels 1 & 2</div>
                        <div class="toc-card-desc">Articles + Sections</div>
                        <div class="toc-card-preview">
                            <div>I. First Article</div>
                            <div class="indent">A. Section One</div>
                            <div class="indent">B. Section Two</div>
                        </div>
                    </div>
                    <div class="toc-card" onclick="selectTocStyle('level123', this)">
                        <div class="toc-card-check">‚úì</div>
                        <div class="toc-card-title">Levels 1-3</div>
                        <div class="toc-card-desc">Full detail</div>
                        <div class="toc-card-preview">
                            <div>I. First Article</div>
                            <div class="indent">A. Section</div>
                            <div class="indent2">1. Para</div>
                        </div>
                    </div>
                </div>
                
                <!-- TOC Options -->
                <div class="options-card">
                    <div class="options-title">Options</div>
                    <label class="option-row">
                        <input type="checkbox" id="toc-hyperlinks" checked>
                        <span>Use Hyperlinks</span>
                    </label>
                    <label class="option-row">
                        <input type="checkbox" id="toc-page-numbers" checked>
                        <span>Show Page Numbers</span>
                    </label>
                    <label class="option-row">
                        <input type="checkbox" id="toc-right-align">
                        <span>Right-Align Page Numbers</span>
                    </label>
                    <label class="option-row">
                        <input type="checkbox" id="toc-dot-leaders" checked>
                        <span>Dot Leaders</span>
                    </label>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn secondary" onclick="updateToc()">üîÑ Update TOC</button>
                <button class="btn" onclick="insertToc()">Insert TOC</button>
            </div>
        </div>
        
        <!-- NUMBERING EDITOR (existing, keep similar) -->
        <div class="sub-panel" id="numbering-editor">
            <button class="back-btn" onclick="hideNumberingEditor()">‚Üê Back</button>
            <div class="content">
                <div class="field">
                    <label>Scheme Name</label>
                    <input type="text" id="scheme-name" value="Legal Outline" class="large-input">
                </div>
                
                <!-- Level editors - keep existing but with larger styling -->
                <div class="level-card" id="level-1-card">
                    <div class="level-card-header" onclick="toggleLevelCard(1)">
                        <span class="level-badge">1</span>
                        <span class="level-card-title">Level 1</span>
                        <span class="level-card-sample" id="level-1-sample">I.</span>
                        <span class="level-expand">‚ñº</span>
                    </div>
                    <div class="level-card-body" id="level-1-body">
                        <div class="field-row">
                            <div class="field">
                                <label>Before Number</label>
                                <input type="text" id="level-1-before" placeholder="Article ">
                            </div>
                            <div class="field">
                                <label>Number Style</label>
                                <select id="level-1-style" class="large-select">
                                    <option value="I">I, II, III (Roman)</option>
                                    <option value="1">1, 2, 3 (Numeric)</option>
                                    <option value="A">A, B, C (Alpha)</option>
                                    <option value="a">a, b, c (alpha)</option>
                                    <option value="i">i, ii, iii (roman)</option>
                                    <option value="none">(none)</option>
                                </select>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label>After Number</label>
                                <input type="text" id="level-1-after" value="." placeholder=".">
                            </div>
                            <div class="field">
                                <label>Followed By</label>
                                <select id="level-1-follow" class="large-select">
                                    <option value="tab">Tab</option>
                                    <option value="space">Space</option>
                                    <option value="nothing">Nothing</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Repeat for levels 2-5 (similar structure) -->
                <div class="level-card collapsed" id="level-2-card">
                    <div class="level-card-header" onclick="toggleLevelCard(2)">
                        <span class="level-badge">2</span>
                        <span class="level-card-title">Level 2</span>
                        <span class="level-card-sample" id="level-2-sample">A.</span>
                        <span class="level-expand">‚ñ∂</span>
                    </div>
                    <div class="level-card-body" id="level-2-body" style="display:none;">
                        <div class="field-row">
                            <div class="field">
                                <label>Before Number</label>
                                <input type="text" id="level-2-before" placeholder="">
                            </div>
                            <div class="field">
                                <label>Number Style</label>
                                <select id="level-2-style" class="large-select">
                                    <option value="A" selected>A, B, C (Alpha)</option>
                                    <option value="I">I, II, III (Roman)</option>
                                    <option value="1">1, 2, 3 (Numeric)</option>
                                    <option value="a">a, b, c (alpha)</option>
                                    <option value="i">i, ii, iii (roman)</option>
                                    <option value="none">(none)</option>
                                </select>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label>After Number</label>
                                <input type="text" id="level-2-after" value=".">
                            </div>
                            <div class="field">
                                <label>Followed By</label>
                                <select id="level-2-follow" class="large-select">
                                    <option value="tab">Tab</option>
                                    <option value="space">Space</option>
                                    <option value="nothing">Nothing</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="level-card collapsed" id="level-3-card">
                    <div class="level-card-header" onclick="toggleLevelCard(3)">
                        <span class="level-badge">3</span>
                        <span class="level-card-title">Level 3</span>
                        <span class="level-card-sample" id="level-3-sample">1.</span>
                        <span class="level-expand">‚ñ∂</span>
                    </div>
                    <div class="level-card-body" id="level-3-body" style="display:none;">
                        <!-- Same structure as above -->
                        <div class="field-row">
                            <div class="field">
                                <label>Before Number</label>
                                <input type="text" id="level-3-before">
                            </div>
                            <div class="field">
                                <label>Number Style</label>
                                <select id="level-3-style" class="large-select">
                                    <option value="1" selected>1, 2, 3 (Numeric)</option>
                                    <option value="A">A, B, C (Alpha)</option>
                                    <option value="a">a, b, c (alpha)</option>
                                    <option value="I">I, II, III (Roman)</option>
                                    <option value="i">i, ii, iii (roman)</option>
                                    <option value="none">(none)</option>
                                </select>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label>After Number</label>
                                <input type="text" id="level-3-after" value=".">
                            </div>
                            <div class="field">
                                <label>Followed By</label>
                                <select id="level-3-follow" class="large-select">
                                    <option value="tab">Tab</option>
                                    <option value="space">Space</option>
                                    <option value="nothing">Nothing</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="level-card collapsed" id="level-4-card">
                    <div class="level-card-header" onclick="toggleLevelCard(4)">
                        <span class="level-badge">4</span>
                        <span class="level-card-title">Level 4</span>
                        <span class="level-card-sample" id="level-4-sample">(a)</span>
                        <span class="level-expand">‚ñ∂</span>
                    </div>
                    <div class="level-card-body" id="level-4-body" style="display:none;">
                        <div class="field-row">
                            <div class="field">
                                <label>Before Number</label>
                                <input type="text" id="level-4-before" value="(">
                            </div>
                            <div class="field">
                                <label>Number Style</label>
                                <select id="level-4-style" class="large-select">
                                    <option value="a" selected>a, b, c (alpha)</option>
                                    <option value="1">1, 2, 3 (Numeric)</option>
                                    <option value="A">A, B, C (Alpha)</option>
                                    <option value="I">I, II, III (Roman)</option>
                                    <option value="i">i, ii, iii (roman)</option>
                                    <option value="none">(none)</option>
                                </select>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label>After Number</label>
                                <input type="text" id="level-4-after" value=")">
                            </div>
                            <div class="field">
                                <label>Followed By</label>
                                <select id="level-4-follow" class="large-select">
                                    <option value="tab">Tab</option>
                                    <option value="space">Space</option>
                                    <option value="nothing">Nothing</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="level-card collapsed" id="level-5-card">
                    <div class="level-card-header" onclick="toggleLevelCard(5)">
                        <span class="level-badge">5</span>
                        <span class="level-card-title">Level 5</span>
                        <span class="level-card-sample" id="level-5-sample">(i)</span>
                        <span class="level-expand">‚ñ∂</span>
                    </div>
                    <div class="level-card-body" id="level-5-body" style="display:none;">
                        <div class="field-row">
                            <div class="field">
                                <label>Before Number</label>
                                <input type="text" id="level-5-before" value="(">
                            </div>
                            <div class="field">
                                <label>Number Style</label>
                                <select id="level-5-style" class="large-select">
                                    <option value="i" selected>i, ii, iii (roman)</option>
                                    <option value="1">1, 2, 3 (Numeric)</option>
                                    <option value="a">a, b, c (alpha)</option>
                                    <option value="A">A, B, C (Alpha)</option>
                                    <option value="I">I, II, III (Roman)</option>
                                    <option value="none">(none)</option>
                                </select>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label>After Number</label>
                                <input type="text" id="level-5-after" value=")">
                            </div>
                            <div class="field">
                                <label>Followed By</label>
                                <select id="level-5-follow" class="large-select">
                                    <option value="tab">Tab</option>
                                    <option value="space">Space</option>
                                    <option value="nothing">Nothing</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Global Options -->
                <div class="options-card">
                    <div class="options-title">Options</div>
                    <label class="option-row">
                        <input type="checkbox" id="opt-restart" checked>
                        <span>Restart numbering after higher level</span>
                    </label>
                    <label class="option-row">
                        <input type="checkbox" id="opt-legal">
                        <span>Legal style (1.1.1 format)</span>
                    </label>
                    <label class="option-row">
                        <input type="checkbox" id="opt-right-align">
                        <span>Right-align numbers</span>
                    </label>
                    <div class="field-inline">
                        <label>Start at:</label>
                        <input type="number" id="scheme-start" value="1" min="1" class="small-input">
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn secondary" onclick="hideNumberingEditor()">Cancel</button>
                <button class="btn" onclick="saveNumberingScheme()">üíæ Save Scheme</button>
            </div>
        </div>
    </div>
    <!-- LIBRARY PANEL -->
    <div class="panel" id="panel-library">
        <div class="search-box">
            <input type="text" class="search-input" id="search" placeholder="Search clauses..." oninput="filterClauses()">
        </div>
        
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="setCategory('all')">All</button>
            <button class="filter-tab" data-filter="contracts" onclick="setCategory('contracts')">Contracts</button>
            <button class="filter-tab" data-filter="litigation" onclick="setCategory('litigation')">Litigation</button>
            <button class="filter-tab" data-filter="corporate" onclick="setCategory('corporate')">Corporate</button>
        </div>
        
        <div id="library-status" class="status">Loading clauses...</div>
        <div id="clauses" class="content"></div>
    </div>
    
    <!-- ADMIN PANEL -->
    <div class="panel" id="panel-admin">
        <div class="content">
            <div class="section-header">Settings</div>
            <div class="section-desc">Configure your preferences</div>
            
            <div class="option-card" onclick="alert('Coming soon!')">
                <span class="option-icon">üè¢</span>
                <div class="option-text">
                    <div class="option-title">Firm Settings</div>
                    <div class="option-desc">Firm name, address, branding</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
            
            <div class="option-card" onclick="alert('Coming soon!')">
                <span class="option-icon">üé®</span>
                <div class="option-text">
                    <div class="option-title">Styles</div>
                    <div class="option-desc">Document styles & formatting</div>
                </div>
                <span class="option-arrow">‚Üí</span>
            </div>
        </div>
    </div>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        const API = 'https://6b2bpmn8f8.execute-api.us-east-1.amazonaws.com/prod';
        const FIRM = 'morrison';
        
        // Authors list - will come from firm settings after auth
        // Each author can have optional title for signature blocks
        const AUTHORS = [
            { name: 'Nick Bridges', title: 'Managing Partner', default: true },
            { name: 'Sarah Chen', title: 'Partner' },
            { name: 'Michael Torres', title: 'Associate' },
            { name: 'Jennifer Williams', title: 'Of Counsel' },
            { name: 'David Park', title: 'Associate' }
        ];
        
        let allClauses = [];
        let currentCategory = 'all';

        Office.onReady(async (info) => {
            // Set today's date on date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
            
            // Populate author dropdowns
            populateAuthorDropdowns();
            
            // Load user's saved numbering schemes
            loadUserSchemes();
            
            // Load clauses
            loadClauses();
            
            // Initialize numbering preview
            updateNumberingPreview('legal-outline');
        });
        
        // Simple toast notification
        function toast(message, type = 'info', duration = 3000) {
            // Remove any existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toastEl = document.createElement('div');
            toastEl.className = `toast-notification toast-${type}`;
            toastEl.textContent = message;
            document.body.appendChild(toastEl);
            
            // Animate in
            setTimeout(() => toastEl.classList.add('show'), 10);
            
            // Remove after duration
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => toastEl.remove(), 300);
            }, duration);
        }
        
        // Populate all author/signer dropdowns with firm authors
        function populateAuthorDropdowns() {
            const authorSelects = document.querySelectorAll('.author-select');
            const defaultAuthor = AUTHORS.find(a => a.default) || AUTHORS[0];
            
            authorSelects.forEach(select => {
                select.innerHTML = '';
                AUTHORS.forEach(author => {
                    const option = document.createElement('option');
                    option.value = author.name;
                    option.textContent = author.name;
                    option.dataset.title = author.title || '';
                    if (author.default) option.selected = true;
                    select.appendChild(option);
                });
            });
        }
        
        // Get selected author's title (for signature blocks)
        function getSelectedAuthorTitle(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return '';
            const selected = select.options[select.selectedIndex];
            return selected?.dataset?.title || '';
        }
        
        // Handle title option toggle for letter form
        document.addEventListener('DOMContentLoaded', () => {
            const titleOption = document.getElementById('letter-title-option');
            const titleCustom = document.getElementById('letter-title-custom');
            if (titleOption && titleCustom) {
                titleOption.addEventListener('change', () => {
                    titleCustom.style.display = titleOption.value === 'custom' ? 'block' : 'none';
                });
            }
        });

        // Panel Navigation
        function switchPanel(panelId) {
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase() === panelId.toLowerCase()) {
                    tab.classList.add('active');
                }
            });
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === 'panel-' + panelId);
            });
        }

        // Template Forms
        function showTemplate(type) {
            document.getElementById('generate-main').classList.remove('active');
            document.getElementById('generate-' + type).classList.add('active');
        }
        
        function hideTemplate() {
            document.querySelectorAll('#panel-generate .sub-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('generate-main').classList.add('active');
        }
        // ========== NUMBERING & TOC FUNCTIONS ==========
        
        let selectedSchemeId = 'legal-outline';
        let selectedTocStyle = 'level1';
        
        // Numbering Schemes Data
        // Each scheme can have optional styleAssociations for linking to Word styles
        const numberingSchemes = {
            'legal-outline': {
                name: 'Legal Outline',
                levels: [
                    { before: '', style: 'I', after: '.', follow: 'tab' },
                    { before: '', style: 'A', after: '.', follow: 'tab' },
                    { before: '', style: '1', after: '.', follow: 'tab' },
                    { before: '(', style: 'a', after: ')', follow: 'tab' },
                    { before: '(', style: 'i', after: ')', follow: 'tab' }
                ],
                options: { restart: true, legal: false, rightAlign: false, startAt: 1 },
                styleAssociations: [
                    { level: 0, styleName: 'Heading 1' },
                    { level: 1, styleName: 'Heading 2' },
                    { level: 2, styleName: 'Heading 3' }
                ]
            },
            'contract-sections': {
                name: 'Contract Sections',
                levels: [
                    { before: 'ARTICLE ', style: 'I', after: '', follow: 'tab' },
                    { before: 'Section ', style: '1', after: '.', follow: 'tab' },
                    { before: '', style: 'a', after: '.', follow: 'tab' },
                    { before: '(', style: 'i', after: ')', follow: 'tab' },
                    { before: '(', style: 'A', after: ')', follow: 'tab' }
                ],
                options: { restart: true, legal: false, rightAlign: false, startAt: 1 },
                styleAssociations: [
                    { level: 0, styleName: 'Heading 1' },
                    { level: 1, styleName: 'Heading 2' }
                ]
            },
            'heading-style': {
                name: 'Heading Style',
                levels: [
                    { before: '', style: '1', after: '.', follow: 'tab' },
                    { before: '', style: '1', after: '.', follow: 'tab' },
                    { before: '', style: '1', after: '.', follow: 'tab' },
                    { before: '', style: '1', after: '.', follow: 'tab' },
                    { before: '', style: '1', after: '.', follow: 'tab' }
                ],
                options: { restart: true, legal: true, rightAlign: false, startAt: 1 },
                styleAssociations: [
                    { level: 0, styleName: 'Heading 1' },
                    { level: 1, styleName: 'Heading 2' },
                    { level: 2, styleName: 'Heading 3' },
                    { level: 3, styleName: 'Heading 4' },
                    { level: 4, styleName: 'Heading 5' }
                ]
            },
            'pleading-format': {
                name: 'Pleading Format',
                levels: [
                    { before: '', style: '1', after: '.', follow: 'tab' },
                    { before: '', style: 'a', after: '.', follow: 'tab' },
                    { before: '(', style: '1', after: ')', follow: 'tab' },
                    { before: '(', style: 'a', after: ')', follow: 'tab' },
                    { before: '(', style: 'i', after: ')', follow: 'tab' }
                ],
                options: { restart: true, legal: false, rightAlign: false, startAt: 1 },
                styleAssociations: []
            }
        };
        
        // User's saved schemes (loaded from localStorage, later from cloud)
        let userSchemes = {};
        try {
            userSchemes = JSON.parse(localStorage.getItem('draftbridge_numbering_schemes') || '{}');
        } catch (e) {
            console.error('Failed to parse saved schemes:', e);
            userSchemes = {};
        }
        
        // HTML escape utility to prevent XSS (includes single/double quotes for attribute contexts)
        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        function switchNumberingMode(mode) {
            // Update sub-nav buttons
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.sub-nav-btn').classList.add('active');
            
            // Show appropriate panel
            if (mode === 'numbering') {
                document.getElementById('numbering-browse').classList.add('active');
                document.getElementById('toc-browse').classList.remove('active');
            } else {
                document.getElementById('numbering-browse').classList.remove('active');
                document.getElementById('toc-browse').classList.add('active');
            }
            document.getElementById('numbering-editor').classList.remove('active');
        }
        
        function selectSchemeCard(schemeId, element) {
            selectedSchemeId = schemeId;
            
            // Update all scheme cards
            document.querySelectorAll('.scheme-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.scheme-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            if (element) {
                element.classList.add('selected');
            }
            
            updateNumberingPreview(schemeId);
        }
        
        function updateNumberingPreview(schemeId) {
            const scheme = numberingSchemes[schemeId];
            if (!scheme) return;
            
            const preview = document.getElementById('numbering-preview');
            const samples = ['Article One', 'Section Title', 'Paragraph text', 'Sub-paragraph', 'Detail item'];
            
            let html = '';
            for (let i = 0; i < 5; i++) {
                const level = scheme.levels[i];
                const num = level.before + formatNumber(i + 1, level.style) + level.after;
                html += `<div class="preview-line l${i+1}"><span class="num">${num}</span> ${samples[i]}</div>`;
            }
            preview.innerHTML = html;
        }
        
        function formatNumber(n, style) {
            switch(style) {
                case 'I': return toRoman(n).toUpperCase();
                case 'i': return toRoman(n).toLowerCase();
                case 'A': return String.fromCharCode(64 + n);
                case 'a': return String.fromCharCode(96 + n);
                case '1': return n.toString();
                case 'none': return '';
                default: return n.toString();
            }
        }
        
        function toRoman(num) {
            const romanNumerals = [
                ['M', 1000], ['CM', 900], ['D', 500], ['CD', 400],
                ['C', 100], ['XC', 90], ['L', 50], ['XL', 40],
                ['X', 10], ['IX', 9], ['V', 5], ['IV', 4], ['I', 1]
            ];
            let result = '';
            for (const [letter, value] of romanNumerals) {
                while (num >= value) {
                    result += letter;
                    num -= value;
                }
            }
            return result;
        }
        
        function toggleSchemesSection(sectionId) {
            const section = event.target.closest('.schemes-section');
            section.classList.toggle('collapsed');
        }
        
        function showNumberingEditor() {
            document.getElementById('numbering-browse').classList.remove('active');
            document.getElementById('toc-browse').classList.remove('active');
            document.getElementById('numbering-editor').classList.add('active');
            
            // Load scheme into editor
            const scheme = numberingSchemes[selectedSchemeId];
            if (scheme) {
                document.getElementById('scheme-name').value = scheme.name;
                
                for (let i = 1; i <= 5; i++) {
                    const level = scheme.levels[i - 1];
                    const beforeEl = document.getElementById(`level-${i}-before`);
                    const styleEl = document.getElementById(`level-${i}-style`);
                    const afterEl = document.getElementById(`level-${i}-after`);
                    const followEl = document.getElementById(`level-${i}-follow`);
                    
                    if (beforeEl) beforeEl.value = level.before;
                    if (styleEl) styleEl.value = level.style;
                    if (afterEl) afterEl.value = level.after;
                    if (followEl) followEl.value = level.follow;
                }
                
                document.getElementById('opt-restart').checked = scheme.options.restart;
                document.getElementById('opt-legal').checked = scheme.options.legal;
                document.getElementById('opt-right-align').checked = scheme.options.rightAlign;
                document.getElementById('scheme-start').value = scheme.options.startAt;
            }
        }
        
        function hideNumberingEditor() {
            document.getElementById('numbering-editor').classList.remove('active');
            document.getElementById('numbering-browse').classList.add('active');
        }
        
        function toggleLevelCard(level) {
            const card = document.getElementById(`level-${level}-card`);
            const body = document.getElementById(`level-${level}-body`);
            
            if (card.classList.contains('collapsed')) {
                card.classList.remove('collapsed');
                body.style.display = 'block';
            } else {
                card.classList.add('collapsed');
                body.style.display = 'none';
            }
        }
        
        function saveNumberingScheme() {
            const scheme = {
                name: document.getElementById('scheme-name').value,
                levels: [],
                options: {
                    restart: document.getElementById('opt-restart').checked,
                    legal: document.getElementById('opt-legal').checked,
                    rightAlign: document.getElementById('opt-right-align').checked,
                    startAt: parseInt(document.getElementById('scheme-start').value) || 1
                }
            };
            
            for (let i = 1; i <= 5; i++) {
                scheme.levels.push({
                    before: document.getElementById(`level-${i}-before`)?.value || '',
                    style: document.getElementById(`level-${i}-style`)?.value || '1',
                    after: document.getElementById(`level-${i}-after`)?.value || '',
                    follow: document.getElementById(`level-${i}-follow`)?.value || 'tab'
                });
            }
            
            numberingSchemes[selectedSchemeId] = scheme;
            updateNumberingPreview(selectedSchemeId);
            
            alert('‚úì Scheme saved!');
            hideNumberingEditor();
        }
        
        // Open Word's native numbering dialog
        async function openWordNumberingDialog() {
            try {
                await Word.run(async (context) => {
                    // Select the current paragraph first
                    const selection = context.document.getSelection();
                    selection.load('paragraphs');
                    await context.sync();
                    
                    // Use Office ribbon command to open Numbering dialog
                    // This opens the "Define New Number Format" dialog
                    if (Office.context.requirements.isSetSupported('WordApi', '1.5')) {
                        // Trigger ribbon command for numbering library
                        await context.document.body.paragraphs.getFirst().select();
                        await context.sync();
                    }
                });
                
                // Show instruction since we can't directly open the dialog
                toast('Use Home ‚Üí Numbering dropdown ‚Üí Define New Number Format', 'info', 5000);
                
            } catch (err) {
                console.error('Could not open dialog:', err);
                toast('Open from: Home ‚Üí Numbering dropdown ‚Üí Define New Number Format', 'info', 5000);
            }
        }
        
        async function applySelectedScheme() {
            const scheme = numberingSchemes[selectedSchemeId] || userSchemes[selectedSchemeId];
            if (!scheme) {
                alert('Please select a scheme first');
                return;
            }
            
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.load('paragraphs,text');
                    await context.sync();
                    
                    // Check if document/selection is empty
                    const paragraphs = selection.paragraphs;
                    paragraphs.load('items');
                    await context.sync();
                    
                    let targetParagraphs = paragraphs.items;
                    
                    // If empty or no content, insert placeholder paragraphs
                    if (targetParagraphs.length === 0 || (targetParagraphs.length === 1 && !selection.text.trim())) {
                        // Insert sample numbered items
                        const body = context.document.body;
                        body.insertParagraph('Item 1', Word.InsertLocation.end);
                        body.insertParagraph('Item 2', Word.InsertLocation.end);
                        body.insertParagraph('Item 3', Word.InsertLocation.end);
                        await context.sync();
                        
                        // Re-select the inserted content
                        body.load('paragraphs');
                        await context.sync();
                        targetParagraphs = body.paragraphs.items.slice(-3);
                    }
                    
                    // Load listFormat for all target paragraphs
                    for (let i = 0; i < targetParagraphs.length; i++) {
                        const para = targetParagraphs[i];
                        para.load('listFormat');
                    }
                    await context.sync();
                    
                    // Apply numbering
                    for (let i = 0; i < targetParagraphs.length; i++) {
                        const para = targetParagraphs[i];
                        if (para.listFormat) {
                            para.listFormat.convertToNumberedList();
                        }
                    }
                    await context.sync();
                    
                    // If scheme has style associations, try to link them
                    if (scheme.styleAssociations && scheme.styleAssociations.length > 0) {
                        await applyStyleAssociations(context, scheme.styleAssociations);
                    }
                });
                
                toast('Numbering applied!', 'success');
            } catch (err) {
                console.error('Apply failed:', err);
                toast('Failed to apply: ' + err.message, 'error');
            }
        }
        
        // Apply style associations from a numbering scheme
        async function applyStyleAssociations(context, associations) {
            const missingStyles = [];
            const linkedStyles = [];
            
            // Get all built-in style names to check against
            const builtInStyles = [
                'Normal', 'Heading 1', 'Heading 2', 'Heading 3', 'Heading 4', 'Heading 5',
                'Heading 6', 'Heading 7', 'Heading 8', 'Heading 9', 'Title', 'Subtitle',
                'Quote', 'Intense Quote', 'List Paragraph', 'TOC Heading'
            ];
            
            for (const assoc of associations) {
                try {
                    // Check if it's a known built-in style (these always exist)
                    if (builtInStyles.includes(assoc.styleName)) {
                        linkedStyles.push(assoc.styleName);
                    } else {
                        // For custom styles, we can't easily check existence
                        // Mark as potentially missing - user will see if it fails
                        missingStyles.push(assoc);
                    }
                } catch (e) {
                    missingStyles.push(assoc);
                }
            }
            
            if (missingStyles.length > 0) {
                // Show dialog for missing/custom styles
                showMissingStylesDialog(missingStyles, linkedStyles);
            } else if (linkedStyles.length > 0) {
                toast(`Linked to styles: ${linkedStyles.join(', ')}`, 'success');
            }
        }
        
        // Dialog for handling missing styles
        function showMissingStylesDialog(missingStyles, linkedStyles) {
            const styleNames = missingStyles.map(s => s.styleName).join(', ');
            const message = `Some styles weren't found in this document:\n\n${styleNames}\n\nThe numbering format was applied. You can manually link these styles in Word's Styles pane.`;
            
            if (linkedStyles.length > 0) {
                alert(`‚úì Numbering applied!\n\nLinked to: ${linkedStyles.join(', ')}\n\n‚ö†Ô∏è Not found: ${styleNames}`);
            } else {
                alert(`‚úì Numbering applied!\n\n‚ö†Ô∏è Styles not found: ${styleNames}\n\nYou can create these styles in Word and link them manually.`);
            }
        }
        
        // Capture numbering scheme from current document
        async function captureNumberingFromDocument() {
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.load('paragraphs');
                    await context.sync();
                    
                    const paragraphs = selection.paragraphs;
                    paragraphs.load('items');
                    await context.sync();
                    
                    if (paragraphs.items.length === 0) {
                        toast('Select some numbered text first', 'warning');
                        return;
                    }
                    
                    // Collect styles used in selection
                    const styleMap = new Map(); // level -> styleName
                    const capturedLevels = [];
                    
                    for (const para of paragraphs.items) {
                        para.load(['style', 'listFormat/listLevelNumber', 'listFormat/listString']);
                        await context.sync();
                        
                        const level = para.listFormat.listLevelNumber;
                        const styleName = para.style;
                        const listString = para.listFormat.listString;
                        
                        if (level >= 0 && listString) {
                            // Capture the level format
                            if (!capturedLevels[level]) {
                                capturedLevels[level] = {
                                    before: '',
                                    style: detectNumberStyle(listString),
                                    after: detectSuffix(listString),
                                    follow: 'tab'
                                };
                            }
                            
                            // Capture style association
                            if (styleName && styleName !== 'Normal' && !styleMap.has(level)) {
                                styleMap.set(level, styleName);
                            }
                        }
                    }
                    
                    // Build style associations array
                    const styleAssociations = [];
                    for (const [level, styleName] of styleMap) {
                        styleAssociations.push({ level, styleName });
                    }
                    
                    // Filter out sparse array holes and compact levels
                    const compactLevels = capturedLevels.filter(l => l !== undefined);
                    if (compactLevels.length === 0) {
                        toast('No numbered paragraphs found in selection', 'warning');
                        return;
                    }
                    
                    // Show save dialog with captured data
                    showSaveSchemeDialog(compactLevels, styleAssociations);
                });
            } catch (err) {
                console.error('Capture failed:', err);
                toast('Failed to capture: ' + err.message, 'error');
            }
        }
        
        // Detect number style from list string (e.g., "I." -> "I", "1." -> "1")
        function detectNumberStyle(listString) {
            if (!listString) return '1';
            const cleaned = listString.replace(/[\.\)\(\s]/g, '');
            if (/^[IVXLCDM]+$/i.test(cleaned)) {
                return cleaned === cleaned.toUpperCase() ? 'I' : 'i';
            }
            if (/^[A-Z]+$/.test(cleaned)) return 'A';
            if (/^[a-z]+$/.test(cleaned)) return 'a';
            return '1';
        }
        
        // Detect suffix from list string
        function detectSuffix(listString) {
            if (!listString) return '.';
            if (listString.endsWith(')')) return ')';
            if (listString.endsWith('.')) return '.';
            if (listString.endsWith(':')) return ':';
            return '';
        }
        
        // Show dialog to save captured scheme
        function showSaveSchemeDialog(levels, styleAssociations) {
            // Build HTML for style associations preview
            let stylePreview = '';
            if (styleAssociations.length > 0) {
                stylePreview = styleAssociations.map(s => 
                    `<div class="style-assoc-item">Level ${s.level + 1} ‚Üí "${escapeHtml(s.styleName)}"</div>`
                ).join('');
            } else {
                stylePreview = '<div class="style-assoc-empty">No style associations detected</div>';
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">Save Numbering Scheme</div>
                    <div class="field">
                        <label>Scheme Name</label>
                        <input type="text" id="save-scheme-name" placeholder="My Legal Outline">
                    </div>
                    <div class="field">
                        <label>
                            <input type="checkbox" id="save-scheme-styles" checked>
                            Include style associations
                        </label>
                        <div class="style-assoc-preview">${stylePreview}</div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn secondary" onclick="closeSaveSchemeModal()">Cancel</button>
                        <button class="btn" onclick="saveNewScheme()">Save</button>
                    </div>
                </div>
            `;
            
            // Store captured data for save
            modal.dataset.levels = JSON.stringify(levels);
            modal.dataset.styles = JSON.stringify(styleAssociations);
            
            document.body.appendChild(modal);
            document.getElementById('save-scheme-name').focus();
            
            // Close on Escape key - store handler for cleanup
            modal._escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeSaveSchemeModal();
                }
            };
            document.addEventListener('keydown', modal._escHandler);
        }
        
        function closeSaveSchemeModal() {
            const modal = document.querySelector('.modal-overlay');
            // Clean up escape handler to prevent memory leak
            if (modal && modal._escHandler) {
                document.removeEventListener('keydown', modal._escHandler);
            }
            if (modal) modal.remove();
        }
        
        function saveNewScheme() {
            const modal = document.querySelector('.modal-overlay');
            const name = document.getElementById('save-scheme-name').value.trim();
            const includeStyles = document.getElementById('save-scheme-styles').checked;
            
            if (!name) {
                toast('Please enter a scheme name', 'warning');
                return;
            }
            
            // Check for duplicate names
            const existingNames = Object.values(userSchemes).map(s => s.name.toLowerCase());
            if (existingNames.includes(name.toLowerCase())) {
                toast('A scheme with this name already exists', 'warning');
                return;
            }
            
            const levels = JSON.parse(modal.dataset.levels || '[]');
            const styleAssociations = includeStyles ? JSON.parse(modal.dataset.styles || '[]') : [];
            
            // Generate unique ID
            const schemeId = 'user_' + Date.now();
            
            // Create scheme object
            const scheme = {
                name: name,
                levels: levels.length > 0 ? levels : [
                    { before: '', style: '1', after: '.', follow: 'tab' }
                ],
                options: { restart: true, legal: false, rightAlign: false, startAt: 1 },
                styleAssociations: styleAssociations,
                createdAt: new Date().toISOString()
            };
            
            // Save to userSchemes
            userSchemes[schemeId] = scheme;
            localStorage.setItem('draftbridge_numbering_schemes', JSON.stringify(userSchemes));
            
            // Refresh the scheme list
            refreshSchemeList();
            
            closeSaveSchemeModal();
            toast(`Saved "${name}" with ${styleAssociations.length} style associations`, 'success');
        }
        
        // Refresh the scheme dropdown/list to include user schemes
        function refreshSchemeList() {
            // Just reload the user schemes display
            loadUserSchemes();
        }
        
        // Load user schemes on startup
        function loadUserSchemes() {
            const container = document.getElementById('user-schemes-container');
            if (!container) return;
            
            const userSchemeKeys = Object.keys(userSchemes);
            if (userSchemeKeys.length === 0) {
                container.innerHTML = '<div class="empty-state">No saved schemes yet</div>';
                return;
            }
            
            container.innerHTML = '';
            for (const [id, scheme] of Object.entries(userSchemes)) {
                const hasStyles = scheme.styleAssociations && scheme.styleAssociations.length > 0;
                const item = document.createElement('div');
                item.className = 'scheme-list-item';
                item.onclick = () => selectSchemeCard(id, item);
                item.innerHTML = `
                    <span class="scheme-icon">${hasStyles ? 'üé®' : 'üìã'}</span>
                    <span class="scheme-name">${escapeHtml(scheme.name)}</span>
                    ${hasStyles ? `<span class="scheme-badge">${scheme.styleAssociations.length} styles</span>` : ''}
                    <button class="scheme-delete" onclick="event.stopPropagation(); deleteUserScheme('${escapeHtml(id)}')">√ó</button>
                `;
                container.appendChild(item);
            }
        }
        
        // Delete a user-saved scheme
        function deleteUserScheme(schemeId) {
            if (!confirm('Delete this numbering scheme?')) return;
            
            delete userSchemes[schemeId];
            localStorage.setItem('draftbridge_numbering_schemes', JSON.stringify(userSchemes));
            
            // Clear selection if we deleted the active scheme
            if (selectedSchemeId === schemeId) {
                selectedSchemeId = 'legal-outline'; // Reset to default
            }
            
            loadUserSchemes();
            toast('Scheme deleted', 'success');
        }
        
        // TOC Functions
        function selectTocStyle(style, element) {
            selectedTocStyle = style;
            
            document.querySelectorAll('.toc-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (element) {
                element.classList.add('selected');
            }
        }
        
        async function insertToc() {
            try {
                await Word.run(async (context) => {
                    // Determine heading levels based on selection
                    let headingLevels = '1';
                    if (selectedTocStyle === 'level12') headingLevels = '1-2';
                    if (selectedTocStyle === 'level123') headingLevels = '1-3';
                    
                    // Get the body to insert TOC at cursor or beginning
                    const range = context.document.getSelection();
                    
                    // Insert TOC field code
                    // Word uses field codes like: TOC \o "1-3" \h \z \u
                    // \o = heading levels, \h = hyperlinks, \z = hide tab/page in web, \u = use applied paragraph styles
                    const tocField = `TOC \\o "${headingLevels}" \\h \\z \\u`;
                    
                    // Insert as a field
                    range.insertField(Word.FieldType.toc, tocField, Word.InsertLocation.start);
                    
                    await context.sync();
                });
                
                toast('TOC inserted! Press F9 or right-click ‚Üí Update Field to populate.', 'success', 5000);
            } catch (err) {
                console.error('TOC insert failed:', err);
                // Fallback: try inserting via References tab guidance
                if (err.message.includes('insertField') || err.message.includes('not supported')) {
                    toast('Use References tab ‚Üí Table of Contents to insert TOC', 'info', 5000);
                } else {
                    toast('Failed to insert TOC: ' + err.message, 'error');
                }
            }
        }
        
        async function updateToc() {
            try {
                await Word.run(async (context) => {
                    // Note: Word.js API doesn't have direct TOC update
                    // This would need VBA or user to press F9
                    alert('To update TOC: Select the Table of Contents and press F9, or right-click and choose "Update Field"');
                });
            } catch (err) {
                console.error('TOC update failed:', err);
            }
        }
        // Generate Documents
        async function generateLetter() {
            const date = document.getElementById('letter-date').value;
            const recipient = document.getElementById('letter-recipient').value;
            const address = document.getElementById('letter-address').value;
            const subject = document.getElementById('letter-subject').value;
            const closing = document.getElementById('letter-closing').value;
            const delivery = document.getElementById('letter-delivery').value;
            const enclosures = document.getElementById('letter-enclosures').value;
            const signer = document.getElementById('letter-signer').value;
            
            // Get job title based on option
            const titleOption = document.getElementById('letter-title-option').value;
            let jobTitle = '';
            if (titleOption === 'yes') {
                jobTitle = getSelectedAuthorTitle('letter-signer');
            } else if (titleOption === 'custom') {
                jobTitle = document.getElementById('letter-title-custom').value;
            }
            
            let text = `${formatDate(date)}

${recipient}
${address}`;

            if (delivery) text += `\n\n${delivery}`;

            text += `

RE: ${subject}

Dear ${recipient.split(' ')[0]}:

[Letter body here]

${closing},


${signer}`;

            if (jobTitle) text += `\n${jobTitle}`;

            if (enclosures) text += `\n\n${enclosures}`;
            
            await insertText(text);
            hideTemplate();
        }
        
        async function generateMemo() {
            const date = document.getElementById('memo-date').value;
            const to = document.getElementById('memo-to').value;
            const from = document.getElementById('memo-from').value;
            const subject = document.getElementById('memo-subject').value;
            const cc = document.getElementById('memo-cc').value;
            
            let text = `MEMORANDUM

DATE:    ${formatDate(date)}
TO:      ${to}
FROM:    ${from}
RE:      ${subject}`;
            
            if (cc) text += `\nCC:      ${cc}`;
            
            text += `\n\n${'‚îÄ'.repeat(50)}\n\n[Memo body here]`;
            
            await insertText(text);
            hideTemplate();
        }
        
        async function generateFax() {
            const date = document.getElementById('fax-date').value;
            const to = document.getElementById('fax-to').value;
            const faxNum = document.getElementById('fax-number').value;
            const from = document.getElementById('fax-from').value;
            const phone = document.getElementById('fax-phone').value;
            const pages = document.getElementById('fax-pages').value;
            const subject = document.getElementById('fax-subject').value;
            
            const text = `FAX COVER SHEET

DATE:     ${formatDate(date)}
TO:       ${to}
FAX:      ${faxNum}
FROM:     ${from}
PHONE:    ${phone}
PAGES:    ${pages} (including cover)
RE:       ${subject}

${'‚îÄ'.repeat(50)}

COMMENTS:

[Comments here]`;
            
            await insertText(text);
            hideTemplate();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }
        
        async function insertText(text) {
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.insertText(text, Word.InsertLocation.replace);
                    await context.sync();
                });
                alert('‚úì Inserted!');
            } catch (err) {
                console.error('Insert failed:', err);
                alert('Failed to insert: ' + err.message);
            }
        }

        // Library Functions
        async function loadClauses() {
            const statusEl = document.getElementById('library-status');

            try {
                statusEl.textContent = 'Fetching clauses...';
                
                const response = await fetch(`${API}/firms/${FIRM}/clauses`);
                if (!response.ok) throw new Error('Failed to fetch');
                
                allClauses = await response.json();
                
                statusEl.textContent = `‚úì ${allClauses.length} clauses loaded`;
                statusEl.classList.remove('error');

                renderClauses();

            } catch (err) {
                console.error('Load failed:', err);
                statusEl.textContent = '‚úó Failed to load: ' + err.message;
                statusEl.classList.add('error');
            }
        }

        function setCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === category);
            });
            filterClauses();
        }

        function filterClauses() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            const filtered = allClauses.filter(clause => {
                const matchesCategory = currentCategory === 'all' || clause.category === currentCategory;
                const matchesSearch = !searchTerm || 
                    clause.title.toLowerCase().includes(searchTerm) ||
                    clause.content.toLowerCase().includes(searchTerm) ||
                    (clause.tags || []).some(tag => tag.toLowerCase().includes(searchTerm));
                return matchesCategory && matchesSearch;
            });
            
            renderClauses(filtered);
            
            const statusEl = document.getElementById('library-status');
            if (searchTerm || currentCategory !== 'all') {
                statusEl.textContent = `${filtered.length} of ${allClauses.length} clauses`;
            } else {
                statusEl.textContent = `‚úì ${allClauses.length} clauses loaded`;
            }
        }

        // Virtualized clause rendering - only render visible items
        const CLAUSES_PER_PAGE = 20;
        let currentClauseList = [];
        let renderedCount = 0;

        function renderClauses(clauses = allClauses) {
            const clausesEl = document.getElementById('clauses');
            currentClauseList = clauses;
            renderedCount = 0;
            
            if (clauses.length === 0) {
                clausesEl.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">üì≠</div>
                        <div>No clauses found</div>
                    </div>
                `;
                return;
            }

            // Clear and render first batch
            clausesEl.innerHTML = '';
            renderMoreClauses();
            
            // Setup scroll listener for lazy loading
            clausesEl.onscroll = () => {
                if (clausesEl.scrollTop + clausesEl.clientHeight >= clausesEl.scrollHeight - 100) {
                    renderMoreClauses();
                }
            };
        }

        function renderMoreClauses() {
            if (renderedCount >= currentClauseList.length) return;
            
            const clausesEl = document.getElementById('clauses');
            const batch = currentClauseList.slice(renderedCount, renderedCount + CLAUSES_PER_PAGE);
            
            const fragment = document.createDocumentFragment();
            batch.forEach(clause => {
                const div = document.createElement('div');
                div.className = 'clause';
                div.innerHTML = `
                    <div class="clause-header">
                        <div class="clause-title">${escapeHtml(clause.title)}</div>
                        <span class="clause-category ${clause.category || 'contracts'}">${clause.category || 'contracts'}</span>
                    </div>
                    <div class="clause-content">${escapeHtml(clause.content)}</div>
                    <button class="btn" onclick="insertClause('${clause.clauseId}', this)">Insert</button>
                `;
                fragment.appendChild(div);
            });
            
            clausesEl.appendChild(fragment);
            renderedCount += batch.length;
            
            // Show load more indicator if there are more
            if (renderedCount < currentClauseList.length) {
                const existing = clausesEl.querySelector('.load-more-indicator');
                if (!existing) {
                    const indicator = document.createElement('div');
                    indicator.className = 'load-more-indicator';
                    indicator.textContent = `Scroll for more (${currentClauseList.length - renderedCount} remaining)`;
                    indicator.style.cssText = 'text-align:center;padding:12px;color:#888;font-size:12px;';
                    clausesEl.appendChild(indicator);
                }
            } else {
                const indicator = clausesEl.querySelector('.load-more-indicator');
                if (indicator) indicator.remove();
            }
        }

        async function insertClause(clauseId, btn) {
            const clause = allClauses.find(c => c.clauseId === clauseId);
            if (!clause) return;
            
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Inserting...';

            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.insertText(clause.content, Word.InsertLocation.replace);
                    await context.sync();
                });

                btn.textContent = '‚úì Done!';
                btn.classList.add('success');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('success');
                    btn.disabled = false;
                }, 1500);

            } catch (err) {
                console.error('Insert failed:', err);
                btn.textContent = '‚úó Error';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ENCRYPTION - AES-256-GCM (Military Grade)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function showEncryptModal() {
            document.getElementById('encrypt-password').value = '';
            document.getElementById('encrypt-password-confirm').value = '';
            document.getElementById('encrypt-modal').classList.remove('hidden');
        }
        
        function hideEncryptModal() {
            document.getElementById('encrypt-modal').classList.add('hidden');
        }
        
        function showDecryptModal() {
            document.getElementById('decrypt-password').value = '';
            document.getElementById('decrypt-file').value = '';
            document.getElementById('decrypt-modal').classList.remove('hidden');
        }
        
        function hideDecryptModal() {
            document.getElementById('decrypt-modal').classList.add('hidden');
        }
        
        // Derive AES-256 key from password using PBKDF2
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000, // High iteration count for security
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 }, // AES-256
                false,
                ['encrypt', 'decrypt']
            );
        }
        
        // Encrypt data with AES-256-GCM
        async function encryptData(plaintext, password) {
            const encoder = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16)); // 128-bit salt
            const iv = crypto.getRandomValues(new Uint8Array(12));   // 96-bit IV for GCM
            
            const key = await deriveKey(password, salt);
            
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                encoder.encode(plaintext)
            );
            
            // Combine: salt (16) + iv (12) + ciphertext
            const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
            combined.set(salt, 0);
            combined.set(iv, salt.length);
            combined.set(new Uint8Array(encrypted), salt.length + iv.length);
            
            return combined;
        }
        
        // Decrypt data with AES-256-GCM
        async function decryptData(encryptedData, password) {
            const salt = encryptedData.slice(0, 16);
            const iv = encryptedData.slice(16, 28);
            const ciphertext = encryptedData.slice(28);
            
            const key = await deriveKey(password, salt);
            
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                ciphertext
            );
            
            return new TextDecoder().decode(decrypted);
        }
        
        // Export encrypted document
        async function encryptAndExport() {
            const password = document.getElementById('encrypt-password').value;
            const confirm = document.getElementById('encrypt-password-confirm').value;
            
            if (!password) {
                toast('Please enter a password', 'error');
                return;
            }
            
            if (password !== confirm) {
                toast('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                toast('Password must be at least 8 characters', 'error');
                return;
            }
            
            toast('Encrypting document...', 'info');
            
            try {
                await Word.run(async (context) => {
                    // Get document content
                    const body = context.document.body;
                    body.load('text');
                    await context.sync();
                    
                    const content = body.text;
                    
                    // Create document package with metadata
                    const docPackage = JSON.stringify({
                        version: 1,
                        type: 'draftbridge-encrypted',
                        timestamp: new Date().toISOString(),
                        content: content
                    });
                    
                    // Encrypt with AES-256-GCM
                    const encrypted = await encryptData(docPackage, password);
                    
                    // Create downloadable file
                    const blob = new Blob([encrypted], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    
                    // Generate filename
                    const filename = `document_${Date.now()}.docx.enc`;
                    
                    // Trigger download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    hideEncryptModal();
                    toast('‚úÖ Encrypted document downloaded', 'success');
                });
            } catch (err) {
                console.error('Encryption error:', err);
                toast('Encryption failed: ' + err.message, 'error');
            }
        }
        
        // Decrypt and insert document
        async function decryptAndOpen() {
            const fileInput = document.getElementById('decrypt-file');
            const password = document.getElementById('decrypt-password').value;
            
            if (!fileInput.files || !fileInput.files[0]) {
                toast('Please select an encrypted file', 'error');
                return;
            }
            
            if (!password) {
                toast('Please enter the password', 'error');
                return;
            }
            
            toast('Decrypting...', 'info');
            
            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const encryptedData = new Uint8Array(arrayBuffer);
                
                // Decrypt
                const decrypted = await decryptData(encryptedData, password);
                const docPackage = JSON.parse(decrypted);
                
                // Verify it's a DraftBridge encrypted file
                if (docPackage.type !== 'draftbridge-encrypted') {
                    throw new Error('Invalid file format');
                }
                
                // Insert into document
                await Word.run(async (context) => {
                    const body = context.document.body;
                    body.clear();
                    body.insertText(docPackage.content, Word.InsertLocation.start);
                    await context.sync();
                });
                
                hideDecryptModal();
                toast('‚úÖ Document decrypted and loaded', 'success');
                
            } catch (err) {
                console.error('Decryption error:', err);
                if (err.message.includes('decrypt')) {
                    toast('Wrong password or corrupted file', 'error');
                } else {
                    toast('Decryption failed: ' + err.message, 'error');
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VOICE CONTROL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let recognition = null;
        let isListening = false;
        let favoriteClausesCache = [];
        
        // Initialize speech recognition
        function initVoiceControl() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.log('Speech recognition not supported in this environment');
                // Hide voice control option if not supported
                const voiceCards = document.querySelectorAll('[onclick*="Voice"]');
                voiceCards.forEach(card => card.style.display = 'none');
                return;
            }
            
            // Check if we're in Word add-in context
            const isWordAddin = typeof Office !== 'undefined' && Office.context;
            console.log('Voice control init - Word add-in:', isWordAddin, 'WebView:', navigator.userAgent);
            
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                isListening = true;
                document.getElementById('voice-icon').classList.add('listening');
                document.getElementById('voice-text').textContent = 'Listening...';
                document.getElementById('voice-btn').textContent = 'Stop';
            };
            
            recognition.onend = () => {
                isListening = false;
                document.getElementById('voice-icon').classList.remove('listening');
                document.getElementById('voice-text').textContent = 'Press to speak...';
                document.getElementById('voice-btn').textContent = 'Start Listening';
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show transcript
                const transcriptEl = document.getElementById('voice-transcript');
                transcriptEl.classList.add('active');
                transcriptEl.textContent = finalTranscript || interimTranscript;
                
                // Process final transcript
                if (finalTranscript) {
                    processVoiceCommand(finalTranscript.toLowerCase().trim());
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let errorMsg = 'Error: ' + event.error;
                
                if (event.error === 'not-allowed') {
                    errorMsg = 'Microphone access denied. Check Word permissions.';
                } else if (event.error === 'no-speech') {
                    errorMsg = 'No speech detected. Try again.';
                } else if (event.error === 'network') {
                    errorMsg = 'Network error. Speech may require internet.';
                } else if (event.error === 'service-not-allowed') {
                    errorMsg = 'Speech service not available in this Office version.';
                }
                
                showVoiceAction(errorMsg, true);
            };
            
            } catch (initError) {
                console.error('Failed to initialize speech recognition:', initError);
                return;
            }
            
            // Keyboard shortcut: Ctrl+Shift+V
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'V') {
                    e.preventDefault();
                    toggleVoiceWindow();
                }
            });
            
            // Cache favorite clauses for voice commands
            loadFavoriteClauses();
        }
        
        function loadFavoriteClauses() {
            // Get favorites from localStorage or use sample
            const favorites = localStorage.getItem('draftbridge_favorites');
            if (favorites) {
                try {
                    favoriteClausesCache = JSON.parse(favorites);
                } catch (e) {
                    console.error('Failed to parse favorites:', e);
                    favoriteClausesCache = [];
                }
            } else {
                // Demo favorites
                favoriteClausesCache = [
                    { id: 1, title: 'Indemnification', content: 'Party A shall indemnify and hold harmless Party B...' },
                    { id: 2, title: 'Confidentiality', content: 'All information shared between the parties shall remain confidential...' },
                    { id: 3, title: 'Force Majeure', content: 'Neither party shall be liable for any failure or delay...' },
                    { id: 4, title: 'Governing Law', content: 'This Agreement shall be governed by the laws of the State of California...' },
                    { id: 5, title: 'Severability', content: 'If any provision of this Agreement is held to be invalid...' }
                ];
            }
        }
        
        function toggleVoiceWindow() {
            const window = document.getElementById('voice-control');
            if (window.classList.contains('hidden')) {
                window.classList.remove('hidden');
                if (!isListening && recognition) {
                    recognition.start();
                }
            } else {
                closeVoiceControl();
            }
        }
        
        function closeVoiceControl() {
            document.getElementById('voice-control').classList.add('hidden');
            if (isListening && recognition) {
                recognition.stop();
            }
            // Clear displays
            document.getElementById('voice-transcript').classList.remove('active');
            document.getElementById('voice-action').classList.remove('active');
        }
        
        async function toggleVoiceListening() {
            if (!recognition) {
                showVoiceAction('Voice control not available. Requires Office 365/2021+ on Windows.', true);
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    // Request microphone permission explicitly first
                    // This triggers the browser/OS permission prompt
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            // Permission granted - stop the stream (SpeechRecognition will create its own)
                            stream.getTracks().forEach(track => track.stop());
                            console.log('Microphone permission granted');
                        } catch (permErr) {
                            console.error('Microphone permission denied:', permErr);
                            if (permErr.name === 'NotAllowedError') {
                                showVoiceAction('Microphone blocked. In Windows: Settings ‚Üí Privacy ‚Üí Microphone ‚Üí Allow desktop apps', true);
                                return;
                            } else if (permErr.name === 'NotFoundError') {
                                showVoiceAction('No microphone found. Check your audio devices.', true);
                                return;
                            }
                        }
                    }
                    
                    recognition.start();
                } catch (err) {
                    console.error('Failed to start recognition:', err);
                    if (err.message.includes('already started')) {
                        recognition.stop();
                        setTimeout(() => recognition.start(), 100);
                    } else {
                        showVoiceAction('Could not start voice recognition. Try closing and reopening.', true);
                    }
                }
            }
        }
        
        function showVoiceAction(message, isError = false) {
            const actionEl = document.getElementById('voice-action');
            actionEl.textContent = message;
            actionEl.classList.add('active');
            actionEl.classList.toggle('error', isError);
            
            // Auto-hide success messages
            if (!isError) {
                setTimeout(() => {
                    actionEl.classList.remove('active');
                }, 3000);
            }
        }

        function showVoiceHelp() {
            const helpHtml = `
                <div style="font-size:12px;line-height:1.6;">
                    <strong>üìã Voice Commands:</strong><br>
                    <br>
                    <strong>Create:</strong><br>
                    ‚Ä¢ "Letter to [name]"<br>
                    ‚Ä¢ "Memo to [name]"<br>
                    <br>
                    <strong>Insert:</strong><br>
                    ‚Ä¢ "Insert [clause name]"<br>
                    ‚Ä¢ "Add signature"<br>
                    ‚Ä¢ "Add closing"<br>
                    ‚Ä¢ "Today's date"<br>
                    <br>
                    <strong>Navigate:</strong><br>
                    ‚Ä¢ "Go to library"<br>
                    ‚Ä¢ "Go to generate"<br>
                    ‚Ä¢ "Go to numbering"<br>
                    <br>
                    <strong>Numbering:</strong><br>
                    ‚Ä¢ "Legal outline"<br>
                    ‚Ä¢ "Contract style"<br>
                    <br>
                    ‚Ä¢ "Close" to exit
                </div>
            `;
            const actionEl = document.getElementById('voice-action');
            actionEl.innerHTML = helpHtml;
            actionEl.classList.add('active');
            actionEl.classList.remove('error');
        }
        
        // Clean filler words from voice input
        function cleanVoiceInput(text) {
            // Comprehensive filler list (287 items) - sorted longest first for proper replacement
            const fillers = [
                // Compound/long phrases first
                "if it's not too much trouble", "i would appreciate if you", "i'd appreciate it if you",
                "i was wondering if you could", "i was hoping you could", "it would be great if you could",
                "hold on let me start again", "it's on the tip of my tongue", "you hear what i'm saying",
                "that's not what i meant", "or something like that", "and stuff like that",
                "and things like that", "know what i'm saying", "that came out wrong",
                "be so kind as to", "when you get a chance", "for your information",
                "here's the situation", "let me start over", "what i meant was",
                "to put it another way", "know what i mean", "see what i mean",
                "forget what i said", "here's what i need", "okay so basically",
                "first things first", "what i need is", "what i want is",
                "do me a favor and", "be a dear and", "i'm looking to",
                "let me try again", "that's not right", "in other words",
                "here's the thing", "the thing is", "that is to say",
                "for the most part", "i think that's it", "that should do it",
                "that will be all", "and that's it", "please and thank you",
                "thank you very much", "thanks so much", "much appreciated",
                "i appreciate it", "good morning", "good afternoon", "good evening",
                "wait wait wait", "no no no", "well well well", "boy oh boy",
                "man oh man", "oh my god", "oh my gosh", "good grief", "good lord",
                "bloody hell", "dear me", "my goodness", "i beg your pardon",
                "yadda yadda yadda", "yada yada yada", "blah blah blah",
                "and so forth", "and so on", "over and out",
                // Medium phrases
                "i would like to", "i'd like you to", "i would like you to", "i'd like to",
                "i want you to", "i need you to", "go ahead and", "let me see",
                "let me think", "let me check", "give me a second", "give me a sec",
                "gimme a sec", "one moment", "one second", "just a moment",
                "just a second", "just a sec", "hold on", "hang on",
                "wait a minute", "wait a second", "wait a sec", "bear with me",
                "what was it", "what is it", "what's it called", "how do i say this",
                "how should i put this", "how do i put this", "what's the word",
                "let me recall", "trying to remember", "oh what is it",
                "i'm thinking", "scratch that", "never mind", "nevermind",
                "forget that", "ignore that", "disregard that", "let me rephrase",
                "or rather", "actually no", "no wait", "wait wait", "no no",
                "sorry i meant", "not that", "the other one", "i mean",
                "okay thanks", "got it", "sounds good", "sure thing", "you bet",
                "copy that", "that's all", "that's it", "that'll do",
                "i see", "oh i see", "oh right", "oh okay", "oh yeah", "oh yes", "ah yes",
                "come again", "say again", "repeat that", "excuse me",
                "by the way", "oh by the way", "here's the deal",
                "i was like", "he was like", "she was like", "they were like",
                "and i was like", "and then like", "you know like", "like basically",
                "basically like", "well basically", "so basically", "so anyway",
                "but anyway", "anyway so", "so yeah", "but yeah", "and yeah",
                "yeah so", "yeah and", "yeah but", "i dunno", "i don't know",
                "who knows", "eh whatever", "i guess so", "if you say so",
                "if you want", "if you like", "as you wish", "as you please",
                "or whatever", "and whatnot", "and stuff", "and things",
                "type thing", "type of", "sorta like", "kinda like",
                "no worries", "no problem", "no prob", "no probs", "nae bother",
                "fair enough", "fair play", "you get me", "you feel me",
                "feel me", "ya dig", "got it right", "right mate",
                "you see", "d'you see", "you understand", "nah mean",
                // Short phrases
                "i want to", "i wanna", "i need to", "allow me to", "help me to",
                "help me", "i'm trying to", "i'm gonna", "i'm going to",
                "i am going to", "i wish to", "i intend to", "i plan to",
                "can i", "may i", "might i", "shall i", "should i",
                "can you", "could you", "would you", "will you", "would you mind",
                "do you mind", "if you could", "if you would", "if you don't mind",
                "if possible", "if you can", "i think", "i believe", "i feel like",
                "in my opinion", "as it were", "if you will", "so to speak",
                "more or less", "pretty much", "i guess", "i suppose", "i reckon",
                "right then", "now then", "okay so", "ok so", "right so",
                "well then", "and then", "after that", "following that",
                "let's see", "let's go", "here we go", "here goes",
                "to start", "to begin", "to begin with", "for starters",
                "first of all", "moving on", "um like", "uh like", "so like",
                "and like", "but like", "it's like",
                // Single/short words
                "um", "umm", "ummm", "uh", "uhh", "uhhh", "er", "err", "errr",
                "ah", "ahh", "ahhh", "eh", "ehh", "hm", "hmm", "hmmm",
                "mhm", "mm", "mmm", "erm", "ur", "like", "you know", "y'know",
                "ya know", "basically", "actually", "literally", "kind of", "kinda",
                "sort of", "sorta", "honestly", "frankly", "really", "truly",
                "essentially", "fundamentally", "obviously", "clearly", "apparently",
                "presumably", "supposedly", "technically", "virtually", "practically",
                "just", "simply", "maybe", "perhaps", "probably", "possibly",
                "definitely", "certainly", "surely", "right", "please", "thanks",
                "thank you", "cheers", "ta", "kindly", "so", "well", "okay", "ok", "k",
                "okey dokey", "okie dokie", "alright", "all right", "aight", "a'ight",
                "now", "anyway", "anyways", "anyhow", "anywho", "next", "first",
                "firstly", "then", "alrighty", "righty", "righty-ho", "righto",
                "thinking", "correction", "rather", "sorry", "oops", "my bad",
                "wrong", "whoops", "yeah", "yep", "yup", "ya", "yah", "uh huh",
                "uh-huh", "mm-hmm", "mmhmm", "cool", "great", "awesome", "perfect",
                "wonderful", "fantastic", "excellent", "good", "nice", "sweet",
                "brilliant", "lovely", "cheers mate", "thanks mate", "ta mate",
                "much obliged", "period", "full stop", "done", "end", "over",
                "roger", "understood", "affirmative", "sure", "absolutely",
                "hey", "hi", "hello", "hiya", "howdy", "yo", "sup", "what's up",
                "greetings", "hey there", "hi there", "hello there", "dear",
                "buddy", "pal", "friend", "mate", "dude", "bro", "man", "fam",
                "folks", "y'all", "you guys", "listen", "look", "see", "fyi",
                "btw", "incidentally", "innit", "ain't it", "isn't it",
                "comprende", "capisce", "get it", "dig", "reckon", "methinks",
                "fixin to", "fixing to", "about to", "boutta", "finna", "gonna",
                "gotta", "wanna", "hafta", "oughta", "shoulda", "coulda", "woulda",
                "mighta", "musta", "or something", "et cetera", "etc",
                "uh oh", "oh", "ohh", "ooh", "aah", "whoa", "wow", "gee", "gosh",
                "golly", "jeez", "geez", "crikey", "blimey", "goodness", "oh my",
                "omg", "heavens", "lord", "lordy", "huh", "what", "pardon",
                "whatever", "whatevs", "whatev", "meh", "idk", "ima", "imma", "lemme"
            ];
            
            let cleaned = text.toLowerCase().trim();
            
            // Remove fillers (longest first, with word boundaries)
            fillers.forEach(filler => {
                const escaped = filler.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b${escaped}\\b`, 'gi');
                cleaned = cleaned.replace(regex, ' ');
            });
            
            // Clean up multiple spaces
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            
            // Remove leading/trailing articles
            cleaned = cleaned.replace(/^(the|a|an|this|that|my|your|our|their)\s+/i, '');
            cleaned = cleaned.replace(/\s+(the|a|an)$/i, '');
            
            console.log('Voice cleaned:', text, '‚Üí', cleaned);
            return cleaned;
        }
        
        // Command aliases for flexibility
        const VOICE_ALIASES = {
            'add': 'insert', 'put in': 'insert', 'include': 'insert',
            'provision': 'clause', 'section': 'clause',
            'correspondence': 'letter', 'mail': 'letter',
            'memorandum': 'memo', 'internal memo': 'memo',
            'clauses': 'library', 'saved clauses': 'library',
            'create': 'generate', 'new document': 'generate', 'templates': 'generate',
            'sign': 'signature', 'my name': 'signature',
            'today': 'date', 'current date': 'date', 'todays date': 'date',
            'sincerely': 'closing', 'regards': 'closing'
        };

        function applyAliases(cmd) {
            let result = cmd;
            for (const [alias, canonical] of Object.entries(VOICE_ALIASES)) {
                if (result.includes(alias)) {
                    result = result.replace(alias, canonical);
                }
            }
            return result;
        }

        // Process voice commands
        function processVoiceCommand(rawCommand) {
            let command = cleanVoiceInput(rawCommand);
            command = applyAliases(command);
            console.log('Voice command:', rawCommand, '‚Üí', command);

            // Help command
            if (command === 'help' || command === 'commands' || command === 'what can i say') {
                showVoiceHelp();
                return;
            }
            
            // Letter commands
            if (command.includes('letter to') || command.includes('begin a letter') || command.includes('start a letter')) {
                const clientMatch = command.match(/letter to (.+)/);
                const clientName = clientMatch ? clientMatch[1] : null;
                createLetterFromVoice(clientName);
                return;
            }
            
            // Memo commands
            if (command.includes('memo to') || command.includes('start a memo') || command.includes('begin a memo')) {
                const recipientMatch = command.match(/memo to (.+)/);
                const recipient = recipientMatch ? recipientMatch[1] : null;
                createMemoFromVoice(recipient);
                return;
            }
            
            // Clause insertion with placement options
            if (command.includes('insert') && (command.includes('clause') || command.includes('at cursor') || command.includes('at end') || command.includes('at beginning'))) {
                let placement = 'cursor'; // default
                if (command.includes('at end') || command.includes('at the end')) placement = 'end';
                if (command.includes('at beginning') || command.includes('at the beginning') || command.includes('at start')) placement = 'start';
                
                const clauseMatch = command.match(/insert (.+?)(?:\s+at\s+(?:cursor|end|beginning|start|the))?$/);
                let clauseName = clauseMatch ? clauseMatch[1] : null;
                // Clean up clause name
                if (clauseName) {
                    clauseName = clauseName.replace(/\s*(clause|at cursor|at end|at beginning|at start|at the)$/gi, '').trim();
                }
                insertClauseFromVoice(clauseName, placement);
                return;
            }
            
            // Simple insert without "clause" keyword
            if (command.startsWith('insert ')) {
                const clauseName = command.replace('insert ', '').trim();
                insertClauseFromVoice(clauseName, 'cursor');
                return;
            }
            
            // Numbering commands
            if (command.includes('numbering') || command.includes('number style') || command.includes('outline')) {
                // Apply specific scheme
                if (command.includes('legal outline') || command.includes('legal numbering')) {
                    applyNumberingFromVoice('legal-outline');
                    return;
                }
                if (command.includes('contract') || command.includes('contract style')) {
                    applyNumberingFromVoice('contract-sections');
                    return;
                }
                if (command.includes('pleading') || command.includes('pleading style')) {
                    applyNumberingFromVoice('pleading-format');
                    return;
                }
                if (command.includes('heading') || command.includes('heading style')) {
                    applyNumberingFromVoice('heading-style');
                    return;
                }
                
                // Swap/change numbering
                if (command.includes('swap') || command.includes('change') || command.includes('switch')) {
                    showVoiceAction('Say a style: "legal outline", "contract", "pleading", or "heading"');
                    return;
                }
                
                // Go to numbering panel
                switchPanel('numbering');
                showVoiceAction('‚úÖ Opened Numbering panel');
                return;
            }
            
            // Quick actions
            if (command.includes('add closing') || command.includes('closing phrase')) {
                insertClosingFromVoice();
                return;
            }
            
            if (command.includes('add signature') || command.includes('signature block')) {
                insertSignatureFromVoice();
                return;
            }
            
            if (command.includes('today') || command.includes('date')) {
                insertDateFromVoice();
                return;
            }
            
            // Navigation
            if (command.includes('go to library') || command.includes('open library')) {
                switchPanel('library');
                showVoiceAction('‚úÖ Switched to Library');
                return;
            }
            
            if (command.includes('go to generate') || command.includes('open generate')) {
                switchPanel('generate');
                showVoiceAction('‚úÖ Switched to Generate');
                return;
            }
            
            if (command.includes('go to numbering') || command.includes('open numbering')) {
                switchPanel('numbering');
                showVoiceAction('‚úÖ Switched to Numbering');
                return;
            }
            
            if (command.includes('close') || command.includes('cancel') || command.includes('stop')) {
                closeVoiceControl();
                return;
            }
            
            // Unknown command
            showVoiceAction('Try: "insert [clause] at cursor", "legal outline", or "letter to [client]"', true);
        }
        
        async function createLetterFromVoice(clientName) {
            showVoiceAction('‚úÖ Creating letter' + (clientName ? ' for ' + clientName : ''));
            
            // Switch to generate panel and show letter form
            switchPanel('generate');
            showTemplate('letter');
            
            // If client name provided, try to fill it
            if (clientName) {
                setTimeout(() => {
                    const recipientField = document.getElementById('letter-recipient');
                    if (recipientField) {
                        recipientField.value = clientName;
                    }
                }, 100);
            }
        }
        
        async function createMemoFromVoice(recipient) {
            showVoiceAction('‚úÖ Creating memo' + (recipient ? ' to ' + recipient : ''));
            
            switchPanel('generate');
            showTemplate('memo');
            
            if (recipient) {
                setTimeout(() => {
                    const toField = document.getElementById('memo-to');
                    if (toField) {
                        toField.value = recipient;
                    }
                }, 100);
            }
        }
        
        async function insertClauseFromVoice(clauseName, placement = 'cursor') {
            if (!clauseName) {
                showVoiceAction('Please specify a clause name', true);
                return;
            }
            
            // Fuzzy search favorites
            const matches = favoriteClausesCache.filter(c => 
                c.title.toLowerCase().includes(clauseName) ||
                clauseName.includes(c.title.toLowerCase())
            );
            
            if (matches.length === 0) {
                showVoiceAction('No matching clause found in favorites', true);
                return;
            }
            
            const clause = matches[0];
            
            try {
                await Word.run(async (context) => {
                    let target;
                    let location;
                    
                    if (placement === 'end') {
                        target = context.document.body;
                        location = Word.InsertLocation.end;
                    } else if (placement === 'start') {
                        target = context.document.body;
                        location = Word.InsertLocation.start;
                    } else {
                        // At cursor (default)
                        target = context.document.getSelection();
                        location = Word.InsertLocation.replace;
                    }
                    
                    target.insertText(clause.content, location);
                    await context.sync();
                });
                
                const placementText = placement === 'cursor' ? 'at cursor' : `at ${placement}`;
                showVoiceAction(`‚úÖ Inserted "${clause.title}" ${placementText}`);
            } catch (err) {
                showVoiceAction('Failed to insert clause', true);
            }
        }
        
        // Apply numbering scheme from voice
        async function applyNumberingFromVoice(schemeId) {
            const schemeNames = {
                'legal-outline': 'Legal Outline',
                'contract-sections': 'Contract Sections',
                'pleading-format': 'Pleading Format',
                'heading-style': 'Heading Style'
            };
            
            const schemeName = schemeNames[schemeId] || schemeId;
            
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    const paragraphs = selection.paragraphs;
                    paragraphs.load('items');
                    await context.sync();
                    
                    // Apply list formatting based on scheme
                    // Note: Full implementation would use Word's listItem API
                    // This is a simplified version that shows the concept
                    
                    if (paragraphs.items.length > 0) {
                        // For now, we'll switch to the numbering panel and select the scheme
                        // Full implementation would apply the actual Word list template
                    }
                    
                    await context.sync();
                });
                
                // Switch to numbering panel and select the scheme
                switchPanel('numbering');
                
                // Select the scheme card
                setTimeout(() => {
                    const card = document.querySelector(`[onclick*="${schemeId}"]`);
                    if (card) {
                        card.click();
                    }
                }, 100);
                
                showVoiceAction(`‚úÖ Applied: ${schemeName}`);
            } catch (err) {
                console.error('Numbering error:', err);
                showVoiceAction('Failed to apply numbering', true);
            }
        }
        
        async function insertClosingFromVoice() {
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.insertText('\n\nSincerely,\n\n', Word.InsertLocation.end);
                    await context.sync();
                });
                showVoiceAction('‚úÖ Closing phrase added');
            } catch (err) {
                showVoiceAction('Failed to insert closing', true);
            }
        }
        
        async function insertSignatureFromVoice() {
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.insertText('\n\n/s/ [Name]\n[Name]\n[Title]', Word.InsertLocation.end);
                    await context.sync();
                });
                showVoiceAction('‚úÖ Signature block added');
            } catch (err) {
                showVoiceAction('Failed to insert signature', true);
            }
        }
        
        async function insertDateFromVoice() {
            const today = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.insertText(today, Word.InsertLocation.replace);
                    await context.sync();
                });
                showVoiceAction('‚úÖ Date inserted: ' + today);
            } catch (err) {
                showVoiceAction('Failed to insert date', true);
            }
        }
        
        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initVoiceControl);
        } else {
            initVoiceControl();
        }
    </script>
</body>
</html>
