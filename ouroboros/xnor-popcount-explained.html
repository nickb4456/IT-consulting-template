<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XNOR + POPCOUNT Explained</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #1a202c;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            font-size: 1.2rem;
            color: #718096;
            margin-bottom: 32px;
        }
        h2 {
            font-size: 1.5rem;
            color: #2d3748;
            margin: 32px 0 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        h3 {
            font-size: 1.2rem;
            color: #4a5568;
            margin: 24px 0 12px;
        }
        p { margin-bottom: 16px; color: #4a5568; }
        
        .bit-display {
            font-family: 'SF Mono', 'Fira Code', monospace;
            background: #1a202c;
            color: #68d391;
            padding: 20px 24px;
            border-radius: 12px;
            margin: 16px 0;
            overflow-x: auto;
        }
        .bit-display .label {
            color: #a0aec0;
            display: inline-block;
            width: 100px;
        }
        .bit-display .bits {
            color: #68d391;
            letter-spacing: 2px;
        }
        .bit-display .highlight {
            color: #f6e05e;
            font-weight: bold;
        }
        .bit-display .result {
            color: #63b3ed;
        }
        
        .step-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        .step-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 24px;
            border-left: 4px solid #667eea;
        }
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .step-card h4 {
            color: #2d3748;
            margin-bottom: 8px;
        }
        .step-card p {
            font-size: 0.9rem;
            margin: 0;
        }
        
        code {
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.9em;
            color: #6b46c1;
        }
        
        pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 24px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 16px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        .keyword { color: #f687b3; }
        .function { color: #68d391; }
        .number { color: #f6ad55; }
        .string { color: #68d391; }
        .comment { color: #718096; }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .comparison-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        .comparison-table tr:hover {
            background: #f7fafc;
        }
        .fast { color: #38a169; font-weight: 600; }
        .slow { color: #e53e3e; }
        
        .truth-table {
            display: inline-block;
            margin: 16px 0;
        }
        .truth-table td, .truth-table th {
            padding: 8px 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .truth-table th {
            background: #667eea;
            color: white;
        }
        .truth-table .match {
            background: #c6f6d5;
            color: #22543d;
            font-weight: bold;
        }
        
        .formula-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 12px;
            text-align: center;
            margin: 24px 0;
        }
        .formula-box .formula {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 1.3rem;
            margin: 8px 0;
        }
        
        .speed-bar {
            height: 24px;
            border-radius: 12px;
            margin: 8px 0;
            position: relative;
        }
        .speed-bar .fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding-left: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .speed-bar.fast .fill {
            background: linear-gradient(90deg, #38a169, #68d391);
            width: 100%;
        }
        .speed-bar.slow .fill {
            background: linear-gradient(90deg, #e53e3e, #fc8181);
            width: 10%;
        }
        
        .emoji-large {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        
        footer {
            text-align: center;
            color: rgba(255,255,255,0.7);
            margin-top: 40px;
            font-size: 0.9rem;
        }
        footer a { color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>‚ö° XNOR + POPCOUNT</h1>
            <p class="subtitle">Ultra-fast binary similarity at CPU speed</p>
            
            <h2>The Problem We're Solving</h2>
            <p>We have <strong>binary embeddings</strong> ‚Äî 128-bit vectors that encode semantic meaning. We need to compare millions of them quickly to find similar items (pheromones, memories, documents).</p>
            
            <div class="step-grid">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h4>Traditional Way</h4>
                    <p>Load all embeddings into JavaScript, loop through each one, compute similarity. Slow at scale.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <h4>XNOR + POPCOUNT Way</h4>
                    <p>Let SQLite compute similarity inline using CPU bit operations. 100x faster!</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>How It Works</h2>
            
            <h3>Step 1: Binary Embeddings</h3>
            <p>Our embeddings are 128 bits (16 bytes). Each bit represents a semantic feature:</p>
            
            <div class="bit-display">
                <div><span class="label">Text:</span> "Transformer attention mechanism"</div>
                <div><span class="label">Embedding:</span> <span class="bits">11010010 00110101 11001010 ...</span> (128 bits)</div>
            </div>
            
            <h3>Step 2: XNOR Operation</h3>
            <p><strong>XNOR</strong> (Exclusive NOR) tells us which bits <em>match</em> between two embeddings:</p>
            
            <div class="bit-display">
                <div><span class="label">A:</span> <span class="bits">1 0 1 1 0 0 1 0</span></div>
                <div><span class="label">B:</span> <span class="bits">1 0 1 0 0 0 1 1</span></div>
                <div style="border-top: 1px solid #4a5568; margin: 8px 0; padding-top: 8px;">
                    <span class="label">A XNOR B:</span> <span class="bits highlight">1 1 1 0 1 1 1 0</span>
                    <span class="result"> ‚Üê 1 where bits match!</span>
                </div>
            </div>
            
            <table class="truth-table">
                <tr><th>A</th><th>B</th><th>A XNOR B</th></tr>
                <tr><td>0</td><td>0</td><td class="match">1 ‚úì</td></tr>
                <tr><td>0</td><td>1</td><td>0</td></tr>
                <tr><td>1</td><td>0</td><td>0</td></tr>
                <tr><td>1</td><td>1</td><td class="match">1 ‚úì</td></tr>
            </table>
            
            <h3>Step 3: POPCOUNT</h3>
            <p><strong>POPCOUNT</strong> (Population Count) counts how many 1-bits are in a value:</p>
            
            <div class="bit-display">
                <div><span class="label">XNOR result:</span> <span class="bits highlight">1 1 1 0 1 1 1 0</span></div>
                <div><span class="label">POPCOUNT:</span> <span class="result">6</span> (six 1-bits = six matching bits)</div>
            </div>
            
            <p>This is a <strong>single CPU instruction</strong> on modern processors! (<code>POPCNT</code> on x86)</p>
            
            <h3>Step 4: Similarity Score</h3>
            
            <div class="formula-box">
                <div>The Formula:</div>
                <div class="formula">Similarity = POPCOUNT(A XNOR B) / total_bits</div>
                <div style="margin-top: 12px; font-size: 0.9rem;">6 matching bits √∑ 8 total bits = <strong>0.75 (75% similar)</strong></div>
            </div>
        </div>
        
        <div class="card">
            <h2>Why It's So Fast</h2>
            
            <h3>1. Lookup Table for POPCOUNT</h3>
            <p>Instead of counting bits in a loop, we pre-compute all 256 possible byte values:</p>
            
            <pre><code><span class="keyword">const</span> POPCOUNT_TABLE = <span class="keyword">new</span> <span class="function">Uint8Array</span>(<span class="number">256</span>);
<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i < <span class="number">256</span>; i++) {
  <span class="keyword">let</span> count = <span class="number">0</span>, n = i;
  <span class="keyword">while</span> (n) { count++; n &= n - <span class="number">1</span>; }
  POPCOUNT_TABLE[i] = count;
}

<span class="comment">// Now popcount is just a table lookup!</span>
<span class="keyword">const</span> bits = POPCOUNT_TABLE[<span class="number">0b11101110</span>]; <span class="comment">// ‚Üí 6</span></code></pre>
            
            <h3>2. No Memory Allocation</h3>
            <p>Everything operates on existing buffers. No new objects created, no garbage collection.</p>
            
            <h3>3. SQLite Integration</h3>
            <p>By embedding this in SQLite as a custom function, comparisons happen <em>during</em> query execution:</p>
            
            <pre><code><span class="comment">-- SQLite does the comparison, only returns matches</span>
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pheromones
<span class="keyword">WHERE</span> <span class="function">hamming_similarity</span>(embedding, ?) > <span class="number">0.7</span>
<span class="keyword">ORDER BY</span> <span class="function">hamming_similarity</span>(embedding, ?) <span class="keyword">DESC</span></code></pre>
        </div>
        
        <div class="card">
            <h2>Performance Comparison</h2>
            
            <table class="comparison-table">
                <tr>
                    <th>Method</th>
                    <th>Speed</th>
                    <th>Memory</th>
                    <th>At 1M items</th>
                </tr>
                <tr>
                    <td>JavaScript loop</td>
                    <td class="slow">~100K/sec</td>
                    <td>High (load all)</td>
                    <td class="slow">~10 seconds</td>
                </tr>
                <tr>
                    <td>SQLite without XNOR</td>
                    <td>~500K/sec</td>
                    <td>Medium</td>
                    <td>~2 seconds</td>
                </tr>
                <tr>
                    <td>SQLite + XNOR+POPCOUNT</td>
                    <td class="fast">~10M/sec</td>
                    <td>Low</td>
                    <td class="fast">~100ms</td>
                </tr>
            </table>
            
            <h3>Visual Speed Comparison</h3>
            
            <p><strong>SQLite + XNOR+POPCOUNT</strong></p>
            <div class="speed-bar fast">
                <div class="fill">10,000,000 comparisons/sec ‚ö°</div>
            </div>
            
            <p><strong>JavaScript Loop</strong></p>
            <div class="speed-bar slow">
                <div class="fill">100K/sec</div>
            </div>
        </div>
        
        <div class="card">
            <h2>The Code</h2>
            
            <h3>Registering the Function in SQLite</h3>
            <pre><code><span class="comment">// Popcount lookup table</span>
<span class="keyword">const</span> POPCOUNT_TABLE = <span class="keyword">new</span> <span class="function">Uint8Array</span>(<span class="number">256</span>);
<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i < <span class="number">256</span>; i++) {
  <span class="keyword">let</span> count = <span class="number">0</span>, n = i;
  <span class="keyword">while</span> (n) { count++; n &= n - <span class="number">1</span>; }
  POPCOUNT_TABLE[i] = count;
}

<span class="comment">// Register with better-sqlite3</span>
db.<span class="function">function</span>(<span class="string">'hamming_similarity'</span>, { deterministic: <span class="keyword">true</span> }, (a, b) => {
  <span class="keyword">if</span> (!Buffer.<span class="function">isBuffer</span>(a) || !Buffer.<span class="function">isBuffer</span>(b)) <span class="keyword">return</span> <span class="number">0</span>;
  <span class="keyword">if</span> (a.length !== b.length) <span class="keyword">return</span> <span class="number">0</span>;
  
  <span class="keyword">let</span> matching = <span class="number">0</span>;
  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i < a.length; i++) {
    <span class="comment">// XNOR: ~(a XOR b) gives bits that match</span>
    <span class="keyword">const</span> xnor = ~(a[i] ^ b[i]) & <span class="number">0xFF</span>;
    <span class="comment">// POPCOUNT via lookup table</span>
    matching += POPCOUNT_TABLE[xnor];
  }
  
  <span class="keyword">return</span> matching / (a.length * <span class="number">8</span>);
});</code></pre>
            
            <h3>Using in Queries</h3>
            <pre><code><span class="comment">// Find similar pheromones</span>
<span class="keyword">const</span> results = db.<span class="function">prepare</span>(<span class="string">`
  SELECT *, hamming_similarity(embedding, ?) as sim
  FROM pheromones
  WHERE hamming_similarity(embedding, ?) > 0.65
  ORDER BY sim DESC
  LIMIT 20
`</span>).<span class="function">all</span>(queryEmbedding, queryEmbedding);</code></pre>
        </div>
        
        <div class="card">
            <div class="emoji-large">üêú‚ö°</div>
            <h2>Where We Use It</h2>
            
            <div class="step-grid">
                <div class="step-card">
                    <h4>Ouroboros Colonies</h4>
                    <p>Alpha, Beta, Gamma colonies use it to find similar pheromones for stigmergic coordination.</p>
                </div>
                <div class="step-card">
                    <h4>Nova's Memory</h4>
                    <p>Searching through memory files and daily logs to find relevant context.</p>
                </div>
                <div class="step-card">
                    <h4>Nick's Prompts</h4>
                    <p>Checking if a question was asked before to avoid repetition.</p>
                </div>
                <div class="step-card">
                    <h4>Ring PDF Reader</h4>
                    <p>Finding connections between document chunks for the ant colony intelligence.</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Key Takeaways</h2>
            <ol style="padding-left: 24px;">
                <li style="margin-bottom: 12px;"><strong>Binary embeddings enable bitwise operations</strong> ‚Äî 16 bytes can encode rich semantics</li>
                <li style="margin-bottom: 12px;"><strong>XNOR finds matching bits</strong> ‚Äî A single CPU instruction</li>
                <li style="margin-bottom: 12px;"><strong>POPCOUNT counts them</strong> ‚Äî Another single instruction (or lookup table)</li>
                <li style="margin-bottom: 12px;"><strong>SQLite integration keeps data local</strong> ‚Äî No JavaScript round-trips</li>
                <li style="margin-bottom: 12px;"><strong>100x speedup</strong> ‚Äî From ~100K to ~10M comparisons per second</li>
            </ol>
        </div>
    </div>
    
    <footer>
        <p>Created by Nova ‚ú® | February 11, 2026</p>
        <p><a href="colony-code-explained.html">View Code Documentation ‚Üí</a></p>
    </footer>
<script src="nav.js"></script>
</body>
</html>
