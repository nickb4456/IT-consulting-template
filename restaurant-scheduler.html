<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StaffSync - Restaurant Staff Scheduler</title>
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent: #0051E6;
            --accent-hover: #1d4ed8;
            --accent-light: #dbeafe;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
            
            /* Professional muted role colors - using subtle indicators */
            --role-server: #0051E6;
            --role-cook: #0051E6;
            --role-host: #06b6d4;
            --role-bartender: #f59e0b;
            --role-busser: #10b981;
            --role-manager: #1f2937;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.08);
            --radius: 6px;
            --radius-lg: 8px;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --accent-light: #1e3a5a;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
            --info-light: #0c4a6e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Lato', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 16px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 24px 32px;
            min-height: 100vh;
            max-width: 1400px;
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .logo-text {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.3px;
        }

        .logo-sub {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Navigation */
        .nav-section {
            margin-bottom: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
            padding-left: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .nav-item .icon {
            font-size: 15px;
            width: 20px;
            text-align: center;
            opacity: 0.8;
        }

        /* Theme Toggle */
        .theme-toggle {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .toggle-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        /* Nav Badge */
        .nav-badge {
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* Command Bar - NLP Input */
        .command-bar {
            margin-bottom: 24px;
            position: relative;
        }

        .command-input-wrapper {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 4px 12px;
            transition: all 0.2s ease;
        }

        .command-input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .command-icon {
            color: var(--text-muted);
            font-size: 16px;
            margin-right: 10px;
        }

        .command-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-primary);
            padding: 10px 0;
            outline: none;
        }

        .command-input::placeholder {
            color: var(--text-muted);
        }

        .command-help-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-muted);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .command-help-btn:hover {
            background: var(--accent);
            color: white;
        }

        .command-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .command-suggestions.active {
            display: block;
        }

        .command-suggestion {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.1s ease;
        }

        .command-suggestion:last-child {
            border-bottom: none;
        }

        .command-suggestion:hover {
            background: var(--bg-tertiary);
        }

        .command-suggestion-text {
            font-size: 13px;
            color: var(--text-primary);
        }

        .command-suggestion-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .command-preview {
            background: var(--accent-light);
            padding: 12px;
            border-radius: var(--radius);
            margin-top: 8px;
            font-size: 13px;
        }

        .command-preview-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--accent);
        }

        /* Swap Request Cards */
        .swap-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }

        .swap-details {
            flex: 1;
        }

        .swap-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .swap-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .swap-arrow {
            font-size: 20px;
            color: var(--text-muted);
            margin: 0 16px;
        }

        .swap-actions {
            display: flex;
            gap: 8px;
        }

        .swap-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .swap-status.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        .swap-status.approved {
            background: var(--success-light);
            color: var(--success);
        }

        .swap-status.rejected {
            background: var(--danger-light);
            color: var(--danger);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Analytics Charts */
        .chart-container {
            padding: 16px;
            min-height: 200px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 180px;
            padding-top: 20px;
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            background: linear-gradient(to top, var(--accent), var(--accent-hover));
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-label {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
        }

        .bar-value {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .donut-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }

        .donut {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            position: relative;
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .utilization-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .utilization-item:last-child {
            border-bottom: none;
        }

        .utilization-name {
            flex: 1;
            font-weight: 500;
            font-size: 13px;
        }

        .utilization-bar-wrapper {
            width: 120px;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-right: 12px;
            overflow: hidden;
        }

        .utilization-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .utilization-percent {
            font-size: 12px;
            font-weight: 600;
            width: 45px;
            text-align: right;
        }

        .efficiency-display {
            text-align: center;
            padding: 24px;
        }

        .efficiency-score-big {
            font-size: 64px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .efficiency-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .efficiency-breakdown {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .efficiency-metric {
            text-align: center;
        }

        .efficiency-metric-value {
            font-size: 20px;
            font-weight: 700;
        }

        .efficiency-metric-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Marketplace Tabs */
        .marketplace-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Marketplace Listing */
        .market-listing {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 12px;
            gap: 16px;
        }

        .listing-type {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .listing-type.sell {
            background: var(--success-light);
            color: var(--success);
        }

        .listing-type.buy {
            background: var(--info-light);
            color: var(--info);
        }

        .listing-details {
            flex: 1;
        }

        .listing-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .listing-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .listing-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
        }

        .listing-price.free {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Clickable Alerts */
        .alert-item {
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .alert-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .alert-item::after {
            content: 'â†’ Click to fill';
            font-size: 11px;
            color: var(--accent);
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .alert-item:hover::after {
            opacity: 1;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.4px;
            color: var(--text-primary);
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: 1px solid transparent;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 6px;
            min-width: 32px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Forms */
        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        /* Role Badges - Professional subtle style */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .role-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .role-badge.server::before { background: var(--role-server); }
        .role-badge.cook::before { background: var(--role-cook); }
        .role-badge.host::before { background: var(--role-host); }
        .role-badge.bartender::before { background: var(--role-bartender); }
        .role-badge.busser::before { background: var(--role-busser); }
        .role-badge.manager::before { background: var(--role-manager); }

        /* Certification Badges */
        .cert-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .cert-badge.active {
            background: var(--success-light);
            color: var(--success);
        }

        /* Schedule Grid */
        .schedule-container {
            overflow-x: auto;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-width: 800px;
        }

        .schedule-cell {
            background: var(--bg-secondary);
            padding: 10px;
            min-height: 90px;
            position: relative;
        }

        .schedule-header {
            background: var(--bg-tertiary);
            font-weight: 500;
            font-size: 12px;
            text-align: center;
            min-height: auto;
            padding: 12px 10px;
            color: var(--text-secondary);
        }

        .schedule-header.today {
            background: var(--accent);
            color: white;
        }

        .schedule-shift-label {
            font-weight: 500;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-secondary);
        }

        .schedule-shift-label .time {
            font-size: 10px;
            font-weight: 400;
            color: var(--text-muted);
            display: block;
        }

        .shift-chip {
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-left: 3px solid var(--text-muted);
        }

        .shift-chip:hover {
            background: var(--border-color);
        }

        .shift-chip.server { border-left-color: var(--role-server); }
        .shift-chip.cook { border-left-color: var(--role-cook); }
        .shift-chip.host { border-left-color: var(--role-host); }
        .shift-chip.bartender { border-left-color: var(--role-bartender); }
        .shift-chip.busser { border-left-color: var(--role-busser); }
        .shift-chip.manager { border-left-color: var(--role-manager); }

        .shift-chip .remove-shift {
            opacity: 0;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
            color: var(--text-muted);
        }

        .shift-chip:hover .remove-shift {
            opacity: 1;
        }

        .add-shift-btn {
            width: 100%;
            padding: 6px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-top: 4px;
        }

        .add-shift-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }

        /* Conflict Indicators */
        .conflict-indicator {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: help;
            font-weight: 600;
        }

        .conflict-indicator.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .conflict-indicator.danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Week Navigation */
        .week-nav {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .week-nav-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .week-nav-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .week-display {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            width: fit-content;
        }

        .view-tab {
            padding: 6px 14px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.15s ease;
        }

        .view-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .view-tab:hover:not(.active) {
            color: var(--text-secondary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 20px;
            max-width: 560px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(10px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* Availability Grid */
        .availability-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 3px;
            margin-top: 10px;
        }

        .avail-header {
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            padding: 6px 3px;
            color: var(--text-muted);
        }

        .avail-label {
            font-size: 11px;
            padding: 6px;
            display: flex;
            align-items: center;
            color: var(--text-secondary);
        }

        .avail-cell {
            width: 100%;
            height: 30px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .avail-cell.available {
            background: var(--success);
            border-color: var(--success);
        }

        .avail-cell:hover {
            border-color: var(--accent);
        }

        /* Employee View */
        .employee-schedule {
            display: grid;
            gap: 12px;
        }

        .employee-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 14px;
        }

        .employee-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .employee-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .employee-shifts {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .employee-shift-chip {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .employee-shift-chip .day {
            font-weight: 600;
            color: var(--text-primary);
        }

        .employee-hours {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        .hours-warning {
            color: var(--warning);
        }

        .hours-danger {
            color: var(--danger);
        }

        /* Day View */
        .day-view-container {
            display: grid;
            gap: 16px;
        }

        .shift-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .shift-section-header {
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-section-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .shift-section-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .shift-staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            padding: 14px;
        }

        .staff-slot {
            padding: 10px;
            border-radius: var(--radius);
            text-align: center;
        }

        .staff-slot.filled {
            background: var(--bg-tertiary);
        }

        .staff-slot.empty {
            border: 1px dashed var(--border-color);
            color: var(--text-muted);
        }

        .staff-slot.warning {
            border: 1px dashed var(--warning);
            background: var(--warning-light);
            color: var(--warning);
        }

        .staff-slot-name {
            font-weight: 500;
            margin-bottom: 2px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .staff-slot-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Alerts Panel */
        .alerts-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 6px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-item.warning {
            background: var(--warning-light);
        }

        .alert-item.danger {
            background: var(--danger-light);
        }

        .alert-item.info {
            background: var(--info-light);
        }

        .alert-icon {
            font-size: 14px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
        }

        .alert-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .alert-action {
            font-size: 12px;
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        /* Labor Cost Display */
        .labor-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-top: 14px;
        }

        .labor-item {
            text-align: center;
        }

        .labor-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
        }

        .labor-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Print Styles */
        .print-container {
            display: none;
        }

        @media print {
            .sidebar, .header-actions, .week-nav-btn, .add-shift-btn, .remove-shift {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .schedule-grid {
                font-size: 10px;
            }

            .shift-chip {
                padding: 2px 4px;
                font-size: 9px;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -240px;
                z-index: 100;
                transition: left 0.2s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: flex !important;
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            z-index: 99;
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
        }

        /* Hidden sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Shift Templates Section */
        .shift-templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
        }

        .template-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }

        .template-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .template-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .template-requirements {
            display: grid;
            gap: 6px;
        }

        .req-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .req-count {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Holiday management */
        .holiday-list {
            display: grid;
            gap: 6px;
        }

        .holiday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
        }

        .holiday-date {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
        }

        .holiday-name {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .toast {
            padding: 12px 16px;
            border-radius: var(--radius);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.2s ease;
            font-size: 13px;
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        .toast.warning {
            border-left: 3px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
            cursor: grabbing !important;
        }

        .shift-chip[draggable="true"] {
            cursor: grab;
        }

        .shift-chip[draggable="true"]:active {
            cursor: grabbing;
        }

        .drag-over {
            background: var(--accent-light) !important;
            border: 2px dashed var(--accent) !important;
            transform: scale(1.02);
            transition: all 0.15s ease;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo .icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #0051E6, #1d4ed8);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: white;
            margin: 0 auto 16px;
        }

        .login-logo h1 {
            font-size: 24px;
            color: #1f2937;
            margin: 0;
        }

        .login-logo p {
            color: #6b7280;
            font-size: 14px;
            margin-top: 4px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .login-form input {
            padding: 14px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .login-form input:focus {
            outline: none;
            border-color: #0051E6;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .login-form .btn-login {
            padding: 14px;
            background: linear-gradient(135deg, #0051E6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-form .btn-login:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .login-form .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-divider {
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
            margin: 8px 0;
        }

        .login-toggle {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
        }

        .login-toggle a {
            color: #0051E6;
            cursor: pointer;
            text-decoration: none;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .role-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 8px;
        }

        .role-option {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-option:hover {
            border-color: #0051E6;
        }

        .role-option.selected {
            border-color: #0051E6;
            background: #eff6ff;
        }

        .role-option .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .role-option .title {
            font-weight: 600;
            color: #1f2937;
        }

        .role-option .desc {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .user-menu {
            position: relative;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .user-badge .avatar {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            display: none;
            z-index: 100;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .user-dropdown-item.danger {
            color: var(--danger);
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .sync-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .sync-indicator.syncing .dot {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <div class="login-logo">
                <div class="icon">S</div>
                <h1>StaffSync</h1>
                <p>Restaurant Staff Scheduling</p>
            </div>

            <div class="login-error" id="login-error"></div>

            <!-- Login Form -->
            <form class="login-form" id="login-form">
                <input type="email" id="login-email" placeholder="Email address" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn-login" id="login-btn">Sign In</button>
            </form>

            <!-- Signup Form (hidden by default) -->
            <form class="login-form" id="signup-form" style="display: none;">
                <input type="text" id="signup-name" placeholder="Full name" required>
                <input type="email" id="signup-email" placeholder="Email address" required>
                <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required minlength="6">

                <div class="login-divider">Select your role</div>

                <div class="role-selector">
                    <div class="role-option selected" data-role="manager" onclick="selectRole(this)">
                        <div class="icon">ðŸ‘”</div>
                        <div class="title">Manager</div>
                        <div class="desc">Create organization</div>
                    </div>
                    <div class="role-option" data-role="employee" onclick="selectRole(this)">
                        <div class="icon">ðŸ‘¤</div>
                        <div class="title">Employee</div>
                        <div class="desc">Join with code</div>
                    </div>
                </div>

                <!-- Organization code input for employees -->
                <div id="org-code-field" style="display: none;">
                    <input type="text" id="signup-org-code" placeholder="Organization code from your manager" style="text-transform: uppercase;">
                </div>

                <button type="submit" class="btn-login" id="signup-btn">Create Account</button>
            </form>

            <div class="login-toggle" id="login-toggle">
                Don't have an account? <a onclick="toggleAuthMode()">Sign up</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="app-container" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">S</div>
                <div>
                    <div class="logo-text">StaffSync</div>
                    <div class="logo-sub">Staff Scheduling</div>
                </div>
            </div>

            <nav>
                <div class="nav-section">
                    <div class="nav-label">Schedule</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="icon">â—‰</span>
                        Dashboard
                    </div>
                    <div class="nav-item" data-page="schedule">
                        <span class="icon">â–¦</span>
                        Week Schedule
                    </div>
                    <div class="nav-item" data-page="day-view">
                        <span class="icon">â–£</span>
                        Day View
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Management</div>
                    <div class="nav-item" data-page="staff">
                        <span class="icon">âš‡</span>
                        Staff
                    </div>
                    <div class="nav-item" data-page="shifts">
                        <span class="icon">â—·</span>
                        Shift Templates
                    </div>
                    <div class="nav-item" data-page="holidays">
                        <span class="icon">â—ˆ</span>
                        Holidays
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Reports</div>
                    <div class="nav-item" data-page="labor">
                        <span class="icon">â—</span>
                        Labor Costs
                    </div>
                    <div class="nav-item" data-page="analytics">
                        <span class="icon">ðŸ“Š</span>
                        Analytics
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Requests</div>
                    <div class="nav-item" data-page="swaps">
                        <span class="icon">â‡„</span>
                        Shift Swaps
                        <span class="nav-badge" id="swap-badge" style="display:none;">0</span>
                    </div>
                    <div class="nav-item" data-page="marketplace">
                        <span class="icon">$</span>
                        Shift Market
                        <span class="nav-badge" id="market-badge" style="display:none;">0</span>
                    </div>
                    <div class="nav-item" data-page="approvals">
                        <span class="icon">âœ“</span>
                        Approvals
                        <span class="nav-badge" id="approval-badge" style="display:none;">0</span>
                    </div>
                </div>
            </nav>

            <div class="theme-toggle">
                <button class="toggle-btn" onclick="toggleTheme()">
                    <span id="theme-icon">â—</span>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>

            <!-- User Area -->
            <div id="user-area" style="padding: 16px; border-top: 1px solid var(--border-color); margin-top: auto;"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- NLP Command Bar -->
            <div class="command-bar" id="command-bar">
                <div class="command-input-wrapper">
                    <span class="command-icon">âŒ˜</span>
                    <input type="text" 
                           id="command-input" 
                           class="command-input" 
                           placeholder="Try: 'remove jan from saturdays' or 'give mike tuesdays off' or 'add sarah to dinner shifts'..."
                           autocomplete="off">
                    <button class="command-help-btn" onclick="showCommandHelp()" title="Command Help">?</button>
                </div>
                <div class="command-suggestions" id="command-suggestions"></div>
            </div>

            <!-- Dashboard -->
            <section class="page-section active" id="page-dashboard">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Week of <span id="dashboard-week"></span></p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="autoSchedule()">
                            Auto-Schedule
                        </button>
                        <button class="btn btn-secondary" onclick="exportSchedule()">
                            Export
                        </button>
                    </div>
                </div>

                <div class="stats-row" id="dashboard-stats">
                    <!-- Stats populated by JS -->
                </div>

                <div class="alerts-panel" id="alerts-panel">
                    <div class="card-header">
                        <h3 class="card-title">Alerts & Suggestions</h3>
                    </div>
                    <div id="alerts-list">
                        <!-- Alerts populated by JS -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">This Week's Schedule</h3>
                        <button class="btn btn-sm btn-secondary" onclick="navigateTo('schedule')">View Full Schedule â†’</button>
                    </div>
                    <div class="schedule-container" id="dashboard-schedule-preview">
                        <!-- Mini schedule preview -->
                    </div>
                </div>
            </section>

            <!-- Week Schedule -->
            <section class="page-section" id="page-schedule">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Week Schedule</h1>
                        <p class="page-subtitle">Drag and drop to assign shifts</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="autoSchedule()">
                            Auto-Schedule
                        </button>
                        <button class="btn btn-secondary" onclick="clearWeekSchedule()">
                            Clear Week
                        </button>
                    </div>
                </div>

                <div class="week-nav">
                    <button class="week-nav-btn" onclick="changeWeek(-1)">â† Previous</button>
                    <span class="week-display" id="week-display"></span>
                    <button class="week-nav-btn" onclick="changeWeek(1)">Next â†’</button>
                    <button class="week-nav-btn" onclick="goToToday()">Today</button>
                </div>

                <div class="view-tabs">
                    <button class="view-tab active" data-view="grid" onclick="setScheduleView('grid')">Grid View</button>
                    <button class="view-tab" data-view="employee" onclick="setScheduleView('employee')">By Employee</button>
                </div>

                <div id="schedule-grid-view">
                    <div class="schedule-container">
                        <div class="schedule-grid" id="schedule-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div id="schedule-employee-view" style="display: none;">
                    <div class="employee-schedule" id="employee-schedule">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Day View -->
            <section class="page-section" id="page-day-view">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Day View</h1>
                        <p class="page-subtitle" id="day-view-date"></p>
                    </div>
                    <div class="header-actions">
                        <input type="date" id="day-picker" class="form-input" style="width: auto;" onchange="selectDay(this.value)">
                    </div>
                </div>

                <div class="day-view-container" id="day-view-container">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Staff Management -->
            <section class="page-section" id="page-staff">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Staff Management</h1>
                        <p class="page-subtitle">Manage employees and availability</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openStaffModal()">
                            + Add Employee
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table id="staff-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Hourly Rate</th>
                                    <th>Max Hours/Week</th>
                                    <th>Certifications</th>
                                    <th>This Week</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staff-tbody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Shift Templates -->
            <section class="page-section" id="page-shifts">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Shift Templates</h1>
                        <p class="page-subtitle">Define shift times and staffing requirements</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openShiftModal()">
                            + Add Shift Template
                        </button>
                    </div>
                </div>

                <div class="shift-templates-grid" id="shift-templates-grid">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Holidays -->
            <section class="page-section" id="page-holidays">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Holidays & Blackout Dates</h1>
                        <p class="page-subtitle">Manage special dates and closures</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openHolidayModal()">
                            + Add Holiday
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="holiday-list" id="holiday-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Labor Costs -->
            <section class="page-section" id="page-labor">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Labor Costs</h1>
                        <p class="page-subtitle">Weekly labor cost analysis</p>
                    </div>
                </div>

                <div class="stats-row" id="labor-stats">
                    <!-- Populated by JS -->
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cost Breakdown by Day</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Total Hours</th>
                                    <th>Labor Cost</th>
                                    <th>Staff Count</th>
                                </tr>
                            </thead>
                            <tbody id="labor-breakdown">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cost by Role</h3>
                    </div>
                    <div id="labor-by-role">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Analytics -->
            <section class="page-section" id="page-analytics">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Analytics</h1>
                        <p class="page-subtitle">Insights and trends for your scheduling</p>
                    </div>
                    <div class="header-actions">
                        <select class="form-input" id="analytics-period" onchange="renderAnalytics()" style="width: auto;">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                </div>

                <div class="stats-row" id="analytics-stats">
                    <!-- Populated by JS -->
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Labor Cost Trend</h3>
                        </div>
                        <div class="chart-container" id="labor-chart">
                            <!-- Chart rendered by JS -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Hours by Role</h3>
                        </div>
                        <div class="chart-container" id="role-chart">
                            <!-- Chart rendered by JS -->
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Staff Utilization</h3>
                        </div>
                        <div id="utilization-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Busiest Shifts</h3>
                        </div>
                        <div id="busy-shifts-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <h3 class="card-title">Staffing Efficiency Score</h3>
                    </div>
                    <div id="efficiency-score">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Shift Marketplace -->
            <section class="page-section" id="page-marketplace">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Shift Marketplace</h1>
                        <p class="page-subtitle">Buy, sell, and trade shifts with coworkers</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="openPostShiftModal('sell')">
                            ðŸ’° Sell a Shift
                        </button>
                        <button class="btn btn-primary" onclick="openPostShiftModal('buy')">
                            ðŸ›’ Want a Shift
                        </button>
                    </div>
                </div>

                <div class="marketplace-tabs">
                    <button class="tab-btn active" onclick="switchMarketTab('available')">Available Shifts</button>
                    <button class="tab-btn" onclick="switchMarketTab('wanted')">Shifts Wanted</button>
                    <button class="tab-btn" onclick="switchMarketTab('my-posts')">My Posts</button>
                </div>

                <div class="card">
                    <div id="marketplace-listings">
                        <p class="empty-state">No shifts posted yet. Be the first to post!</p>
                    </div>
                </div>
            </section>

            <!-- Shift Swaps -->
            <section class="page-section" id="page-swaps">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Shift Swaps</h1>
                        <p class="page-subtitle">Request and manage shift trades with coworkers</p>
                    </div>
                    <button class="btn btn-primary" onclick="openSwapRequestModal()">
                        + Request Swap
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Swap Requests</h3>
                    </div>
                    <div id="my-swap-requests">
                        <p class="empty-state">No pending swap requests</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Incoming Swap Offers</h3>
                    </div>
                    <div id="incoming-swaps">
                        <p class="empty-state">No incoming swap offers</p>
                    </div>
                </div>
            </section>

            <!-- Manager Approvals -->
            <section class="page-section" id="page-approvals">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Pending Approvals</h1>
                        <p class="page-subtitle">Review and approve schedule changes</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Shift Swap Requests</h3>
                    </div>
                    <div id="pending-swap-approvals">
                        <p class="empty-state">No pending approvals</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Time-Off Requests</h3>
                    </div>
                    <div id="pending-timeoff-approvals">
                        <p class="empty-state">No pending time-off requests</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Staff Modal -->
    <div class="modal-overlay" id="staff-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="staff-modal-title">Add Employee</h2>
                <button class="modal-close" onclick="closeModal('staff-modal')">Ã—</button>
            </div>
            <form id="staff-form" onsubmit="saveStaff(event)">
                <input type="hidden" id="staff-id">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="staff-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-select" id="staff-role" required>
                            <option value="">Select role...</option>
                            <option value="server">Server</option>
                            <option value="cook">Cook</option>
                            <option value="host">Host</option>
                            <option value="bartender">Bartender</option>
                            <option value="busser">Busser</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Hourly Rate ($)</label>
                        <input type="number" class="form-input" id="staff-rate" step="0.01" min="0" value="15.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Hours/Week</label>
                        <input type="number" class="form-input" id="staff-max-hours" min="1" max="60" value="40">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="staff-phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Certifications</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <label class="form-check">
                            <input type="checkbox" id="cert-food-handler"> Food Handler
                        </label>
                        <label class="form-check">
                            <input type="checkbox" id="cert-alcohol"> Alcohol Service
                        </label>
                        <label class="form-check">
                            <input type="checkbox" id="cert-food-safety"> Food Safety Manager
                        </label>
                        <label class="form-check">
                            <input type="checkbox" id="cert-first-aid"> First Aid
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Availability</label>
                    <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Click cells to toggle availability</p>
                    <div class="availability-grid" id="availability-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staff-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shift Template Modal -->
    <div class="modal-overlay" id="shift-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="shift-modal-title">Add Shift Template</h2>
                <button class="modal-close" onclick="closeModal('shift-modal')">Ã—</button>
            </div>
            <form id="shift-form" onsubmit="saveShiftTemplate(event)">
                <input type="hidden" id="shift-id">
                <div class="form-group">
                    <label class="form-label">Shift Name *</label>
                    <input type="text" class="form-input" id="shift-name" required placeholder="e.g., Breakfast, Lunch, Dinner">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Time *</label>
                        <input type="time" class="form-input" id="shift-start" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time *</label>
                        <input type="time" class="form-input" id="shift-end" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Required Staff</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Servers</label>
                            <input type="number" class="form-input" id="req-server" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Cooks</label>
                            <input type="number" class="form-input" id="req-cook" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Hosts</label>
                            <input type="number" class="form-input" id="req-host" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Bartenders</label>
                            <input type="number" class="form-input" id="req-bartender" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Bussers</label>
                            <input type="number" class="form-input" id="req-busser" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Managers</label>
                            <input type="number" class="form-input" id="req-manager" min="0" value="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('shift-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Holiday Modal -->
    <div class="modal-overlay" id="holiday-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Holiday / Blackout Date</h2>
                <button class="modal-close" onclick="closeModal('holiday-modal')">Ã—</button>
            </div>
            <form id="holiday-form" onsubmit="saveHoliday(event)">
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="holiday-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Name / Description *</label>
                    <input type="text" class="form-input" id="holiday-name" required placeholder="e.g., Christmas Day, Restaurant Closed">
                </div>
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" id="holiday-closed"> Restaurant Closed (no shifts)
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('holiday-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Shift Modal -->
    <div class="modal-overlay" id="assign-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Assign Shift</h2>
                <button class="modal-close" onclick="closeModal('assign-modal')">Ã—</button>
            </div>
            <div id="assign-modal-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Export Schedule</h2>
                <button class="modal-close" onclick="closeModal('export-modal')">Ã—</button>
            </div>
            <div style="display: grid; gap: 8px;">
                <button class="btn btn-secondary" onclick="copyScheduleToClipboard()" style="width: 100%; justify-content: center;">
                    Copy to Clipboard
                </button>
                <button class="btn btn-secondary" onclick="printSchedule()" style="width: 100%; justify-content: center;">
                    Print Schedule
                </button>
                <button class="btn btn-secondary" onclick="downloadCSV()" style="width: 100%; justify-content: center;">
                    Download CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA MODELS & STATE
        // ============================================
        const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const SHIFTS_DEFAULT = ['morning', 'afternoon', 'evening'];
        const ROLES = ['server', 'cook', 'host', 'bartender', 'busser', 'manager'];
        const ROLE_LABELS = {
            server: 'Server',
            cook: 'Cook',
            host: 'Host',
            bartender: 'Bartender',
            busser: 'Busser',
            manager: 'Manager'
        };

        let state = {
            staff: [],
            shiftTemplates: [],
            schedule: {}, // { 'YYYY-MM-DD': { shiftId: [{ staffId, role }] } }
            holidays: [],
            currentWeekStart: getWeekStart(new Date()),
            selectedDay: new Date().toISOString().split('T')[0],
            theme: 'light'
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function formatDate(date, format = 'short') {
            const d = new Date(date);
            if (format === 'short') {
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else if (format === 'full') {
                return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            } else if (format === 'iso') {
                return d.toISOString().split('T')[0];
            }
            return d.toLocaleDateString();
        }

        // Security: Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Security: Escape CSV values to prevent formula injection
        function escapeCSV(value) {
            if (!value) return '';
            const str = String(value);
            // Prefix formula characters with single quote to neutralize
            if (/^[=+\-@\t\r]/.test(str)) {
                return `"'${str.replace(/"/g, '""')}"`;
            }
            // Wrap in quotes and escape internal quotes
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        function calculateShiftHours(template) {
            const [startH, startM] = template.startTime.split(':').map(Number);
            const [endH, endM] = template.endTime.split(':').map(Number);
            let hours = endH - startH + (endM - startM) / 60;
            if (hours < 0) hours += 24; // overnight shift
            return hours;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : '!'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // STORAGE
        // ============================================
        function saveState() {
            localStorage.setItem('restaurantSchedulerPro', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('restaurantSchedulerPro');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                state.currentWeekStart = new Date(state.currentWeekStart);
            }
            applyTheme();
        }

        // ============================================
        // THEME
        // ============================================
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveState();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            document.getElementById('theme-icon').textContent = state.theme === 'light' ? 'â—' : 'â—‘';
            document.getElementById('theme-text').textContent = state.theme === 'light' ? 'Dark Mode' : 'Light Mode';
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.toggle('active', section.id === `page-${page}`);
            });
            
            // Refresh page content
            switch(page) {
                case 'dashboard': renderDashboard(); break;
                case 'analytics': renderAnalytics(); break;
                case 'schedule': renderSchedule(); break;
                case 'day-view': renderDayView(); break;
                case 'staff': renderStaffTable(); break;
                case 'shifts': renderShiftTemplates(); break;
                case 'holidays': renderHolidays(); break;
                case 'labor': renderLaborCosts(); break;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ============================================
        // WEEK NAVIGATION
        // ============================================
        function changeWeek(delta) {
            const newDate = new Date(state.currentWeekStart);
            newDate.setDate(newDate.getDate() + (delta * 7));
            state.currentWeekStart = newDate;
            saveState();
            renderSchedule();
            renderDashboard();
        }

        function goToToday() {
            state.currentWeekStart = getWeekStart(new Date());
            saveState();
            renderSchedule();
            renderDashboard();
        }

        // ============================================
        // MODALS
        // ============================================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ============================================
        // STAFF MANAGEMENT
        // ============================================
        function openStaffModal(staffId = null) {
            const modal = document.getElementById('staff-modal');
            const form = document.getElementById('staff-form');
            const title = document.getElementById('staff-modal-title');
            
            form.reset();
            renderAvailabilityGrid();
            
            if (staffId) {
                const staff = state.staff.find(s => s.id === staffId);
                if (staff) {
                    title.textContent = 'Edit Employee';
                    document.getElementById('staff-id').value = staff.id;
                    document.getElementById('staff-name').value = staff.name;
                    document.getElementById('staff-role').value = staff.role;
                    document.getElementById('staff-rate').value = staff.hourlyRate;
                    document.getElementById('staff-max-hours').value = staff.maxHours;
                    document.getElementById('staff-phone').value = staff.phone || '';
                    document.getElementById('cert-food-handler').checked = staff.certifications?.foodHandler;
                    document.getElementById('cert-alcohol').checked = staff.certifications?.alcohol;
                    document.getElementById('cert-food-safety').checked = staff.certifications?.foodSafety;
                    document.getElementById('cert-first-aid').checked = staff.certifications?.firstAid;
                    
                    // Set availability
                    if (staff.availability) {
                        Object.entries(staff.availability).forEach(([day, shifts]) => {
                            shifts.forEach(shift => {
                                const cell = document.querySelector(`.avail-cell[data-day="${day}"][data-shift="${shift}"]`);
                                if (cell) cell.classList.add('available');
                            });
                        });
                    }
                }
            } else {
                title.textContent = 'Add Employee';
                document.getElementById('staff-id').value = '';
            }
            
            openModal('staff-modal');
        }

        function renderAvailabilityGrid() {
            const grid = document.getElementById('availability-grid');
            const shifts = state.shiftTemplates.length > 0 ? state.shiftTemplates : [
                { id: 'morning', name: 'Morning' },
                { id: 'afternoon', name: 'Afternoon' },
                { id: 'evening', name: 'Evening' }
            ];
            
            let html = '<div class="avail-header"></div>';
            DAYS_SHORT.forEach(day => {
                html += `<div class="avail-header">${day}</div>`;
            });
            
            shifts.forEach(shift => {
                html += `<div class="avail-label">${escapeHtml(shift.name)}</div>`;
                DAYS.forEach((day, i) => {
                    html += `<div class="avail-cell" data-day="${i}" data-shift="${shift.id}" onclick="toggleAvailability(this)"></div>`;
                });
            });
            
            grid.innerHTML = html;
        }

        function toggleAvailability(cell) {
            cell.classList.toggle('available');
        }

        function saveStaff(e) {
            e.preventDefault();
            
            const id = document.getElementById('staff-id').value || generateId();
            const isEdit = !!document.getElementById('staff-id').value;
            
            // Gather availability
            const availability = {};
            document.querySelectorAll('.avail-cell.available').forEach(cell => {
                const day = cell.dataset.day;
                const shift = cell.dataset.shift;
                if (!availability[day]) availability[day] = [];
                availability[day].push(shift);
            });
            
            const staffData = {
                id,
                name: document.getElementById('staff-name').value,
                role: document.getElementById('staff-role').value,
                hourlyRate: parseFloat(document.getElementById('staff-rate').value) || 15,
                maxHours: parseInt(document.getElementById('staff-max-hours').value) || 40,
                phone: document.getElementById('staff-phone').value,
                certifications: {
                    foodHandler: document.getElementById('cert-food-handler').checked,
                    alcohol: document.getElementById('cert-alcohol').checked,
                    foodSafety: document.getElementById('cert-food-safety').checked,
                    firstAid: document.getElementById('cert-first-aid').checked
                },
                availability
            };
            
            if (isEdit) {
                const index = state.staff.findIndex(s => s.id === id);
                state.staff[index] = staffData;
            } else {
                state.staff.push(staffData);
            }
            
            saveState();
            closeModal('staff-modal');
            renderStaffTable();
            showToast(isEdit ? 'Employee updated' : 'Employee added');
        }

        function deleteStaff(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                state.staff = state.staff.filter(s => s.id !== id);
                
                // Remove from schedule
                Object.keys(state.schedule).forEach(date => {
                    Object.keys(state.schedule[date]).forEach(shiftId => {
                        state.schedule[date][shiftId] = state.schedule[date][shiftId].filter(a => a.staffId !== id);
                    });
                });
                
                saveState();
                renderStaffTable();
                showToast('Employee deleted', 'warning');
            }
        }

        function renderStaffTable() {
            const tbody = document.getElementById('staff-tbody');
            
            if (state.staff.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            No employees yet. Click "Add Employee" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = state.staff.map(staff => {
                const weekHours = calculateWeekHours(staff.id);
                const certs = [];
                if (staff.certifications?.foodHandler) certs.push('Food Handler');
                if (staff.certifications?.alcohol) certs.push('Alcohol');
                if (staff.certifications?.foodSafety) certs.push('Food Safety');
                if (staff.certifications?.firstAid) certs.push('First Aid');
                
                const hoursClass = weekHours > staff.maxHours ? 'hours-danger' : weekHours > staff.maxHours * 0.9 ? 'hours-warning' : '';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(staff.name)}</strong></td>
                        <td><span class="role-badge ${escapeHtml(staff.role)}">${escapeHtml(ROLE_LABELS[staff.role])}</span></td>
                        <td>$${staff.hourlyRate.toFixed(2)}</td>
                        <td>${staff.maxHours}h</td>
                        <td>${certs.map(c => `<span class="cert-badge active">${c}</span>`).join('') || '<span class="cert-badge">None</span>'}</td>
                        <td class="${hoursClass}">${weekHours.toFixed(1)}h / ${staff.maxHours}h</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openStaffModal('${staff.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStaff('${staff.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateWeekHours(staffId) {
            let totalHours = 0;
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.keys(state.schedule[dateKey]).forEach(shiftId => {
                        const assignments = state.schedule[dateKey][shiftId];
                        if (assignments.some(a => a.staffId === staffId)) {
                            const template = state.shiftTemplates.find(t => t.id === shiftId);
                            if (template) {
                                totalHours += calculateShiftHours(template);
                            }
                        }
                    });
                }
            });
            
            return totalHours;
        }

        // ============================================
        // SHIFT TEMPLATES
        // ============================================
        function openShiftModal(shiftId = null) {
            const form = document.getElementById('shift-form');
            const title = document.getElementById('shift-modal-title');
            
            form.reset();
            
            if (shiftId) {
                const shift = state.shiftTemplates.find(s => s.id === shiftId);
                if (shift) {
                    title.textContent = 'Edit Shift Template';
                    document.getElementById('shift-id').value = shift.id;
                    document.getElementById('shift-name').value = shift.name;
                    document.getElementById('shift-start').value = shift.startTime;
                    document.getElementById('shift-end').value = shift.endTime;
                    ROLES.forEach(role => {
                        document.getElementById(`req-${role}`).value = shift.requirements?.[role] || 0;
                    });
                }
            } else {
                title.textContent = 'Add Shift Template';
                document.getElementById('shift-id').value = '';
            }
            
            openModal('shift-modal');
        }

        function saveShiftTemplate(e) {
            e.preventDefault();
            
            const id = document.getElementById('shift-id').value || generateId();
            const isEdit = !!document.getElementById('shift-id').value;
            
            const requirements = {};
            ROLES.forEach(role => {
                requirements[role] = parseInt(document.getElementById(`req-${role}`).value) || 0;
            });
            
            const shiftData = {
                id,
                name: document.getElementById('shift-name').value,
                startTime: document.getElementById('shift-start').value,
                endTime: document.getElementById('shift-end').value,
                requirements
            };
            
            if (isEdit) {
                const index = state.shiftTemplates.findIndex(s => s.id === id);
                state.shiftTemplates[index] = shiftData;
            } else {
                state.shiftTemplates.push(shiftData);
            }
            
            saveState();
            closeModal('shift-modal');
            renderShiftTemplates();
            showToast(isEdit ? 'Shift template updated' : 'Shift template added');
        }

        function deleteShiftTemplate(id) {
            if (confirm('Are you sure you want to delete this shift template?')) {
                state.shiftTemplates = state.shiftTemplates.filter(s => s.id !== id);
                saveState();
                renderShiftTemplates();
                showToast('Shift template deleted', 'warning');
            }
        }

        function renderShiftTemplates() {
            const container = document.getElementById('shift-templates-grid');
            
            if (state.shiftTemplates.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">
                        <p style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;">â—·</p>
                        <p>No shift templates yet.</p>
                        <p style="font-size: 12px;">Create templates like "Breakfast", "Lunch", "Dinner" to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.shiftTemplates.map(shift => {
                const hours = calculateShiftHours(shift);
                return `
                    <div class="template-card">
                        <div class="template-header">
                            <div>
                                <div class="template-name">${escapeHtml(shift.name)}</div>
                                <div class="template-time">${escapeHtml(shift.startTime)} - ${escapeHtml(shift.endTime)} (${hours}h)</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-secondary" onclick="openShiftModal('${shift.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteShiftTemplate('${shift.id}')">Ã—</button>
                            </div>
                        </div>
                        <div class="template-requirements">
                            ${ROLES.filter(role => shift.requirements?.[role] > 0).map(role => `
                                <div class="req-row">
                                    <span>${ROLE_LABELS[role]}</span>
                                    <span class="req-count">${shift.requirements[role]}</span>
                                </div>
                            `).join('') || '<div style="color: var(--text-muted); font-size: 12px;">No requirements set</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // HOLIDAYS
        // ============================================
        function openHolidayModal() {
            document.getElementById('holiday-form').reset();
            openModal('holiday-modal');
        }

        function saveHoliday(e) {
            e.preventDefault();
            
            state.holidays.push({
                id: generateId(),
                date: document.getElementById('holiday-date').value,
                name: document.getElementById('holiday-name').value,
                closed: document.getElementById('holiday-closed').checked
            });
            
            state.holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveState();
            closeModal('holiday-modal');
            renderHolidays();
            showToast('Holiday added');
        }

        function deleteHoliday(id) {
            state.holidays = state.holidays.filter(h => h.id !== id);
            saveState();
            renderHolidays();
        }

        function renderHolidays() {
            const container = document.getElementById('holiday-list');
            
            if (state.holidays.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        No holidays or blackout dates configured.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.holidays.map(holiday => `
                <div class="holiday-item">
                    <div>
                        <div class="holiday-date">${formatDate(holiday.date, 'full')}</div>
                        <div class="holiday-name">${escapeHtml(holiday.name)} ${holiday.closed ? '(Closed)' : ''}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${holiday.id}')">Delete</button>
                </div>
            `).join('');
        }

        // ============================================
        // SCHEDULE
        // ============================================
        function renderSchedule() {
            const weekDates = getWeekDates(state.currentWeekStart);
            const today = new Date().toISOString().split('T')[0];
            
            // Update week display
            document.getElementById('week-display').textContent = 
                `${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}`;
            
            const grid = document.getElementById('schedule-grid');
            
            if (state.shiftTemplates.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">
                        <p style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;">â–¦</p>
                        <p>No shift templates configured.</p>
                        <p><a href="#" onclick="navigateTo('shifts')" style="color: var(--accent);">Create shift templates</a> to start scheduling.</p>
                    </div>
                `;
                return;
            }
            
            // Header row
            let html = '<div class="schedule-cell schedule-header">Shift</div>';
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                const isToday = dateKey === today;
                const holiday = state.holidays.find(h => h.date === dateKey);
                html += `
                    <div class="schedule-cell schedule-header ${isToday ? 'today' : ''}">
                        <div>${DAYS_SHORT[i]}</div>
                        <div style="font-size: 10px; font-weight: 400; opacity: 0.8;">${formatDate(date)}</div>
                        ${holiday ? `<div style="font-size: 9px; color: ${holiday.closed ? 'var(--danger)' : 'var(--warning)'};">${escapeHtml(holiday.name)}</div>` : ''}
                    </div>
                `;
            });
            
            // Shift rows
            state.shiftTemplates.forEach(shift => {
                html += `
                    <div class="schedule-cell schedule-shift-label">
                        <div>
                            ${escapeHtml(shift.name)}
                            <span class="time">${escapeHtml(shift.startTime)} - ${escapeHtml(shift.endTime)}</span>
                        </div>
                    </div>
                `;
                
                weekDates.forEach(date => {
                    const dateKey = formatDate(date, 'iso');
                    const assignments = state.schedule[dateKey]?.[shift.id] || [];
                    const holiday = state.holidays.find(h => h.date === dateKey && h.closed);
                    const conflicts = getConflicts(dateKey, shift.id);
                    
                    html += `
                        <div class="schedule-cell" 
                             data-date="${dateKey}" 
                             data-shift="${shift.id}"
                             ondragover="handleDragOver(event)"
                             ondrop="handleDrop(event)"
                             ondragleave="handleDragLeave(event)">
                            ${conflicts.length > 0 ? `
                                <div class="conflict-indicator ${conflicts.some(c => c.type === 'danger') ? 'danger' : 'warning'}" 
                                     title="${conflicts.map(c => c.message).join('\n')}">
                                    !
                                </div>
                            ` : ''}
                            ${holiday ? `<div style="color: var(--text-muted); font-size: 11px; text-align: center;">Closed</div>` : `
                                ${assignments.map(a => {
                                    const staff = state.staff.find(s => s.id === a.staffId);
                                    return staff ? `
                                        <div class="shift-chip ${escapeHtml(staff.role)}"
                                             draggable="true"
                                             ondragstart="handleDragStart(event, '${dateKey}', '${shift.id}', '${a.staffId}')"
                                             ondragend="handleDragEnd(event)"
                                             onclick="showShiftOptions('${dateKey}', '${shift.id}', '${a.staffId}')"
                                             style="cursor: grab;">
                                            ${escapeHtml(staff.name)}
                                            <span class="remove-shift" onclick="event.stopPropagation(); removeAssignment('${dateKey}', '${shift.id}', '${a.staffId}')">Ã—</span>
                                        </div>
                                    ` : '';
                                }).join('')}
                                <button class="add-shift-btn" onclick="openAssignModal('${dateKey}', '${shift.id}')">+ Add</button>
                            `}
                        </div>
                    `;
                });
            });
            
            grid.innerHTML = html;
        }

        function setScheduleView(view) {
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            document.getElementById('schedule-grid-view').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('schedule-employee-view').style.display = view === 'employee' ? 'block' : 'none';
            
            if (view === 'employee') {
                renderEmployeeView();
            }
        }

        function renderEmployeeView() {
            const container = document.getElementById('employee-schedule');
            const weekDates = getWeekDates(state.currentWeekStart);
            
            if (state.staff.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                        No employees to display.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.staff.map(staff => {
                const weekHours = calculateWeekHours(staff.id);
                const shifts = [];
                
                weekDates.forEach((date, dayIndex) => {
                    const dateKey = formatDate(date, 'iso');
                    state.shiftTemplates.forEach(template => {
                        const assignments = state.schedule[dateKey]?.[template.id] || [];
                        if (assignments.some(a => a.staffId === staff.id)) {
                            shifts.push({
                                day: DAYS_SHORT[dayIndex],
                                date: formatDate(date),
                                shift: template.name,
                                time: `${template.startTime} - ${template.endTime}`
                            });
                        }
                    });
                });
                
                const hoursClass = weekHours > staff.maxHours ? 'hours-danger' : weekHours > staff.maxHours * 0.9 ? 'hours-warning' : '';
                
                return `
                    <div class="employee-card">
                        <div class="employee-card-header">
                            <div class="employee-avatar">
                                ${escapeHtml(staff.name.charAt(0).toUpperCase())}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 13px;">${escapeHtml(staff.name)}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${ROLE_LABELS[staff.role]}</div>
                            </div>
                        </div>
                        <div class="employee-shifts">
                            ${shifts.length > 0 ? shifts.map(s => `
                                <div class="employee-shift-chip">
                                    <span class="day">${s.day}</span> ${s.shift} (${s.time})
                                </div>
                            `).join('') : '<div style="color: var(--text-muted); font-size: 12px;">No shifts this week</div>'}
                        </div>
                        <div class="employee-hours">
                            <span>Weekly Hours:</span>
                            <span class="${hoursClass}">${weekHours.toFixed(1)}h / ${staff.maxHours}h</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // DAY VIEW
        // ============================================
        function selectDay(dateStr) {
            state.selectedDay = dateStr;
            renderDayView();
        }

        function renderDayView() {
            document.getElementById('day-picker').value = state.selectedDay;
            document.getElementById('day-view-date').textContent = formatDate(state.selectedDay, 'full');
            
            const container = document.getElementById('day-view-container');
            const holiday = state.holidays.find(h => h.date === state.selectedDay);
            
            if (holiday?.closed) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px;">
                        <p style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;">â—ˆ</p>
                        <h3>${escapeHtml(holiday.name)}</h3>
                        <p style="color: var(--text-muted);">Restaurant is closed</p>
                    </div>
                `;
                return;
            }
            
            if (state.shiftTemplates.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px; color: var(--text-muted);">
                        No shift templates configured.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.shiftTemplates.map(shift => {
                const assignments = state.schedule[state.selectedDay]?.[shift.id] || [];
                const requirements = shift.requirements || {};
                
                const staffSlots = [];
                ROLES.forEach(role => {
                    const required = requirements[role] || 0;
                    const assigned = assignments.filter(a => {
                        const staff = state.staff.find(s => s.id === a.staffId);
                        return staff?.role === role;
                    });
                    
                    for (let i = 0; i < Math.max(required, assigned.length); i++) {
                        if (assigned[i]) {
                            const staff = state.staff.find(s => s.id === assigned[i].staffId);
                            staffSlots.push({
                                filled: true,
                                name: staff?.name,
                                role: role
                            });
                        } else if (i < required) {
                            staffSlots.push({
                                filled: false,
                                role: role,
                                warning: true
                            });
                        }
                    }
                });
                
                return `
                    <div class="shift-section"
                         data-shift="${shift.id}"
                         ondragover="handleDayViewDragOver(event)"
                         ondrop="handleDayViewDrop(event, '${shift.id}')"
                         ondragleave="handleDragLeave(event)">
                        <div class="shift-section-header">
                            <div class="shift-section-title">${escapeHtml(shift.name)}</div>
                            <div class="shift-section-time">${escapeHtml(shift.startTime)} - ${escapeHtml(shift.endTime)}</div>
                        </div>
                        <div class="shift-staff-grid">
                            ${staffSlots.length > 0 ? staffSlots.map((slot, idx) => {
                                if (slot.filled) {
                                    const staffMember = state.staff.find(s => s.name === slot.name);
                                    return `
                                        <div class="staff-slot filled"
                                             draggable="true"
                                             ondragstart="handleDayViewDragStart(event, '${shift.id}', '${staffMember?.id}')"
                                             ondragend="handleDragEnd(event)"
                                             onclick="removeDayViewAssignment('${shift.id}', '${staffMember?.id}')"
                                             style="cursor: grab;">
                                            <div class="staff-slot-name">${slot.name}</div>
                                            <div class="staff-slot-role">${ROLE_LABELS[slot.role]}</div>
                                            <span class="slot-remove">Ã—</span>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="staff-slot ${slot.warning ? 'warning' : 'empty'}"
                                             onclick="openDayViewAssignModal('${shift.id}', '${slot.role}')">
                                            <div class="staff-slot-name">${slot.warning ? '+ Add Staff' : 'Empty'}</div>
                                            <div class="staff-slot-role">${ROLE_LABELS[slot.role]}</div>
                                        </div>
                                    `;
                                }
                            }).join('') : '<div style="color: var(--text-muted); padding: 20px; font-size: 12px;">No staff requirements set</div>'}
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openDayViewAssignModal('${shift.id}')">+ Add Staff</button>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // ASSIGNMENT
        // ============================================
        function openAssignModal(date, shiftId) {
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            const existingAssignments = state.schedule[date]?.[shiftId] || [];
            const existingIds = existingAssignments.map(a => a.staffId);
            const dayIndex = new Date(date).getDay();
            
            // Filter available staff
            const availableStaff = state.staff.filter(staff => {
                // Not already assigned
                if (existingIds.includes(staff.id)) return false;
                
                // Check availability
                // Day with [] = NOT available that day
                // Day with shifts = only available for those shifts
                // Day not specified = available for everything
                const avail = staff.availability?.[dayIndex];
                if (avail !== undefined) {
                    if (avail.length === 0) return false;
                    if (!avail.includes(shiftId)) return false;
                }
                
                // Check max hours
                const currentHours = calculateWeekHours(staff.id);
                const shiftHours = calculateShiftHours(shift);
                if (currentHours + shiftHours > staff.maxHours) return false;
                
                return true;
            });
            
            const content = document.getElementById('assign-modal-content');
            content.innerHTML = `
                <p style="margin-bottom: 14px; font-size: 13px;">
                    <strong>${escapeHtml(shift.name)}</strong> on ${formatDate(date, 'full')}
                </p>
                ${availableStaff.length > 0 ? `
                    <div style="display: grid; gap: 6px; max-height: 400px; overflow-y: auto;">
                        ${availableStaff.map(staff => {
                            const hours = calculateWeekHours(staff.id);
                            return `
                                <button class="btn btn-secondary" style="width: 100%; justify-content: space-between;" 
                                        onclick="assignStaff('${date}', '${shiftId}', '${staff.id}')">
                                    <span><span class="role-badge ${escapeHtml(staff.role)}">${escapeHtml(ROLE_LABELS[staff.role])}</span> ${escapeHtml(staff.name)}</span>
                                    <span style="font-size: 11px; color: var(--text-muted);">${hours.toFixed(1)}h this week</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <p>No available staff for this shift.</p>
                        <p style="font-size: 12px;">All employees are either already assigned, unavailable, or at max hours.</p>
                    </div>
                `}
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('assign-modal')">Cancel</button>
                </div>
            `;
            
            openModal('assign-modal');
        }

        function assignStaff(date, shiftId, staffId) {
            if (!state.schedule[date]) state.schedule[date] = {};
            if (!state.schedule[date][shiftId]) state.schedule[date][shiftId] = [];
            
            // Prevent duplicates
            if (!state.schedule[date][shiftId].some(a => a.staffId === staffId)) {
                const staff = state.staff.find(s => s.id === staffId);
                state.schedule[date][shiftId].push({ staffId, role: staff.role });
                saveState();
            }
            
            closeModal('assign-modal');
            renderSchedule();
            renderDashboard();
            showToast('Shift assigned');
        }

        function removeAssignment(date, shiftId, staffId) {
            if (state.schedule[date]?.[shiftId]) {
                state.schedule[date][shiftId] = state.schedule[date][shiftId].filter(a => a.staffId !== staffId);
                saveState();
                renderSchedule();
                renderDashboard();
            }
        }

        function showShiftOptions(date, shiftId, staffId) {
            const staff = state.staff.find(s => s.id === staffId);
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            
            if (confirm(`Remove ${staff.name} from ${shift.name} on ${formatDate(date)}?`)) {
                removeAssignment(date, shiftId, staffId);
            }
        }

        function clearWeekSchedule() {
            if (confirm('Clear all shifts for this week?')) {
                const weekDates = getWeekDates(state.currentWeekStart);
                weekDates.forEach(date => {
                    const dateKey = formatDate(date, 'iso');
                    delete state.schedule[dateKey];
                });
                saveState();
                renderSchedule();
                renderDashboard();
                showToast('Week cleared', 'warning');
            }
        }

        // ============================================
        // DRAG & DROP
        // ============================================
        let dragData = null;

        function handleDragStart(e, date, shiftId, staffId) {
            dragData = { date, shiftId, staffId };
            e.dataTransfer.setData('text/plain', JSON.stringify(dragData));
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging');

            // Set drag image
            const dragImage = e.target.cloneNode(true);
            dragImage.style.position = 'absolute';
            dragImage.style.top = '-1000px';
            document.body.appendChild(dragImage);
            e.dataTransfer.setDragImage(dragImage, 0, 0);
            setTimeout(() => dragImage.remove(), 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!dragData) return;

            const newDate = e.currentTarget.dataset.date;
            const newShiftId = e.currentTarget.dataset.shift;

            // Don't do anything if dropped in same spot
            if (newDate === dragData.date && newShiftId === dragData.shiftId) {
                dragData = null;
                return;
            }

            // Remove from old position
            removeAssignment(dragData.date, dragData.shiftId, dragData.staffId);

            // Add to new position
            assignStaff(newDate, newShiftId, dragData.staffId);

            showToast('Shift moved successfully', 'success');
            dragData = null;
        }

        // ============================================
        // CONFLICTS & ALERTS
        // ============================================
        function getConflicts(date, shiftId) {
            const conflicts = [];
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            const assignments = state.schedule[date]?.[shiftId] || [];
            const requirements = shift?.requirements || {};
            
            // Check understaffing
            ROLES.forEach(role => {
                const required = requirements[role] || 0;
                const assigned = assignments.filter(a => {
                    const staff = state.staff.find(s => s.id === a.staffId);
                    return staff?.role === role;
                }).length;
                
                if (assigned < required) {
                    conflicts.push({
                        type: 'warning',
                        message: `Need ${required - assigned} more ${ROLE_LABELS[role]}(s)`,
                        role: role,
                        shiftId: shiftId,
                        dateKey: date,
                        clickable: true
                    });
                }
            });
            
            // Check overtime
            assignments.forEach(a => {
                const staff = state.staff.find(s => s.id === a.staffId);
                if (staff) {
                    const hours = calculateWeekHours(staff.id);
                    if (hours > staff.maxHours) {
                        conflicts.push({
                            type: 'danger',
                            message: `${staff.name} is over max hours (${hours.toFixed(1)}/${staff.maxHours}h)`
                        });
                    }
                }
            });
            
            return conflicts;
        }

        function getAllAlerts() {
            const alerts = [];
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                state.shiftTemplates.forEach(shift => {
                    const conflicts = getConflicts(dateKey, shift.id);
                    conflicts.forEach(c => {
                        alerts.push({
                            ...c,
                            date: formatDate(date),
                            shift: shift.name
                        });
                    });
                });
            });
            
            // Check staff with no shifts
            state.staff.forEach(staff => {
                const hours = calculateWeekHours(staff.id);
                if (hours === 0) {
                    alerts.push({
                        type: 'info',
                        message: `${staff.name} has no shifts this week`,
                        date: '',
                        shift: ''
                    });
                }
            });
            
            return alerts;
        }

        // ============================================
        // AI AUTO-SCHEDULE
        // ============================================
        function autoSchedule() {
            if (state.staff.length === 0) {
                showToast('Add employees first', 'error');
                return;
            }
            
            if (state.shiftTemplates.length === 0) {
                showToast('Create shift templates first', 'error');
                return;
            }
            
            if (!confirm('Auto-schedule will fill empty slots. Continue?')) return;
            
            const weekDates = getWeekDates(state.currentWeekStart);
            let assigned = 0;
            
            // Track hours assigned this session
            const sessionHours = {};
            state.staff.forEach(s => sessionHours[s.id] = calculateWeekHours(s.id));
            
            // For each day and shift
            weekDates.forEach((date, dayIndex) => {
                const dateKey = formatDate(date, 'iso');
                
                // Skip holidays
                if (state.holidays.find(h => h.date === dateKey && h.closed)) return;
                
                state.shiftTemplates.forEach(shift => {
                    if (!state.schedule[dateKey]) state.schedule[dateKey] = {};
                    if (!state.schedule[dateKey][shift.id]) state.schedule[dateKey][shift.id] = [];
                    
                    const currentAssignments = state.schedule[dateKey][shift.id];
                    const shiftHours = calculateShiftHours(shift);
                    
                    // For each role requirement
                    ROLES.forEach(role => {
                        const required = shift.requirements?.[role] || 0;
                        const currentCount = currentAssignments.filter(a => {
                            const staff = state.staff.find(s => s.id === a.staffId);
                            return staff?.role === role;
                        }).length;
                        
                        const needed = required - currentCount;
                        
                        if (needed > 0) {
                            // Find available staff for this role
                            const candidates = state.staff
                                .filter(s => {
                                    // Right role
                                    if (s.role !== role) return false;
                                    
                                    // Not already assigned
                                    if (currentAssignments.some(a => a.staffId === s.id)) return false;
                                    
                                    // Check availability
                                    // Empty {} = available for everything
                                    // Day with [] = NOT available that day
                                    // Day with shifts = only available for those shifts
                                    // Day not specified = available for everything that day
                                    const avail = s.availability?.[dayIndex];
                                    if (avail !== undefined) {
                                        if (avail.length === 0) return false; // explicitly unavailable
                                        if (!avail.includes(shift.id)) return false; // shift not allowed
                                    }
                                    
                                    // Check max hours
                                    if (sessionHours[s.id] + shiftHours > s.maxHours) return false;
                                    
                                    return true;
                                })
                                // Sort by least hours (fairness)
                                .sort((a, b) => sessionHours[a.id] - sessionHours[b.id]);
                            
                            // Assign as many as needed
                            for (let i = 0; i < Math.min(needed, candidates.length); i++) {
                                const staff = candidates[i];
                                currentAssignments.push({ staffId: staff.id, role: staff.role });
                                sessionHours[staff.id] += shiftHours;
                                assigned++;
                            }
                        }
                    });
                });
            });
            
            saveState();
            renderSchedule();
            renderDashboard();
            
            if (assigned > 0) {
                showToast(`Auto-scheduled ${assigned} shifts`);
            } else {
                showToast('No shifts could be auto-filled', 'warning');
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function renderDashboard() {
            const weekDates = getWeekDates(state.currentWeekStart);
            document.getElementById('dashboard-week').textContent = 
                `${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}`;
            
            // Stats
            const totalShifts = Object.values(state.schedule).reduce((sum, day) => 
                sum + Object.values(day).reduce((s, shifts) => s + shifts.length, 0), 0);
            const alerts = getAllAlerts();
            const laborCost = calculateWeeklyLaborCost();
            const totalHours = calculateTotalWeeklyHours();
            
            document.getElementById('dashboard-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">âš‡</div>
                    <div>
                        <div class="stat-value">${state.staff.length}</div>
                        <div class="stat-label">Total Staff</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â–¦</div>
                    <div>
                        <div class="stat-value">${totalShifts}</div>
                        <div class="stat-label">Scheduled Shifts</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">!</div>
                    <div>
                        <div class="stat-value">${alerts.filter(a => a.type !== 'info').length}</div>
                        <div class="stat-label">Alerts</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">$</div>
                    <div>
                        <div class="stat-value">$${laborCost.toFixed(0)}</div>
                        <div class="stat-label">Est. Labor Cost</div>
                    </div>
                </div>
            `;
            
            // Alerts
            const alertsList = document.getElementById('alerts-list');
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        âœ“ No alerts - everything looks good
                    </div>
                `;
            } else {
                alertsList.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div class="alert-item ${alert.type}" 
                         ${alert.clickable ? `onclick="openQuickFillModal('${alert.role}', '${alert.shiftId}', '${alert.dateKey}')" style="cursor:pointer;"` : ''}>
                        <span class="alert-icon">${alert.type === 'danger' ? '!' : alert.type === 'warning' ? '!' : 'i'}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.message}</div>
                            ${alert.date ? `<div class="alert-desc">${alert.shift} on ${alert.date}${alert.clickable ? ' <span style="color: var(--accent); font-size: 11px;">â†’ Click to fill</span>' : ''}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        // ============================================
        // LABOR COSTS
        // ============================================
        function calculateWeeklyLaborCost() {
            let total = 0;
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            const hours = calculateShiftHours(template);
                            assignments.forEach(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff) {
                                    total += hours * staff.hourlyRate;
                                }
                            });
                        }
                    });
                }
            });
            
            return total;
        }

        function calculateTotalWeeklyHours() {
            let total = 0;
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            total += calculateShiftHours(template) * assignments.length;
                        }
                    });
                }
            });
            
            return total;
        }

        function renderLaborCosts() {
            const weekDates = getWeekDates(state.currentWeekStart);
            const totalCost = calculateWeeklyLaborCost();
            const totalHours = calculateTotalWeeklyHours();
            const avgHourlyRate = state.staff.length > 0 
                ? state.staff.reduce((sum, s) => sum + s.hourlyRate, 0) / state.staff.length 
                : 0;
            
            document.getElementById('labor-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">$</div>
                    <div>
                        <div class="stat-value">$${totalCost.toFixed(2)}</div>
                        <div class="stat-label">Total Labor Cost</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â—·</div>
                    <div>
                        <div class="stat-value">${totalHours.toFixed(1)}h</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â—</div>
                    <div>
                        <div class="stat-value">$${avgHourlyRate.toFixed(2)}</div>
                        <div class="stat-label">Avg Hourly Rate</div>
                    </div>
                </div>
            `;
            
            // Daily breakdown
            const breakdown = document.getElementById('labor-breakdown');
            breakdown.innerHTML = weekDates.map((date, i) => {
                const dateKey = formatDate(date, 'iso');
                let dayHours = 0;
                let dayCost = 0;
                let dayStaff = new Set();
                
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            const hours = calculateShiftHours(template);
                            assignments.forEach(a => {
                                dayStaff.add(a.staffId);
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff) {
                                    dayHours += hours;
                                    dayCost += hours * staff.hourlyRate;
                                }
                            });
                        }
                    });
                }
                
                return `
                    <tr>
                        <td><strong>${DAYS[i]}</strong> ${formatDate(date)}</td>
                        <td>${dayHours.toFixed(1)}h</td>
                        <td>$${dayCost.toFixed(2)}</td>
                        <td>${dayStaff.size}</td>
                    </tr>
                `;
            }).join('');
            
            // Cost by role
            const roleContainer = document.getElementById('labor-by-role');
            const roleCosts = {};
            ROLES.forEach(role => roleCosts[role] = { hours: 0, cost: 0 });
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            const hours = calculateShiftHours(template);
                            assignments.forEach(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff && roleCosts[staff.role]) {
                                    roleCosts[staff.role].hours += hours;
                                    roleCosts[staff.role].cost += hours * staff.hourlyRate;
                                }
                            });
                        }
                    });
                }
            });
            
            roleContainer.innerHTML = `
                <div class="labor-summary">
                    ${ROLES.map(role => `
                        <div class="labor-item">
                            <div class="labor-value">$${roleCosts[role].cost.toFixed(0)}</div>
                            <div class="labor-label">${ROLE_LABELS[role]} (${roleCosts[role].hours.toFixed(1)}h)</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // EXPORT
        // ============================================
        function exportSchedule() {
            openModal('export-modal');
        }

        function copyScheduleToClipboard() {
            const weekDates = getWeekDates(state.currentWeekStart);
            let text = `SCHEDULE: ${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}\n\n`;
            
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                text += `${DAYS[i].toUpperCase()} (${formatDate(date)})\n`;
                
                if (state.schedule[dateKey]) {
                    state.shiftTemplates.forEach(shift => {
                        const assignments = state.schedule[dateKey][shift.id] || [];
                        if (assignments.length > 0) {
                            text += `  ${shift.name} (${shift.startTime}-${shift.endTime}):\n`;
                            assignments.forEach(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff) {
                                    text += `    - ${staff.name} (${staff.role})\n`;
                                }
                            });
                        }
                    });
                } else {
                    text += `  No shifts scheduled\n`;
                }
                text += '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Schedule copied to clipboard');
                closeModal('export-modal');
            });
        }

        function printSchedule() {
            closeModal('export-modal');
            window.print();
        }

        function downloadCSV() {
            const weekDates = getWeekDates(state.currentWeekStart);
            let csv = 'Day,Date,Shift,Start,End,Employee,Role,Hourly Rate\n';
            
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                
                if (state.schedule[dateKey]) {
                    state.shiftTemplates.forEach(shift => {
                        const assignments = state.schedule[dateKey][shift.id] || [];
                        assignments.forEach(a => {
                            const staff = state.staff.find(s => s.id === a.staffId);
                            if (staff) {
                                csv += `${escapeCSV(DAYS[i])},${escapeCSV(dateKey)},${escapeCSV(shift.name)},${escapeCSV(shift.startTime)},${escapeCSV(shift.endTime)},${escapeCSV(staff.name)},${escapeCSV(staff.role)},${escapeCSV('$'+staff.hourlyRate)}\n`;
                            }
                        });
                    });
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schedule-${formatDate(weekDates[0], 'iso')}.csv`;
            a.click();
            
            showToast('CSV downloaded');
            closeModal('export-modal');
        }

        // ============================================
        // SAMPLE DATA
        // ============================================
        function loadSampleData() {
            if (state.staff.length > 0 || state.shiftTemplates.length > 0) return;
            
            // Sample shift templates
            state.shiftTemplates = [
                { id: 'breakfast', name: 'Breakfast', startTime: '06:00', endTime: '11:00', requirements: { cook: 2, server: 2, host: 1, busser: 1 } },
                { id: 'lunch', name: 'Lunch', startTime: '11:00', endTime: '15:00', requirements: { cook: 3, server: 4, host: 1, bartender: 1, busser: 2, manager: 1 } },
                { id: 'dinner', name: 'Dinner', startTime: '16:00', endTime: '22:00', requirements: { cook: 4, server: 5, host: 1, bartender: 2, busser: 2, manager: 1 } },
                { id: 'close', name: 'Close', startTime: '22:00', endTime: '01:00', requirements: { cook: 1, server: 1, busser: 1 } }
            ];
            
            // Sample staff
            state.staff = [
                { id: 's1', name: 'Maria Garcia', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: { 0: ['lunch', 'dinner'], 1: ['lunch', 'dinner'], 2: ['lunch', 'dinner'], 3: ['lunch', 'dinner'], 4: ['lunch', 'dinner'], 5: ['breakfast', 'lunch', 'dinner'], 6: ['breakfast', 'lunch'] } },
                { id: 's2', name: 'James Wilson', role: 'server', hourlyRate: 15, maxHours: 35, certifications: { foodHandler: true, alcohol: true }, availability: { 1: ['dinner', 'close'], 2: ['dinner', 'close'], 3: ['dinner', 'close'], 4: ['dinner', 'close'], 5: ['dinner', 'close'], 6: ['dinner'] } },
                { id: 's3', name: 'Emily Chen', role: 'server', hourlyRate: 14, maxHours: 30, certifications: { foodHandler: true }, availability: { 0: ['breakfast', 'lunch'], 1: ['breakfast', 'lunch'], 2: ['breakfast', 'lunch'], 4: ['breakfast', 'lunch'], 5: ['breakfast', 'lunch'] } },
                { id: 's4', name: 'David Kim', role: 'server', hourlyRate: 16, maxHours: 40, certifications: { foodHandler: true, alcohol: true, firstAid: true }, availability: {} },
                { id: 's5', name: 'Sarah Johnson', role: 'server', hourlyRate: 15, maxHours: 25, certifications: { foodHandler: true }, availability: { 5: ['lunch', 'dinner'], 6: ['lunch', 'dinner'] } },
                { id: 'c1', name: 'Marco Rossi', role: 'cook', hourlyRate: 20, maxHours: 45, certifications: { foodHandler: true, foodSafety: true }, availability: {} },
                { id: 'c2', name: 'Ana Martinez', role: 'cook', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 'c3', name: 'Tom Baker', role: 'cook', hourlyRate: 17, maxHours: 35, certifications: { foodHandler: true }, availability: { 0: [], 6: [] } },
                { id: 'c4', name: 'Wei Zhang', role: 'cook', hourlyRate: 19, maxHours: 40, certifications: { foodHandler: true, foodSafety: true }, availability: {} },
                { id: 'h1', name: 'Jessica Brown', role: 'host', hourlyRate: 14, maxHours: 30, certifications: {}, availability: {} },
                { id: 'b1', name: 'Mike O\'Connor', role: 'bartender', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 'b2', name: 'Lisa Park', role: 'bartender', hourlyRate: 17, maxHours: 35, certifications: { alcohol: true }, availability: { 0: [], 1: [] } },
                { id: 'u1', name: 'Carlos Mendez', role: 'busser', hourlyRate: 13, maxHours: 35, certifications: {}, availability: {} },
                { id: 'u2', name: 'Kevin Nguyen', role: 'busser', hourlyRate: 13, maxHours: 30, certifications: {}, availability: {} },
                { id: 'm1', name: 'Rachel Thompson', role: 'manager', hourlyRate: 25, maxHours: 45, certifications: { foodHandler: true, alcohol: true, foodSafety: true, firstAid: true }, availability: {} }
            ];
            
            saveState();
        }

        // ============================================
        // NLP COMMAND PROCESSING
        // ============================================
        
        // Initialize swap requests in state
        if (!state.swapRequests) state.swapRequests = [];
        if (!state.timeOffRequests) state.timeOffRequests = [];
        
        const commandPatterns = [
            {
                patterns: [
                    /remove\s+(\w+)\s+(?:from\s+)?(\w+)(?:s)?(?:\s+and\s+fill\s+(?:their\s+)?shift)?/i,
                    /take\s+(\w+)\s+off\s+(\w+)(?:s)?/i
                ],
                action: 'remove_from_day',
                description: 'Remove employee from specific days'
            },
            {
                patterns: [
                    /give\s+(\w+)\s+(\w+)(?:s)?\s+off/i,
                    /(\w+)\s+(?:has|needs)\s+(\w+)(?:s)?\s+off/i
                ],
                action: 'day_off',
                description: 'Give employee day(s) off'
            },
            {
                patterns: [
                    /add\s+(\w+)\s+to\s+(\w+)\s+shift(?:s)?/i,
                    /schedule\s+(\w+)\s+(?:for\s+)?(\w+)/i,
                    /put\s+(\w+)\s+on\s+(\w+)/i
                ],
                action: 'add_to_shift',
                description: 'Add employee to shifts'
            },
            {
                patterns: [
                    /swap\s+(\w+)\s+(?:and|with)\s+(\w+)\s+(?:on\s+)?(\w+)?/i,
                    /switch\s+(\w+)\s+(?:and|with)\s+(\w+)/i
                ],
                action: 'swap_shifts',
                description: 'Swap shifts between employees'
            },
            {
                patterns: [
                    /fill\s+(\w+)(?:'s)?\s+shift(?:s)?(?:\s+on\s+(\w+))?/i,
                    /cover\s+(?:for\s+)?(\w+)(?:\s+on\s+(\w+))?/i
                ],
                action: 'fill_shift',
                description: 'Auto-fill someone\'s shifts'
            },
            {
                patterns: [
                    /clear\s+(\w+)(?:'s)?\s+schedule/i,
                    /remove\s+all\s+shifts\s+(?:for\s+)?(\w+)/i
                ],
                action: 'clear_schedule',
                description: 'Clear employee\'s schedule'
            }
        ];

        const dayMapping = {
            'sunday': 0, 'sun': 0,
            'monday': 1, 'mon': 1,
            'tuesday': 2, 'tue': 2, 'tues': 2,
            'wednesday': 3, 'wed': 3,
            'thursday': 4, 'thu': 4, 'thur': 4, 'thurs': 4,
            'friday': 5, 'fri': 5,
            'saturday': 6, 'sat': 6
        };

        function findStaffByName(name) {
            const nameLower = name.toLowerCase();
            return state.staff.find(s => 
                s.name.toLowerCase().includes(nameLower) ||
                s.name.toLowerCase().split(' ')[0] === nameLower
            );
        }

        function findShiftByName(name) {
            const nameLower = name.toLowerCase();
            return state.shiftTemplates.find(s => 
                s.name.toLowerCase().includes(nameLower) ||
                s.id.toLowerCase() === nameLower
            );
        }

        function parseCommand(input) {
            const inputLower = input.toLowerCase().trim();
            
            for (const cmd of commandPatterns) {
                for (const pattern of cmd.patterns) {
                    const match = inputLower.match(pattern);
                    if (match) {
                        return {
                            action: cmd.action,
                            matches: match.slice(1),
                            description: cmd.description
                        };
                    }
                }
            }
            return null;
        }

        function executeCommand(input) {
            const parsed = parseCommand(input);
            if (!parsed) {
                showToast('Could not understand command. Try "help" for examples.', 'error');
                return false;
            }

            const { action, matches } = parsed;

            switch (action) {
                case 'remove_from_day':
                case 'day_off': {
                    const [empName, dayName] = matches;
                    const employee = findStaffByName(empName);
                    const dayNum = dayMapping[dayName.toLowerCase()];
                    
                    if (!employee) {
                        showToast(`Could not find employee "${empName}"`, 'error');
                        return false;
                    }
                    if (dayNum === undefined) {
                        showToast(`Could not understand day "${dayName}"`, 'error');
                        return false;
                    }

                    // Remove from all future occurrences of this day
                    const weekDates = getWeekDates(state.currentWeekStart);
                    let removed = 0;
                    
                    weekDates.forEach(date => {
                        if (date.getDay() === dayNum) {
                            const dateKey = formatDate(date, 'iso');
                            if (state.schedule[dateKey]) {
                                Object.keys(state.schedule[dateKey]).forEach(shiftId => {
                                    const before = state.schedule[dateKey][shiftId].length;
                                    state.schedule[dateKey][shiftId] = state.schedule[dateKey][shiftId]
                                        .filter(a => a.staffId !== employee.id);
                                    removed += before - state.schedule[dateKey][shiftId].length;
                                });
                            }
                        }
                    });

                    saveState();
                    renderDashboard();
                    renderSchedule();
                    showToast(`Removed ${employee.name} from ${DAYS[dayNum]}s (${removed} shift${removed !== 1 ? 's' : ''})`, 'success');
                    
                    // Check if auto-fill was requested
                    if (input.toLowerCase().includes('fill')) {
                        showToast('Auto-filling shifts...', 'info');
                        setTimeout(() => autoSchedule(), 500);
                    }
                    return true;
                }

                case 'add_to_shift': {
                    const [empName, shiftName] = matches;
                    const employee = findStaffByName(empName);
                    const shift = findShiftByName(shiftName);
                    
                    if (!employee) {
                        showToast(`Could not find employee "${empName}"`, 'error');
                        return false;
                    }
                    if (!shift) {
                        showToast(`Could not find shift "${shiftName}"`, 'error');
                        return false;
                    }

                    // Add to this week's shifts
                    const weekDates = getWeekDates(state.currentWeekStart);
                    let added = 0;
                    
                    weekDates.forEach(date => {
                        const dateKey = formatDate(date, 'iso');
                        if (!state.schedule[dateKey]) state.schedule[dateKey] = {};
                        if (!state.schedule[dateKey][shift.id]) state.schedule[dateKey][shift.id] = [];
                        
                        // Don't add if already scheduled
                        if (!state.schedule[dateKey][shift.id].find(a => a.staffId === employee.id)) {
                            state.schedule[dateKey][shift.id].push({
                                staffId: employee.id,
                                role: employee.role
                            });
                            added++;
                        }
                    });

                    saveState();
                    renderDashboard();
                    renderSchedule();
                    showToast(`Added ${employee.name} to ${shift.name} shifts (${added} day${added !== 1 ? 's' : ''})`, 'success');
                    return true;
                }

                case 'swap_shifts': {
                    const [emp1Name, emp2Name, dayName] = matches;
                    const emp1 = findStaffByName(emp1Name);
                    const emp2 = findStaffByName(emp2Name);
                    
                    if (!emp1 || !emp2) {
                        showToast(`Could not find one or both employees`, 'error');
                        return false;
                    }

                    // Create swap request
                    const swapRequest = {
                        id: generateId(),
                        requesterId: emp1.id,
                        targetId: emp2.id,
                        day: dayName ? dayMapping[dayName.toLowerCase()] : null,
                        status: 'pending_target', // Waiting for emp2 to accept
                        createdAt: new Date().toISOString()
                    };
                    
                    state.swapRequests.push(swapRequest);
                    saveState();
                    updateSwapBadges();
                    renderSwapRequests();
                    
                    showToast(`Swap request created: ${emp1.name} â‡„ ${emp2.name}. Awaiting approval.`, 'success');
                    return true;
                }

                case 'fill_shift': {
                    const [empName] = matches;
                    const employee = findStaffByName(empName);
                    
                    if (!employee) {
                        showToast(`Could not find employee "${empName}"`, 'error');
                        return false;
                    }

                    showToast(`Auto-filling ${employee.name}'s shifts...`, 'info');
                    setTimeout(() => autoSchedule(), 300);
                    return true;
                }

                case 'clear_schedule': {
                    const [empName] = matches;
                    const employee = findStaffByName(empName);
                    
                    if (!employee) {
                        showToast(`Could not find employee "${empName}"`, 'error');
                        return false;
                    }

                    let removed = 0;
                    Object.keys(state.schedule).forEach(dateKey => {
                        Object.keys(state.schedule[dateKey]).forEach(shiftId => {
                            const before = state.schedule[dateKey][shiftId].length;
                            state.schedule[dateKey][shiftId] = state.schedule[dateKey][shiftId]
                                .filter(a => a.staffId !== employee.id);
                            removed += before - state.schedule[dateKey][shiftId].length;
                        });
                    });

                    saveState();
                    renderDashboard();
                    renderSchedule();
                    showToast(`Cleared ${employee.name}'s schedule (${removed} shift${removed !== 1 ? 's' : ''})`, 'success');
                    return true;
                }
            }

            return false;
        }

        function showCommandHelp() {
            const helpText = `
                <div style="padding: 16px;">
                    <h3 style="margin-bottom: 12px;">Command Examples</h3>
                    <div style="display: grid; gap: 8px; font-size: 13px;">
                        <div><strong>"remove jan from saturdays"</strong> - Remove Jan from all Saturday shifts</div>
                        <div><strong>"give mike tuesdays off"</strong> - Remove Mike from Tuesday shifts</div>
                        <div><strong>"add sarah to dinner shifts"</strong> - Schedule Sarah for dinner all week</div>
                        <div><strong>"swap maria and james"</strong> - Create swap request between two employees</div>
                        <div><strong>"fill jan's shifts"</strong> - Auto-fill shifts after removing someone</div>
                        <div><strong>"clear tom's schedule"</strong> - Remove all of Tom's shifts</div>
                        <div><strong>"remove jan from saturdays and fill their shift"</strong> - Remove and auto-fill</div>
                    </div>
                </div>
            `;
            
            // Create a simple modal for help
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'help-modal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Command Help</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    ${helpText}
                </div>
            `;
            modal.style.display = 'flex';
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Command input handler
        document.getElementById('command-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const input = this.value.trim();
                if (input) {
                    executeCommand(input);
                    this.value = '';
                }
            }
        });

        // Live suggestions as user types
        document.getElementById('command-input').addEventListener('input', function(e) {
            const input = this.value.trim().toLowerCase();
            const suggestions = document.getElementById('command-suggestions');
            
            if (input.length < 2) {
                suggestions.classList.remove('active');
                return;
            }

            const parsed = parseCommand(input);
            if (parsed) {
                // Show preview of what the command will do
                let previewHtml = `<div class="command-suggestion">
                    <div class="command-suggestion-text">Press Enter to: ${parsed.description}</div>
                </div>`;
                suggestions.innerHTML = previewHtml;
                suggestions.classList.add('active');
            } else {
                suggestions.classList.remove('active');
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.command-bar')) {
                document.getElementById('command-suggestions').classList.remove('active');
            }
        });

        // ============================================
        // ANALYTICS
        // ============================================
        
        function renderAnalytics() {
            const period = document.getElementById('analytics-period')?.value || 'week';
            const weekDates = getWeekDates(state.currentWeekStart);
            
            // Calculate metrics
            let totalHours = 0;
            let totalCost = 0;
            let shiftsScheduled = 0;
            let shiftsFilled = 0;
            const hoursByRole = {};
            const hoursByDay = [];
            const staffHours = {};
            
            ROLES.forEach(r => hoursByRole[r] = 0);
            state.staff.forEach(s => staffHours[s.id] = 0);
            
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                let dayHours = 0;
                let dayCost = 0;
                
                if (state.schedule[dateKey]) {
                    state.shiftTemplates.forEach(shift => {
                        const assignments = state.schedule[dateKey][shift.id] || [];
                        const hours = calculateShiftHours(shift);
                        const requirements = shift.requirements || {};
                        
                        // Count total required vs filled
                        Object.entries(requirements).forEach(([role, required]) => {
                            shiftsScheduled += required;
                            const filled = assignments.filter(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                return staff?.role === role;
                            }).length;
                            shiftsFilled += Math.min(filled, required);
                        });
                        
                        assignments.forEach(a => {
                            const staff = state.staff.find(s => s.id === a.staffId);
                            if (staff) {
                                totalHours += hours;
                                totalCost += hours * staff.hourlyRate;
                                dayHours += hours;
                                dayCost += hours * staff.hourlyRate;
                                hoursByRole[staff.role] = (hoursByRole[staff.role] || 0) + hours;
                                staffHours[staff.id] = (staffHours[staff.id] || 0) + hours;
                            }
                        });
                    });
                }
                
                hoursByDay.push({ day: DAYS_SHORT[i], hours: dayHours, cost: dayCost });
            });
            
            // Render stats
            const statsContainer = document.getElementById('analytics-stats');
            if (statsContainer) {
                const fillRate = shiftsScheduled > 0 ? Math.round((shiftsFilled / shiftsScheduled) * 100) : 100;
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalHours.toFixed(0)}h</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${totalCost.toFixed(0)}</div>
                        <div class="stat-label">Labor Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${fillRate}%</div>
                        <div class="stat-label">Fill Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${totalHours > 0 ? (totalCost / totalHours).toFixed(2) : '0'}</div>
                        <div class="stat-label">Avg $/Hour</div>
                    </div>
                `;
            }
            
            // Render labor cost bar chart
            const laborChart = document.getElementById('labor-chart');
            if (laborChart) {
                const maxCost = Math.max(...hoursByDay.map(d => d.cost), 100);
                laborChart.innerHTML = `
                    <div class="bar-chart">
                        ${hoursByDay.map(d => `
                            <div class="bar-group">
                                <div class="bar" style="height: ${(d.cost / maxCost) * 150}px;">
                                    <span class="bar-value">$${d.cost.toFixed(0)}</span>
                                </div>
                                <span class="bar-label">${d.day}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Render hours by role
            const roleChart = document.getElementById('role-chart');
            if (roleChart) {
                const roleColors = {
                    server: 'var(--role-server)',
                    cook: 'var(--role-cook)',
                    host: 'var(--role-host)',
                    bartender: 'var(--role-bartender)',
                    busser: 'var(--role-busser)',
                    manager: 'var(--role-manager)'
                };
                
                const totalRoleHours = Object.values(hoursByRole).reduce((a, b) => a + b, 0);
                
                roleChart.innerHTML = `
                    <div class="donut-chart">
                        <div class="donut-legend">
                            ${ROLES.map(role => `
                                <div class="legend-item">
                                    <span class="legend-color" style="background: ${roleColors[role]}"></span>
                                    <span>${ROLE_LABELS[role]}: ${hoursByRole[role]?.toFixed(0) || 0}h (${totalRoleHours > 0 ? Math.round((hoursByRole[role] || 0) / totalRoleHours * 100) : 0}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Render staff utilization
            const utilizationList = document.getElementById('utilization-list');
            if (utilizationList) {
                const utilizationData = state.staff.map(s => ({
                    name: s.name,
                    hours: staffHours[s.id] || 0,
                    maxHours: s.maxHours,
                    percent: s.maxHours > 0 ? Math.round((staffHours[s.id] || 0) / s.maxHours * 100) : 0
                })).sort((a, b) => b.percent - a.percent);
                
                utilizationList.innerHTML = utilizationData.slice(0, 8).map(u => {
                    const color = u.percent > 100 ? 'var(--danger)' : u.percent > 80 ? 'var(--success)' : u.percent > 50 ? 'var(--accent)' : 'var(--warning)';
                    return `
                        <div class="utilization-item">
                            <span class="utilization-name">${escapeHtml(u.name)}</span>
                            <div class="utilization-bar-wrapper">
                                <div class="utilization-bar" style="width: ${Math.min(u.percent, 100)}%; background: ${color};"></div>
                            </div>
                            <span class="utilization-percent" style="color: ${color}">${u.percent}%</span>
                        </div>
                    `;
                }).join('');
            }
            
            // Render busiest shifts
            const busyShifts = document.getElementById('busy-shifts-list');
            if (busyShifts) {
                const shiftCounts = {};
                weekDates.forEach(date => {
                    const dateKey = formatDate(date, 'iso');
                    if (state.schedule[dateKey]) {
                        state.shiftTemplates.forEach(shift => {
                            const count = (state.schedule[dateKey][shift.id] || []).length;
                            const key = `${DAYS_SHORT[date.getDay()]} ${shift.name}`;
                            shiftCounts[key] = (shiftCounts[key] || 0) + count;
                        });
                    }
                });
                
                const sorted = Object.entries(shiftCounts).sort((a, b) => b[1] - a[1]).slice(0, 6);
                
                busyShifts.innerHTML = sorted.map(([shift, count], i) => `
                    <div class="utilization-item">
                        <span style="width: 24px; color: var(--text-muted); font-size: 12px;">#${i + 1}</span>
                        <span class="utilization-name">${shift}</span>
                        <span style="font-weight: 600;">${count} staff</span>
                    </div>
                `).join('') || '<p class="empty-state">No shifts scheduled</p>';
            }
            
            // Render efficiency score
            const efficiencyContainer = document.getElementById('efficiency-score');
            if (efficiencyContainer) {
                const fillRate = shiftsScheduled > 0 ? (shiftsFilled / shiftsScheduled) : 1;
                const avgUtilization = state.staff.length > 0 
                    ? state.staff.reduce((sum, s) => sum + Math.min((staffHours[s.id] || 0) / s.maxHours, 1), 0) / state.staff.length 
                    : 0;
                const overTimeCount = state.staff.filter(s => (staffHours[s.id] || 0) > s.maxHours).length;
                const overtimePenalty = state.staff.length > 0 ? (1 - overTimeCount / state.staff.length) : 1;
                
                const score = Math.round((fillRate * 0.4 + avgUtilization * 0.4 + overtimePenalty * 0.2) * 100);
                
                efficiencyContainer.innerHTML = `
                    <div class="efficiency-display">
                        <div class="efficiency-score-big">${score}</div>
                        <div class="efficiency-label">Staffing Efficiency Score</div>
                        <div class="efficiency-breakdown">
                            <div class="efficiency-metric">
                                <div class="efficiency-metric-value" style="color: ${fillRate >= 0.9 ? 'var(--success)' : 'var(--warning)'}">${Math.round(fillRate * 100)}%</div>
                                <div class="efficiency-metric-label">Fill Rate</div>
                            </div>
                            <div class="efficiency-metric">
                                <div class="efficiency-metric-value" style="color: ${avgUtilization >= 0.7 ? 'var(--success)' : 'var(--warning)'}">${Math.round(avgUtilization * 100)}%</div>
                                <div class="efficiency-metric-label">Avg Utilization</div>
                            </div>
                            <div class="efficiency-metric">
                                <div class="efficiency-metric-value" style="color: ${overTimeCount === 0 ? 'var(--success)' : 'var(--danger)'}">${overTimeCount}</div>
                                <div class="efficiency-metric-label">Over Max Hours</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // SHIFT MARKETPLACE
        // ============================================
        
        if (!state.marketListings) state.marketListings = [];
        let currentMarketTab = 'available';

        function openPostShiftModal(type) {
            const staffOptions = state.staff.map(s => 
                `<option value="${s.id}">${escapeHtml(s.name)} (${s.role})</option>`
            ).join('');
            
            const shiftOptions = state.shiftTemplates.map(s => 
                `<option value="${s.id}">${escapeHtml(s.name)} (${s.startTime}-${s.endTime})</option>`
            ).join('');
            
            const weekDates = getWeekDates(state.currentWeekStart);
            const dateOptions = weekDates.map(d => 
                `<option value="${formatDate(d, 'iso')}">${DAYS[d.getDay()]} ${formatDate(d, 'short')}</option>`
            ).join('');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'post-shift-modal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">${type === 'sell' ? 'ðŸ’° Sell a Shift' : 'ðŸ›’ Want a Shift'}</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <form onsubmit="submitMarketListing(event, '${type}')">
                        <div class="form-group">
                            <label class="form-label">Who is posting?</label>
                            <select class="form-input" id="listing-poster" required>${staffOptions}</select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${type === 'sell' ? 'Shift to give away' : 'Shift wanted'}</label>
                            <select class="form-input" id="listing-shift" required>${shiftOptions}</select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <select class="form-input" id="listing-date" required>${dateOptions}</select>
                        </div>
                        ${type === 'sell' ? `
                        <div class="form-group">
                            <label class="form-label">Price (optional - leave 0 for free)</label>
                            <input type="number" class="form-input" id="listing-price" min="0" value="0" placeholder="$0 = Free">
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label class="form-label">Note (optional)</label>
                            <input type="text" class="form-input" id="listing-note" placeholder="e.g., Need someone ASAP">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Post</button>
                        </div>
                    </form>
                </div>
            `;
            modal.style.display = 'flex';
            document.body.appendChild(modal);
        }

        function submitMarketListing(e, type) {
            e.preventDefault();
            
            const listing = {
                id: generateId(),
                type: type,
                posterId: document.getElementById('listing-poster').value,
                shiftId: document.getElementById('listing-shift').value,
                date: document.getElementById('listing-date').value,
                price: type === 'sell' ? parseInt(document.getElementById('listing-price')?.value || 0) : 0,
                note: document.getElementById('listing-note').value,
                status: 'open',
                createdAt: new Date().toISOString()
            };
            
            state.marketListings.push(listing);
            saveState();
            
            document.getElementById('post-shift-modal').remove();
            renderMarketplace();
            updateMarketBadge();
            showToast(`Shift ${type === 'sell' ? 'listed for sale' : 'request posted'}!`, 'success');
        }

        function renderMarketplace() {
            const container = document.getElementById('marketplace-listings');
            if (!container) return;
            
            let listings = state.marketListings.filter(l => l.status === 'open');
            
            if (currentMarketTab === 'available') {
                listings = listings.filter(l => l.type === 'sell');
            } else if (currentMarketTab === 'wanted') {
                listings = listings.filter(l => l.type === 'buy');
            }
            
            if (listings.length === 0) {
                container.innerHTML = '<p class="empty-state">No listings yet. Post the first one!</p>';
                return;
            }

            let html = '';
            listings.forEach(listing => {
                const poster = state.staff.find(s => s.id === listing.posterId);
                const shift = state.shiftTemplates.find(s => s.id === listing.shiftId);
                if (!poster || !shift) return;
                
                const date = new Date(listing.date);
                
                html += `
                    <div class="market-listing">
                        <span class="listing-type ${listing.type}">${listing.type === 'sell' ? 'Available' : 'Wanted'}</span>
                        <div class="listing-details">
                            <div class="listing-title">${escapeHtml(shift.name)} - ${DAYS[date.getDay()]} ${formatDate(date, 'short')}</div>
                            <div class="listing-meta">
                                Posted by ${escapeHtml(poster.name)} â€¢ ${shift.startTime} - ${shift.endTime}
                                ${listing.note ? ` â€¢ "${escapeHtml(listing.note)}"` : ''}
                            </div>
                        </div>
                        <div class="listing-price ${listing.price === 0 ? 'free' : ''}">
                            ${listing.price > 0 ? '$' + listing.price : 'Free'}
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="claimListing('${listing.id}')">
                            ${listing.type === 'sell' ? 'Take Shift' : 'Offer to Cover'}
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function switchMarketTab(tab) {
            currentMarketTab = tab;
            document.querySelectorAll('.marketplace-tabs .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tab.replace('-', ' ')));
            });
            renderMarketplace();
        }

        function claimListing(id) {
            const listing = state.marketListings.find(l => l.id === id);
            if (!listing) return;
            
            const claimerId = prompt('Enter your name to claim this shift:');
            if (!claimerId) return;
            
            const claimer = findStaffByName(claimerId);
            if (!claimer) {
                showToast('Could not find you in the system', 'error');
                return;
            }
            
            listing.claimerId = claimer.id;
            listing.status = 'pending_manager';
            saveState();
            
            updateMarketBadge();
            renderMarketplace();
            showToast('Claim submitted! Awaiting manager approval.', 'success');
        }

        function updateMarketBadge() {
            const openListings = (state.marketListings || []).filter(l => l.status === 'open').length;
            const badge = document.getElementById('market-badge');
            if (badge) {
                if (openListings > 0) {
                    badge.textContent = openListings;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // ============================================
        // CLICKABLE DASHBOARD ALERTS
        // ============================================
        
        function openQuickFillModal(role, shiftId, date) {
            const availableStaff = state.staff.filter(s => s.role === role);
            
            if (availableStaff.length === 0) {
                showToast(`No ${role}s available to assign`, 'error');
                return;
            }
            
            const staffOptions = availableStaff.map(s => 
                `<div class="quick-fill-option" onclick="quickAssignStaff('${s.id}', '${shiftId}', '${date}')">
                    <strong>${escapeHtml(s.name)}</strong>
                    <span style="color: var(--text-muted); font-size: 12px;">$${s.hourlyRate}/hr</span>
                </div>`
            ).join('');
            
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            const dateObj = new Date(date);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'quick-fill-modal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Quick Fill: ${ROLE_LABELS[role]}</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <p style="padding: 0 16px; color: var(--text-muted); font-size: 13px;">
                        ${shift?.name || 'Shift'} on ${DAYS[dateObj.getDay()]} ${formatDate(dateObj, 'short')}
                    </p>
                    <div style="padding: 16px; display: grid; gap: 8px;">
                        ${staffOptions}
                    </div>
                    <div style="padding: 12px 16px; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-secondary btn-full" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            // Add styles for quick-fill options
            const style = document.createElement('style');
            style.textContent = `
                .quick-fill-option {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 16px;
                    background: var(--bg-tertiary);
                    border-radius: var(--radius);
                    cursor: pointer;
                    transition: all 0.15s ease;
                }
                .quick-fill-option:hover {
                    background: var(--accent-light);
                    transform: translateX(4px);
                }
            `;
            modal.appendChild(style);
            document.body.appendChild(modal);
        }

        function quickAssignStaff(staffId, shiftId, date) {
            if (!state.schedule[date]) state.schedule[date] = {};
            if (!state.schedule[date][shiftId]) state.schedule[date][shiftId] = [];
            
            const staff = state.staff.find(s => s.id === staffId);
            
            // Check if already assigned
            if (state.schedule[date][shiftId].find(a => a.staffId === staffId)) {
                showToast(`${staff.name} is already assigned to this shift`, 'error');
                return;
            }
            
            state.schedule[date][shiftId].push({
                staffId: staffId,
                role: staff.role
            });
            
            saveState();
            document.getElementById('quick-fill-modal')?.remove();
            renderDashboard();
            renderSchedule();
            showToast(`Assigned ${staff.name} to shift`, 'success');
        }

        // ============================================
        // SWAP REQUEST MANAGEMENT
        // ============================================
        
        function updateSwapBadges() {
            const pendingSwaps = state.swapRequests.filter(r => 
                r.status === 'pending_target' || r.status === 'pending_manager'
            ).length;
            
            const swapBadge = document.getElementById('swap-badge');
            const approvalBadge = document.getElementById('approval-badge');
            
            if (pendingSwaps > 0) {
                swapBadge.textContent = pendingSwaps;
                swapBadge.style.display = 'inline';
            } else {
                swapBadge.style.display = 'none';
            }
            
            const managerPending = state.swapRequests.filter(r => r.status === 'pending_manager').length;
            if (managerPending > 0) {
                approvalBadge.textContent = managerPending;
                approvalBadge.style.display = 'inline';
            } else {
                approvalBadge.style.display = 'none';
            }
        }

        function renderSwapRequests() {
            const mySwaps = document.getElementById('my-swap-requests');
            const incomingSwaps = document.getElementById('incoming-swaps');
            
            if (!mySwaps || !incomingSwaps) return;
            
            // For demo, show all requests
            const requests = state.swapRequests || [];
            
            if (requests.length === 0) {
                mySwaps.innerHTML = '<p class="empty-state">No pending swap requests</p>';
                incomingSwaps.innerHTML = '<p class="empty-state">No incoming swap offers</p>';
                return;
            }

            let myHtml = '';
            let incomingHtml = '';
            
            requests.forEach(req => {
                const requester = state.staff.find(s => s.id === req.requesterId);
                const target = state.staff.find(s => s.id === req.targetId);
                
                if (!requester || !target) return;
                
                const cardHtml = `
                    <div class="swap-card">
                        <div class="swap-details">
                            <div class="swap-title">${escapeHtml(requester.name)} â‡„ ${escapeHtml(target.name)}</div>
                            <div class="swap-meta">
                                ${req.day !== null ? DAYS[req.day] : 'All shifts'} â€¢ 
                                Created ${new Date(req.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <span class="swap-status ${req.status.includes('pending') ? 'pending' : req.status}">${req.status.replace('_', ' ')}</span>
                        ${req.status === 'pending_target' ? `
                            <div class="swap-actions">
                                <button class="btn btn-sm btn-success" onclick="acceptSwap('${req.id}')">Accept</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectSwap('${req.id}')">Decline</button>
                            </div>
                        ` : ''}
                        ${req.status === 'pending_manager' ? `
                            <div class="swap-actions">
                                <button class="btn btn-sm btn-success" onclick="approveSwap('${req.id}')">Approve</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectSwap('${req.id}')">Reject</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                myHtml += cardHtml;
            });
            
            mySwaps.innerHTML = myHtml || '<p class="empty-state">No pending swap requests</p>';
            incomingSwaps.innerHTML = incomingHtml || '<p class="empty-state">No incoming swap offers</p>';
            
            // Also render approvals page
            renderApprovals();
        }

        function renderApprovals() {
            const pendingSwaps = document.getElementById('pending-swap-approvals');
            if (!pendingSwaps) return;
            
            const managerRequests = (state.swapRequests || []).filter(r => r.status === 'pending_manager');
            
            if (managerRequests.length === 0) {
                pendingSwaps.innerHTML = '<p class="empty-state">No pending approvals</p>';
                return;
            }

            let html = '';
            managerRequests.forEach(req => {
                const requester = state.staff.find(s => s.id === req.requesterId);
                const target = state.staff.find(s => s.id === req.targetId);
                
                if (!requester || !target) return;
                
                html += `
                    <div class="swap-card">
                        <div class="swap-details">
                            <div class="swap-title">Shift Swap: ${escapeHtml(requester.name)} â‡„ ${escapeHtml(target.name)}</div>
                            <div class="swap-meta">Both parties have agreed â€¢ Awaiting manager approval</div>
                        </div>
                        <div class="swap-actions">
                            <button class="btn btn-sm btn-success" onclick="approveSwap('${req.id}')">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectSwap('${req.id}')">Reject</button>
                        </div>
                    </div>
                `;
            });
            
            pendingSwaps.innerHTML = html;
        }

        function acceptSwap(id) {
            const req = state.swapRequests.find(r => r.id === id);
            if (req) {
                req.status = 'pending_manager';
                saveState();
                updateSwapBadges();
                renderSwapRequests();
                showToast('Swap accepted! Awaiting manager approval.', 'success');
            }
        }

        function approveSwap(id) {
            const req = state.swapRequests.find(r => r.id === id);
            if (req) {
                // Actually perform the swap in the schedule
                const requester = state.staff.find(s => s.id === req.requesterId);
                const target = state.staff.find(s => s.id === req.targetId);
                
                // Swap their shifts for the week
                const weekDates = getWeekDates(state.currentWeekStart);
                weekDates.forEach(date => {
                    if (req.day !== null && date.getDay() !== req.day) return;
                    
                    const dateKey = formatDate(date, 'iso');
                    if (state.schedule[dateKey]) {
                        Object.keys(state.schedule[dateKey]).forEach(shiftId => {
                            const assignments = state.schedule[dateKey][shiftId];
                            const reqIdx = assignments.findIndex(a => a.staffId === req.requesterId);
                            const targIdx = assignments.findIndex(a => a.staffId === req.targetId);
                            
                            // Swap them
                            if (reqIdx !== -1 && targIdx !== -1) {
                                [assignments[reqIdx].staffId, assignments[targIdx].staffId] = 
                                [assignments[targIdx].staffId, assignments[reqIdx].staffId];
                            }
                        });
                    }
                });
                
                req.status = 'approved';
                saveState();
                updateSwapBadges();
                renderSwapRequests();
                renderSchedule();
                renderDashboard();
                showToast(`Swap approved: ${requester.name} â‡„ ${target.name}`, 'success');
            }
        }

        function rejectSwap(id) {
            const req = state.swapRequests.find(r => r.id === id);
            if (req) {
                req.status = 'rejected';
                saveState();
                updateSwapBadges();
                renderSwapRequests();
                showToast('Swap request rejected', 'info');
            }
        }

        function openSwapRequestModal() {
            // Simple prompt for now
            const emp1 = prompt('Your name (or first name):');
            const emp2 = prompt('Swap with (name):');
            
            if (emp1 && emp2) {
                executeCommand(`swap ${emp1} and ${emp2}`);
            }
        }

        // ============================================
        // INIT
        // ============================================
        function init() {
            loadState();
            loadSampleData();
            
            // Initialize swap requests if not present
            if (!state.swapRequests) state.swapRequests = [];
            if (!state.timeOffRequests) state.timeOffRequests = [];
            
            // Navigation click handlers
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });
            
            // Initialize day picker
            document.getElementById('day-picker').value = state.selectedDay;

            // Initial render
            renderDashboard();
            renderSchedule();
            renderStaffTable();
            renderShiftTemplates();
            renderHolidays();
            renderLaborCosts();
            renderSwapRequests();
            renderMarketplace();
            updateSwapBadges();
            updateMarketBadge();
        }

        // ============================================
        // FIREBASE INTEGRATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCrBQKmHV9zzS6XUc3cleuIck2Xli30jQo",
            authDomain: "scheduler-d2be6.firebaseapp.com",
            projectId: "scheduler-d2be6",
            storageBucket: "scheduler-d2be6.firebasestorage.app",
            messagingSenderId: "752240565816",
            appId: "1:752240565816:web:a04845e817d864a95510cd",
            measurementId: "G-LZV3BQELLB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userRole = 'employee';
        let organizationId = null;

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user.uid);
                showApp();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        async function loadUserData(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    userRole = data.role || 'employee';
                    organizationId = data.organizationId;

                    // Load organization data
                    if (organizationId) {
                        await loadOrganizationData();
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadOrganizationData() {
            try {
                const scheduleDoc = await db.collection('schedules').doc(organizationId).get();
                if (scheduleDoc.exists) {
                    const data = scheduleDoc.data();
                    if (data.staff) state.staff = data.staff;
                    if (data.shiftTemplates) state.shiftTemplates = data.shiftTemplates;
                    if (data.schedule) state.schedule = data.schedule;
                    if (data.holidays) state.holidays = data.holidays;
                    if (data.swapRequests) state.swapRequests = data.swapRequests;
                    if (data.timeOffRequests) state.timeOffRequests = data.timeOffRequests;
                }
            } catch (error) {
                console.error('Error loading organization data:', error);
            }
        }

        async function saveToFirestore() {
            if (!organizationId || userRole !== 'manager') return;

            try {
                await db.collection('schedules').doc(organizationId).set({
                    staff: state.staff,
                    shiftTemplates: state.shiftTemplates,
                    schedule: state.schedule,
                    holidays: state.holidays,
                    swapRequests: state.swapRequests || [],
                    timeOffRequests: state.timeOffRequests || [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                }, { merge: true });

                showSyncStatus('synced');
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                showSyncStatus('error');
            }
        }

        function showSyncStatus(status) {
            const indicator = document.getElementById('sync-indicator');
            if (!indicator) return;

            if (status === 'syncing') {
                indicator.classList.add('syncing');
                indicator.querySelector('span').textContent = 'Syncing...';
            } else if (status === 'synced') {
                indicator.classList.remove('syncing');
                indicator.querySelector('span').textContent = 'Synced';
            } else {
                indicator.classList.remove('syncing');
                indicator.querySelector('span').textContent = 'Sync error';
            }
        }

        // Override saveState to also save to Firestore
        const originalSaveState = saveState;
        saveState = function() {
            originalSaveState();
            if (currentUser && userRole === 'manager') {
                showSyncStatus('syncing');
                saveToFirestore();
            }
        };

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').style.display = 'flex';

            // Update user display
            updateUserDisplay();

            // Initialize app
            init();
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').style.display = 'none';
        }

        let organizationCode = null;

        async function updateUserDisplay() {
            const userArea = document.getElementById('user-area');
            if (userArea && currentUser) {
                // Get org code for managers
                if (userRole === 'manager' && organizationId) {
                    const orgDoc = await db.collection('organizations').doc(organizationId).get();
                    if (orgDoc.exists) {
                        organizationCode = orgDoc.data().code;
                    }
                }

                const initial = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : currentUser.email.charAt(0).toUpperCase();
                userArea.innerHTML = `
                    <div class="sync-indicator" id="sync-indicator">
                        <div class="dot"></div>
                        <span>Synced</span>
                    </div>
                    ${userRole === 'manager' && organizationCode ? `
                        <div style="margin: 12px 0; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">Share this code with employees</div>
                            <div style="font-size: 18px; font-weight: 700; letter-spacing: 2px; color: var(--accent);" onclick="copyOrgCode()" title="Click to copy">${organizationCode}</div>
                        </div>
                    ` : ''}
                    <div class="user-menu">
                        <div class="user-badge" onclick="toggleUserDropdown()">
                            <div class="avatar">${initial}</div>
                            <span>${currentUser.displayName || currentUser.email.split('@')[0]}</span>
                            <span style="font-size: 10px; color: var(--text-muted);">${userRole}</span>
                        </div>
                        <div class="user-dropdown" id="user-dropdown">
                            <div class="user-dropdown-item" onclick="showProfile()">
                                <span>ðŸ‘¤</span> My Profile
                            </div>
                            ${userRole === 'manager' ? `
                                <div class="user-dropdown-item" onclick="showOrgSettings()">
                                    <span>âš™ï¸</span> Organization Settings
                                </div>
                                <div class="user-dropdown-item" onclick="showInviteModal()">
                                    <span>ðŸ“§</span> Invite Employees
                                </div>
                            ` : ''}
                            <div class="user-dropdown-item danger" onclick="signOut()">
                                <span>ðŸšª</span> Sign Out
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function copyOrgCode() {
            if (organizationCode) {
                navigator.clipboard.writeText(organizationCode);
                showToast('Organization code copied!', 'success');
            }
        }

        function showInviteModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'invite-modal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Invite Employees</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div style="padding: 16px;">
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                            Share your organization code with employees so they can join your schedule.
                        </p>

                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Organization Code</div>
                            <div style="font-size: 32px; font-weight: 800; letter-spacing: 4px; color: var(--accent);">${organizationCode}</div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="copyOrgCode()">ðŸ“‹ Copy Code</button>
                        </div>

                        <div class="login-divider">Or invite by email</div>

                        <div style="display: flex; gap: 8px;">
                            <input type="email" id="invite-email" placeholder="employee@email.com" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary);">
                            <button class="btn btn-primary" onclick="sendInvite()">Send</button>
                        </div>

                        <p style="font-size: 11px; color: var(--text-muted); margin-top: 12px;">
                            The employee will receive an email with instructions to join your organization.
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function sendInvite() {
            const email = document.getElementById('invite-email')?.value?.trim();
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }

            try {
                // Save invite to Firestore
                await db.collection('invites').add({
                    email: email.toLowerCase(),
                    organizationId: organizationId,
                    organizationCode: organizationCode,
                    invitedBy: currentUser.uid,
                    invitedByName: currentUser.displayName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });

                showToast(`Invite sent to ${email}`, 'success');
                document.getElementById('invite-email').value = '';
                document.getElementById('invite-modal')?.remove();
            } catch (error) {
                console.error('Error sending invite:', error);
                showToast('Failed to send invite', 'error');
            }
        }

        function toggleUserDropdown() {
            document.getElementById('user-dropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                const dropdown = document.getElementById('user-dropdown');
                if (dropdown) dropdown.classList.remove('show');
            }
        });

        async function signOut() {
            try {
                await auth.signOut();
                showToast('Signed out successfully');
            } catch (error) {
                showToast('Error signing out', 'error');
            }
        }

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const errorEl = document.getElementById('login-error');

            btn.disabled = true;
            btn.textContent = 'Signing in...';
            errorEl.classList.remove('show');

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        });

        // Signup form handler
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const role = document.querySelector('.role-option.selected')?.dataset.role || 'employee';
            const orgCode = document.getElementById('signup-org-code')?.value?.toUpperCase().trim();
            const btn = document.getElementById('signup-btn');
            const errorEl = document.getElementById('login-error');

            btn.disabled = true;
            btn.textContent = 'Creating account...';
            errorEl.classList.remove('show');

            try {
                let orgId = null;

                // For employees, verify organization code first
                if (role === 'employee') {
                    if (!orgCode) {
                        throw { code: 'custom/no-org-code' };
                    }

                    // Look up organization by code
                    const orgQuery = await db.collection('organizations')
                        .where('code', '==', orgCode)
                        .limit(1)
                        .get();

                    if (orgQuery.empty) {
                        throw { code: 'custom/invalid-org-code' };
                    }

                    orgId = orgQuery.docs[0].id;
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);

                // Update display name
                await userCredential.user.updateProfile({ displayName: name });

                // Create organization for managers
                if (role === 'manager') {
                    // Generate a unique 6-character code
                    const orgCodeGen = generateOrgCode();

                    const orgRef = await db.collection('organizations').add({
                        name: `${name}'s Restaurant`,
                        code: orgCodeGen,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        ownerId: userCredential.user.uid
                    });
                    orgId = orgRef.id;

                    // Create empty schedule doc
                    await db.collection('schedules').doc(orgId).set({
                        staff: [],
                        shiftTemplates: [],
                        schedule: {},
                        holidays: [],
                        swapRequests: [],
                        timeOffRequests: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Save user data
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: role,
                    organizationId: orgId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            } catch (error) {
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        function generateOrgCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function selectRole(element) {
            document.querySelectorAll('.role-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            // Show/hide org code field for employees
            const orgCodeField = document.getElementById('org-code-field');
            if (element.dataset.role === 'employee') {
                orgCodeField.style.display = 'block';
            } else {
                orgCodeField.style.display = 'none';
            }
        }

        let isSignupMode = false;
        function toggleAuthMode() {
            isSignupMode = !isSignupMode;
            document.getElementById('login-form').style.display = isSignupMode ? 'none' : 'flex';
            document.getElementById('signup-form').style.display = isSignupMode ? 'flex' : 'none';
            document.getElementById('login-toggle').innerHTML = isSignupMode
                ? 'Already have an account? <a onclick="toggleAuthMode()">Sign in</a>'
                : 'Don\'t have an account? <a onclick="toggleAuthMode()">Sign up</a>';
            document.getElementById('login-error').classList.remove('show');
        }

        function getAuthErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Invalid email address',
                'auth/user-disabled': 'This account has been disabled',
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'An account with this email already exists',
                'auth/weak-password': 'Password must be at least 6 characters',
                'auth/network-request-failed': 'Network error. Please check your connection.',
                'custom/no-org-code': 'Please enter your organization code from your manager',
                'custom/invalid-org-code': 'Invalid organization code. Please check with your manager.'
            };
            return messages[code] || 'An error occurred. Please try again.';
        }

        function showProfile() {
            showToast('Profile settings coming soon');
        }

        function showOrgSettings() {
            showToast('Organization settings coming soon');
        }

        // Don't auto-init, wait for auth
        // init();
    </script>
</body>
</html>
