<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StaffSync - Restaurant Staff Scheduler</title>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrBQKmHV9zzS6XUc3cleuIck2Xli30jQo",
            authDomain: "scheduler-d2be6.firebaseapp.com",
            projectId: "scheduler-d2be6",
            storageBucket: "scheduler-d2be6.firebasestorage.app",
            messagingSenderId: "752240565816",
            appId: "1:752240565816:web:a04845e817d864a95510cd",
            measurementId: "G-LZV3BQELLB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;

        // Notify app that Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-light: #dbeafe;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
            
            /* Professional muted role colors - using subtle indicators */
            --role-server: #6366f1;
            --role-cook: #8b5cf6;
            --role-host: #06b6d4;
            --role-bartender: #f59e0b;
            --role-busser: #10b981;
            --role-manager: #1f2937;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.08);
            --radius: 6px;
            --radius-lg: 8px;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --accent-light: #1e3a5a;
            --success-light: #064e3b;
            --warning-light: #78350f;
            --danger-light: #7f1d1d;
            --info-light: #0c4a6e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 16px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 24px 32px;
            min-height: 100vh;
            max-width: 1400px;
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .logo-text {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.3px;
        }

        .logo-sub {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Navigation */
        .nav-section {
            margin-bottom: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
            padding-left: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .nav-item .icon {
            font-size: 15px;
            width: 20px;
            text-align: center;
            opacity: 0.8;
        }

        /* Theme Toggle */
        .theme-toggle {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .toggle-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Day Checkbox */
        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 13px;
        }
        .day-checkbox:has(input:checked) {
            background: var(--accent-light);
            border-color: var(--accent);
        }
        .day-checkbox input {
            display: none;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.4px;
            color: var(--text-primary);
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: 1px solid transparent;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 6px;
            min-width: 32px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* AI Command Input */
        .ai-command-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--accent-light));
            border: 1px solid var(--accent);
        }

        .ai-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-icon {
            font-size: 20px;
        }

        .ai-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .ai-input::placeholder {
            color: var(--text-muted);
            font-size: 12px;
        }

        .ai-response {
            margin-top: 12px;
            padding: 12px;
            border-radius: var(--radius);
            font-size: 13px;
            line-height: 1.5;
            display: none;
        }

        .ai-response.visible {
            display: block;
        }

        .ai-response.success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .ai-response.info {
            background: var(--info-light);
            color: var(--info);
            border: 1px solid var(--info);
        }

        .ai-response.error {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .stat-card.clickable,
        .alert-item.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-card.clickable:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .alert-item.clickable:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .alert-action-hint {
            color: var(--text-muted);
            font-size: 16px;
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .alert-item.clickable:hover .alert-action-hint {
            opacity: 1;
            color: var(--accent);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Forms */
        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        /* Role Badges - Professional subtle style */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .role-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .role-badge.server::before { background: var(--role-server); }
        .role-badge.cook::before { background: var(--role-cook); }
        .role-badge.host::before { background: var(--role-host); }
        .role-badge.bartender::before { background: var(--role-bartender); }
        .role-badge.busser::before { background: var(--role-busser); }
        .role-badge.manager::before { background: var(--role-manager); }

        /* Certification Badges */
        .cert-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .cert-badge.active {
            background: var(--success-light);
            color: var(--success);
        }

        /* Schedule Grid */
        .schedule-container {
            overflow-x: auto;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-width: 800px;
        }

        .schedule-cell {
            background: var(--bg-secondary);
            padding: 10px;
            min-height: 90px;
            position: relative;
        }

        .schedule-header {
            background: var(--bg-tertiary);
            font-weight: 500;
            font-size: 12px;
            text-align: center;
            min-height: auto;
            padding: 12px 10px;
            color: var(--text-secondary);
        }

        .schedule-header.today {
            background: var(--accent);
            color: white;
        }

        .schedule-shift-label {
            font-weight: 500;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-secondary);
        }

        .schedule-shift-label .time {
            font-size: 10px;
            font-weight: 400;
            color: var(--text-muted);
            display: block;
        }

        .shift-chip {
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-left: 3px solid var(--text-muted);
        }

        .shift-chip:hover {
            background: var(--border-color);
        }

        .shift-chip.server { border-left-color: var(--role-server); }
        .shift-chip.cook { border-left-color: var(--role-cook); }
        .shift-chip.host { border-left-color: var(--role-host); }
        .shift-chip.bartender { border-left-color: var(--role-bartender); }
        .shift-chip.busser { border-left-color: var(--role-busser); }
        .shift-chip.manager { border-left-color: var(--role-manager); }

        .shift-chip .remove-shift {
            opacity: 0;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
            color: var(--text-muted);
        }

        .shift-chip:hover .remove-shift {
            opacity: 1;
        }

        .add-shift-btn {
            width: 100%;
            padding: 6px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-top: 4px;
        }

        .add-shift-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }

        /* Conflict Indicators */
        .conflict-indicator {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: help;
            font-weight: 600;
        }

        .conflict-indicator.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .conflict-indicator.danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Week Navigation */
        .week-nav {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .week-nav-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .week-nav-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .week-display {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            width: fit-content;
        }

        .view-tab {
            padding: 6px 14px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.15s ease;
        }

        .view-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .view-tab:hover:not(.active) {
            color: var(--text-secondary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 20px;
            max-width: 560px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(10px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .assign-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .assign-option:hover {
            background: var(--bg-tertiary);
        }

        .assign-option:last-child {
            border-bottom: none;
        }

        @keyframes highlight-pulse {
            0%, 100% { background: transparent; }
            50% { background: var(--accent-light); }
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* Availability Grid */
        .availability-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 3px;
            margin-top: 10px;
        }

        .avail-header {
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            padding: 6px 3px;
            color: var(--text-muted);
        }

        .avail-label {
            font-size: 11px;
            padding: 6px;
            display: flex;
            align-items: center;
            color: var(--text-secondary);
        }

        .avail-cell {
            width: 100%;
            height: 30px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .avail-cell.available {
            background: var(--success);
            border-color: var(--success);
        }

        .avail-cell:hover {
            border-color: var(--accent);
        }

        /* Employee View */
        .employee-schedule {
            display: grid;
            gap: 12px;
        }

        .employee-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 14px;
        }

        .employee-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .employee-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .employee-shifts {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .employee-shift-chip {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .employee-shift-chip .day {
            font-weight: 600;
            color: var(--text-primary);
        }

        .employee-hours {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        .hours-warning {
            color: var(--warning);
        }

        .hours-danger {
            color: var(--danger);
        }

        /* Day View */
        .day-view-container {
            display: grid;
            gap: 16px;
        }

        .shift-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .shift-section-header {
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-section-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .shift-section-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .shift-staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            padding: 14px;
        }

        .staff-slot {
            padding: 10px;
            border-radius: var(--radius);
            text-align: center;
        }

        .staff-slot.filled {
            background: var(--bg-tertiary);
        }

        .staff-slot.empty {
            border: 1px dashed var(--border-color);
            color: var(--text-muted);
        }

        .staff-slot.warning {
            border: 1px dashed var(--warning);
            background: var(--warning-light);
            color: var(--warning);
        }

        .staff-slot-name {
            font-weight: 500;
            margin-bottom: 2px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .staff-slot-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Alerts Panel */
        .alerts-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 6px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-item.warning {
            background: var(--warning-light);
        }

        .alert-item.danger {
            background: var(--danger-light);
        }

        .alert-item.info {
            background: var(--info-light);
        }

        .alert-icon {
            font-size: 14px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
        }

        .alert-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .alert-action {
            font-size: 12px;
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        /* Labor Cost Display */
        .labor-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-top: 14px;
        }

        .labor-item {
            text-align: center;
        }

        .labor-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
        }

        .labor-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Print Styles */
        .print-container {
            display: none;
        }

        @media print {
            .sidebar, .header-actions, .week-nav-btn, .add-shift-btn, .remove-shift {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .schedule-grid {
                font-size: 10px;
            }

            .shift-chip {
                padding: 2px 4px;
                font-size: 9px;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -240px;
                z-index: 100;
                transition: left 0.2s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .header-actions {
                width: 100%;
                flex-wrap: wrap;
            }

            .header-actions .btn {
                flex: 1;
                min-width: 80px;
                justify-content: center;
                font-size: 12px;
                padding: 8px 10px;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .schedule-grid {
                min-width: 600px;
                font-size: 11px;
            }

            .schedule-cell {
                padding: 6px;
                min-height: 70px;
            }

            .shift-chip {
                font-size: 10px;
                padding: 4px 6px;
            }

            .week-nav {
                flex-wrap: wrap;
                gap: 8px;
            }

            .week-display {
                font-size: 14px;
                order: -1;
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 12px;
            }

            .page-title {
                font-size: 18px;
            }

            .header-actions .btn {
                font-size: 11px;
                padding: 6px 8px;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 12px;
            }

            .card {
                padding: 12px;
            }

            .modal {
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .availability-grid {
                font-size: 10px;
                overflow-x: auto;
            }

            .avail-cell {
                min-width: 28px;
                min-height: 28px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
            }

            .template-card {
                padding: 12px;
            }

            .view-tabs {
                width: 100%;
            }

            .view-tab {
                flex: 1;
                justify-content: center;
            }

            .employee-card {
                padding: 12px;
            }

            .labor-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            z-index: 99;
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Hidden sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Shift Templates Section */
        .shift-templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
        }

        .template-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }

        .template-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .template-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .template-requirements {
            display: grid;
            gap: 6px;
        }

        .req-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .req-count {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Holiday management */
        .holiday-list {
            display: grid;
            gap: 6px;
        }

        .holiday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
        }

        .holiday-date {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
        }

        .holiday-name {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .toast {
            padding: 12px 16px;
            border-radius: var(--radius);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.2s ease;
            font-size: 13px;
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        .toast.warning {
            border-left: 3px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background: var(--accent-light) !important;
            border: 1px dashed var(--accent) !important;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            margin: 20px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin: 0 auto 12px;
        }

        .login-logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .login-logo p {
            color: #6b7280;
            font-size: 14px;
            margin-top: 4px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .login-input {
            padding: 14px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .login-btn {
            padding: 14px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: #1d4ed8;
        }

        .login-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .login-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #6b7280;
        }

        .login-toggle a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .login-error.visible {
            display: block;
        }

        .login-success {
            background: #d1fae5;
            color: #059669;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .login-success.visible {
            display: block;
        }

        .login-loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .role-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .role-btn {
            flex: 1;
            padding: 16px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .role-btn:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }

        .role-btn.active {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .role-btn-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .role-btn-title {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
        }

        .role-btn-desc {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        .org-code-display {
            background: #f1f5f9;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin-bottom: 16px;
        }

        .org-code-label {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .org-code-value {
            font-size: 18px;
            font-weight: 700;
            font-family: monospace;
            color: #1e40af;
            letter-spacing: 1px;
        }

        .org-code-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 8px;
        }

        .signup-section {
            display: none;
        }

        .signup-section.visible {
            display: block;
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            color: #9ca3af;
            font-size: 12px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e7eb;
        }

        .org-code-sidebar {
            margin: 16px;
            padding: 12px;
            background: var(--accent-light);
            border-radius: var(--radius);
            text-align: center;
            border: 1px dashed var(--accent);
        }
        .org-code-label-sm {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .org-code-value-sm {
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .org-code-value-sm:hover {
            background: var(--bg-secondary);
        }
        .org-code-hint-sm {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--text-secondary);
            margin: 16px;
            margin-top: auto;
        }

        .user-badge-email {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logout-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .logout-btn:hover {
            background: var(--danger-light);
            border-color: var(--danger);
            color: var(--danger);
        }

        .app-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 16px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <div class="login-logo-icon">S</div>
                <h1>StaffSync</h1>
                <p>Restaurant Staff Scheduling</p>
            </div>

            <div class="login-error" id="loginError"></div>
            <div class="login-success" id="loginSuccess"></div>

            <!-- Sign In Form -->
            <div id="signInSection">
                <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                    <input type="email" class="login-input" id="loginEmail" placeholder="Email address" required>
                    <input type="password" class="login-input" id="loginPassword" placeholder="Password" required minlength="6">
                    <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
                </form>
                <div class="login-toggle">
                    Don't have an account? <a onclick="showSignupOptions()">Sign Up</a>
                </div>
            </div>

            <!-- Sign Up Options -->
            <div id="signUpSection" class="signup-section">
                <p style="text-align: center; margin-bottom: 16px; font-size: 14px; color: #4b5563;">I am a...</p>
                <div class="role-selector">
                    <button type="button" class="role-btn" onclick="selectSignupRole('manager')">
                        <div class="role-btn-icon"></div>
                        <div class="role-btn-title">Manager</div>
                        <div class="role-btn-desc">Create new restaurant</div>
                    </button>
                    <button type="button" class="role-btn" onclick="selectSignupRole('manager-join')">
                        <div class="role-btn-icon"></div>
                        <div class="role-btn-title">Invited Manager</div>
                        <div class="role-btn-desc">Join as manager (invited)</div>
                    </button>
                    <button type="button" class="role-btn" onclick="selectSignupRole('employee')">
                        <div class="role-btn-icon"></div>
                        <div class="role-btn-title">Employee</div>
                        <div class="role-btn-desc">Join existing restaurant</div>
                    </button>
                </div>
                <div class="login-toggle">
                    Already have an account? <a onclick="showSignIn()">Sign In</a>
                </div>
            </div>

            <!-- Manager Signup -->
            <div id="managerSignupSection" class="signup-section">
                <p style="text-align: center; margin-bottom: 8px; font-size: 14px; color: #4b5563;">Create Your Restaurant</p>
                <div class="org-code-display">
                    <div class="org-code-label">Your Organization Code</div>
                    <div class="org-code-value" id="generatedOrgCode">XXXX-0000</div>
                    <div class="org-code-hint">Share this code with your staff</div>
                </div>
                <form class="login-form" onsubmit="handleManagerSignup(event)">
                    <input type="text" class="login-input" id="managerRestaurantName" placeholder="Restaurant name" required oninput="updateOrgCodeFromName()">
                    <input type="email" class="login-input" id="managerEmail" placeholder="Your email" required>
                    <input type="password" class="login-input" id="managerPassword" placeholder="Password (min 6 chars)" required minlength="6">
                    <button type="submit" class="login-btn" id="managerSignupBtn">Create Restaurant</button>
                </form>
                <div class="login-toggle">
                    <a onclick="showSignupOptions()"> Back</a>
                </div>
            </div>

            <!-- Employee Signup -->
            <div id="employeeSignupSection" class="signup-section">
                <p style="text-align: center; margin-bottom: 16px; font-size: 14px; color: #4b5563;">Join Your Restaurant</p>
                <form class="login-form" onsubmit="handleEmployeeSignup(event)">
                    <input type="text" class="login-input" id="employeeOrgCode" placeholder="Organization code (from your manager)" required style="text-transform: uppercase; font-family: monospace;">
                    <input type="text" class="login-input" id="employeeName" placeholder="Your full name" required>
                    <input type="email" class="login-input" id="employeeEmail" placeholder="Your email" required>
                    <input type="password" class="login-input" id="employeePassword" placeholder="Password (min 6 chars)" required minlength="6">
                    <button type="submit" class="login-btn" id="employeeSignupBtn">Join Restaurant</button>
                </form>
                <div class="login-toggle">
                    <a onclick="showSignupOptions()"> Back</a>
                </div>
            </div>

            <!-- Manager Join (Invited) Signup -->
            <div id="managerJoinSignupSection" class="signup-section">
                <p style="text-align: center; margin-bottom: 16px; font-size: 14px; color: #4b5563;">Join as Manager</p>
                <p style="text-align: center; margin-bottom: 16px; font-size: 12px; color: #6b7280;">You must be invited by an existing manager</p>
                <form class="login-form" onsubmit="handleManagerJoinSignup(event)">
                    <input type="text" class="login-input" id="managerJoinOrgCode" placeholder="Organization code" required style="text-transform: uppercase; font-family: monospace;">
                    <input type="text" class="login-input" id="managerJoinName" placeholder="Your full name" required>
                    <input type="email" class="login-input" id="managerJoinEmail" placeholder="Your email (must match invite)" required>
                    <input type="password" class="login-input" id="managerJoinPassword" placeholder="Password (min 6 chars)" required minlength="6">
                    <button type="submit" class="login-btn" id="managerJoinSignupBtn">Join as Manager</button>
                </form>
                <div class="login-toggle">
                    <a onclick="showSignupOptions()"> Back</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">S</div>
                <div>
                    <div class="logo-text">StaffSync</div>
                    <div class="logo-sub">Staff Scheduling</div>
                </div>
            </div>

            <nav>
                <div class="nav-section">
                    <div class="nav-label">Schedule</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="icon"></span>
                        Dashboard
                    </div>
                    <div class="nav-item" data-page="schedule">
                        <span class="icon"></span>
                        Week Schedule
                    </div>
                    <div class="nav-item" data-page="day-view">
                        <span class="icon"></span>
                        Day View
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Management</div>
                    <div class="nav-item" data-page="staff">
                        <span class="icon"></span>
                        Staff
                    </div>
                    <div class="nav-item" data-page="shifts">
                        <span class="icon"></span>
                        Shift Templates
                    </div>
                    <div class="nav-item" data-page="holidays">
                        <span class="icon"></span>
                        Holidays
                    </div>
                    <div class="nav-item manager-only" data-page="team" id="navTeam" style="display: none;">
                        <span class="icon"></span>
                        Team & Invites
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Employee</div>
                    <div class="nav-item" data-page="shift-market">
                        <span class="icon"></span>
                        Shift Marketplace
                    </div>
                    <div class="nav-item" data-page="my-preferences">
                        <span class="icon"></span>
                        My Preferences
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Reports</div>
                    <div class="nav-item manager-only" data-page="labor" id="navLabor">
                        <span class="icon"></span>
                        Labor Costs
                    </div>
                </div>
            </nav>

            <div class="theme-toggle">
                <button class="toggle-btn" onclick="toggleTheme()">
                    <span id="theme-icon"></span>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>

            <div class="org-code-sidebar" id="orgCodeSidebar" style="display: none;">
                <div class="org-code-label-sm">Organization Code</div>
                <div class="org-code-value-sm" id="sidebarOrgCode" onclick="copyOrgCodeFromSidebar()">---</div>
                <div class="org-code-hint-sm">Click to copy</div>
            </div>

            <div class="user-badge" id="userBadge">
                <span></span>
                <span class="user-badge-email" id="userEmail">user@email.com</span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard -->
            <section class="page-section active" id="page-dashboard">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Week of <span id="dashboard-week"></span></p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="autoSchedule()">
                            Auto-Schedule
                        </button>
                        <button class="btn btn-secondary" onclick="exportSchedule()">
                            Export
                        </button>
                    </div>
                </div>

                <!-- AI Command Input -->
                <div class="card ai-command-card">
                    <div class="ai-input-wrapper">
                        <span class="ai-icon"></span>
                        <input type="text" id="ai-command" class="ai-input" placeholder="Try: &quot;Dave has been slacking, cut his hours&quot; or &quot;Sarah is doing great, give her more shifts&quot; or &quot;Swap Tom and Mike on Friday&quot;" onkeydown="if(event.key==='Enter')processAICommand()">
                        <button class="btn btn-primary btn-sm" onclick="processAICommand()">Go</button>
                    </div>
                    <div id="ai-response" class="ai-response"></div>
                </div>

                <div class="stats-row" id="dashboard-stats">
                    <!-- Stats populated by JS -->
                </div>

                <div class="alerts-panel" id="alerts-panel">
                    <div class="card-header">
                        <h3 class="card-title">Alerts & Suggestions</h3>
                    </div>
                    <div id="alerts-list">
                        <!-- Alerts populated by JS -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">This Week's Schedule</h3>
                        <button class="btn btn-sm btn-secondary" onclick="navigateTo('schedule')">View Full Schedule </button>
                    </div>
                    <div class="schedule-container" id="dashboard-schedule-preview">
                        <!-- Mini schedule preview -->
                    </div>
                </div>
            </section>

            <!-- Week Schedule -->
            <section class="page-section" id="page-schedule">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Week Schedule</h1>
                        <p class="page-subtitle">Drag and drop to assign shifts</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="autoSchedule()">
                            Auto-Schedule
                        </button>
                        <button class="btn btn-secondary" onclick="clearWeekSchedule()">
                            Clear Week
                        </button>
                    </div>
                </div>

                <div class="week-nav">
                    <button class="week-nav-btn" onclick="changeWeek(-1)"> Previous</button>
                    <span class="week-display" id="week-display"></span>
                    <button class="week-nav-btn" onclick="changeWeek(1)">Next </button>
                    <button class="week-nav-btn" onclick="goToToday()">Today</button>
                </div>

                <div class="view-tabs">
                    <button class="view-tab active" data-view="grid" onclick="setScheduleView('grid')">Grid View</button>
                    <button class="view-tab" data-view="employee" onclick="setScheduleView('employee')">By Employee</button>
                </div>

                <div id="schedule-grid-view">
                    <div class="schedule-container">
                        <div class="schedule-grid" id="schedule-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div id="schedule-employee-view" style="display: none;">
                    <div class="employee-schedule" id="employee-schedule">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Day View -->
            <section class="page-section" id="page-day-view">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Day View</h1>
                        <p class="page-subtitle" id="day-view-date"></p>
                    </div>
                    <div class="header-actions">
                        <input type="date" id="day-picker" class="form-input" style="width: auto;" onchange="selectDay(this.value)">
                    </div>
                </div>

                <div class="day-view-container" id="day-view-container">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Staff Management -->
            <section class="page-section" id="page-staff">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Staff Management</h1>
                        <p class="page-subtitle">Manage employees and availability</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="openModal('csv-help-modal')" title="CSV Import Help">
                            ? Help
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('csv-upload').click()">
                             Import CSV
                        </button>
                        <input type="file" id="csv-upload" accept=".csv" style="display:none" onchange="importStaffCSV(event)">
                        <button class="btn btn-danger" onclick="deleteAllEmployees()">
                            Delete All
                        </button>
                        <button class="btn btn-primary" onclick="openStaffModal()">
                            + Add Employee
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table id="staff-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Hourly Rate</th>
                                    <th>Max Hours/Week</th>
                                    <th>Certifications</th>
                                    <th>This Week</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staff-tbody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Shift Templates -->
            <section class="page-section" id="page-shifts">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Shift Templates</h1>
                        <p class="page-subtitle">Define shift times and staffing requirements</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openShiftModal()">
                            + Add Shift Template
                        </button>
                    </div>
                </div>

                <div class="shift-templates-grid" id="shift-templates-grid">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Holidays -->
            <section class="page-section" id="page-holidays">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Holidays & Blackout Dates</h1>
                        <p class="page-subtitle">Manage special dates and closures</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openHolidayModal()">
                            + Add Holiday
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="holiday-list" id="holiday-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Labor Costs -->
            <section class="page-section" id="page-labor">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Labor Costs</h1>
                        <p class="page-subtitle">Weekly labor cost analysis</p>
                    </div>
                </div>

                <div class="stats-row" id="labor-stats">
                    <!-- Populated by JS -->
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cost Breakdown by Day</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Total Hours</th>
                                    <th>Labor Cost</th>
                                    <th>Staff Count</th>
                                </tr>
                            </thead>
                            <tbody id="labor-breakdown">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cost by Role</h3>
                    </div>
                    <div id="labor-by-role">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Team & Invites (Manager Only) -->
            <section class="page-section" id="page-team">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Team & Invites</h1>
                        <p class="page-subtitle">Manage your organization</p>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--accent-light); color: var(--accent);"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="org-code-display">---</div>
                            <div class="stat-label">Organization Code</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="copyOrgCode()" style="margin-left: auto;">Copy</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--success-light); color: var(--success);"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="manager-count">0</div>
                            <div class="stat-label">Managers</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--info-light); color: var(--info);"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="employee-count">0</div>
                            <div class="stat-label">Employees</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Invite Manager</h3>
                    </div>
                    <p style="padding: 0 16px 12px; font-size: 13px; color: var(--text-muted);">
                        Add email addresses to allow others to join as managers. They'll need your org code and the email you enter below.
                    </p>
                    <div style="padding: 0 16px 16px; display: flex; gap: 8px;">
                        <input type="email" class="form-input" id="invite-manager-email" placeholder="Email address to invite" style="flex: 1;">
                        <button class="btn btn-primary" onclick="inviteManager()">Invite</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Manager Invites</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Invited</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-invites-list">
                                <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No pending invites</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Invite Employee</h3>
                        <label class="toggle-switch" style="margin-left: auto;">
                            <input type="checkbox" id="require-employee-invite" onchange="toggleEmployeeInviteRequirement()">
                            <span class="toggle-slider"></span>
                            <span style="margin-left: 8px; font-size: 12px;">Require invite</span>
                        </label>
                    </div>
                    <p style="padding: 0 16px 12px; font-size: 13px; color: var(--text-muted);">
                        When enabled, only invited emails can join as employees. Otherwise anyone with the org code can join.
                    </p>
                    <div style="padding: 0 16px 16px; display: flex; gap: 8px;">
                        <input type="email" class="form-input" id="invite-employee-email" placeholder="Employee email address" style="flex: 1;">
                        <button class="btn btn-primary" onclick="inviteEmployee()">Invite</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Employee Invites</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-employee-invites-list">
                                <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No pending invites</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Team Members</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody id="team-members-list">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" id="pending-swaps-card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Shift Swaps</h3>
                        <span class="badge" id="pending-swaps-badge" style="display: none; background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                    </div>
                    <p style="padding: 0 16px 12px; font-size: 13px; color: var(--text-muted);">
                        Shift swaps require your approval before taking effect.
                    </p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-swaps-list">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No pending swaps</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Shift Marketplace -->
            <section class="page-section" id="page-shift-market">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Shift Marketplace</h1>
                        <p class="page-subtitle">Trade shifts with coworkers</p>
                    </div>
                    <button class="btn btn-primary" onclick="openPostShiftModal()">Post Shift for Trade</button>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--warning-light); color: var(--warning);"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="shifts-posted-count">0</div>
                            <div class="stat-label">Shifts Available</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--success-light); color: var(--success);"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="my-posts-count">0</div>
                            <div class="stat-label">My Posted Shifts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--info-light); color: var(--info);"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="pending-requests-count">0</div>
                            <div class="stat-label">Pending Requests</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Available Shifts</h3>
                        <span style="font-size: 12px; color: var(--text-muted);">Click to request a shift</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>Posted By</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="available-shifts-list">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No shifts available for trade</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Posted Shifts</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>Requests</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="my-posted-shifts-list">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">You haven't posted any shifts</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Shift Requests</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>Original Owner</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="my-shift-requests-list">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No pending requests</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- My Preferences -->
            <section class="page-section" id="page-my-preferences">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">My Preferences</h1>
                        <p class="page-subtitle">Set your availability and shift preferences</p>
                    </div>
                    <button class="btn btn-primary" onclick="saveMyPreferences()">Save Preferences</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Extra Shift Preferences</h3>
                    </div>
                    <div style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="pref-want-extra-shifts" onchange="updateExtraShiftUI()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div>
                                <div style="font-weight: 500;">I want extra shifts</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Auto-scheduler will prioritize you for open shifts</div>
                            </div>
                        </div>

                        <div id="extra-shift-days" style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius);">
                            <div style="font-weight: 500; margin-bottom: 12px;">Which days do you want extra shifts?</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <label class="day-checkbox"><input type="checkbox" id="extra-sun" checked> <span>Sunday</span></label>
                                <label class="day-checkbox"><input type="checkbox" id="extra-mon" checked> <span>Monday</span></label>
                                <label class="day-checkbox"><input type="checkbox" id="extra-tue" checked> <span>Tuesday</span></label>
                                <label class="day-checkbox"><input type="checkbox" id="extra-wed" checked> <span>Wednesday</span></label>
                                <label class="day-checkbox"><input type="checkbox" id="extra-thu" checked> <span>Thursday</span></label>
                                <label class="day-checkbox"><input type="checkbox" id="extra-fri" checked> <span>Friday</span></label>
                                <label class="day-checkbox"><input type="checkbox" id="extra-sat" checked> <span>Saturday</span></label>
                            </div>
                            <div style="margin-top: 12px;">
                                <label style="font-size: 13px;">Max extra hours per week:</label>
                                <input type="number" class="form-input" id="pref-max-extra-hours" value="10" min="0" max="40" style="width: 80px; margin-left: 8px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Notification Preferences</h3>
                    </div>
                    <div style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="pref-notify-new-shifts" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Notify me when new shifts are posted for trade</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="pref-notify-schedule-change" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Notify me when my schedule changes</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="pref-notify-request-status" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Notify me when my shift requests are approved/denied</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Schedule This Week</h3>
                    </div>
                    <div id="my-schedule-preview" style="padding: 16px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()"></button>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Staff Modal -->
    <div class="modal-overlay" id="staff-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="staff-modal-title">Add Employee</h2>
                <button class="modal-close" onclick="closeModal('staff-modal')"></button>
            </div>
            <form id="staff-form" onsubmit="saveStaff(event)">
                <input type="hidden" id="staff-id">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="staff-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-select" id="staff-role" required>
                            <option value="">Select role...</option>
                            <option value="server">Server</option>
                            <option value="cook">Cook</option>
                            <option value="host">Host</option>
                            <option value="bartender">Bartender</option>
                            <option value="busser">Busser</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Hourly Rate ($)</label>
                        <input type="number" class="form-input" id="staff-rate" step="0.01" min="0" value="15.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Hours/Week</label>
                        <input type="number" class="form-input" id="staff-max-hours" min="1" max="60" value="40">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="staff-phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Certifications</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <label class="form-check">
                            <input type="checkbox" id="cert-food-handler"> Food Handler
                        </label>
                        <label class="form-check">
                            <input type="checkbox" id="cert-alcohol"> Alcohol Service
                        </label>
                        <label class="form-check">
                            <input type="checkbox" id="cert-food-safety"> Food Safety Manager
                        </label>
                        <label class="form-check">
                            <input type="checkbox" id="cert-first-aid"> First Aid
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Availability</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-sm btn-success" onclick="setAllAvailable()">Available All Shifts</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllAvailability()">Clear All</button>
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Or click cells to toggle individual availability</p>
                    <div class="availability-grid" id="availability-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staff-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shift Template Modal -->
    <div class="modal-overlay" id="shift-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="shift-modal-title">Add Shift Template</h2>
                <button class="modal-close" onclick="closeModal('shift-modal')"></button>
            </div>
            <form id="shift-form" onsubmit="saveShiftTemplate(event)">
                <input type="hidden" id="shift-id">
                <div class="form-group">
                    <label class="form-label">Shift Name *</label>
                    <input type="text" class="form-input" id="shift-name" required placeholder="e.g., Breakfast, Lunch, Dinner">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Time *</label>
                        <input type="time" class="form-input" id="shift-start" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time *</label>
                        <input type="time" class="form-input" id="shift-end" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Required Staff</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Servers</label>
                            <input type="number" class="form-input" id="req-server" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Cooks</label>
                            <input type="number" class="form-input" id="req-cook" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Hosts</label>
                            <input type="number" class="form-input" id="req-host" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Bartenders</label>
                            <input type="number" class="form-input" id="req-bartender" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Bussers</label>
                            <input type="number" class="form-input" id="req-busser" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px;">Managers</label>
                            <input type="number" class="form-input" id="req-manager" min="0" value="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('shift-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Holiday Modal -->
    <div class="modal-overlay" id="holiday-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Holiday / Blackout Date</h2>
                <button class="modal-close" onclick="closeModal('holiday-modal')"></button>
            </div>
            <form id="holiday-form" onsubmit="saveHoliday(event)">
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="holiday-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Name / Description *</label>
                    <input type="text" class="form-input" id="holiday-name" required placeholder="e.g., Christmas Day, Restaurant Closed">
                </div>
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" id="holiday-closed"> Restaurant Closed (no shifts)
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('holiday-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Shift Modal -->
    <div class="modal-overlay" id="assign-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Assign Shift</h2>
                <button class="modal-close" onclick="closeModal('assign-modal')"></button>
            </div>
            <div id="assign-modal-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Export Schedule</h2>
                <button class="modal-close" onclick="closeModal('export-modal')"></button>
            </div>
            <div style="display: grid; gap: 8px;">
                <button class="btn btn-secondary" onclick="copyScheduleToClipboard()" style="width: 100%; justify-content: center;">
                    Copy to Clipboard
                </button>
                <button class="btn btn-secondary" onclick="printSchedule()" style="width: 100%; justify-content: center;">
                    Print Schedule
                </button>
                <button class="btn btn-secondary" onclick="downloadCSV()" style="width: 100%; justify-content: center;">
                    Download CSV
                </button>
            </div>
        </div>
    </div>

    <!-- CSV Import Help Modal -->
    <div class="modal-overlay" id="csv-help-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">CSV Import Instructions</h2>
                <button class="modal-close" onclick="closeModal('csv-help-modal')"></button>
            </div>
            <div style="font-size: 13px; line-height: 1.6;">
                <p style="margin-bottom: 12px;"><strong>Import employees from a CSV file with the following format:</strong></p>

                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 11px; margin-bottom: 16px; overflow-x: auto;">
                    name,role,hourlyRate,maxHours,availability<br>
                    John Smith,server,15,40,all<br>
                    Jane Doe,cook,18,35,all<br>
                    Bob Wilson,bartender,17,30,mon-fri<br>
                    Amy Chen,host,14,25,weekends
                </div>

                <p style="margin-bottom: 8px;"><strong>Columns:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 16px;">
                    <li><strong>name</strong> - Employee's full name (required)</li>
                    <li><strong>role</strong> - server, cook, host, bartender, busser, or manager (required)</li>
                    <li><strong>hourlyRate</strong> - Hourly pay rate (default: 15)</li>
                    <li><strong>maxHours</strong> - Max hours per week (default: 40)</li>
                    <li><strong>availability</strong> - See options below (default: all)</li>
                </ul>

                <p style="margin-bottom: 8px;"><strong>Availability Options:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 16px;">
                    <li><strong>all</strong> - Available all days and shifts</li>
                    <li><strong>weekdays</strong> or <strong>mon-fri</strong> - Monday through Friday only</li>
                    <li><strong>weekends</strong> - Saturday and Sunday only</li>
                    <li><strong>morning</strong> - Morning/breakfast shifts only</li>
                    <li><strong>evening</strong> - Evening/dinner shifts only</li>
                    <li><strong>0,1,2,3,4,5,6</strong> - Specific days (0=Sun, 1=Mon, etc.)</li>
                </ul>

                <p style="color: var(--text-muted); font-size: 11px;">
                    Tip: Create your CSV in Excel or Google Sheets and export as CSV. The first row should be the header row.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="downloadSampleCSV()">Download Sample CSV</button>
                <button class="btn btn-primary" onclick="closeModal('csv-help-modal')">Got It</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA MODELS & STATE
        // ============================================
        const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const SHIFTS_DEFAULT = ['morning', 'afternoon', 'evening'];
        const ROLES = ['server', 'cook', 'host', 'bartender', 'busser', 'manager'];
        const ROLE_LABELS = {
            server: 'Server',
            cook: 'Cook',
            host: 'Host',
            bartender: 'Bartender',
            busser: 'Busser',
            manager: 'Manager'
        };

        let state = {
            staff: [],
            shiftTemplates: [],
            schedule: {}, // { 'YYYY-MM-DD': { shiftId: [{ staffId, role }] } }
            holidays: [],
            currentWeekStart: getWeekStart(new Date()),
            selectedDay: new Date().toISOString().split('T')[0],
            theme: 'light'
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function formatDate(date, format = 'short') {
            const d = new Date(date);
            if (format === 'short') {
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else if (format === 'full') {
                return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            } else if (format === 'iso') {
                return d.toISOString().split('T')[0];
            }
            return d.toLocaleDateString();
        }

        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        function calculateShiftHours(template) {
            const [startH, startM] = template.startTime.split(':').map(Number);
            const [endH, endM] = template.endTime.split(':').map(Number);
            let hours = endH - startH + (endM - startM) / 60;
            if (hours < 0) hours += 24; // overnight shift
            return hours;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '' : type === 'error' ? '' : '!'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        let currentUser = null;
        let currentUserData = null; // Stores org code, role, name

        function generateOrgCode(restaurantName) {
            // Generate code based on restaurant name if provided
            let prefix;
            if (restaurantName && restaurantName.trim().length > 0) {
                // Take first word, remove special chars, uppercase, max 8 chars
                prefix = restaurantName.trim().split(/\s+/)[0]
                    .replace(/[^a-zA-Z]/g, '')
                    .toUpperCase()
                    .substring(0, 8);
                if (prefix.length < 2) prefix = 'REST';
            } else {
                const words = ['CAFE', 'DINE', 'EATS', 'CHEF', 'FORK', 'GRILL', 'BISTRO'];
                prefix = words[Math.floor(Math.random() * words.length)];
            }
            const num = Math.floor(1000 + Math.random() * 9000);
            return `${prefix}-${num}`;
        }

        function updateOrgCodeFromName() {
            const nameInput = document.getElementById('managerRestaurantName');
            const codeDisplay = document.getElementById('generatedOrgCode');
            if (nameInput && codeDisplay) {
                codeDisplay.textContent = generateOrgCode(nameInput.value);
            }
        }

        function showSignIn() {
            document.getElementById('signInSection').style.display = 'block';
            document.getElementById('signUpSection').classList.remove('visible');
            document.getElementById('managerSignupSection').classList.remove('visible');
            document.getElementById('employeeSignupSection').classList.remove('visible');
            document.getElementById('managerJoinSignupSection').classList.remove('visible');
            document.getElementById('loginError').classList.remove('visible');
            document.getElementById('loginSuccess').classList.remove('visible');
        }

        function showSignupOptions() {
            document.getElementById('signInSection').style.display = 'none';
            document.getElementById('signUpSection').classList.add('visible');
            document.getElementById('managerSignupSection').classList.remove('visible');
            document.getElementById('employeeSignupSection').classList.remove('visible');
            document.getElementById('managerJoinSignupSection').classList.remove('visible');
            document.getElementById('loginError').classList.remove('visible');
        }

        function selectSignupRole(role) {
            document.getElementById('signUpSection').classList.remove('visible');
            document.getElementById('loginError').classList.remove('visible');
            document.getElementById('managerSignupSection').classList.remove('visible');
            document.getElementById('employeeSignupSection').classList.remove('visible');
            document.getElementById('managerJoinSignupSection').classList.remove('visible');

            if (role === 'manager') {
                document.getElementById('managerSignupSection').classList.add('visible');
                document.getElementById('generatedOrgCode').textContent = generateOrgCode();
            } else if (role === 'manager-join') {
                document.getElementById('managerJoinSignupSection').classList.add('visible');
            } else {
                document.getElementById('employeeSignupSection').classList.add('visible');
            }
        }

        function showError(message) {
            const el = document.getElementById('loginError');
            el.textContent = message;
            el.classList.add('visible');
            document.getElementById('loginSuccess').classList.remove('visible');
        }

        function showSuccess(message) {
            const el = document.getElementById('loginSuccess');
            el.textContent = message;
            el.classList.add('visible');
            document.getElementById('loginError').classList.remove('visible');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Signing in...';
            document.getElementById('loginError').classList.remove('visible');

            try {
                await window.firebaseSignIn(window.firebaseAuth, email, password);
            } catch (error) {
                console.error('Login error:', error.code, error.message);
                let message = 'Invalid email or password';
                if (error.code === 'auth/user-not-found') message = 'No account found with this email';
                else if (error.code === 'auth/wrong-password') message = 'Incorrect password';
                else if (error.code === 'auth/invalid-credential') message = 'Invalid email or password';
                else if (error.code === 'auth/invalid-email') message = 'Invalid email format';
                else if (error.code === 'auth/too-many-requests') message = 'Too many attempts. Try again later.';
                else message = `Error: ${error.code || error.message}`;

                showError(message);
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        // Flag to prevent race condition during signup
        let signupInProgress = false;

        async function handleManagerSignup(e) {
            e.preventDefault();
            const restaurantName = document.getElementById('managerRestaurantName').value;
            const email = document.getElementById('managerEmail').value;
            const password = document.getElementById('managerPassword').value;
            const orgCode = document.getElementById('generatedOrgCode').textContent;
            const btn = document.getElementById('managerSignupBtn');

            btn.disabled = true;
            btn.textContent = 'Creating...';
            signupInProgress = true;

            try {
                // Create user account
                const userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
                const user = userCredential.user;

                // Create organization in Firestore
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', orgCode);
                await window.firebaseSetDoc(orgRef, {
                    name: restaurantName,
                    code: orgCode,
                    ownerId: user.uid,
                    managerInvites: [],
                    createdAt: new Date().toISOString()
                });

                // Create user profile
                const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userData = {
                    email: email,
                    name: 'Manager',
                    role: 'manager',
                    orgCode: orgCode,
                    restaurantName: restaurantName,
                    createdAt: new Date().toISOString()
                };
                await window.firebaseSetDoc(userRef, userData);

                // Create initial schedule data for org
                const scheduleRef = window.firebaseDoc(window.firebaseDb, 'schedules', orgCode);
                await window.firebaseSetDoc(scheduleRef, {
                    staff: [],
                    shiftTemplates: [],
                    schedule: {},
                    holidays: [],
                    theme: 'light',
                    createdAt: new Date().toISOString()
                });

                // All documents created - manually complete login
                signupInProgress = false;
                currentUser = user;
                currentUserData = userData;

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').style.display = 'flex';
                document.getElementById('userEmail').textContent = `${userData.name} (${userData.role})`;

                const navTeam = document.getElementById('navTeam');
                if (navTeam) navTeam.style.display = 'flex';

                updateOrgCodeDisplay();
                loadStateFromFirestore();
                showToast(`Welcome! Your org code is ${orgCode}`, 'success');

            } catch (error) {
                signupInProgress = false;
                let message = 'An error occurred';
                if (error.code === 'auth/email-already-in-use') message = 'Email already in use';
                else if (error.code === 'auth/weak-password') message = 'Password must be at least 6 characters';
                console.error('Signup error:', error);

                showError(message);
                btn.disabled = false;
                btn.textContent = 'Create Restaurant';
            }
        }

        async function handleEmployeeSignup(e) {
            e.preventDefault();
            const orgCode = document.getElementById('employeeOrgCode').value.toUpperCase().trim();
            const name = document.getElementById('employeeName').value;
            const email = document.getElementById('employeeEmail').value.toLowerCase().trim();
            const password = document.getElementById('employeePassword').value;
            const btn = document.getElementById('employeeSignupBtn');

            btn.disabled = true;
            btn.textContent = 'Verifying...';

            try {
                // Check if organization exists
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (!orgSnap.exists()) {
                    showError('Organization code not found. Check with your manager.');
                    btn.disabled = false;
                    btn.textContent = 'Join Restaurant';
                    return;
                }

                const orgData = orgSnap.data();

                // Check if employee invites are required
                if (orgData.requireEmployeeInvite) {
                    const invitedEmails = (orgData.employeeInvites || []).map(e => e.toLowerCase());
                    if (!invitedEmails.includes(email)) {
                        showError('Your email is not on the invite list. Ask your manager to invite you.');
                        btn.disabled = false;
                        btn.textContent = 'Join Restaurant';
                        return;
                    }
                }

                btn.textContent = 'Joining...';
                signupInProgress = true;

                // Create user account
                const userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
                const user = userCredential.user;

                // Create user profile
                const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userData = {
                    email: email,
                    name: name,
                    role: 'employee',
                    orgCode: orgCode,
                    createdAt: new Date().toISOString()
                };
                await window.firebaseSetDoc(userRef, userData);

                // Remove from invite list if they were invited
                if (orgData.requireEmployeeInvite && orgData.employeeInvites) {
                    const updatedInvites = orgData.employeeInvites.filter(e => e.toLowerCase() !== email);
                    await window.firebaseSetDoc(orgRef, { ...orgData, employeeInvites: updatedInvites });
                }

                // Manually complete login
                signupInProgress = false;
                currentUser = user;
                currentUserData = userData;

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').style.display = 'flex';
                document.getElementById('userEmail').textContent = `${name} (employee)`;

                const navTeam = document.getElementById('navTeam');
                if (navTeam) navTeam.style.display = 'none';

                loadStateFromFirestore();
                showToast(`Welcome to ${orgData.name}!`, 'success');

            } catch (error) {
                signupInProgress = false;
                let message = 'An error occurred';
                if (error.code === 'auth/email-already-in-use') message = 'Email already in use';
                else if (error.code === 'auth/weak-password') message = 'Password must be at least 6 characters';

                showError(message);
                btn.disabled = false;
                btn.textContent = 'Join Restaurant';
            }
        }

        async function handleManagerJoinSignup(e) {
            e.preventDefault();
            const orgCode = document.getElementById('managerJoinOrgCode').value.toUpperCase().trim();
            const name = document.getElementById('managerJoinName').value;
            const email = document.getElementById('managerJoinEmail').value.toLowerCase().trim();
            const password = document.getElementById('managerJoinPassword').value;
            const btn = document.getElementById('managerJoinSignupBtn');

            btn.disabled = true;
            btn.textContent = 'Verifying...';

            try {
                // Check if organization exists
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (!orgSnap.exists()) {
                    showError('Organization code not found. Check with your manager.');
                    btn.disabled = false;
                    btn.textContent = 'Join as Manager';
                    return;
                }

                const orgData = orgSnap.data();
                const invitedEmails = (orgData.managerInvites || []).map(e => e.toLowerCase());

                // Check if email is in the invite list
                if (!invitedEmails.includes(email)) {
                    showError('Your email is not on the manager invite list. Ask an existing manager to invite you.');
                    btn.disabled = false;
                    btn.textContent = 'Join as Manager';
                    return;
                }

                btn.textContent = 'Joining...';
                signupInProgress = true;

                // Create user account
                const userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
                const user = userCredential.user;

                // Create user profile as manager
                const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userData = {
                    email: email,
                    name: name,
                    role: 'manager',
                    orgCode: orgCode,
                    createdAt: new Date().toISOString()
                };
                await window.firebaseSetDoc(userRef, userData);

                // Remove email from invite list
                const updatedInvites = orgData.managerInvites.filter(e => e.toLowerCase() !== email);
                await window.firebaseSetDoc(orgRef, { ...orgData, managerInvites: updatedInvites });

                // Manually complete login
                signupInProgress = false;
                currentUser = user;
                currentUserData = userData;

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').style.display = 'flex';
                document.getElementById('userEmail').textContent = `${name} (manager)`;

                const navTeam = document.getElementById('navTeam');
                if (navTeam) navTeam.style.display = 'flex';

                updateOrgCodeDisplay();
                loadStateFromFirestore();
                showToast(`Welcome to ${orgData.name}!`, 'success');

            } catch (error) {
                signupInProgress = false;
                let message = 'An error occurred';
                if (error.code === 'auth/email-already-in-use') message = 'Email already in use';
                else if (error.code === 'auth/weak-password') message = 'Password must be at least 6 characters';

                showError(message);
                btn.disabled = false;
                btn.textContent = 'Join as Manager';
            }
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                await window.firebaseSignOut(window.firebaseAuth);
            }
        }

        async function onUserLoggedIn(user) {
            // Skip if signup is in progress (we handle login manually after signup)
            if (signupInProgress) return;

            currentUser = user;

            // Get user profile to find their org
            try {
                const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userSnap = await window.firebaseGetDoc(userRef);

                if (userSnap.exists()) {
                    currentUserData = userSnap.data();
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').style.display = 'flex';
                    document.getElementById('userEmail').textContent = `${currentUserData.name || user.email} (${currentUserData.role})`;

                    // Show Team nav for managers only
                    const navTeam = document.getElementById('navTeam');
                    if (navTeam) {
                        navTeam.style.display = currentUserData.role === 'manager' ? 'flex' : 'none';
                    }

                    updateOrgCodeDisplay();
                    loadStateFromFirestore();
                } else {
                    // User exists in auth but not in Firestore - wait a moment and retry
                    // This can happen due to race conditions
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const retrySnap = await window.firebaseGetDoc(userRef);
                    if (retrySnap.exists()) {
                        currentUserData = retrySnap.data();
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('appContainer').style.display = 'flex';
                        document.getElementById('userEmail').textContent = `${currentUserData.name || user.email} (${currentUserData.role})`;
                        const navTeam = document.getElementById('navTeam');
                        if (navTeam) navTeam.style.display = currentUserData.role === 'manager' ? 'flex' : 'none';
                        updateOrgCodeDisplay();
                        loadStateFromFirestore();
                    } else {
                        showError('Account setup incomplete. Please sign up again.');
                        await window.firebaseSignOut(window.firebaseAuth);
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Error loading account. Please try again.');
            }
        }

        function onUserLoggedOut() {
            // Only reset if user was previously logged in (actual logout, not failed login)
            const wasLoggedIn = currentUser !== null;

            currentUser = null;
            currentUserData = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').style.display = 'none';

            // Only reset form and show sign in if this was an actual logout
            if (wasLoggedIn) {
                showSignIn();
                document.getElementById('loginForm').reset();
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtn').textContent = 'Sign In';
                // Reset state
                state = {
                    staff: [],
                    shiftTemplates: [],
                    schedule: {},
                    holidays: [],
                    currentWeekStart: getWeekStart(new Date()),
                    selectedDay: new Date().toISOString().split('T')[0],
                    theme: 'light'
                };
            }
        }

        // ============================================
        // STORAGE (Firebase Firestore)
        // ============================================
        let saveTimeout = null;

        function saveState() {
            // Debounce saves to avoid too many writes
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveStateToFirestore(), 500);
            // Also save to localStorage as backup
            localStorage.setItem('restaurantSchedulerPro', JSON.stringify(state));
        }

        async function saveStateToFirestore() {
            if (!currentUser || !currentUserData || !currentUserData.orgCode) return;
            try {
                const docRef = window.firebaseDoc(window.firebaseDb, 'schedules', currentUserData.orgCode);
                await window.firebaseSetDoc(docRef, {
                    staff: state.staff,
                    shiftTemplates: state.shiftTemplates,
                    schedule: state.schedule,
                    holidays: state.holidays,
                    theme: state.theme,
                    shiftTrades: state.shiftTrades || [],
                    userPreferences: state.userPreferences || {},
                    updatedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving to Firestore:', error);
            }
        }

        async function loadStateFromFirestore() {
            if (!currentUser || !currentUserData || !currentUserData.orgCode) return;
            try {
                const docRef = window.firebaseDoc(window.firebaseDb, 'schedules', currentUserData.orgCode);
                const docSnap = await window.firebaseGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.staff = data.staff || [];
                    state.shiftTemplates = data.shiftTemplates || [];
                    state.schedule = data.schedule || {};
                    state.holidays = data.holidays || [];
                    state.theme = data.theme || 'light';
                    state.shiftTrades = data.shiftTrades || [];
                    state.userPreferences = data.userPreferences || {};
                } else {
                    // New user - load sample data
                    loadSampleData();
                }

                state.currentWeekStart = getWeekStart(new Date());
                applyTheme();
                renderAll();
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                // Fall back to localStorage
                loadStateFromLocalStorage();
            }
        }

        function loadStateFromLocalStorage() {
            const saved = localStorage.getItem('restaurantSchedulerPro');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                state.currentWeekStart = new Date(state.currentWeekStart);
            }
            applyTheme();
            renderAll();
        }

        function loadState() {
            // This is now handled by loadStateFromFirestore
            applyTheme();
        }

        function renderAll() {
            renderDashboard();
            renderSchedule();
            renderStaffTable();
            renderShiftTemplates();
            renderHolidays();
            renderLaborCosts();
        }

        // ============================================
        // THEME
        // ============================================
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveState();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            document.getElementById('theme-icon').textContent = state.theme === 'light' ? '' : '';
            document.getElementById('theme-text').textContent = state.theme === 'light' ? 'Dark Mode' : 'Light Mode';
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.toggle('active', section.id === `page-${page}`);
            });

            // Close sidebar on mobile
            closeSidebar();

            // Refresh page content
            switch(page) {
                case 'dashboard': renderDashboard(); break;
                case 'schedule': renderSchedule(); break;
                case 'day-view': renderDayView(); break;
                case 'staff': renderStaffTable(); break;
                case 'shifts': renderShiftTemplates(); break;
                case 'holidays': renderHolidays(); break;
                case 'labor': renderLaborCosts(); break;
                case 'team': renderTeamPage(); break;
                case 'shift-market': renderShiftMarketplace(); break;
                case 'my-preferences': renderMyPreferences(); break;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        // ============================================
        // WEEK NAVIGATION
        // ============================================
        function changeWeek(delta) {
            const newDate = new Date(state.currentWeekStart);
            newDate.setDate(newDate.getDate() + (delta * 7));
            state.currentWeekStart = newDate;
            saveState();
            renderSchedule();
            renderDashboard();
        }

        function goToToday() {
            state.currentWeekStart = getWeekStart(new Date());
            saveState();
            renderSchedule();
            renderDashboard();
        }

        // ============================================
        // MODALS
        // ============================================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ============================================
        // STAFF MANAGEMENT
        // ============================================
        function openStaffModal(staffId = null) {
            const modal = document.getElementById('staff-modal');
            const form = document.getElementById('staff-form');
            const title = document.getElementById('staff-modal-title');
            
            form.reset();
            renderAvailabilityGrid();
            
            if (staffId) {
                const staff = state.staff.find(s => s.id === staffId);
                if (staff) {
                    title.textContent = 'Edit Employee';
                    document.getElementById('staff-id').value = staff.id;
                    document.getElementById('staff-name').value = staff.name;
                    document.getElementById('staff-role').value = staff.role;
                    document.getElementById('staff-rate').value = staff.hourlyRate;
                    document.getElementById('staff-max-hours').value = staff.maxHours;
                    document.getElementById('staff-phone').value = staff.phone || '';
                    document.getElementById('cert-food-handler').checked = staff.certifications?.foodHandler;
                    document.getElementById('cert-alcohol').checked = staff.certifications?.alcohol;
                    document.getElementById('cert-food-safety').checked = staff.certifications?.foodSafety;
                    document.getElementById('cert-first-aid').checked = staff.certifications?.firstAid;
                    
                    // Set availability - check both data-shift (name) and data-shift-id for compatibility
                    if (staff.availability) {
                        Object.entries(staff.availability).forEach(([day, shifts]) => {
                            shifts.forEach(shift => {
                                // Try matching by name first, then by ID
                                let cell = document.querySelector(`.avail-cell[data-day="${day}"][data-shift="${shift}"]`);
                                if (!cell) {
                                    cell = document.querySelector(`.avail-cell[data-day="${day}"][data-shift-id="${shift}"]`);
                                }
                                if (cell) cell.classList.add('available');
                            });
                        });
                    }
                }
            } else {
                title.textContent = 'Add Employee';
                document.getElementById('staff-id').value = '';
            }
            
            openModal('staff-modal');
        }

        function renderAvailabilityGrid() {
            const grid = document.getElementById('availability-grid');
            const shifts = state.shiftTemplates.length > 0 ? state.shiftTemplates : [
                { id: 'morning', name: 'Morning' },
                { id: 'afternoon', name: 'Afternoon' },
                { id: 'evening', name: 'Evening' }
            ];
            
            let html = '<div class="avail-header"></div>';
            DAYS_SHORT.forEach(day => {
                html += `<div class="avail-header">${day}</div>`;
            });
            
            shifts.forEach(shift => {
                html += `<div class="avail-label">${shift.name}</div>`;
                DAYS.forEach((day, i) => {
                    // Use lowercase name for consistency with sample data
                    html += `<div class="avail-cell" data-day="${i}" data-shift="${shift.name.toLowerCase()}" data-shift-id="${shift.id}" onclick="toggleAvailability(this)"></div>`;
                });
            });
            
            grid.innerHTML = html;
        }

        function toggleAvailability(cell) {
            cell.classList.toggle('available');
        }

        function setAllAvailable() {
            document.querySelectorAll('.avail-cell').forEach(cell => {
                cell.classList.add('available');
            });
        }

        function clearAllAvailability() {
            document.querySelectorAll('.avail-cell').forEach(cell => {
                cell.classList.remove('available');
            });
        }

        function saveStaff(e) {
            e.preventDefault();
            
            const id = document.getElementById('staff-id').value || generateId();
            const isEdit = !!document.getElementById('staff-id').value;
            
            // Gather availability
            const availability = {};
            document.querySelectorAll('.avail-cell.available').forEach(cell => {
                const day = cell.dataset.day;
                const shift = cell.dataset.shift;
                if (!availability[day]) availability[day] = [];
                availability[day].push(shift);
            });
            
            const staffData = {
                id,
                name: document.getElementById('staff-name').value,
                role: document.getElementById('staff-role').value,
                hourlyRate: parseFloat(document.getElementById('staff-rate').value) || 15,
                maxHours: parseInt(document.getElementById('staff-max-hours').value) || 40,
                phone: document.getElementById('staff-phone').value,
                certifications: {
                    foodHandler: document.getElementById('cert-food-handler').checked,
                    alcohol: document.getElementById('cert-alcohol').checked,
                    foodSafety: document.getElementById('cert-food-safety').checked,
                    firstAid: document.getElementById('cert-first-aid').checked
                },
                availability
            };
            
            if (isEdit) {
                const index = state.staff.findIndex(s => s.id === id);
                state.staff[index] = staffData;
            } else {
                state.staff.push(staffData);
            }
            
            saveState();
            closeModal('staff-modal');
            renderStaffTable();
            showToast(isEdit ? 'Employee updated' : 'Employee added');
        }

        function deleteStaff(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                state.staff = state.staff.filter(s => s.id !== id);

                // Remove from schedule
                Object.keys(state.schedule).forEach(date => {
                    Object.keys(state.schedule[date]).forEach(shiftId => {
                        state.schedule[date][shiftId] = state.schedule[date][shiftId].filter(a => a.staffId !== id);
                    });
                });

                saveState();
                renderStaffTable();
                showToast('Employee deleted', 'warning');
            }
        }

        function deleteAllEmployees() {
            if (confirm('Are you sure you want to delete ALL employees? This will also clear the schedule.')) {
                state.staff = [];
                state.schedule = {};
                saveState();
                renderStaffTable();
                renderSchedule();
                renderDashboard();
                showToast('All employees deleted', 'warning');
            }
        }

        function importStaffCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        showToast('CSV file is empty or invalid', 'error');
                        return;
                    }

                    // Parse header
                    const header = lines[0].toLowerCase().split(',').map(h => h.trim());
                    const nameIdx = header.indexOf('name');
                    const roleIdx = header.indexOf('role');
                    const rateIdx = header.indexOf('hourlyrate');
                    const hoursIdx = header.indexOf('maxhours');
                    const availIdx = header.indexOf('availability');

                    if (nameIdx === -1 || roleIdx === -1) {
                        showToast('CSV must have "name" and "role" columns', 'error');
                        return;
                    }

                    let imported = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        if (values.length < 2) continue;

                        const name = values[nameIdx]?.trim();
                        const role = values[roleIdx]?.trim().toLowerCase();

                        if (!name || !ROLES.includes(role)) continue;

                        const hourlyRate = parseFloat(values[rateIdx]) || 15;
                        const maxHours = parseInt(values[hoursIdx]) || 40;
                        const availStr = (values[availIdx] || 'all').trim().toLowerCase();

                        const availability = parseAvailability(availStr);

                        state.staff.push({
                            id: generateId(),
                            name,
                            role,
                            hourlyRate,
                            maxHours,
                            certifications: {},
                            availability
                        });
                        imported++;
                    }

                    saveState();
                    renderStaffTable();
                    showToast(`Imported ${imported} employees`);
                } catch (err) {
                    showToast('Error parsing CSV file', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            return values;
        }

        function parseAvailability(str) {
            if (!str || str === 'all' || str === '') return {};

            if (str === 'weekdays' || str === 'mon-fri') {
                // Available Monday-Friday (days 1-5), not available Sunday (0) and Saturday (6)
                return { 0: [], 6: [] };
            }

            if (str === 'weekends') {
                // Only available Saturday and Sunday
                return { 1: [], 2: [], 3: [], 4: [], 5: [] };
            }

            if (str === 'morning' || str === 'breakfast') {
                // Will be available for all days but we can't restrict to specific shifts easily
                // without knowing shift names, so return empty (all available)
                return {};
            }

            if (str === 'evening' || str === 'dinner') {
                return {};
            }

            // Check if it's a comma-separated list of day numbers
            if (/^[0-6,\s]+$/.test(str)) {
                const availableDays = str.split(',').map(d => parseInt(d.trim())).filter(d => d >= 0 && d <= 6);
                const unavailable = {};
                for (let i = 0; i < 7; i++) {
                    if (!availableDays.includes(i)) {
                        unavailable[i] = [];
                    }
                }
                return unavailable;
            }

            return {}; // Default: available for everything
        }

        function downloadSampleCSV() {
            const csv = `name,role,hourlyRate,maxHours,availability
John Smith,server,15,40,all
Jane Doe,cook,18,35,all
Bob Wilson,bartender,17,30,mon-fri
Amy Chen,host,14,25,weekends
Mike Johnson,busser,13,35,1,2,3,4,5
Sarah Lee,manager,22,45,all`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'staff-import-sample.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Sample CSV downloaded');
        }

        function renderStaffTable() {
            const tbody = document.getElementById('staff-tbody');
            
            if (state.staff.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            No employees yet. Click "Add Employee" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = state.staff.map(staff => {
                const weekHours = calculateWeekHours(staff.id);
                const certs = [];
                if (staff.certifications?.foodHandler) certs.push('Food Handler');
                if (staff.certifications?.alcohol) certs.push('Alcohol');
                if (staff.certifications?.foodSafety) certs.push('Food Safety');
                if (staff.certifications?.firstAid) certs.push('First Aid');
                
                const hoursClass = weekHours > staff.maxHours ? 'hours-danger' : weekHours > staff.maxHours * 0.9 ? 'hours-warning' : '';
                
                return `
                    <tr data-staff-id="${staff.id}">
                        <td><strong>${staff.name}</strong></td>
                        <td><span class="role-badge ${staff.role}">${ROLE_LABELS[staff.role]}</span></td>
                        <td>$${staff.hourlyRate.toFixed(2)}</td>
                        <td>${staff.maxHours}h</td>
                        <td>${certs.map(c => `<span class="cert-badge active">${c}</span>`).join('') || '<span class="cert-badge">None</span>'}</td>
                        <td class="${hoursClass}">${weekHours.toFixed(1)}h / ${staff.maxHours}h</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openStaffModal('${staff.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStaff('${staff.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateWeekHours(staffId) {
            let totalHours = 0;
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.keys(state.schedule[dateKey]).forEach(shiftId => {
                        const assignments = state.schedule[dateKey][shiftId];
                        if (assignments.some(a => a.staffId === staffId)) {
                            const template = state.shiftTemplates.find(t => t.id === shiftId);
                            if (template) {
                                totalHours += calculateShiftHours(template);
                            }
                        }
                    });
                }
            });
            
            return totalHours;
        }

        // ============================================
        // SHIFT TEMPLATES
        // ============================================
        function openShiftModal(shiftId = null) {
            const form = document.getElementById('shift-form');
            const title = document.getElementById('shift-modal-title');
            
            form.reset();
            
            if (shiftId) {
                const shift = state.shiftTemplates.find(s => s.id === shiftId);
                if (shift) {
                    title.textContent = 'Edit Shift Template';
                    document.getElementById('shift-id').value = shift.id;
                    document.getElementById('shift-name').value = shift.name;
                    document.getElementById('shift-start').value = shift.startTime;
                    document.getElementById('shift-end').value = shift.endTime;
                    ROLES.forEach(role => {
                        document.getElementById(`req-${role}`).value = shift.requirements?.[role] || 0;
                    });
                }
            } else {
                title.textContent = 'Add Shift Template';
                document.getElementById('shift-id').value = '';
            }
            
            openModal('shift-modal');
        }

        function saveShiftTemplate(e) {
            e.preventDefault();
            
            const id = document.getElementById('shift-id').value || generateId();
            const isEdit = !!document.getElementById('shift-id').value;
            
            const requirements = {};
            ROLES.forEach(role => {
                requirements[role] = parseInt(document.getElementById(`req-${role}`).value) || 0;
            });
            
            const shiftData = {
                id,
                name: document.getElementById('shift-name').value,
                startTime: document.getElementById('shift-start').value,
                endTime: document.getElementById('shift-end').value,
                requirements
            };
            
            if (isEdit) {
                const index = state.shiftTemplates.findIndex(s => s.id === id);
                state.shiftTemplates[index] = shiftData;
            } else {
                state.shiftTemplates.push(shiftData);
            }
            
            saveState();
            closeModal('shift-modal');
            renderShiftTemplates();
            showToast(isEdit ? 'Shift template updated' : 'Shift template added');
        }

        function deleteShiftTemplate(id) {
            if (confirm('Are you sure you want to delete this shift template?')) {
                state.shiftTemplates = state.shiftTemplates.filter(s => s.id !== id);
                saveState();
                renderShiftTemplates();
                showToast('Shift template deleted', 'warning');
            }
        }

        function renderShiftTemplates() {
            const container = document.getElementById('shift-templates-grid');
            
            if (state.shiftTemplates.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">
                        <p style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></p>
                        <p>No shift templates yet.</p>
                        <p style="font-size: 12px;">Create templates like "Breakfast", "Lunch", "Dinner" to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.shiftTemplates.map(shift => {
                const hours = calculateShiftHours(shift);
                return `
                    <div class="template-card">
                        <div class="template-header">
                            <div>
                                <div class="template-name">${shift.name}</div>
                                <div class="template-time">${shift.startTime} - ${shift.endTime} (${hours}h)</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-secondary" onclick="openShiftModal('${shift.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteShiftTemplate('${shift.id}')"></button>
                            </div>
                        </div>
                        <div class="template-requirements">
                            ${ROLES.filter(role => shift.requirements?.[role] > 0).map(role => `
                                <div class="req-row">
                                    <span>${ROLE_LABELS[role]}</span>
                                    <span class="req-count">${shift.requirements[role]}</span>
                                </div>
                            `).join('') || '<div style="color: var(--text-muted); font-size: 12px;">No requirements set</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // HOLIDAYS
        // ============================================
        function openHolidayModal() {
            document.getElementById('holiday-form').reset();
            openModal('holiday-modal');
        }

        function saveHoliday(e) {
            e.preventDefault();
            
            state.holidays.push({
                id: generateId(),
                date: document.getElementById('holiday-date').value,
                name: document.getElementById('holiday-name').value,
                closed: document.getElementById('holiday-closed').checked
            });
            
            state.holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveState();
            closeModal('holiday-modal');
            renderHolidays();
            showToast('Holiday added');
        }

        function deleteHoliday(id) {
            state.holidays = state.holidays.filter(h => h.id !== id);
            saveState();
            renderHolidays();
        }

        function renderHolidays() {
            const container = document.getElementById('holiday-list');
            
            if (state.holidays.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        No holidays or blackout dates configured.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.holidays.map(holiday => `
                <div class="holiday-item">
                    <div>
                        <div class="holiday-date">${formatDate(holiday.date, 'full')}</div>
                        <div class="holiday-name">${holiday.name} ${holiday.closed ? '(Closed)' : ''}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${holiday.id}')">Delete</button>
                </div>
            `).join('');
        }

        // ============================================
        // SCHEDULE
        // ============================================
        function renderSchedule() {
            const weekDates = getWeekDates(state.currentWeekStart);
            const today = new Date().toISOString().split('T')[0];
            
            // Update week display
            document.getElementById('week-display').textContent = 
                `${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}`;
            
            const grid = document.getElementById('schedule-grid');
            
            if (state.shiftTemplates.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">
                        <p style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></p>
                        <p>No shift templates configured.</p>
                        <p><a href="#" onclick="navigateTo('shifts')" style="color: var(--accent);">Create shift templates</a> to start scheduling.</p>
                    </div>
                `;
                return;
            }
            
            // Header row
            let html = '<div class="schedule-cell schedule-header">Shift</div>';
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                const isToday = dateKey === today;
                const holiday = state.holidays.find(h => h.date === dateKey);
                html += `
                    <div class="schedule-cell schedule-header ${isToday ? 'today' : ''}">
                        <div>${DAYS_SHORT[i]}</div>
                        <div style="font-size: 10px; font-weight: 400; opacity: 0.8;">${formatDate(date)}</div>
                        ${holiday ? `<div style="font-size: 9px; color: ${holiday.closed ? 'var(--danger)' : 'var(--warning)'};">${holiday.name}</div>` : ''}
                    </div>
                `;
            });
            
            // Shift rows
            state.shiftTemplates.forEach(shift => {
                html += `
                    <div class="schedule-cell schedule-shift-label">
                        <div>
                            ${shift.name}
                            <span class="time">${shift.startTime} - ${shift.endTime}</span>
                        </div>
                    </div>
                `;
                
                weekDates.forEach(date => {
                    const dateKey = formatDate(date, 'iso');
                    const assignments = state.schedule[dateKey]?.[shift.id] || [];
                    const holiday = state.holidays.find(h => h.date === dateKey && h.closed);
                    const conflicts = getConflicts(dateKey, shift.id);
                    
                    html += `
                        <div class="schedule-cell" 
                             data-date="${dateKey}" 
                             data-shift="${shift.id}"
                             ondragover="handleDragOver(event)"
                             ondrop="handleDrop(event)"
                             ondragleave="handleDragLeave(event)">
                            ${conflicts.length > 0 ? `
                                <div class="conflict-indicator ${conflicts.some(c => c.type === 'danger') ? 'danger' : 'warning'}" 
                                     title="${conflicts.map(c => c.message).join('\n')}">
                                    !
                                </div>
                            ` : ''}
                            ${holiday ? `<div style="color: var(--text-muted); font-size: 11px; text-align: center;">Closed</div>` : `
                                ${assignments.map(a => {
                                    const staff = state.staff.find(s => s.id === a.staffId);
                                    return staff ? `
                                        <div class="shift-chip ${staff.role}"
                                             draggable="true"
                                             ondragstart="handleDragStart(event, '${dateKey}', '${shift.id}', '${a.staffId}')"
                                             onclick="showShiftOptions('${dateKey}', '${shift.id}', '${a.staffId}')">
                                            ${staff.name}
                                            <span class="remove-shift" onclick="event.stopPropagation(); removeAssignment('${dateKey}', '${shift.id}', '${a.staffId}')"></span>
                                        </div>
                                    ` : '';
                                }).join('')}
                                <button class="add-shift-btn" onclick="openAssignModal('${dateKey}', '${shift.id}')">+ Add</button>
                            `}
                        </div>
                    `;
                });
            });
            
            grid.innerHTML = html;
        }

        function setScheduleView(view) {
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            document.getElementById('schedule-grid-view').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('schedule-employee-view').style.display = view === 'employee' ? 'block' : 'none';
            
            if (view === 'employee') {
                renderEmployeeView();
            }
        }

        function renderEmployeeView() {
            const container = document.getElementById('employee-schedule');
            const weekDates = getWeekDates(state.currentWeekStart);
            
            if (state.staff.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                        No employees to display.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.staff.map(staff => {
                const weekHours = calculateWeekHours(staff.id);
                const shifts = [];
                
                weekDates.forEach((date, dayIndex) => {
                    const dateKey = formatDate(date, 'iso');
                    state.shiftTemplates.forEach(template => {
                        const assignments = state.schedule[dateKey]?.[template.id] || [];
                        if (assignments.some(a => a.staffId === staff.id)) {
                            shifts.push({
                                day: DAYS_SHORT[dayIndex],
                                date: formatDate(date),
                                shift: template.name,
                                time: `${template.startTime} - ${template.endTime}`
                            });
                        }
                    });
                });
                
                const hoursClass = weekHours > staff.maxHours ? 'hours-danger' : weekHours > staff.maxHours * 0.9 ? 'hours-warning' : '';
                
                return `
                    <div class="employee-card">
                        <div class="employee-card-header">
                            <div class="employee-avatar">
                                ${staff.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 13px;">${staff.name}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${ROLE_LABELS[staff.role]}</div>
                            </div>
                        </div>
                        <div class="employee-shifts">
                            ${shifts.length > 0 ? shifts.map(s => `
                                <div class="employee-shift-chip">
                                    <span class="day">${s.day}</span> ${s.shift} (${s.time})
                                </div>
                            `).join('') : '<div style="color: var(--text-muted); font-size: 12px;">No shifts this week</div>'}
                        </div>
                        <div class="employee-hours">
                            <span>Weekly Hours:</span>
                            <span class="${hoursClass}">${weekHours.toFixed(1)}h / ${staff.maxHours}h</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // DAY VIEW
        // ============================================
        function selectDay(dateStr) {
            state.selectedDay = dateStr;
            renderDayView();
        }

        function renderDayView() {
            document.getElementById('day-picker').value = state.selectedDay;
            document.getElementById('day-view-date').textContent = formatDate(state.selectedDay, 'full');
            
            const container = document.getElementById('day-view-container');
            const holiday = state.holidays.find(h => h.date === state.selectedDay);
            
            if (holiday?.closed) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px;">
                        <p style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></p>
                        <h3>${holiday.name}</h3>
                        <p style="color: var(--text-muted);">Restaurant is closed</p>
                    </div>
                `;
                return;
            }
            
            if (state.shiftTemplates.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px; color: var(--text-muted);">
                        No shift templates configured.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.shiftTemplates.map(shift => {
                const assignments = state.schedule[state.selectedDay]?.[shift.id] || [];
                const requirements = shift.requirements || {};
                
                const staffSlots = [];
                ROLES.forEach(role => {
                    const required = requirements[role] || 0;
                    const assigned = assignments.filter(a => {
                        const staff = state.staff.find(s => s.id === a.staffId);
                        return staff?.role === role;
                    });
                    
                    for (let i = 0; i < Math.max(required, assigned.length); i++) {
                        if (assigned[i]) {
                            const staff = state.staff.find(s => s.id === assigned[i].staffId);
                            staffSlots.push({
                                filled: true,
                                name: staff?.name,
                                role: role
                            });
                        } else if (i < required) {
                            staffSlots.push({
                                filled: false,
                                role: role,
                                warning: true
                            });
                        }
                    }
                });
                
                return `
                    <div class="shift-section">
                        <div class="shift-section-header">
                            <div class="shift-section-title">${shift.name}</div>
                            <div class="shift-section-time">${shift.startTime} - ${shift.endTime}</div>
                        </div>
                        <div class="shift-staff-grid">
                            ${staffSlots.length > 0 ? staffSlots.map(slot => `
                                <div class="staff-slot ${slot.filled ? 'filled' : slot.warning ? 'warning' : 'empty'}">
                                    <div class="staff-slot-name">${slot.filled ? slot.name : slot.warning ? 'NEEDED' : 'Empty'}</div>
                                    <div class="staff-slot-role">${ROLE_LABELS[slot.role]}</div>
                                </div>
                            `).join('') : '<div style="color: var(--text-muted); padding: 20px; font-size: 12px;">No staff requirements set</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // ASSIGNMENT
        // ============================================
        function openAssignModal(date, shiftId) {
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            const existingAssignments = state.schedule[date]?.[shiftId] || [];
            const existingIds = existingAssignments.map(a => a.staffId);
            const dayIndex = new Date(date).getDay();
            
            // Filter available staff
            const availableStaff = state.staff.filter(staff => {
                // Not already assigned
                if (existingIds.includes(staff.id)) return false;
                
                // Check availability
                // Day with [] = NOT available that day
                // Day with shifts = only available for those shifts
                // Day not specified = available for everything
                const avail = staff.availability?.[dayIndex];
                if (avail !== undefined) {
                    if (avail.length === 0) return false;
                    // Check both shift ID and name (lowercase) for compatibility
                    const shiftMatches = avail.some(a => a === shiftId || a === shift.name.toLowerCase());
                    if (!shiftMatches) return false;
                }
                
                // Check max hours
                const currentHours = calculateWeekHours(staff.id);
                const shiftHours = calculateShiftHours(shift);
                if (currentHours + shiftHours > staff.maxHours) return false;
                
                return true;
            });
            
            const content = document.getElementById('assign-modal-content');
            content.innerHTML = `
                <p style="margin-bottom: 14px; font-size: 13px;">
                    <strong>${shift.name}</strong> on ${formatDate(date, 'full')}
                </p>
                ${availableStaff.length > 0 ? `
                    <div style="display: grid; gap: 6px; max-height: 400px; overflow-y: auto;">
                        ${availableStaff.map(staff => {
                            const hours = calculateWeekHours(staff.id);
                            return `
                                <button class="btn btn-secondary" style="width: 100%; justify-content: space-between;" 
                                        onclick="assignStaff('${date}', '${shiftId}', '${staff.id}')">
                                    <span><span class="role-badge ${staff.role}">${ROLE_LABELS[staff.role]}</span> ${staff.name}</span>
                                    <span style="font-size: 11px; color: var(--text-muted);">${hours.toFixed(1)}h this week</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <p>No available staff for this shift.</p>
                        <p style="font-size: 12px;">All employees are either already assigned, unavailable, or at max hours.</p>
                    </div>
                `}
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('assign-modal')">Cancel</button>
                </div>
            `;
            
            openModal('assign-modal');
        }

        function assignStaff(date, shiftId, staffId) {
            if (!state.schedule[date]) state.schedule[date] = {};
            if (!state.schedule[date][shiftId]) state.schedule[date][shiftId] = [];
            
            // Prevent duplicates
            if (!state.schedule[date][shiftId].some(a => a.staffId === staffId)) {
                const staff = state.staff.find(s => s.id === staffId);
                state.schedule[date][shiftId].push({ staffId, role: staff.role });
                saveState();
            }
            
            closeModal('assign-modal');
            renderSchedule();
            renderDashboard();
            showToast('Shift assigned');
        }

        function removeAssignment(date, shiftId, staffId) {
            if (state.schedule[date]?.[shiftId]) {
                state.schedule[date][shiftId] = state.schedule[date][shiftId].filter(a => a.staffId !== staffId);
                saveState();
                renderSchedule();
                renderDashboard();
            }
        }

        function showShiftOptions(date, shiftId, staffId) {
            const staff = state.staff.find(s => s.id === staffId);
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            
            if (confirm(`Remove ${staff.name} from ${shift.name} on ${formatDate(date)}?`)) {
                removeAssignment(date, shiftId, staffId);
            }
        }

        function clearWeekSchedule() {
            if (confirm('Clear all shifts for this week?')) {
                const weekDates = getWeekDates(state.currentWeekStart);
                weekDates.forEach(date => {
                    const dateKey = formatDate(date, 'iso');
                    delete state.schedule[dateKey];
                });
                saveState();
                renderSchedule();
                renderDashboard();
                showToast('Week cleared', 'warning');
            }
        }

        // ============================================
        // DRAG & DROP
        // ============================================
        let dragData = null;

        function handleDragStart(e, date, shiftId, staffId) {
            dragData = { date, shiftId, staffId };
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (!dragData) return;
            
            const newDate = e.currentTarget.dataset.date;
            const newShiftId = e.currentTarget.dataset.shift;
            
            // Remove from old position
            removeAssignment(dragData.date, dragData.shiftId, dragData.staffId);
            
            // Add to new position
            assignStaff(newDate, newShiftId, dragData.staffId);
            
            dragData = null;
        }

        // ============================================
        // CONFLICTS & ALERTS
        // ============================================
        function getConflicts(date, shiftId) {
            const conflicts = [];
            const shift = state.shiftTemplates.find(s => s.id === shiftId);
            const assignments = state.schedule[date]?.[shiftId] || [];
            const requirements = shift?.requirements || {};

            // Check understaffing
            ROLES.forEach(role => {
                const required = requirements[role] || 0;
                const assigned = assignments.filter(a => {
                    const staff = state.staff.find(s => s.id === a.staffId);
                    return staff?.role === role;
                }).length;

                if (assigned < required) {
                    conflicts.push({
                        type: 'warning',
                        message: `Need ${required - assigned} more ${ROLE_LABELS[role]}(s)`,
                        action: 'assignRole',
                        role: role,
                        dateKey: date,
                        shiftId: shiftId,
                        needed: required - assigned
                    });
                }
            });

            // Check overtime
            assignments.forEach(a => {
                const staff = state.staff.find(s => s.id === a.staffId);
                if (staff) {
                    const hours = calculateWeekHours(staff.id);
                    if (hours > staff.maxHours) {
                        conflicts.push({
                            type: 'danger',
                            message: `${staff.name} is over max hours (${hours.toFixed(1)}/${staff.maxHours}h)`,
                            action: 'viewStaff',
                            staffId: staff.id,
                            staffName: staff.name
                        });
                    }
                }
            });

            return conflicts;
        }

        function getAllAlerts() {
            const alerts = [];
            const weekDates = getWeekDates(state.currentWeekStart);

            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                state.shiftTemplates.forEach(shift => {
                    const conflicts = getConflicts(dateKey, shift.id);
                    conflicts.forEach(c => {
                        alerts.push({
                            ...c,
                            date: formatDate(date),
                            shift: shift.name
                        });
                    });
                });
            });

            // Check staff with no shifts
            state.staff.forEach(staff => {
                const hours = calculateWeekHours(staff.id);
                if (hours === 0) {
                    alerts.push({
                        type: 'info',
                        message: `${staff.name} has no shifts this week`,
                        date: '',
                        shift: '',
                        action: 'scheduleStaff',
                        staffId: staff.id,
                        staffName: staff.name,
                        role: staff.role
                    });
                }
            });

            // Check for pending shift swaps (manager only)
            if (currentUserData?.role === 'manager') {
                const pendingSwaps = (state.shiftTrades || []).filter(t => t.status === 'pending_manager_approval');
                pendingSwaps.forEach(trade => {
                    const fromStaff = state.staff.find(s => s.id === trade.postedBy);
                    const toStaff = state.staff.find(s => s.id === trade.approvedRequesterId);
                    const shift = state.shiftTemplates.find(s => s.id === trade.shiftId);
                    alerts.unshift({
                        type: 'warning',
                        message: `Shift swap: ${fromStaff?.name || '?'}  ${toStaff?.name || '?'}`,
                        date: trade.date,
                        shift: shift?.name || '',
                        action: 'approveSwap',
                        tradeId: trade.id
                    });
                });
            }

            return alerts;
        }

        // ============================================
        // AI AUTO-SCHEDULE
        // ============================================
        function autoSchedule() {
            if (state.staff.length === 0) {
                showToast('Add employees first', 'error');
                return;
            }
            
            if (state.shiftTemplates.length === 0) {
                showToast('Create shift templates first', 'error');
                return;
            }
            
            if (!confirm('Auto-schedule will fill empty slots. Continue?')) return;
            
            const weekDates = getWeekDates(state.currentWeekStart);
            let assigned = 0;
            
            // Track hours assigned this session
            const sessionHours = {};
            state.staff.forEach(s => sessionHours[s.id] = calculateWeekHours(s.id));
            
            // For each day and shift
            weekDates.forEach((date, dayIndex) => {
                const dateKey = formatDate(date, 'iso');
                
                // Skip holidays
                if (state.holidays.find(h => h.date === dateKey && h.closed)) return;
                
                state.shiftTemplates.forEach(shift => {
                    if (!state.schedule[dateKey]) state.schedule[dateKey] = {};
                    if (!state.schedule[dateKey][shift.id]) state.schedule[dateKey][shift.id] = [];
                    
                    const currentAssignments = state.schedule[dateKey][shift.id];
                    const shiftHours = calculateShiftHours(shift);
                    
                    // For each role requirement
                    ROLES.forEach(role => {
                        const required = shift.requirements?.[role] || 0;
                        const currentCount = currentAssignments.filter(a => {
                            const staff = state.staff.find(s => s.id === a.staffId);
                            return staff?.role === role;
                        }).length;
                        
                        const needed = required - currentCount;
                        
                        if (needed > 0) {
                            // Find available staff for this role
                            const candidates = state.staff
                                .filter(s => {
                                    // Right role
                                    if (s.role !== role) return false;
                                    
                                    // Not already assigned
                                    if (currentAssignments.some(a => a.staffId === s.id)) return false;
                                    
                                    // Check availability
                                    // Empty {} = available for everything
                                    // Day with [] = NOT available that day
                                    // Day with shifts = only available for those shifts
                                    // Day not specified = available for everything that day
                                    const avail = s.availability?.[dayIndex];
                                    if (avail !== undefined) {
                                        if (avail.length === 0) return false; // explicitly unavailable
                                        // Check both shift ID and name (lowercase) for compatibility
                                        const shiftMatches = avail.some(a => a === shift.id || a === shift.name.toLowerCase());
                                        if (!shiftMatches) return false; // shift not allowed
                                    }
                                    
                                    // Check max hours
                                    if (sessionHours[s.id] + shiftHours > s.maxHours) return false;
                                    
                                    return true;
                                })
                                // Sort by least hours (fairness)
                                .sort((a, b) => sessionHours[a.id] - sessionHours[b.id]);
                            
                            // Assign as many as needed
                            for (let i = 0; i < Math.min(needed, candidates.length); i++) {
                                const staff = candidates[i];
                                currentAssignments.push({ staffId: staff.id, role: staff.role });
                                sessionHours[staff.id] += shiftHours;
                                assigned++;
                            }
                        }
                    });
                });
            });
            
            saveState();
            renderSchedule();
            renderDashboard();
            
            if (assigned > 0) {
                showToast(`Auto-scheduled ${assigned} shifts`);
            } else {
                showToast('No shifts could be auto-filled', 'warning');
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function renderDashboard() {
            const weekDates = getWeekDates(state.currentWeekStart);
            document.getElementById('dashboard-week').textContent = 
                `${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}`;
            
            // Stats
            const totalShifts = Object.values(state.schedule).reduce((sum, day) => 
                sum + Object.values(day).reduce((s, shifts) => s + shifts.length, 0), 0);
            const alerts = getAllAlerts();
            const laborCost = calculateWeeklyLaborCost();
            const totalHours = calculateTotalWeeklyHours();
            
            document.getElementById('dashboard-stats').innerHTML = `
                <div class="stat-card clickable" onclick="navigateTo('staff')" title="View Staff">
                    <div class="stat-icon"></div>
                    <div>
                        <div class="stat-value">${state.staff.length}</div>
                        <div class="stat-label">Total Staff</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="navigateTo('schedule')" title="View Schedule">
                    <div class="stat-icon"></div>
                    <div>
                        <div class="stat-value">${totalShifts}</div>
                        <div class="stat-label">Scheduled Shifts</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="scrollToAlerts()" title="View Alerts">
                    <div class="stat-icon">!</div>
                    <div>
                        <div class="stat-value">${alerts.filter(a => a.type !== 'info').length}</div>
                        <div class="stat-label">Alerts</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="navigateTo('labor')" title="View Labor Costs">
                    <div class="stat-icon">$</div>
                    <div>
                        <div class="stat-value">$${laborCost.toFixed(0)}</div>
                        <div class="stat-label">Est. Labor Cost</div>
                    </div>
                </div>
            `;
            
            // Alerts
            const alertsList = document.getElementById('alerts-list');
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                         No alerts - everything looks good
                    </div>
                `;
            } else {
                alertsList.innerHTML = alerts.slice(0, 5).map((alert, idx) => `
                    <div class="alert-item ${alert.type} clickable" onclick="handleAlertClick(${idx})" title="Click to resolve">
                        <span class="alert-icon">${alert.type === 'danger' ? '!' : alert.type === 'warning' ? '!' : 'i'}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.message}</div>
                            ${alert.date ? `<div class="alert-desc">${alert.shift} on ${alert.date}</div>` : ''}
                        </div>
                        <span class="alert-action-hint"></span>
                    </div>
                `).join('');
            }

            // Store alerts for click handling
            window.currentAlerts = alerts;
        }

        function scrollToAlerts() {
            document.getElementById('alerts-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function handleAlertClick(alertIndex) {
            const alert = window.currentAlerts?.[alertIndex];
            if (!alert) return;

            switch (alert.action) {
                case 'assignRole':
                    // Open modal to assign staff of this role to this shift
                    openAssignRoleModal(alert);
                    break;
                case 'viewStaff':
                    // Navigate to staff page and highlight/edit this person
                    navigateTo('staff');
                    setTimeout(() => {
                        const row = document.querySelector(`[data-staff-id="${alert.staffId}"]`);
                        if (row) {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.style.animation = 'highlight-pulse 1s ease';
                        }
                    }, 100);
                    showToast(`Viewing ${alert.staffName} - consider reducing their hours`, 'info');
                    break;
                case 'scheduleStaff':
                    // Navigate to schedule and suggest adding this person
                    navigateTo('schedule');
                    showToast(`${alert.staffName} (${ROLE_LABELS[alert.role]}) has no shifts - drag them onto the schedule`, 'info');
                    break;
                case 'approveSwap':
                    // Show swap approval dialog
                    openSwapApprovalModal(alert.tradeId);
                    break;
                default:
                    // Default: navigate to schedule
                    navigateTo('schedule');
            }
        }

        function openSwapApprovalModal(tradeId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade) return;

            const fromStaff = state.staff.find(s => s.id === trade.postedBy);
            const toStaff = state.staff.find(s => s.id === trade.approvedRequesterId);
            const shift = state.shiftTemplates.find(s => s.id === trade.shiftId);

            let modal = document.getElementById('swap-approval-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'swap-approval-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Approve Shift Swap?</h2>
                            <button class="modal-close" onclick="closeModal('swap-approval-modal')"></button>
                        </div>
                        <div id="swap-approval-content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('swap-approval-content').innerHTML = `
                <div style="padding: 16px;">
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius); margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="text-align: center;">
                                <div style="font-weight: 600;">${fromStaff?.name || 'Unknown'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Giving up shift</div>
                            </div>
                            <div style="font-size: 24px; color: var(--accent);"></div>
                            <div style="text-align: center;">
                                <div style="font-weight: 600;">${toStaff?.name || 'Unknown'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Taking shift</div>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Shift:</strong> ${shift?.name || trade.shiftId}</p>
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Date:</strong> ${trade.date}</p>
                    ${trade.reason ? `<p style="font-size: 14px; margin-bottom: 16px;"><strong>Reason:</strong> ${trade.reason}</p>` : ''}
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
                        <button class="btn btn-danger" onclick="managerDenySwap('${tradeId}'); closeModal('swap-approval-modal');">Deny</button>
                        <button class="btn btn-success" onclick="managerApproveSwap('${tradeId}'); closeModal('swap-approval-modal');">Approve</button>
                    </div>
                </div>
            `;

            openModal('swap-approval-modal');
        }

        function openAssignRoleModal(alert) {
            // Find available staff for this role who aren't already assigned
            const availableStaff = state.staff.filter(s => {
                if (s.role !== alert.role) return false;
                // Check if already assigned to this shift
                const assignments = state.schedule[alert.dateKey]?.[alert.shiftId] || [];
                if (assignments.some(a => a.staffId === s.id)) return false;
                // Check if under max hours
                const hours = calculateWeekHours(s.id);
                const shift = state.shiftTemplates.find(t => t.id === alert.shiftId);
                const shiftHours = shift ? calculateShiftHours(shift) : 0;
                return hours + shiftHours <= s.maxHours;
            });

            const shift = state.shiftTemplates.find(t => t.id === alert.shiftId);

            if (availableStaff.length === 0) {
                showToast(`No available ${ROLE_LABELS[alert.role]}s for this shift. Consider hiring more.`, 'warning');
                navigateTo('staff');
                return;
            }

            // Create modal content
            const staffOptions = availableStaff.map(s => {
                const hours = calculateWeekHours(s.id);
                return `
                    <div class="assign-option" onclick="quickAssignStaff('${s.id}', '${alert.dateKey}', '${alert.shiftId}')">
                        <div>
                            <strong>${s.name}</strong>
                            <div style="font-size: 12px; color: var(--text-muted);">${hours.toFixed(1)}h / ${s.maxHours}h this week</div>
                        </div>
                        <button class="btn btn-primary btn-sm">Assign</button>
                    </div>
                `;
            }).join('');

            let modal = document.getElementById('quick-assign-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'quick-assign-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2 class="modal-title" id="quick-assign-title">Assign Staff</h2>
                            <button class="modal-close" onclick="closeModal('quick-assign-modal')"></button>
                        </div>
                        <div id="quick-assign-content" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('quick-assign-title').textContent = `Assign ${ROLE_LABELS[alert.role]} - ${shift?.name || ''}`;
            document.getElementById('quick-assign-content').innerHTML = `
                <p style="padding: 12px 16px; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid var(--border-color);">
                    ${alert.date}  Need ${alert.needed} more
                </p>
                ${staffOptions}
            `;

            openModal('quick-assign-modal');
        }

        function quickAssignStaff(staffId, dateKey, shiftId) {
            if (!state.schedule[dateKey]) state.schedule[dateKey] = {};
            if (!state.schedule[dateKey][shiftId]) state.schedule[dateKey][shiftId] = [];

            // Check if not already assigned
            if (!state.schedule[dateKey][shiftId].some(a => a.staffId === staffId)) {
                state.schedule[dateKey][shiftId].push({ staffId });
                saveState();

                const staff = state.staff.find(s => s.id === staffId);
                showToast(`${staff?.name || 'Staff'} assigned!`, 'success');

                closeModal('quick-assign-modal');
                renderDashboard();
                renderSchedule();
            }
        }

        // ============================================
        // LABOR COSTS
        // ============================================
        function calculateWeeklyLaborCost() {
            let total = 0;
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            const hours = calculateShiftHours(template);
                            assignments.forEach(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff) {
                                    total += hours * staff.hourlyRate;
                                }
                            });
                        }
                    });
                }
            });
            
            return total;
        }

        function calculateTotalWeeklyHours() {
            let total = 0;
            const weekDates = getWeekDates(state.currentWeekStart);
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            total += calculateShiftHours(template) * assignments.length;
                        }
                    });
                }
            });
            
            return total;
        }

        function renderLaborCosts() {
            const weekDates = getWeekDates(state.currentWeekStart);
            const totalCost = calculateWeeklyLaborCost();
            const totalHours = calculateTotalWeeklyHours();
            const avgHourlyRate = state.staff.length > 0 
                ? state.staff.reduce((sum, s) => sum + s.hourlyRate, 0) / state.staff.length 
                : 0;
            
            document.getElementById('labor-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">$</div>
                    <div>
                        <div class="stat-value">$${totalCost.toFixed(2)}</div>
                        <div class="stat-label">Total Labor Cost</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div>
                        <div class="stat-value">${totalHours.toFixed(1)}h</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div>
                        <div class="stat-value">$${avgHourlyRate.toFixed(2)}</div>
                        <div class="stat-label">Avg Hourly Rate</div>
                    </div>
                </div>
            `;
            
            // Daily breakdown
            const breakdown = document.getElementById('labor-breakdown');
            breakdown.innerHTML = weekDates.map((date, i) => {
                const dateKey = formatDate(date, 'iso');
                let dayHours = 0;
                let dayCost = 0;
                let dayStaff = new Set();
                
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            const hours = calculateShiftHours(template);
                            assignments.forEach(a => {
                                dayStaff.add(a.staffId);
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff) {
                                    dayHours += hours;
                                    dayCost += hours * staff.hourlyRate;
                                }
                            });
                        }
                    });
                }
                
                return `
                    <tr>
                        <td><strong>${DAYS[i]}</strong> ${formatDate(date)}</td>
                        <td>${dayHours.toFixed(1)}h</td>
                        <td>$${dayCost.toFixed(2)}</td>
                        <td>${dayStaff.size}</td>
                    </tr>
                `;
            }).join('');
            
            // Cost by role
            const roleContainer = document.getElementById('labor-by-role');
            const roleCosts = {};
            ROLES.forEach(role => roleCosts[role] = { hours: 0, cost: 0 });
            
            weekDates.forEach(date => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        const template = state.shiftTemplates.find(t => t.id === shiftId);
                        if (template) {
                            const hours = calculateShiftHours(template);
                            assignments.forEach(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff && roleCosts[staff.role]) {
                                    roleCosts[staff.role].hours += hours;
                                    roleCosts[staff.role].cost += hours * staff.hourlyRate;
                                }
                            });
                        }
                    });
                }
            });
            
            roleContainer.innerHTML = `
                <div class="labor-summary">
                    ${ROLES.map(role => `
                        <div class="labor-item">
                            <div class="labor-value">$${roleCosts[role].cost.toFixed(0)}</div>
                            <div class="labor-label">${ROLE_LABELS[role]} (${roleCosts[role].hours.toFixed(1)}h)</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // TEAM & INVITES (Manager Only)
        // ============================================
        async function renderTeamPage() {
            if (!currentUserData || currentUserData.role !== 'manager') return;

            // Display org code
            document.getElementById('org-code-display').textContent = currentUserData.orgCode;

            // Load organization data for invites
            try {
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', currentUserData.orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (orgSnap.exists()) {
                    const orgData = orgSnap.data();

                    // Manager invites
                    const managerInvites = orgData.managerInvites || [];
                    const invitesList = document.getElementById('pending-invites-list');
                    if (managerInvites.length === 0) {
                        invitesList.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No pending invites</td></tr>';
                    } else {
                        invitesList.innerHTML = managerInvites.map(email => `
                            <tr>
                                <td>${email}</td>
                                <td>Pending</td>
                                <td><button class="btn btn-danger btn-sm" onclick="removeInvite('${email}')">Remove</button></td>
                            </tr>
                        `).join('');
                    }

                    // Employee invites
                    const employeeInvites = orgData.employeeInvites || [];
                    const employeeInvitesList = document.getElementById('pending-employee-invites-list');
                    if (employeeInvites.length === 0) {
                        employeeInvitesList.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No pending invites</td></tr>';
                    } else {
                        employeeInvitesList.innerHTML = employeeInvites.map(email => `
                            <tr>
                                <td>${email}</td>
                                <td>Pending</td>
                                <td><button class="btn btn-danger btn-sm" onclick="removeEmployeeInvite('${email}')">Remove</button></td>
                            </tr>
                        `).join('');
                    }

                    // Require employee invite toggle
                    document.getElementById('require-employee-invite').checked = orgData.requireEmployeeInvite || false;
                }
            } catch (error) {
                console.error('Error loading org data:', error);
            }

            // Load team members (simplified - would need Firebase query in production)
            // For now, just show current user
            const membersList = document.getElementById('team-members-list');
            membersList.innerHTML = `
                <tr>
                    <td>${currentUserData.name || 'You'}</td>
                    <td>${currentUserData.email || currentUser.email}</td>
                    <td><span style="color: var(--accent); font-weight: 500;">Manager</span></td>
                    <td>${new Date(currentUserData.createdAt).toLocaleDateString()}</td>
                </tr>
            `;

            // Update counts (simplified)
            document.getElementById('manager-count').textContent = '1+';
            document.getElementById('employee-count').textContent = state.staff.length.toString();

            // Render pending shift swaps awaiting manager approval
            renderPendingSwaps();
        }

        function renderPendingSwaps() {
            const pendingSwaps = (state.shiftTrades || []).filter(t => t.status === 'pending_manager_approval');
            const swapsList = document.getElementById('pending-swaps-list');
            const badge = document.getElementById('pending-swaps-badge');

            // Update badge
            if (pendingSwaps.length > 0) {
                badge.textContent = pendingSwaps.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }

            if (pendingSwaps.length === 0) {
                swapsList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No pending swaps</td></tr>';
            } else {
                swapsList.innerHTML = pendingSwaps.map(trade => {
                    const fromStaff = state.staff.find(s => s.id === trade.postedBy);
                    const toStaff = state.staff.find(s => s.id === trade.approvedRequesterId);
                    const shift = state.shiftTemplates.find(s => s.id === trade.shiftId);
                    return `
                        <tr>
                            <td>${trade.date}</td>
                            <td>${shift?.name || trade.shiftId}</td>
                            <td><strong>${fromStaff?.name || 'Unknown'}</strong></td>
                            <td><strong>${toStaff?.name || 'Unknown'}</strong></td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="managerApproveSwap('${trade.id}')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="managerDenySwap('${trade.id}')">Deny</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function inviteManager() {
            const emailInput = document.getElementById('invite-manager-email');
            const email = emailInput.value.toLowerCase().trim();

            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            try {
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', currentUserData.orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (orgSnap.exists()) {
                    const orgData = orgSnap.data();
                    const invites = orgData.managerInvites || [];

                    if (invites.map(e => e.toLowerCase()).includes(email)) {
                        showToast('This email is already invited', 'warning');
                        return;
                    }

                    invites.push(email);
                    await window.firebaseSetDoc(orgRef, { ...orgData, managerInvites: invites });

                    emailInput.value = '';
                    showToast(`Invited ${email} as manager`, 'success');
                    renderTeamPage();
                }
            } catch (error) {
                console.error('Error inviting manager:', error);
                showToast('Error sending invite', 'error');
            }
        }

        async function removeInvite(email) {
            if (!confirm(`Remove invite for ${email}?`)) return;

            try {
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', currentUserData.orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (orgSnap.exists()) {
                    const orgData = orgSnap.data();
                    const invites = (orgData.managerInvites || []).filter(e => e.toLowerCase() !== email.toLowerCase());
                    await window.firebaseSetDoc(orgRef, { ...orgData, managerInvites: invites });

                    showToast('Invite removed', 'success');
                    renderTeamPage();
                }
            } catch (error) {
                console.error('Error removing invite:', error);
                showToast('Error removing invite', 'error');
            }
        }

        function copyOrgCode() {
            const code = currentUserData.orgCode;
            navigator.clipboard.writeText(code).then(() => {
                showToast(`Copied: ${code}`, 'success');
            }).catch(() => {
                showToast('Could not copy code', 'error');
            });
        }

        function copyOrgCodeFromSidebar() {
            if (currentUserData?.orgCode) {
                navigator.clipboard.writeText(currentUserData.orgCode).then(() => {
                    showToast(`Copied: ${currentUserData.orgCode}`, 'success');
                }).catch(() => {
                    showToast('Could not copy code', 'error');
                });
            }
        }

        function updateOrgCodeDisplay() {
            const sidebarEl = document.getElementById('orgCodeSidebar');
            const codeEl = document.getElementById('sidebarOrgCode');

            if (currentUserData?.orgCode && sidebarEl && codeEl) {
                codeEl.textContent = currentUserData.orgCode;
                // Only show for managers
                sidebarEl.style.display = currentUserData.role === 'manager' ? 'block' : 'none';
            }
        }

        async function inviteEmployee() {
            const emailInput = document.getElementById('invite-employee-email');
            const email = emailInput.value.toLowerCase().trim();

            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            try {
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', currentUserData.orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (orgSnap.exists()) {
                    const orgData = orgSnap.data();
                    const invites = orgData.employeeInvites || [];

                    if (invites.map(e => e.toLowerCase()).includes(email)) {
                        showToast('This email is already invited', 'warning');
                        return;
                    }

                    invites.push(email);
                    await window.firebaseSetDoc(orgRef, { ...orgData, employeeInvites: invites });

                    emailInput.value = '';
                    showToast(`Invited ${email} as employee`, 'success');
                    renderTeamPage();
                }
            } catch (error) {
                console.error('Error inviting employee:', error);
                showToast('Error sending invite', 'error');
            }
        }

        async function removeEmployeeInvite(email) {
            if (!confirm(`Remove invite for ${email}?`)) return;

            try {
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', currentUserData.orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (orgSnap.exists()) {
                    const orgData = orgSnap.data();
                    const invites = (orgData.employeeInvites || []).filter(e => e.toLowerCase() !== email.toLowerCase());
                    await window.firebaseSetDoc(orgRef, { ...orgData, employeeInvites: invites });

                    showToast('Invite removed', 'success');
                    renderTeamPage();
                }
            } catch (error) {
                console.error('Error removing invite:', error);
                showToast('Error removing invite', 'error');
            }
        }

        async function toggleEmployeeInviteRequirement() {
            const checked = document.getElementById('require-employee-invite').checked;

            try {
                const orgRef = window.firebaseDoc(window.firebaseDb, 'organizations', currentUserData.orgCode);
                const orgSnap = await window.firebaseGetDoc(orgRef);

                if (orgSnap.exists()) {
                    const orgData = orgSnap.data();
                    await window.firebaseSetDoc(orgRef, { ...orgData, requireEmployeeInvite: checked });
                    showToast(checked ? 'Employee invites now required' : 'Anyone can join as employee', 'success');
                }
            } catch (error) {
                console.error('Error updating setting:', error);
                showToast('Error updating setting', 'error');
            }
        }

        // ============================================
        // SHIFT MARKETPLACE
        // ============================================
        // Initialize shift marketplace in state
        if (!state.shiftTrades) state.shiftTrades = [];

        function renderShiftMarketplace() {
            const availableList = document.getElementById('available-shifts-list');
            const myPostsList = document.getElementById('my-posted-shifts-list');
            const myRequestsList = document.getElementById('my-shift-requests-list');

            // Get current user's staff record (if they're an employee)
            const myStaff = state.staff.find(s =>
                s.email?.toLowerCase() === currentUser?.email?.toLowerCase() ||
                s.name.toLowerCase().includes(currentUserData?.name?.toLowerCase() || '')
            );
            const myStaffId = myStaff?.id;

            // Filter trades - only show 'open' trades as available (not pending_manager_approval)
            const openTrades = (state.shiftTrades || []).filter(t => t.status === 'open');
            const pendingApprovalTrades = (state.shiftTrades || []).filter(t => t.status === 'pending_manager_approval');
            const myPosts = (state.shiftTrades || []).filter(t => t.postedBy === myStaffId && (t.status === 'open' || t.status === 'pending_manager_approval'));
            const otherPosts = openTrades.filter(t => t.postedBy !== myStaffId);
            const myRequests = (state.shiftTrades || []).filter(t =>
                t.requests?.some(r => r.requesterId === myStaffId) ||
                t.approvedRequesterId === myStaffId
            );
            const myPendingApproval = pendingApprovalTrades.filter(t => t.approvedRequesterId === myStaffId);

            // Update counts
            document.getElementById('shifts-posted-count').textContent = otherPosts.length;
            document.getElementById('my-posts-count').textContent = myPosts.length;
            document.getElementById('pending-requests-count').textContent = myRequests.length;

            // Render available shifts
            if (otherPosts.length === 0) {
                availableList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No shifts available for trade</td></tr>';
            } else {
                availableList.innerHTML = otherPosts.map(trade => {
                    const poster = state.staff.find(s => s.id === trade.postedBy);
                    const shift = state.shiftTemplates.find(s => s.id === trade.shiftId);
                    return `
                        <tr>
                            <td>${trade.date}</td>
                            <td>${shift?.name || trade.shiftId} (${shift?.startTime}-${shift?.endTime})</td>
                            <td>${poster?.name || 'Unknown'}</td>
                            <td>${trade.reason || '-'}</td>
                            <td><button class="btn btn-primary btn-sm" onclick="requestShift('${trade.id}')">Request</button></td>
                        </tr>
                    `;
                }).join('');
            }

            // Render my posts
            if (myPosts.length === 0) {
                myPostsList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">You haven\'t posted any shifts</td></tr>';
            } else {
                myPostsList.innerHTML = myPosts.map(trade => {
                    const shift = state.shiftTemplates.find(s => s.id === trade.shiftId);
                    const requestCount = trade.requests?.length || 0;
                    const isPendingManager = trade.status === 'pending_manager_approval';
                    const taker = isPendingManager ? state.staff.find(s => s.id === trade.approvedRequesterId) : null;

                    let statusHtml, actionsHtml;
                    if (isPendingManager) {
                        statusHtml = `<span style="color: var(--info);"> Awaiting Manager</span>`;
                        actionsHtml = `<span style="font-size: 12px; color: var(--text-muted);">${taker?.name || 'Someone'} taking</span>`;
                    } else {
                        statusHtml = `<span style="color: var(--warning);">Open</span>`;
                        actionsHtml = `
                            ${requestCount > 0 ? `<button class="btn btn-success btn-sm" onclick="viewTradeRequests('${trade.id}')">View (${requestCount})</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="cancelTrade('${trade.id}')">Cancel</button>
                        `;
                    }

                    return `
                        <tr>
                            <td>${trade.date}</td>
                            <td>${shift?.name || trade.shiftId}</td>
                            <td>${isPendingManager ? taker?.name || '-' : requestCount + ' request(s)'}</td>
                            <td>${statusHtml}</td>
                            <td>${actionsHtml}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Render my requests (including ones waiting for manager approval)
            const myActiveRequests = (state.shiftTrades || []).filter(t => {
                // Include if I'm a requester OR if I'm the approved requester waiting for manager
                const isMyRequest = t.requests?.some(r => r.requesterId === myStaffId);
                const isMyApprovedRequest = t.approvedRequesterId === myStaffId && t.status === 'pending_manager_approval';
                return (isMyRequest && t.status === 'open') || isMyApprovedRequest;
            });

            if (myActiveRequests.length === 0) {
                myRequestsList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No pending requests</td></tr>';
            } else {
                myRequestsList.innerHTML = myActiveRequests.map(trade => {
                    const poster = state.staff.find(s => s.id === trade.postedBy);
                    const shift = state.shiftTemplates.find(s => s.id === trade.shiftId);
                    const isPendingManager = trade.status === 'pending_manager_approval' && trade.approvedRequesterId === myStaffId;

                    let statusHtml, actionsHtml;
                    if (isPendingManager) {
                        statusHtml = `<span style="color: var(--success);"> Approved - Awaiting Manager</span>`;
                        actionsHtml = `<span style="font-size: 12px; color: var(--text-muted);">Manager will confirm</span>`;
                    } else {
                        statusHtml = `<span style="color: var(--info);">Pending</span>`;
                        actionsHtml = `<button class="btn btn-danger btn-sm" onclick="cancelRequest('${trade.id}')">Withdraw</button>`;
                    }

                    return `
                        <tr>
                            <td>${trade.date}</td>
                            <td>${shift?.name || trade.shiftId}</td>
                            <td>${poster?.name || 'Unknown'}</td>
                            <td>${statusHtml}</td>
                            <td>${actionsHtml}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function openPostShiftModal() {
            // Find user's scheduled shifts
            const myStaff = state.staff.find(s =>
                s.email?.toLowerCase() === currentUser?.email?.toLowerCase() ||
                s.name.toLowerCase().includes(currentUserData?.name?.toLowerCase() || '')
            );

            if (!myStaff) {
                showToast('You need to be linked to a staff member to post shifts', 'error');
                return;
            }

            const weekDates = getWeekDates(state.currentWeekStart);
            const myShifts = [];

            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        if (assignments.some(a => a.staffId === myStaff.id)) {
                            const shift = state.shiftTemplates.find(s => s.id === shiftId);
                            myShifts.push({
                                date: dateKey,
                                dayName: DAYS[i],
                                shiftId,
                                shiftName: shift?.name || shiftId
                            });
                        }
                    });
                }
            });

            if (myShifts.length === 0) {
                showToast('You have no scheduled shifts to post', 'info');
                return;
            }

            // Create a simple select dialog
            const options = myShifts.map(s =>
                `<option value="${s.date}|${s.shiftId}">${s.dayName} - ${s.shiftName}</option>`
            ).join('');

            const html = `
                <div style="padding: 16px;">
                    <label class="form-label">Select shift to post:</label>
                    <select class="form-input" id="post-shift-select">${options}</select>
                    <label class="form-label" style="margin-top: 12px;">Reason (optional):</label>
                    <input type="text" class="form-input" id="post-shift-reason" placeholder="e.g., Doctor appointment">
                    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeModal('post-shift-modal')">Cancel</button>
                        <button class="btn btn-primary" onclick="submitPostShift()">Post Shift</button>
                    </div>
                </div>
            `;

            // Create modal dynamically
            let modal = document.getElementById('post-shift-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'post-shift-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Post Shift for Trade</h2>
                            <button class="modal-close" onclick="closeModal('post-shift-modal')"></button>
                        </div>
                        <div id="post-shift-content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('post-shift-content').innerHTML = html;
            openModal('post-shift-modal');
        }

        function submitPostShift() {
            const select = document.getElementById('post-shift-select');
            const reason = document.getElementById('post-shift-reason').value;
            const [date, shiftId] = select.value.split('|');

            const myStaff = state.staff.find(s =>
                s.email?.toLowerCase() === currentUser?.email?.toLowerCase() ||
                s.name.toLowerCase().includes(currentUserData?.name?.toLowerCase() || '')
            );

            if (!state.shiftTrades) state.shiftTrades = [];

            state.shiftTrades.push({
                id: generateId(),
                date,
                shiftId,
                postedBy: myStaff.id,
                reason,
                status: 'open',
                requests: [],
                createdAt: new Date().toISOString()
            });

            saveState();
            closeModal('post-shift-modal');
            showToast('Shift posted for trade!', 'success');
            renderShiftMarketplace();
        }

        function requestShift(tradeId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade) return;

            const myStaff = state.staff.find(s =>
                s.email?.toLowerCase() === currentUser?.email?.toLowerCase() ||
                s.name.toLowerCase().includes(currentUserData?.name?.toLowerCase() || '')
            );

            if (!myStaff) {
                showToast('You need to be linked to a staff member', 'error');
                return;
            }

            if (!trade.requests) trade.requests = [];

            if (trade.requests.some(r => r.requesterId === myStaff.id)) {
                showToast('You already requested this shift', 'warning');
                return;
            }

            trade.requests.push({
                requesterId: myStaff.id,
                status: 'pending',
                requestedAt: new Date().toISOString()
            });

            saveState();
            showToast('Shift requested! Waiting for approval.', 'success');
            renderShiftMarketplace();
        }

        function cancelTrade(tradeId) {
            if (!confirm('Cancel this shift posting?')) return;
            state.shiftTrades = state.shiftTrades.filter(t => t.id !== tradeId);
            saveState();
            showToast('Shift posting cancelled', 'success');
            renderShiftMarketplace();
        }

        function cancelRequest(tradeId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade) return;

            const myStaff = state.staff.find(s =>
                s.email?.toLowerCase() === currentUser?.email?.toLowerCase() ||
                s.name.toLowerCase().includes(currentUserData?.name?.toLowerCase() || '')
            );

            trade.requests = trade.requests.filter(r => r.requesterId !== myStaff.id);
            saveState();
            showToast('Request withdrawn', 'success');
            renderShiftMarketplace();
        }

        function viewTradeRequests(tradeId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade || !trade.requests?.length) return;

            const html = trade.requests.map(req => {
                const requester = state.staff.find(s => s.id === req.requesterId);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <strong>${requester?.name || 'Unknown'}</strong>
                            <div style="font-size: 12px; color: var(--text-muted);">${requester?.role ? ROLE_LABELS[requester.role] : ''}</div>
                        </div>
                        <button class="btn btn-success btn-sm" onclick="approveTradeRequest('${tradeId}', '${req.requesterId}')">Approve</button>
                    </div>
                `;
            }).join('');

            let modal = document.getElementById('view-requests-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'view-requests-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Shift Requests</h2>
                            <button class="modal-close" onclick="closeModal('view-requests-modal')"></button>
                        </div>
                        <div id="view-requests-content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('view-requests-content').innerHTML = html;
            openModal('view-requests-modal');
        }

        function approveTradeRequest(tradeId, requesterId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade) return;

            // Set to pending manager approval (don't swap yet)
            trade.status = 'pending_manager_approval';
            trade.approvedRequesterId = requesterId;
            trade.employeeApprovedAt = new Date().toISOString();

            saveState();
            closeModal('view-requests-modal');
            showToast('Swap sent to manager for approval!', 'success');
            renderShiftMarketplace();
        }

        // Manager approves the shift swap
        function managerApproveSwap(tradeId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade || trade.status !== 'pending_manager_approval') return;

            // Now actually swap the shift assignment
            const dateKey = trade.date;
            if (state.schedule[dateKey] && state.schedule[dateKey][trade.shiftId]) {
                const assignments = state.schedule[dateKey][trade.shiftId];
                const idx = assignments.findIndex(a => a.staffId === trade.postedBy);
                if (idx >= 0) {
                    assignments[idx].staffId = trade.approvedRequesterId;
                }
            }

            // Mark trade as complete
            trade.status = 'completed';
            trade.managerApprovedAt = new Date().toISOString();

            saveState();
            showToast('Shift swap approved!', 'success');
            renderTeamPage();
            renderShiftMarketplace();
            renderSchedule();
            renderDashboard();
        }

        // Manager denies the shift swap
        function managerDenySwap(tradeId) {
            const trade = state.shiftTrades.find(t => t.id === tradeId);
            if (!trade) return;

            if (!confirm('Deny this shift swap? The shift will go back to being available for trade.')) return;

            // Put it back to open status
            trade.status = 'open';
            trade.approvedRequesterId = null;
            trade.employeeApprovedAt = null;

            saveState();
            showToast('Shift swap denied', 'info');
            renderTeamPage();
            renderShiftMarketplace();
        }

        // ============================================
        // MY PREFERENCES
        // ============================================
        function renderMyPreferences() {
            // Load user preferences from state or defaults
            const prefs = state.userPreferences || {};

            document.getElementById('pref-want-extra-shifts').checked = prefs.wantExtraShifts || false;
            document.getElementById('pref-max-extra-hours').value = prefs.maxExtraHours || 10;

            // Day preferences
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            days.forEach(day => {
                const checkbox = document.getElementById(`extra-${day}`);
                if (checkbox) {
                    checkbox.checked = prefs.extraDays?.[day] !== false; // Default to true
                }
            });

            // Notifications
            document.getElementById('pref-notify-new-shifts').checked = prefs.notifyNewShifts !== false;
            document.getElementById('pref-notify-schedule-change').checked = prefs.notifyScheduleChange !== false;
            document.getElementById('pref-notify-request-status').checked = prefs.notifyRequestStatus !== false;

            updateExtraShiftUI();
            renderMySchedulePreview();
        }

        function updateExtraShiftUI() {
            const wantExtra = document.getElementById('pref-want-extra-shifts').checked;
            document.getElementById('extra-shift-days').style.display = wantExtra ? 'block' : 'none';
        }

        function saveMyPreferences() {
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const extraDays = {};
            days.forEach(day => {
                extraDays[day] = document.getElementById(`extra-${day}`)?.checked || false;
            });

            state.userPreferences = {
                wantExtraShifts: document.getElementById('pref-want-extra-shifts').checked,
                maxExtraHours: parseInt(document.getElementById('pref-max-extra-hours').value) || 10,
                extraDays,
                notifyNewShifts: document.getElementById('pref-notify-new-shifts').checked,
                notifyScheduleChange: document.getElementById('pref-notify-schedule-change').checked,
                notifyRequestStatus: document.getElementById('pref-notify-request-status').checked
            };

            saveState();
            showToast('Preferences saved!', 'success');
        }

        function renderMySchedulePreview() {
            const container = document.getElementById('my-schedule-preview');
            const myStaff = state.staff.find(s =>
                s.email?.toLowerCase() === currentUser?.email?.toLowerCase() ||
                s.name.toLowerCase().includes(currentUserData?.name?.toLowerCase() || '')
            );

            if (!myStaff) {
                container.innerHTML = '<p style="color: var(--text-muted);">Link your account to a staff member to see your schedule.</p>';
                return;
            }

            const weekDates = getWeekDates(state.currentWeekStart);
            let html = '<div style="display: grid; gap: 8px;">';

            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                const myShifts = [];

                if (state.schedule[dateKey]) {
                    Object.entries(state.schedule[dateKey]).forEach(([shiftId, assignments]) => {
                        if (assignments.some(a => a.staffId === myStaff.id)) {
                            const shift = state.shiftTemplates.find(s => s.id === shiftId);
                            myShifts.push(shift);
                        }
                    });
                }

                const isToday = dateKey === new Date().toISOString().split('T')[0];

                html += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: ${isToday ? 'var(--accent-light)' : 'var(--bg-tertiary)'}; border-radius: var(--radius);">
                        <div style="width: 80px; font-weight: ${isToday ? '600' : '400'};">${DAYS[i]}</div>
                        <div style="flex: 1;">
                            ${myShifts.length > 0
                                ? myShifts.map(s => `<span style="display: inline-block; padding: 2px 8px; background: var(--accent); color: white; border-radius: 4px; font-size: 12px; margin-right: 4px;">${s.name} ${s.startTime}-${s.endTime}</span>`).join('')
                                : '<span style="color: var(--text-muted); font-size: 13px;">Off</span>'
                            }
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ============================================
        // EXPORT
        // ============================================
        function exportSchedule() {
            openModal('export-modal');
        }

        function copyScheduleToClipboard() {
            const weekDates = getWeekDates(state.currentWeekStart);
            let text = `SCHEDULE: ${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}\n\n`;
            
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                text += `${DAYS[i].toUpperCase()} (${formatDate(date)})\n`;
                
                if (state.schedule[dateKey]) {
                    state.shiftTemplates.forEach(shift => {
                        const assignments = state.schedule[dateKey][shift.id] || [];
                        if (assignments.length > 0) {
                            text += `  ${shift.name} (${shift.startTime}-${shift.endTime}):\n`;
                            assignments.forEach(a => {
                                const staff = state.staff.find(s => s.id === a.staffId);
                                if (staff) {
                                    text += `    - ${staff.name} (${staff.role})\n`;
                                }
                            });
                        }
                    });
                } else {
                    text += `  No shifts scheduled\n`;
                }
                text += '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Schedule copied to clipboard');
                closeModal('export-modal');
            });
        }

        function printSchedule() {
            closeModal('export-modal');
            window.print();
        }

        function downloadCSV() {
            const weekDates = getWeekDates(state.currentWeekStart);
            let csv = 'Day,Date,Shift,Start,End,Employee,Role,Hourly Rate\n';
            
            weekDates.forEach((date, i) => {
                const dateKey = formatDate(date, 'iso');
                
                if (state.schedule[dateKey]) {
                    state.shiftTemplates.forEach(shift => {
                        const assignments = state.schedule[dateKey][shift.id] || [];
                        assignments.forEach(a => {
                            const staff = state.staff.find(s => s.id === a.staffId);
                            if (staff) {
                                csv += `${DAYS[i]},${dateKey},${shift.name},${shift.startTime},${shift.endTime},${staff.name},${staff.role},$${staff.hourlyRate}\n`;
                            }
                        });
                    });
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schedule-${formatDate(weekDates[0], 'iso')}.csv`;
            a.click();
            URL.revokeObjectURL(url); // Clean up to prevent memory leak

            showToast('CSV downloaded');
            closeModal('export-modal');
        }

        // ============================================
        // AI COMMAND PROCESSING
        // ============================================
        function processAICommand() {
            const input = document.getElementById('ai-command');
            const responseEl = document.getElementById('ai-response');
            const text = input.value.trim().toLowerCase();

            if (!text) return;

            const result = parseAndExecuteCommand(text);

            responseEl.className = `ai-response visible ${result.type}`;
            responseEl.innerHTML = result.message;

            if (result.type === 'success') {
                input.value = '';
            }
        }

        function parseAndExecuteCommand(text) {
            // FIRE/REMOVE EMPLOYEE
            const fireMatch = text.match(/(?:fire|fired|remove|delete|let go|terminate|terminated)\s+(\w+)/i);
            if (fireMatch) {
                const name = fireMatch[1];
                return fireEmployee(name);
            }

            // SICK/ABSENT TODAY or specific day
            const sickMatch = text.match(/(\w+)\s+(?:is\s+)?(?:sick|ill|absent|out|called out|can't come|cant come|not coming|won't be in|wont be in)(?:\s+(?:today|tomorrow|(\w+day)))?/i);
            if (sickMatch) {
                const name = sickMatch[1];
                const day = sickMatch[2] || 'today';
                return markAbsent(name, day);
            }

            // CUT HOURS / REDUCE HOURS / SLACKING (negative performance)
            const cutHoursMatch = text.match(/(?:(\w+)\s+(?:has been|is|was)\s+(?:slacking|lazy|unreliable|late|bad|terrible)|cut\s+(?:back\s+)?(\w+)(?:'s)?\s+hours|reduce\s+(?:hours\s+for\s+)?(\w+)|(\w+)\s+(?:needs?\s+)?(?:less|fewer)\s+(?:hours|shifts)|give\s+(\w+)\s+(?:less|fewer)\s+(?:hours|shifts))/i);
            if (cutHoursMatch) {
                const name = cutHoursMatch[1] || cutHoursMatch[2] || cutHoursMatch[3] || cutHoursMatch[4] || cutHoursMatch[5];
                return cutEmployeeHours(name);
            }

            // GIVE MORE HOURS / BOOST HOURS / GOOD PERFORMANCE
            const moreHoursMatch = text.match(/(?:(\w+)\s+(?:has been|is|was)\s+(?:great|awesome|amazing|excellent|killing it|doing great|fantastic|reliable)|give\s+(\w+)\s+(?:more|extra)\s+(?:hours|shifts)|(?:more|extra)\s+(?:hours|shifts)\s+(?:for|to)\s+(\w+)|(\w+)\s+(?:wants?|needs?|deserves?)\s+(?:more|extra)\s+(?:hours|shifts)|boost\s+(\w+)(?:'s)?\s+hours)/i);
            if (moreHoursMatch) {
                const name = moreHoursMatch[1] || moreHoursMatch[2] || moreHoursMatch[3] || moreHoursMatch[4] || moreHoursMatch[5];
                return giveExtraHours(name);
            }

            // SWAP/TRADE SHIFTS
            const swapMatch = text.match(/(?:swap|switch|trade)\s+(\w+)(?:'s)?\s+(?:and|with)\s+(\w+)(?:'s)?(?:\s+(?:on|for)\s+(\w+))?/i);
            if (swapMatch) {
                return swapShifts(swapMatch[1], swapMatch[2], swapMatch[3]);
            }

            // WHO'S WORKING - specific day and shift
            const whoWorkingMatch = text.match(/who(?:'s|s| is)?\s+(?:working|works|scheduled|on)\s+(?:(?:the|for|on)\s+)?(?:(\w+)\s+)?(?:(breakfast|lunch|dinner|close|morning|evening|afternoon))?/i);
            if (whoWorkingMatch || text.includes("who's working") || text.includes("whos working") || text.includes("who works")) {
                const day = whoWorkingMatch?.[1];
                const shift = whoWorkingMatch?.[2];
                return showWhoIsWorking(day, shift);
            }

            // ADD/HIRE EMPLOYEE
            const addMatch = text.match(/(?:add|hire|hired|new)\s+(?:a\s+)?(?:new\s+)?(\w+)\s+(?:named|called)?\s*(\w+)(?:\s+at\s+\$?(\d+))?/i);
            if (addMatch) {
                const role = addMatch[1];
                const name = addMatch[2];
                const rate = addMatch[3];
                return addEmployee(role, name, rate);
            }

            // PROMOTE EMPLOYEE
            const promoteMatch = text.match(/(?:promote|make)\s+(\w+)\s+(?:to\s+)?(?:a\s+)?(\w+)/i);
            if (promoteMatch) {
                return promoteEmployee(promoteMatch[1], promoteMatch[2]);
            }

            // CHANGE PAY RATE
            const payMatch = text.match(/(?:(?:change|set|update|raise|lower)\s+)?(\w+)(?:'s)?\s+(?:pay|rate|wage|hourly)\s+(?:to\s+)?\$?(\d+(?:\.\d{2})?)/i);
            if (payMatch) {
                return changePayRate(payMatch[1], parseFloat(payMatch[2]));
            }

            // CLEAR DAY
            const clearMatch = text.match(/clear\s+(\w+)(?:'s)?\s*(?:schedule)?/i);
            if (clearMatch) {
                const day = clearMatch[1];
                return clearDaySchedule(day);
            }

            // SCHEDULE/FILL DAY
            const scheduleMatch = text.match(/(?:schedule|fill|auto.?schedule)\s+(\w+)/i);
            if (scheduleMatch) {
                const day = scheduleMatch[1];
                return autoScheduleDay(day);
            }

            // HOW MANY HOURS
            const hoursMatch = text.match(/(?:how many hours|hours for|hours does|what are)\s+(\w+)(?:'s)?\s*(?:hours)?/i);
            if (hoursMatch) {
                const name = hoursMatch[1];
                return showEmployeeHours(name);
            }

            // NEED MORE STAFF
            const needStaffMatch = text.match(/(?:need|we need|short|understaffed)\s+(?:more\s+)?(\w+)s?(?:\s+on\s+(\w+))?/i);
            if (needStaffMatch) {
                return analyzeStaffingNeeds(needStaffMatch[1], needStaffMatch[2]);
            }

            // WHO'S AVAILABLE
            const availableMatch = text.match(/who(?:'s|s| is)?\s+available\s+(?:on\s+)?(\w+)?/i);
            if (availableMatch) {
                return showAvailable(availableMatch[1]);
            }

            return {
                type: 'error',
                message: `I didn't understand that. Try:<br>
                 "I fired Dave" / "Let go of Sarah"<br>
                 "Tom is sick today" / "Maria won't be in Friday"<br>
                 "Dave has been slacking, cut his hours"<br>
                 "Sarah is doing great, give her more shifts"<br>
                 "Who's working Friday dinner?"<br>
                 "Add server named Mike at $15"<br>
                 "Swap Tom and Sarah on Monday"<br>
                 "Promote Mike to manager"<br>
                 "How many hours does Maria have?"`
            };
        }

        function findStaffByName(name) {
            name = name.toLowerCase();
            return state.staff.find(s =>
                s.name.toLowerCase().includes(name) ||
                s.name.toLowerCase().split(' ')[0] === name
            );
        }

        function fireEmployee(name) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}". Check the Staff page for employee names.` };
            }

            // Find who can cover their shifts
            const coverageInfo = findCoverageForEmployee(staff.id);

            // Remove from staff
            state.staff = state.staff.filter(s => s.id !== staff.id);

            // Remove from all schedules
            Object.keys(state.schedule).forEach(date => {
                Object.keys(state.schedule[date]).forEach(shiftId => {
                    state.schedule[date][shiftId] = state.schedule[date][shiftId].filter(a => a.staffId !== staff.id);
                });
            });

            saveState();
            renderStaffTable();
            renderSchedule();
            renderDashboard();

            return {
                type: 'success',
                message: `<strong>${staff.name}</strong> has been removed. ${coverageInfo}`
            };
        }

        function findCoverageForEmployee(staffId) {
            const staff = state.staff.find(s => s.id === staffId);
            if (!staff) return '';

            const sameRole = state.staff.filter(s => s.id !== staffId && s.role === staff.role);
            if (sameRole.length === 0) {
                return ` No other ${ROLE_LABELS[staff.role]}s available to cover!`;
            }

            const available = sameRole.filter(s => {
                const hours = calculateWeekHours(s.id);
                return hours < s.maxHours - 5;
            });

            if (available.length > 0) {
                const names = available.slice(0, 3).map(s => s.name.split(' ')[0]).join(', ');
                return `${names} can help cover their shifts.`;
            }
            return `Other ${ROLE_LABELS[staff.role]}s are near max hours.`;
        }

        function markAbsentToday(name) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            const today = new Date().toISOString().split('T')[0];
            let removedCount = 0;

            if (state.schedule[today]) {
                Object.keys(state.schedule[today]).forEach(shiftId => {
                    const before = state.schedule[today][shiftId].length;
                    state.schedule[today][shiftId] = state.schedule[today][shiftId].filter(a => a.staffId !== staff.id);
                    removedCount += before - state.schedule[today][shiftId].length;
                });
            }

            saveState();
            renderSchedule();
            renderDashboard();

            if (removedCount > 0) {
                return {
                    type: 'success',
                    message: `<strong>${staff.name}</strong> removed from ${removedCount} shift(s) today. Get well soon! `
                };
            } else {
                return {
                    type: 'info',
                    message: `<strong>${staff.name}</strong> wasn't scheduled for today anyway.`
                };
            }
        }

        function showWhoIsWorking(dayStr, shiftStr) {
            const weekDates = getWeekDates(state.currentWeekStart);
            let targetDate = null;
            let dayName = '';

            if (!dayStr || dayStr === 'today') {
                targetDate = new Date().toISOString().split('T')[0];
                dayName = 'today';
            } else {
                const dayLower = dayStr.toLowerCase();
                const dayIndex = DAYS.findIndex(d => d.toLowerCase().startsWith(dayLower));
                if (dayIndex >= 0) {
                    targetDate = formatDate(weekDates[dayIndex], 'iso');
                    dayName = DAYS[dayIndex];
                }
            }

            if (!targetDate) {
                return { type: 'error', message: `Couldn't understand the day "${dayStr}".` };
            }

            const daySchedule = state.schedule[targetDate];
            if (!daySchedule || Object.keys(daySchedule).length === 0) {
                return { type: 'info', message: `No one is scheduled for ${dayName} yet.` };
            }

            let html = `<strong>Working ${dayName}:</strong><br>`;
            let found = false;

            state.shiftTemplates.forEach(shift => {
                if (shiftStr && !shift.name.toLowerCase().includes(shiftStr.toLowerCase())) {
                    return;
                }
                const assignments = daySchedule[shift.id] || [];
                if (assignments.length > 0) {
                    found = true;
                    const names = assignments.map(a => {
                        const s = state.staff.find(st => st.id === a.staffId);
                        return s ? s.name.split(' ')[0] : '?';
                    }).join(', ');
                    html += ` <strong>${shift.name}:</strong> ${names}<br>`;
                }
            });

            if (!found) {
                return { type: 'info', message: `No one scheduled for ${shiftStr || 'any shift'} on ${dayName}.` };
            }

            return { type: 'info', message: html };
        }

        function addEmployee(roleStr, name, rate) {
            const roleLower = roleStr.toLowerCase();
            const role = ROLES.find(r => r.startsWith(roleLower) || ROLE_LABELS[r].toLowerCase().startsWith(roleLower));

            if (!role) {
                return { type: 'error', message: `Unknown role "${roleStr}". Try: server, cook, host, bartender, busser, or manager.` };
            }

            const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
            const hourlyRate = parseFloat(rate) || 15;

            state.staff.push({
                id: generateId(),
                name: capitalizedName,
                role: role,
                hourlyRate: hourlyRate,
                maxHours: 40,
                certifications: {},
                availability: {}
            });

            saveState();
            renderStaffTable();

            return {
                type: 'success',
                message: `Added <strong>${capitalizedName}</strong> as a ${ROLE_LABELS[role]} at $${hourlyRate}/hr.  Welcome aboard!`
            };
        }

        function clearDaySchedule(dayStr) {
            const weekDates = getWeekDates(state.currentWeekStart);
            const dayLower = dayStr.toLowerCase();
            const dayIndex = DAYS.findIndex(d => d.toLowerCase().startsWith(dayLower));

            if (dayIndex < 0) {
                return { type: 'error', message: `Couldn't understand the day "${dayStr}".` };
            }

            const targetDate = formatDate(weekDates[dayIndex], 'iso');
            delete state.schedule[targetDate];

            saveState();
            renderSchedule();
            renderDashboard();

            return {
                type: 'success',
                message: `Cleared all shifts for <strong>${DAYS[dayIndex]}</strong>. `
            };
        }

        function autoScheduleDay(dayStr) {
            const weekDates = getWeekDates(state.currentWeekStart);
            const dayLower = dayStr.toLowerCase();
            const dayIndex = DAYS.findIndex(d => d.toLowerCase().startsWith(dayLower));

            if (dayIndex < 0) {
                return { type: 'error', message: `Couldn't understand the day "${dayStr}".` };
            }

            const targetDate = formatDate(weekDates[dayIndex], 'iso');

            // Run auto-schedule for just this day
            if (!state.schedule[targetDate]) state.schedule[targetDate] = {};

            let assigned = 0;
            const sessionHours = {};
            state.staff.forEach(s => sessionHours[s.id] = calculateWeekHours(s.id));

            state.shiftTemplates.forEach(shift => {
                if (!state.schedule[targetDate][shift.id]) state.schedule[targetDate][shift.id] = [];
                const currentAssignments = state.schedule[targetDate][shift.id];
                const shiftHours = calculateShiftHours(shift);

                ROLES.forEach(role => {
                    const required = shift.requirements?.[role] || 0;
                    const currentCount = currentAssignments.filter(a => {
                        const staff = state.staff.find(s => s.id === a.staffId);
                        return staff?.role === role;
                    }).length;

                    const needed = required - currentCount;
                    if (needed > 0) {
                        const candidates = state.staff
                            .filter(s => {
                                if (s.role !== role) return false;
                                if (currentAssignments.some(a => a.staffId === s.id)) return false;
                                if (sessionHours[s.id] + shiftHours > s.maxHours) return false;
                                return true;
                            })
                            .sort((a, b) => sessionHours[a.id] - sessionHours[b.id]);

                        for (let i = 0; i < Math.min(needed, candidates.length); i++) {
                            const staff = candidates[i];
                            currentAssignments.push({ staffId: staff.id, role: staff.role });
                            sessionHours[staff.id] += shiftHours;
                            assigned++;
                        }
                    }
                });
            });

            saveState();
            renderSchedule();
            renderDashboard();

            return {
                type: 'success',
                message: `Auto-scheduled <strong>${DAYS[dayIndex]}</strong>: ${assigned} shifts filled. `
            };
        }

        function giveExtraHours(name) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            staff.maxHours = Math.min(staff.maxHours + 10, 60);
            saveState();
            renderStaffTable();

            return {
                type: 'success',
                message: `<strong>${staff.name}</strong> can now work up to ${staff.maxHours} hours/week.`
            };
        }

        function showEmployeeHours(name) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            const hours = calculateWeekHours(staff.id);
            const remaining = staff.maxHours - hours;

            return {
                type: 'info',
                message: `<strong>${staff.name}</strong> has ${hours.toFixed(1)}h scheduled this week (${remaining.toFixed(1)}h remaining of ${staff.maxHours}h max).`
            };
        }

        function markAbsent(name, dayStr) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            const weekDates = getWeekDates(state.currentWeekStart);
            let targetDate;

            if (dayStr === 'today') {
                targetDate = new Date().toISOString().split('T')[0];
            } else if (dayStr === 'tomorrow') {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                targetDate = tomorrow.toISOString().split('T')[0];
            } else {
                const dayLower = dayStr.toLowerCase().replace('day', '');
                const dayIndex = DAYS.findIndex(d => d.toLowerCase().startsWith(dayLower));
                if (dayIndex >= 0) {
                    targetDate = formatDate(weekDates[dayIndex], 'iso');
                }
            }

            if (!targetDate) {
                return { type: 'error', message: `Couldn't understand the day "${dayStr}".` };
            }

            let removedCount = 0;
            if (state.schedule[targetDate]) {
                Object.keys(state.schedule[targetDate]).forEach(shiftId => {
                    const before = state.schedule[targetDate][shiftId].length;
                    state.schedule[targetDate][shiftId] = state.schedule[targetDate][shiftId].filter(a => a.staffId !== staff.id);
                    removedCount += before - state.schedule[targetDate][shiftId].length;
                });
            }

            saveState();
            renderSchedule();
            renderDashboard();

            if (removedCount > 0) {
                return {
                    type: 'success',
                    message: `<strong>${staff.name}</strong> removed from ${removedCount} shift(s) on ${dayStr}. `
                };
            } else {
                return {
                    type: 'info',
                    message: `<strong>${staff.name}</strong> wasn't scheduled for ${dayStr} anyway.`
                };
            }
        }

        function cutEmployeeHours(name) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            const currentHours = calculateWeekHours(staff.id);

            // Reduce max hours by 10 (minimum 10)
            const oldMax = staff.maxHours;
            staff.maxHours = Math.max(staff.maxHours - 10, 10);

            // Remove from some shifts if they're over the new max
            if (currentHours > staff.maxHours) {
                let hoursToRemove = currentHours - staff.maxHours;
                const weekDates = getWeekDates(state.currentWeekStart);

                // Remove from end of week first
                for (let i = weekDates.length - 1; i >= 0 && hoursToRemove > 0; i--) {
                    const dateKey = formatDate(weekDates[i], 'iso');
                    if (state.schedule[dateKey]) {
                        for (const shiftId of Object.keys(state.schedule[dateKey])) {
                            const idx = state.schedule[dateKey][shiftId].findIndex(a => a.staffId === staff.id);
                            if (idx >= 0) {
                                const shift = state.shiftTemplates.find(t => t.id === shiftId);
                                if (shift) {
                                    state.schedule[dateKey][shiftId].splice(idx, 1);
                                    hoursToRemove -= calculateShiftHours(shift);
                                    if (hoursToRemove <= 0) break;
                                }
                            }
                        }
                    }
                }
            }

            saveState();
            renderStaffTable();
            renderSchedule();
            renderDashboard();

            const newHours = calculateWeekHours(staff.id);
            return {
                type: 'success',
                message: `<strong>${staff.name}</strong>'s max hours reduced from ${oldMax}h to ${staff.maxHours}h. Now scheduled for ${newHours.toFixed(1)}h this week.`
            };
        }

        function swapShifts(name1, name2, dayStr) {
            const staff1 = findStaffByName(name1);
            const staff2 = findStaffByName(name2);

            if (!staff1) return { type: 'error', message: `Couldn't find anyone named "${name1}".` };
            if (!staff2) return { type: 'error', message: `Couldn't find anyone named "${name2}".` };

            const weekDates = getWeekDates(state.currentWeekStart);
            let targetDates = [];

            if (!dayStr) {
                // Swap all shifts this week
                targetDates = weekDates.map(d => formatDate(d, 'iso'));
            } else {
                const dayLower = dayStr.toLowerCase();
                const dayIndex = DAYS.findIndex(d => d.toLowerCase().startsWith(dayLower));
                if (dayIndex >= 0) {
                    targetDates = [formatDate(weekDates[dayIndex], 'iso')];
                }
            }

            let swapCount = 0;
            targetDates.forEach(dateKey => {
                if (state.schedule[dateKey]) {
                    Object.keys(state.schedule[dateKey]).forEach(shiftId => {
                        const assignments = state.schedule[dateKey][shiftId];
                        const idx1 = assignments.findIndex(a => a.staffId === staff1.id);
                        const idx2 = assignments.findIndex(a => a.staffId === staff2.id);

                        if (idx1 >= 0 && idx2 < 0) {
                            assignments[idx1].staffId = staff2.id;
                            swapCount++;
                        } else if (idx2 >= 0 && idx1 < 0) {
                            assignments[idx2].staffId = staff1.id;
                            swapCount++;
                        } else if (idx1 >= 0 && idx2 >= 0) {
                            // Both assigned, swap them
                            assignments[idx1].staffId = staff2.id;
                            assignments[idx2].staffId = staff1.id;
                            swapCount += 2;
                        }
                    });
                }
            });

            saveState();
            renderSchedule();
            renderDashboard();

            if (swapCount > 0) {
                return {
                    type: 'success',
                    message: `Swapped ${swapCount} shift assignment(s) between <strong>${staff1.name}</strong> and <strong>${staff2.name}</strong>.`
                };
            } else {
                return {
                    type: 'info',
                    message: `${staff1.name} and ${staff2.name} don't have overlapping shifts to swap.`
                };
            }
        }

        function promoteEmployee(name, newRoleStr) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            const roleLower = newRoleStr.toLowerCase();
            const newRole = ROLES.find(r => r.startsWith(roleLower) || ROLE_LABELS[r].toLowerCase().startsWith(roleLower));

            if (!newRole) {
                return { type: 'error', message: `Unknown role "${newRoleStr}". Try: server, cook, host, bartender, busser, or manager.` };
            }

            const oldRole = staff.role;
            staff.role = newRole;

            // Give a small raise for promotion
            if (newRole === 'manager') {
                staff.hourlyRate = Math.max(staff.hourlyRate, 20);
            }

            saveState();
            renderStaffTable();

            return {
                type: 'success',
                message: `<strong>${staff.name}</strong> promoted from ${ROLE_LABELS[oldRole]} to ${ROLE_LABELS[newRole]}! `
            };
        }

        function changePayRate(name, newRate) {
            const staff = findStaffByName(name);
            if (!staff) {
                return { type: 'error', message: `Couldn't find anyone named "${name}".` };
            }

            const oldRate = staff.hourlyRate;
            staff.hourlyRate = newRate;

            saveState();
            renderStaffTable();

            const direction = newRate > oldRate ? '' : '';
            return {
                type: 'success',
                message: `<strong>${staff.name}</strong>'s pay updated from $${oldRate.toFixed(2)} to $${newRate.toFixed(2)}/hr ${direction}`
            };
        }

        function analyzeStaffingNeeds(roleStr, dayStr) {
            const roleLower = roleStr.toLowerCase();
            const role = ROLES.find(r => r.startsWith(roleLower) || ROLE_LABELS[r].toLowerCase().startsWith(roleLower));

            if (!role) {
                return { type: 'error', message: `Unknown role "${roleStr}".` };
            }

            const currentStaff = state.staff.filter(s => s.role === role);
            const avgHours = currentStaff.reduce((sum, s) => sum + calculateWeekHours(s.id), 0);
            const totalCapacity = currentStaff.reduce((sum, s) => sum + s.maxHours, 0);

            let message = `<strong>${ROLE_LABELS[role]}s:</strong><br>`;
            message += ` Current staff: ${currentStaff.length}<br>`;
            message += ` Hours scheduled: ${avgHours.toFixed(1)}h<br>`;
            message += ` Total capacity: ${totalCapacity}h<br>`;

            if (avgHours >= totalCapacity * 0.9) {
                message += ` <strong>Near capacity!</strong> Consider hiring more ${ROLE_LABELS[role]}s.`;
            } else {
                message += ` Staffing looks adequate.`;
            }

            return { type: 'info', message };
        }

        function showAvailable(dayStr) {
            const weekDates = getWeekDates(state.currentWeekStart);
            let targetDate;
            let dayName = 'today';

            if (!dayStr || dayStr === 'today') {
                targetDate = new Date().toISOString().split('T')[0];
            } else {
                const dayLower = dayStr.toLowerCase();
                const dayIndex = DAYS.findIndex(d => d.toLowerCase().startsWith(dayLower));
                if (dayIndex >= 0) {
                    targetDate = formatDate(weekDates[dayIndex], 'iso');
                    dayName = DAYS[dayIndex];
                }
            }

            if (!targetDate) {
                return { type: 'error', message: `Couldn't understand the day "${dayStr}".` };
            }

            // Find staff not scheduled that day who have hours remaining
            const scheduledIds = new Set();
            if (state.schedule[targetDate]) {
                Object.values(state.schedule[targetDate]).forEach(assignments => {
                    assignments.forEach(a => scheduledIds.add(a.staffId));
                });
            }

            const available = state.staff.filter(s => {
                if (scheduledIds.has(s.id)) return false;
                const hours = calculateWeekHours(s.id);
                return hours < s.maxHours;
            });

            if (available.length === 0) {
                return { type: 'info', message: `Everyone is either scheduled or at max hours for ${dayName}.` };
            }

            const byRole = {};
            available.forEach(s => {
                if (!byRole[s.role]) byRole[s.role] = [];
                byRole[s.role].push(s.name.split(' ')[0]);
            });

            let html = `<strong>Available on ${dayName}:</strong><br>`;
            Object.entries(byRole).forEach(([role, names]) => {
                html += ` <strong>${ROLE_LABELS[role]}:</strong> ${names.join(', ')}<br>`;
            });

            return { type: 'info', message: html };
        }

        // ============================================
        // SAMPLE DATA
        // ============================================
        function loadSampleData() {
            if (state.staff.length > 0 || state.shiftTemplates.length > 0) return;
            
            // Sample shift templates
            state.shiftTemplates = [
                { id: 'breakfast', name: 'Breakfast', startTime: '06:00', endTime: '11:00', requirements: { cook: 2, server: 2, host: 1, busser: 1 } },
                { id: 'lunch', name: 'Lunch', startTime: '11:00', endTime: '15:00', requirements: { cook: 3, server: 4, host: 1, bartender: 1, busser: 2, manager: 1 } },
                { id: 'dinner', name: 'Dinner', startTime: '16:00', endTime: '22:00', requirements: { cook: 4, server: 5, host: 1, bartender: 2, busser: 2, manager: 1 } },
                { id: 'close', name: 'Close', startTime: '22:00', endTime: '01:00', requirements: { cook: 1, server: 1, busser: 1 } }
            ];
            
            // Sample staff - enough to cover full week (all available for all shifts)
            state.staff = [
                // Servers (need ~413h/week, 11 servers at ~40h each)
                { id: 's1', name: 'Maria Garcia', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 's2', name: 'James Wilson', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 's3', name: 'Emily Chen', role: 'server', hourlyRate: 14, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 's4', name: 'David Kim', role: 'server', hourlyRate: 16, maxHours: 40, certifications: { foodHandler: true, alcohol: true, firstAid: true }, availability: {} },
                { id: 's5', name: 'Sarah Johnson', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 's6', name: 'Alex Rivera', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 's7', name: 'Jordan Lee', role: 'server', hourlyRate: 14, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 's8', name: 'Taylor Swift', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 's9', name: 'Chris Evans', role: 'server', hourlyRate: 16, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 's10', name: 'Pat Morgan', role: 'server', hourlyRate: 14, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 's11', name: 'Sam Taylor', role: 'server', hourlyRate: 15, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                // Cooks (need ~343h/week, 9 cooks at ~40h each)
                { id: 'c1', name: 'Marco Rossi', role: 'cook', hourlyRate: 20, maxHours: 40, certifications: { foodHandler: true, foodSafety: true }, availability: {} },
                { id: 'c2', name: 'Ana Martinez', role: 'cook', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 'c3', name: 'Tom Baker', role: 'cook', hourlyRate: 17, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 'c4', name: 'Wei Zhang', role: 'cook', hourlyRate: 19, maxHours: 40, certifications: { foodHandler: true, foodSafety: true }, availability: {} },
                { id: 'c5', name: 'Pierre Dubois', role: 'cook', hourlyRate: 20, maxHours: 40, certifications: { foodHandler: true, foodSafety: true }, availability: {} },
                { id: 'c6', name: 'Sofia Hernandez', role: 'cook', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 'c7', name: 'Raj Patel', role: 'cook', hourlyRate: 17, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                { id: 'c8', name: 'Yuki Tanaka', role: 'cook', hourlyRate: 19, maxHours: 40, certifications: { foodHandler: true, foodSafety: true }, availability: {} },
                { id: 'c9', name: 'Diego Santos', role: 'cook', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true }, availability: {} },
                // Hosts (need ~105h/week, 3 hosts at ~40h each)
                { id: 'h1', name: 'Jessica Brown', role: 'host', hourlyRate: 14, maxHours: 40, certifications: {}, availability: {} },
                { id: 'h2', name: 'Amanda White', role: 'host', hourlyRate: 14, maxHours: 40, certifications: {}, availability: {} },
                { id: 'h3', name: 'Nicole Green', role: 'host', hourlyRate: 13, maxHours: 40, certifications: {}, availability: {} },
                // Bartenders (need ~112h/week, 3 bartenders at ~40h each)
                { id: 'b1', name: 'Mike O\'Connor', role: 'bartender', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                { id: 'b2', name: 'Lisa Park', role: 'bartender', hourlyRate: 17, maxHours: 40, certifications: { alcohol: true }, availability: {} },
                { id: 'b3', name: 'Jake Miller', role: 'bartender', hourlyRate: 18, maxHours: 40, certifications: { foodHandler: true, alcohol: true }, availability: {} },
                // Bussers (need ~196h/week, 5 bussers at ~40h each)
                { id: 'u1', name: 'Carlos Mendez', role: 'busser', hourlyRate: 13, maxHours: 40, certifications: {}, availability: {} },
                { id: 'u2', name: 'Kevin Nguyen', role: 'busser', hourlyRate: 13, maxHours: 40, certifications: {}, availability: {} },
                { id: 'u3', name: 'Brandon Scott', role: 'busser', hourlyRate: 13, maxHours: 40, certifications: {}, availability: {} },
                { id: 'u4', name: 'Tyler James', role: 'busser', hourlyRate: 12, maxHours: 40, certifications: {}, availability: {} },
                { id: 'u5', name: 'Ryan Cooper', role: 'busser', hourlyRate: 13, maxHours: 40, certifications: {}, availability: {} },
                // Managers (need ~70h/week, 2 managers at ~40h each)
                { id: 'm1', name: 'Rachel Thompson', role: 'manager', hourlyRate: 25, maxHours: 40, certifications: { foodHandler: true, alcohol: true, foodSafety: true, firstAid: true }, availability: {} },
                { id: 'm2', name: 'Daniel Harris', role: 'manager', hourlyRate: 24, maxHours: 40, certifications: { foodHandler: true, alcohol: true, foodSafety: true }, availability: {} }
            ];
            
            saveState();
        }

        // ============================================
        // INIT
        // ============================================
        function initApp() {
            // Navigation click handlers
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });

            // Initialize day picker
            document.getElementById('day-picker').value = state.selectedDay;
        }

        function initFirebase() {
            // Wait for Firebase to be ready
            if (!window.firebaseAuth) {
                window.addEventListener('firebase-ready', initFirebase);
                return;
            }

            // Listen for auth state changes
            window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    onUserLoggedIn(user);
                } else {
                    onUserLoggedOut();
                }
            });
        }

        // Initialize app
        initApp();
        initFirebase();
    </script>
</body>
</html>
