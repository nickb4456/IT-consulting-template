<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Rhode Island Real Estate Market Analysis 2024-2026</title>
 
 <!-- Open Graph / Link Preview -->
 <meta property="og:type" content="website">
 <meta property="og:url" content="https://aibridges.org/ri-report">
 <meta property="og:title" content="Rhode Island Real Estate Market Analysis">
 <meta property="og:description" content="Interactive analysis of 415,000+ RI properties. Find land deals, undervalued homes, and market trends.">
 <meta property="og:image" content="https://placehold.co/1200x630/0f172a/6366f1?text=RI+Real+Estate%0A415K+Properties&font=roboto">
 <meta name="twitter:card" content="summary_large_image">
 <meta name="twitter:title" content="Rhode Island Real Estate Market Analysis">
 <meta name="twitter:description" content="Interactive analysis of 415,000+ RI properties with SQL tools, charts, and deal finders.">
 <meta name="twitter:image" content="https://placehold.co/1200x630/0f172a/6366f1?text=RI+Real+Estate%0A415K+Properties&font=roboto">
 
 <!-- Favicon -->
 <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E1A47'%3E%3Cpath d='M12 3L2 12h3v9h6v-6h2v6h6v-9h3L12 3z'/%3E%3C/svg%3E">
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 <style>
 :root { 
  --primary: #6366f1; 
  --primary-light: #818cf8; 
  --primary-dark: #4f46e5;
  --accent: #22d3ee; 
  --text: #f1f5f9; 
  --text-muted: #94a3b8; 
  --success: #10b981; 
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #0f172a; 
  --darker: #020617;
  --card-bg: rgba(30, 41, 59, 0.7);
  --card-border: rgba(99, 102, 241, 0.2);
}
 * { margin: 0; padding: 0; box-sizing: border-box; }
 body { font-family: 'Lato', system-ui, sans-serif; background: var(--darker); color: var(--text); line-height: 1.6; min-height: 100vh; }
 .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
 
 .hero { text-align: center; padding: 2rem; background: rgba(99,102,241,0.1); border-radius: 16px; margin-bottom: 1.5rem; border: 1px solid rgba(99,102,241,0.2); }
 h1 { font-size: 2.5rem; font-weight: 800; color: #f8fafc; }
 .subtitle { color: #94a3b8; font-size: 1.1rem; margin-top: 0.5rem; }
 
 .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin: 2rem 0; }
 .stat-card { background: rgba(15, 23, 42, 0.8); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid rgba(99, 102, 241, 0.25); }
 .stat-value { font-size: 2rem; font-weight: 800; color: #f8fafc; }
 .stat-label { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.25rem; }
 
 h2 { font-size: 1.5rem; margin: 1.5rem 0 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
 h2::after { content: ''; flex: 1; height: 2px; background: linear-gradient(90deg, rgba(99,102,241,0.5), transparent); }
 
 .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
 .chart-card { background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); }
 .chart-card.full { grid-column: span 2; }
 .chart-card.third { grid-column: span 1; }
 .chart-title { font-size: 1rem; color: #94a3b8; margin-bottom: 1rem; }
 
 .insight-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1.5rem 0; }
 .insight-card { background: rgba(99,102,241,0.1); padding: 1.25rem; border-radius: 14px; border-left: 4px solid #6366f1; position: relative; }
 
 /* Desktop-only hover chart */
 @media (min-width: 769px) {
 .insight-hover { cursor: pointer; transition: all 0.3s; }
 .insight-hover:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(99,102,241,0.3); }
 .hover-hint { display: block; font-size: 0.7rem; color: #6366f1; margin-top: 0.5rem; opacity: 0.7; }
 }
 @media (max-width: 768px) {
 .hover-hint { display: none; }
 }
 .insight-chart-modal { display: none; position: absolute; z-index: 2000; background: rgba(15,23,42,0.98); border: 1px solid rgba(99,102,241,0.4); border-radius: 20px; padding: 2rem; box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 100px rgba(99,102,241,0.3); max-width: 700px; width: 90%; }
 .insight-chart-modal.active { display: block; animation: fadeIn 0.2s ease-out; }
 .insight-chart-modal::before { content: ''; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); border: 10px solid transparent; border-bottom: 10px solid rgba(99,102,241,0.4); }
 .insight-chart-modal::after { content: ''; position: absolute; top: -18px; left: 50%; transform: translateX(-50%); border: 9px solid transparent; border-bottom: 9px solid rgba(15,23,42,0.98); }
 .insight-chart-connector { position: absolute; z-index: 1999; pointer-events: none; }
 .insight-chart-connector line { stroke: url(#connectorGradient); stroke-width: 3; stroke-linecap: round; }
 .insight-chart-content { width: 100%; height: 350px; }
 @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -48%); } to { opacity: 1; transform: translate(-50%, -50%); } }
 .insight-card h3 { color: #6366f1; font-size: 0.9rem; margin-bottom: 0.5rem; }
 .insight-card p { font-size: 0.95rem; }
 .insight-card .big { font-size: 1.5rem; font-weight: 700; color: #10b981; }
 
 /* Hero Image Section */
 .hero-image { position: relative; width: 100%; height: 300px; border-radius: 20px; overflow: hidden; margin: 1.5rem 0; }
 .hero-image img { width: 100%; height: 100%; object-fit: cover; }
 .hero-image-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 2rem; background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4)); }
 .hero-image-overlay .hero-top { color: white; font-size: 1rem; font-weight: 400; letter-spacing: 3px; text-transform: uppercase; }
 .hero-image-overlay .hero-icon { width: 70px; height: 70px; opacity: 0.9; }
 .hero-image-overlay .hero-bottom { color: rgba(255,255,255,0.9); font-size: 0.85rem; font-weight: 300; letter-spacing: 2px; }
 @media (max-width: 768px) {
   .hero-image { height: 220px; border-radius: 16px; margin: 1rem 0; }
   .hero-image-overlay { padding: 1.5rem; }
   .hero-image-overlay .hero-top { font-size: 0.85rem; letter-spacing: 2px; }
   .hero-image-overlay .hero-icon { width: 50px; height: 50px; }
   .hero-image-overlay .hero-bottom { font-size: 0.75rem; }
 }
 
 /* SQL Section */
 .sql-section { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 2rem; border-radius: 20px; margin: 2rem 0; border: 1px solid rgba(255,255,255,0.1); }
 .filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; align-items: flex-end; }
 .more-filters-btn { display: none; }
 .extra-filters { display: flex; flex-wrap: wrap; gap: 1rem; }
 .filter-group { display: flex; flex-direction: column; gap: 0.3rem; }
 .filter-group label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; }
 select, input[type="number"] { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 0.5rem 0.75rem; color: #e2e8f0; font-size: 0.85rem; min-width: 130px; }
 .quick-queries { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
 .quick-btn { background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.4); color: #6366f1; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; box-shadow: 0 0 8px rgba(99,102,241,0.25); }
 .quick-btn:hover { background: rgba(99,102,241,0.4); box-shadow: 0 0 14px rgba(99,102,241,0.5); }
 textarea { width: 100%; height: 70px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 0.75rem; color: #10b981; font-family: monospace; font-size: 0.85rem; }
 .btn-row { display: flex; gap: 0.5rem; margin: 1rem 0; }
 button { background: #6366f1; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; box-shadow: 0 0 12px rgba(99,102,241,0.5), inset 0 1px 0 rgba(255,255,255,0.1); }
 button:hover { box-shadow: 0 0 20px rgba(99,102,241,0.7), inset 0 1px 0 rgba(255,255,255,0.15); transform: translateY(-1px); }
 button:hover { background: #4f46e5; }
 .btn-secondary { background: rgba(255,255,255,0.1); }
 .btn-accent { background: #10b981; }
 .btn-accent:hover { background: #059669; }
 #results { margin-top: 1rem; max-height: 400px; overflow: auto; border-radius: 10px; }
 #results table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
 #results th { background: rgba(99,102,241,0.3); padding: 0.6rem; text-align: left; position: sticky; top: 0; }
 #results td { padding: 0.5rem 0.6rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
 #results tr:hover { background: rgba(255,255,255,0.05); }
 #results a { color: #10b981; }
 .result-count { color: #10b981; margin-bottom: 0.5rem; font-weight: 600; }
 
 /* NAV BAR - matches AIBridges */
 nav { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 0.75rem 1.5rem; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 30px rgba(0,0,0,0.2); }
 .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
 .logo { text-decoration: none; }
 .logo:hover { opacity: 1; }
 .logo:hover svg rect { filter: drop-shadow(0 0 10px rgba(99,102,241,0.7)); transition: filter 0.2s; }
 .logo:hover .logo-text { text-shadow: 0 0 15px rgba(99,102,241,0.5); transition: text-shadow 0.2s; }
 .logo svg rect { transition: filter 0.2s; }
 .nav-links { display: flex; gap: 1.5rem; list-style: none; align-items: center; }
 .nav-links a { color: #a1afc4; text-decoration: none; font-weight: 500; font-size: 0.9rem; transition: color 0.2s; }
 .nav-links a:hover { color: #f8fafc; }
 .nav-cta { background: #6366f1; color: white !important; padding: 0.5rem 1rem; border-radius: 8px; }
 .nav-cta:hover { background: #4f46e5; }
 .hamburger { display: none; background: none; border: none; cursor: pointer; padding: 0.5rem; }
 .hamburger span { display: block; width: 24px; height: 2px; background: #f8fafc; margin: 5px 0; transition: 0.3s; }
 .mobile-menu { display: none; position: fixed; top: 60px; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08); }
 .mobile-menu.active { display: block; }
 .mobile-menu a { display: block; padding: 0.75rem 1rem; color: #a1afc4; text-decoration: none; border-radius: 8px; }
 .mobile-menu a:hover { background: rgba(99,102,241,0.2); color: #f8fafc; }
 
 /* Container offset for fixed nav */
 .container { padding-top: 5rem; }
 .click-hint { margin-top: 1rem; color: #94a3b8; font-size: 0.9rem; background: rgba(99,102,241,0.15); padding: 0.5rem 1rem; border-radius: 20px; display: inline-block; }
 
 @media (max-width: 1024px) {
 .stats-grid { grid-template-columns: repeat(3, 1fr); }
 .chart-grid { grid-template-columns: 1fr; }
 .chart-card.full, .chart-card.third { grid-column: span 1; }
 .insight-grid { grid-template-columns: 1fr; }
 h1 { font-size: 2rem; }
 }
 
 @media (max-width: 768px) {
 nav { padding: 0.75rem 1rem; }
 .nav-container { display: grid; grid-template-columns: 40px 1fr 40px; align-items: center; }
 .nav-links { display: none; }
 .hamburger { display: block; order: -1; }
 .logo { justify-self: center; }
 .container { padding: 4.5rem 1rem 1rem; }
 .hero { padding: 2rem 1rem; border-radius: 16px; }
 h1 { font-size: 1.6rem; }
 .subtitle { font-size: 0.95rem; }
 .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
 .stat-card { padding: 1rem; }
 .stat-value { font-size: 1.4rem; }
 /* Hide BOTH navs on mobile - use hamburger only */
 .nav-tiles { display: none !important; }
 .nav-menu-mobile { display: none !important; }
 /* Compact hero on mobile */
 .hero { padding: 1rem !important; margin-bottom: 1rem !important; }
 .hero h1 { font-size: 1.3rem !important; }
 .hero .subtitle { font-size: 0.85rem !important; margin-top: 0.25rem !important; }
 .sql-section { padding: 1rem; border-radius: 12px; }
 .filters { flex-direction: column; align-items: stretch; }
 .filter-group { width: 100%; }
 .more-filters-btn { display: block; width: 100%; padding: 0.75rem; margin: 0.5rem 0; background: rgba(99,102,241,0.2); border: 1px dashed rgba(99,102,241,0.4); border-radius: 8px; color: #6366f1; font-size: 0.85rem; cursor: pointer; }
 .more-filters-btn.active { background: rgba(99,102,241,0.3); }
 .extra-filters { display: none; flex-direction: column; gap: 1rem; margin-top: 0.5rem; }
 .extra-filters.show { display: flex; }
 select, input[type="number"], input[type="text"], input[type="email"], input[type="tel"], textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
 .btn-row { flex-wrap: wrap; }
 button { flex: 1; min-width: 120px; }
 h2 { font-size: 1.2rem; }
 #results { font-size: 0.7rem; }
 #results th, #results td { padding: 0.4rem; }
 /* Fix mobile overflow for Land Deals and House Hunter */
 #landDealsResults, #houseDealsResults { overflow-x: auto; -webkit-overflow-scrolling: touch; }
 #landDealsResults table, #houseDealsResults table { min-width: 800px; }
 .sql-section { overflow-x: hidden; max-width: 100vw; }
 .container { overflow-x: hidden; }
 }
 
 @media (max-width: 480px) {
 .stats-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
 .stat-card { padding: 0.6rem; }
 .stat-value { font-size: 1rem; }
 .stat-label { font-size: 0.6rem; }
 h1 { font-size: 1.4rem; }
 /* Smaller buttons on mobile */
 button { padding: 0.5rem 0.6rem; font-size: 0.8rem; min-width: 80px; }
 /* Stats inside sections - horizontal scroll */
 .sql-section .stats-grid { 
 display: flex !important; 
 overflow-x: auto; 
 -webkit-overflow-scrolling: touch;
 gap: 0.5rem;
 padding-bottom: 0.5rem;
 }
 .sql-section .stats-grid .stat-card { 
 min-width: 85px; 
 flex-shrink: 0; 
 }
 }
 
 /* Mobile navigation menu (hidden on desktop) */
 .nav-menu-mobile { display: none; margin: 1.5rem 0 2rem; }
 .nav-menu-mobile a { display: flex; align-items: center; gap: 0.75rem; padding: 0.9rem 1rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 12px; color: #e2e8f0; text-decoration: none; border: 1px solid rgba(255,255,255,0.08); }
 .nav-menu-mobile a:hover { background: rgba(99,102,241,0.2); }
 .nav-menu-mobile .icon { font-size: 1.3rem; }
 
 /* Bottom nav for mobile */
 .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); padding: 0.5rem 0; z-index: 1000; }
 .bottom-nav-inner { display: flex; justify-content: space-around; max-width: 500px; margin: 0 auto; }
 .bottom-nav a { display: flex; flex-direction: column; align-items: center; color: #94a3b8; text-decoration: none; font-size: 0.65rem; padding: 0.25rem; }
 .bottom-nav a span { font-size: 1.3rem; margin-bottom: 0.15rem; }
 .bottom-nav a:hover, .bottom-nav a:active { color: #6366f1; }
 @media (max-width: 768px) {
 .bottom-nav { display: block; }
 .container { padding-bottom: 70px; }
 }
 </style>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
 <nav>
 <div class="nav-container">
 <a href="https://aibridges.org" class="logo" style="display:flex;align-items:center;gap:0.5rem">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="32" height="32" rx="6" fill="#6366f1"/>
                <path d="M6 22h20M9 22v-6l7-8 7 8v6M13 22v-5h6v5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
            <span class="logo-text" style="font-weight:700;font-size:1.1rem;color:#f8fafc">Bridges</span>
        </a>
 <ul class="nav-links">
 <li><a href="#price-comp">Address Lookup</a></li>
 <li><a href="#house-hunter">House Hunter</a></li>
 <li><a href="#land-deals">Land Deals</a></li>
 <li><a href="#sql-tool">SQL Search</a></li>
 <li><a href="https://aibridges.org/#contact" class="nav-cta">Contact</a></li>
 </ul>
 <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Menu">
 <span></span><span></span><span></span>
 </button>
 </div>
 </nav>
 <div class="mobile-menu" id="mobileMenu">
 <a href="#price-comp" onclick="closeMobileMenu()">Address Lookup</a>
 <a href="#house-hunter" onclick="closeMobileMenu()">House Hunter</a>
 <a href="#land-deals" onclick="closeMobileMenu()">Land Deals</a>
 <a href="#sql-tool" onclick="closeMobileMenu()">SQL Search</a>
 <a href="#market-stats" onclick="closeMobileMenu()">Market Stats</a>
 <a href="#about-data" onclick="closeMobileMenu()">About the Data</a>
 <a href="https://aibridges.org" style="color:#6366f1">‚Üê Back to AIBridges</a>
 </div>
 <div class="container">
 
 <!-- HERO / HOMEPAGE -->
 <div class="hero" style="padding:2rem 2rem 1.5rem">
 <h1>Rhode Island Real Estate Hub</h1>
 <p class="subtitle" id="heroSubtitle">207,000+ Properties ‚Ä¢ 27 Towns ‚Ä¢ Updated Daily</p>
 </div>
 
 <!-- TOOL NAVIGATION CARDS -->
 <!-- Mobile Menu (hidden on desktop) -->
 <div class="nav-menu-mobile">
 <a href="#house-hunter">House Hunter ‚Äî Find undervalued homes</a>
 <a href="#land-deals">Land Deals ‚Äî Build-to-profit analysis</a>
 <a href="#price-comp">Price Comps ‚Äî Compare any address</a>
 <a href="#sql-tool">SQL Search ‚Äî Query raw data</a>
 <a href="#market-stats">Market Stats ‚Äî Trends & insights</a>
 </div>
 
 <!-- Desktop Tiles (hidden on mobile) -->
 <div class="nav-tiles" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin:1.5rem 0 2.5rem">
 <a href="#house-hunter" style="text-decoration:none">
 <div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:16px;border:1px solid rgba(99,102,241,0.25);transition:all 0.2s;cursor:pointer;box-shadow:0 0 20px rgba(255,255,255,0.08)" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 25px rgba(255,255,255,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 0 20px rgba(255,255,255,0.08)'">
 
 <div style="color:#ffffff;font-weight:700;font-size:1.1rem">House Hunter</div>
 <div style="color:#cbd5e1;font-size:0.85rem">Find undervalued homes</div>
 </div>
 </a>
 <a href="#land-deals" style="text-decoration:none">
 <div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:16px;border:1px solid rgba(99,102,241,0.25);transition:all 0.2s;cursor:pointer;box-shadow:0 0 20px rgba(255,255,255,0.08)" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 25px rgba(255,255,255,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 0 20px rgba(255,255,255,0.08)'">
 
 <div style="color:#ffffff;font-weight:700;font-size:1.1rem">Land Deals</div>
 <div style="color:#cbd5e1;font-size:0.85rem">Build-to-profit analysis</div>
 </div>
 </a>
 <a href="#price-comp" style="text-decoration:none">
 <div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:16px;border:1px solid rgba(99,102,241,0.25);transition:all 0.2s;cursor:pointer;box-shadow:0 0 20px rgba(255,255,255,0.08)" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 25px rgba(255,255,255,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 0 20px rgba(255,255,255,0.08)'">
 
 <div style="color:#ffffff;font-weight:700;font-size:1.1rem">Price Comps</div>
 <div style="color:#cbd5e1;font-size:0.85rem">Compare any address</div>
 </div>
 </a>

 <a href="#market-stats" style="text-decoration:none">
 <div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:16px;border:1px solid rgba(99,102,241,0.25);transition:all 0.2s;cursor:pointer;box-shadow:0 0 20px rgba(255,255,255,0.08)" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 25px rgba(255,255,255,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 0 20px rgba(255,255,255,0.08)'">
 
 <div style="color:#ffffff;font-weight:700;font-size:1.1rem">Market Stats</div>
 <div style="color:#cbd5e1;font-size:0.85rem">Trends & insights</div>
 </div>
 </a>
 <a href="#assessments" style="text-decoration:none">
 <div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:16px;border:1px solid rgba(99,102,241,0.25);transition:all 0.2s;cursor:pointer;box-shadow:0 0 20px rgba(255,255,255,0.08)" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 25px rgba(255,255,255,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 0 20px rgba(255,255,255,0.08)'">
 
 <div style="color:#ffffff;font-weight:700;font-size:1.1rem">Tax Assessments</div>
 <div style="color:#cbd5e1;font-size:0.85rem">362K addresses</div>
 </div>
 </a>
 <a href="#property-lookup" style="text-decoration:none">
 <div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:16px;border:1px solid rgba(99,102,241,0.25);transition:all 0.2s;cursor:pointer;box-shadow:0 0 20px rgba(255,255,255,0.08)" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 25px rgba(255,255,255,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 0 20px rgba(255,255,255,0.08)'">
 
 <div style="color:#ffffff;font-weight:700;font-size:1.1rem">Property Lookup</div>
 <div style="color:#cbd5e1;font-size:0.85rem">114K detailed records</div>
 </div>
 </a>
 </div>

 <!-- QUICK STATS BAR -->
 <div id="market-stats" style="display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;padding:1rem 2rem;background:rgba(99,102,241,0.1);border-radius:12px;margin-bottom:2rem;border:1px solid rgba(99,102,241,0.2)">
        <div style="text-align:center"><span id="statTotal" style="color:#f8fafc;font-size:1.5rem;font-weight:700">...</span><br><span style="color:#94a3b8;font-size:0.75rem">PROPERTIES</span></div>
        <div style="text-align:center"><span id="statActive" style="color:#10b981;font-size:1.5rem;font-weight:700">...</span><br><span style="color:#94a3b8;font-size:0.75rem">FOR SALE NOW</span></div>
        <div style="text-align:center"><span id="statSold" style="color:#f8fafc;font-size:1.5rem;font-weight:700">...</span><br><span style="color:#94a3b8;font-size:0.75rem">SOLD (2 YRS)</span></div>
        <div style="text-align:center"><span id="statMedian" style="color:#f8fafc;font-size:1.5rem;font-weight:700">...</span><br><span style="color:#94a3b8;font-size:0.75rem">MEDIAN PRICE</span></div>
        <div style="text-align:center"><span id="statTowns" style="color:#f8fafc;font-size:1.5rem;font-weight:700">...</span><br><span style="color:#94a3b8;font-size:0.75rem">TOWNS</span></div>
    </div>

    <!-- Hero Image Section -->
    <div class="hero-image">
        <img src="images/newport-bridge.png?v=2" alt="Newport Bridge at sunset, Rhode Island" loading="lazy">
        <div class="hero-image-overlay">
            <p class="hero-top">FIND YOUR HOME</p>
            <svg class="hero-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" stroke-width="2">
                <path d="M32 12L8 32h8v20h12V40h8v12h12V32h8L32 12z" stroke-linejoin="round"/>
                <path d="M28 24a6 6 0 0 1 8 0M24 28a10 10 0 0 1 16 0M20 32a14 14 0 0 1 24 0" stroke-linecap="round"/>
            </svg>
            <p class="hero-bottom">REAL LIVING STARTS HERE</p>
        </div>
    </div>

    <h2>Key Market Insights</h2>
 <div class="insight-grid">
        <div class="insight-card insight-hover" data-chart="inland">
            <h3><span style="opacity:0.7">üèîÔ∏è</span> Top 5 Inland</h3>
 <div id="insightTopCities" style="display:grid;gap:0.4rem;font-size:0.95rem;margin:0.5rem 0">
 <div style="color:#94a3b8">Loading...</div>
 </div>
 <span class="hover-hint">Hover for trend</span>
 </div>
 <div class="insight-card insight-hover" data-chart="dom">
 <h3>Fastest to Sell</h3>
 <div id="insightFastestSell" style="display:grid;gap:0.4rem;font-size:0.95rem;margin:0.5rem 0">
 <div style="color:#94a3b8">Loading...</div>
 </div>
 <span class="hover-hint">Hover for trend</span>
 </div>
 <div class="insight-card insight-hover" data-chart="growth">
 <h3>YoY Appreciation</h3>
 <p><span id="insightYoY" class="big">...</span></p>
 <p id="insightYoYDesc">Loading comparison...</p>
 <span class="hover-hint">Hover for chart</span>
 </div>
 </div>
 
 <!-- Hover Chart Modal (Desktop Only) -->
 <div id="insightChartModal" class="insight-chart-modal">
 <div class="insight-chart-content">
 <canvas id="insightChart" width="600" height="300"></canvas>
 </div>
 </div>

 <h2 id="house-hunter">üè† House Hunter</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1.5rem">Find undervalued homes using <strong style="color:#6366f1">weighted nearby comps</strong> (closest 3-5 sales = 70% weight). <strong>Outliers removed</strong> ($1M+ homes excluded for sub-$500K properties). Uses <strong>10% haircut</strong> for selling costs. <span style="color:#f59e0b">Conservative methodology</span> ‚Äî estimates reflect real nearby sales.</p>
 
 <!-- Filters -->
 <div class="filters" style="margin-bottom:1.5rem">
 <div class="filter-group">
 <label>City</label>
 <select id="houseCity" onchange="filterHouseDeals()">
 <option value="">All Cities</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min DOM</label>
 <select id="houseMinDom" onchange="filterHouseDeals()">
 <option value="0">Any</option>
 <option value="30">30+ days</option>
 <option value="60" selected>60+ days</option>
 <option value="90">90+ days</option>
 <option value="180">180+ days</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Max Price</label>
 <select id="houseMaxPrice" onchange="filterHouseDeals()">
 <option value="">Any</option>
 <option value="300000">$300K</option>
 <option value="400000">$400K</option>
 <option value="500000">$500K</option>
 <option value="750000">$750K</option>
 <option value="1000000">$1M</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min Beds</label>
 <select id="houseMinBeds" onchange="filterHouseDeals()">
 <option value="0">Any</option>
 <option value="2">2+</option>
 <option value="3" selected>3+</option>
 <option value="4">4+</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min Discount %</label>
 <select id="houseMinDiscount" onchange="filterHouseDeals()">
 <option value="-10" selected>Any (incl. near market)</option>
 <option value="0">0%+ below market</option>
 <option value="5">5%+ below</option>
 <option value="10">10%+ below</option>
 <option value="15">15%+ below</option>
 </select>
 </div>
 </div>

 <!-- Summary Stats -->
 <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1.5rem">
 <div class="stat-card"><div class="stat-value" id="houseCount">0</div><div class="stat-label">Deals Found</div></div>
 <div class="stat-card"><div class="stat-value" id="houseAvgDiscount">0%</div><div class="stat-label">Avg Discount</div></div>
 <div class="stat-card"><div class="stat-value" id="houseAvgEquity">$0</div><div class="stat-label">Avg Instant Equity</div></div>
 <div class="stat-card" style="background:rgba(99,102,241,0.15)"><div class="stat-value" id="houseBestDeal" style="color:#10b981">$0</div><div class="stat-label">Best Equity Deal</div></div>
 </div>

 <!-- Results -->
 <div style="margin-bottom:1rem;display:flex;gap:0.5rem">
 <button onclick="filterHouseDeals()" style="background:linear-gradient(135deg,#6366f1,#4f46e5)">Find Deals</button>
 <button class="btn-accent" onclick="exportHouseDealsCSV()">Export CSV</button>
 </div>
 <div id="houseDealsResults" style="max-height:500px;overflow:auto;border-radius:10px"></div>
 <!-- Contextual FSBO CTA (appears after house hunt) -->
 <div id="houseFsboCta" style="display:none;margin-top:1.5rem;padding:1rem 1.5rem;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));border:1px solid rgba(99,102,241,0.25);border-radius:12px;text-align:center">
 <span style="color:#6366f1;font-weight:600">Own a home in RI?</span>
 <span style="color:#94a3b8;margin-left:0.5rem">Sell it yourself for $49 flat ‚Äî no 6% commission.</span>
 <a href="sell-your-home" style="margin-left:1rem;color:#10b981;font-weight:600;text-decoration:underline">List FSBO ‚Üí</a>
 </div>
 </div>
 
 
 <h2 id="land-deals">üèóÔ∏è Land Deal Finder</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1.5rem">Find motivated land sellers (90+ days on market) and calculate build-to-sell ROI using <strong style="color:#22d3ee">median comp $/sqft + 5% new construction premium</strong>. Negative profits mean the land is overpriced for the market ‚Äî use Max Offer as your negotiating target.</p>
 
 <!-- Filters -->
 <div class="filters" style="margin-bottom:1.5rem">
 <div class="filter-group">
 <label>City</label>
 <select id="landCity" onchange="filterLandDeals()">
 <option value="">All Cities</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min DOM</label>
 <select id="landMinDom" onchange="filterLandDeals()">
 <option value="0">Any</option>
 <option value="60">60+ days</option>
 <option value="90" selected>90+ days</option>
 <option value="180">180+ days</option>
 <option value="365">365+ days</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Max Price</label>
 <select id="landMaxPrice" onchange="filterLandDeals()">
 <option value="">Any</option>
 <option value="100000">$100K</option>
 <option value="200000">$200K</option>
 <option value="300000">$300K</option>
 <option value="500000">$500K</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min Lot (acres)</label>
 <input type="number" id="landMinAcres" placeholder="0" step="0.1" onchange="filterLandDeals()">
 </div>
 </div>

 <!-- Build Calculator Inputs -->
 <div style="background:rgba(99,102,241,0.1);padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border:1px solid rgba(99,102,241,0.25)">
 <h3 style="color:#6366f1;margin-bottom:1rem;font-size:1rem">üîß Build Calculator Settings</h3>
 <div class="filters" style="margin-bottom:0.75rem">
 <div class="filter-group">
 <label>üõèÔ∏è Bedrooms</label>
 <select id="targetRooms" onchange="updateBuildFromRooms();filterLandDeals()">
 <option value="2">2 BR (~1,200 sqft)</option>
 <option value="3" selected>3 BR (~1,600 sqft)</option>
 <option value="4">4 BR (~2,200 sqft)</option>
 <option value="5">5 BR (~2,800 sqft)</option>
 <option value="6">6 BR (~3,500 sqft)</option>
 <option value="custom">Custom</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Target SqFt</label>
 <input type="number" id="targetSqft" value="1600" style="width:100px" onchange="document.getElementById('targetRooms').value='custom';filterLandDeals()">
 </div>
 <div class="filter-group">
 <label>Build $/sqft</label>
 <input type="number" id="buildCostPsf" value="175" style="width:80px" onchange="filterLandDeals()">
 </div>
 <div class="filter-group">
 <label>Soft Costs %</label>
 <input type="number" id="softCosts" value="15" style="width:60px" onchange="filterLandDeals()">
 </div>
 <div class="filter-group">
 <label>Target Profit %</label>
 <input type="number" id="targetProfit" value="25" style="width:60px" onchange="filterLandDeals()">
 </div>
 </div>
 <!-- Room cost adjustments info -->
 <div id="buildEstimate" style="background:rgba(16,185,129,0.15);padding:0.75rem 1rem;border-radius:8px;margin-bottom:0.75rem;font-size:0.8rem">
 <span style="color:#10b981;font-weight:600">üìä Est. Build Cost:</span> 
 <span id="buildCostDisplay">$280K</span> 
 <span style="color:#94a3b8">(1,600 sqft √ó $175/sf)</span>
 <span id="roomCostNote" style="color:#64748b;margin-left:1rem">3 BR base rate</span>
 </div>
 <p style="color:#64748b;font-size:0.75rem;margin-top:0.5rem">
 üí° <strong>Build cost scales with complexity:</strong> 2BR=$160/sf, 3BR=$175/sf, 4BR=$185/sf, 5BR=$195/sf, 6BR=$210/sf. 
 More rooms = more plumbing, HVAC, finishes.
 </p>
 </div>
 
 <!-- Lot Buildability Analysis -->
 <div style="background:rgba(34,211,238,0.08);padding:1rem 1.5rem;border-radius:12px;margin-bottom:1.5rem;border:1px solid rgba(34,211,238,0.25)">
 <h4 style="color:#22d3ee;margin-bottom:0.75rem;font-size:0.9rem">üìê Lot Buildability Analysis (RI Zoning Estimates)</h4>
 <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;font-size:0.8rem">
 <div>
 <div style="color:#94a3b8">0.25 acres (10,890 sf)</div>
 <div style="color:#22d3ee;font-weight:600">‚Üí ~2,700 sf buildable</div>
 <div style="color:#64748b;font-size:0.7rem">3-4 BR typical</div>
 </div>
 <div>
 <div style="color:#94a3b8">0.50 acres (21,780 sf)</div>
 <div style="color:#22d3ee;font-weight:600">‚Üí ~5,400 sf buildable</div>
 <div style="color:#64748b;font-size:0.7rem">4-6 BR typical</div>
 </div>
 <div>
 <div style="color:#94a3b8">1.0 acres (43,560 sf)</div>
 <div style="color:#22d3ee;font-weight:600">‚Üí ~10,800 sf buildable</div>
 <div style="color:#64748b;font-size:0.7rem">6+ BR or multi-unit</div>
 </div>
 <div>
 <div style="color:#94a3b8">2.0+ acres</div>
 <div style="color:#22d3ee;font-weight:600">‚Üí Estate / Subdivision</div>
 <div style="color:#64748b;font-size:0.7rem">Multiple homes possible</div>
 </div>
 </div>
 <p style="color:#64748b;font-size:0.7rem;margin-top:0.75rem">
 Based on typical RI FAR 0.25 + 35% coverage. Actual limits vary by town zoning. Coastal zones may be more restrictive.
 </p>
 </div>

 <!-- Summary Stats -->
 <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1.5rem">
 <div class="stat-card"><div class="stat-value" id="landCount">0</div><div class="stat-label">Deals Found</div></div>
 <div class="stat-card"><div class="stat-value" id="landAvgDom">0</div><div class="stat-label">Avg Days Listed</div></div>
 <div class="stat-card"><div class="stat-value" id="landAvgPrice">$0</div><div class="stat-label">Avg Ask Price</div></div>
 <div class="stat-card" style="background:rgba(99,102,241,0.15)"><div class="stat-value" id="landBestDeal" style="color:#10b981">$0</div><div class="stat-label">Best Potential</div></div>
 </div>

 <!-- Results Table -->
 <div style="margin-bottom:1rem;display:flex;gap:0.5rem">
 <button onclick="filterLandDeals()" style="background:linear-gradient(135deg,#10b981,#059669)">Find Deals</button>
 <button class="btn-accent" onclick="exportLandDealsCSV()">Export CSV</button>
 </div>
 <div id="landDealsResults" style="max-height:500px;overflow:auto;border-radius:10px"></div>
 </div>

 <h2>Market Trends</h2>
 
 <!-- Interactive Plotly Visualizations -->
 <p style="color:#94a3b8;margin-bottom:1.5rem">Explore Rhode Island real estate through interactive charts. Hover for details, click legends to filter, drag to pan.</p>
 
 <div class="chart-grid" style="margin-bottom:1.5rem">
 <!-- 3D Market Explorer -->
 <div class="chart-card full" style="background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.08));border:1px solid rgba(99,102,241,0.3)">
 <div class="chart-title" style="font-size:1.1rem;color:#e2e8f0">üéØ 3D Market Explorer: Size √ó Age √ó Price</div>
 <p style="color:#6366f1;font-size:0.85rem;margin-bottom:0.75rem"><strong>üñ±Ô∏è Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Double-click to reset.</strong> Color = $/sqft ‚Äî <span style="color:#ef4444">red = expensive</span>, <span style="color:#818cf8">blue = affordable</span>.</p>
 <iframe src="ri-3d-scatter.html" style="width:100%;height:700px;border:none;border-radius:10px"></iframe>
 <div style="background:rgba(0,0,0,0.2);padding:0.75rem 1rem;border-radius:6px;margin-top:0.75rem;font-size:0.8rem;color:#94a3b8">
 <strong style="color:#6366f1">üìä Stratified Sample:</strong> 1,500 from 30K ‚Äî 150 per price decile for scientific representation.
 </div>
 </div>
 
 <!-- Violin Plot -->
 <div class="chart-card full" style="background:linear-gradient(135deg, rgba(16,185,129,0.08), rgba(99,102,241,0.05));border:1px solid rgba(16,185,129,0.25)">
 <div class="chart-title" style="font-size:1.1rem;color:#e2e8f0">üéª Price Distribution by Bedrooms</div>
 <p style="color:#10b981;font-size:0.85rem;margin-bottom:0.75rem">Each "violin" shows where prices cluster. Wider = more properties. <strong>Click legend</strong> to toggle bedroom counts.</p>
 <iframe src="ri-violin-beds.html" style="width:100%;height:480px;border:none;border-radius:10px"></iframe>
 </div>
 
 <!-- Density Heatmap -->
 <div class="chart-card full" style="background:linear-gradient(135deg, rgba(239,68,68,0.08), rgba(249,115,22,0.05));border:1px solid rgba(239,68,68,0.25)">
 <div class="chart-title" style="font-size:1.1rem;color:#e2e8f0">üî• Price vs Square Footage Density</div>
 <p style="color:#f87171;font-size:0.85rem;margin-bottom:0.75rem">
 <strong>Color key:</strong> 
 <span style="color:#ef4444">üî¥ Red/Orange = HOT (most homes)</span> ‚Üí 
 <span style="color:#22c55e">üü¢ Green = moderate</span> ‚Üí 
 <span style="color:#818cf8">üîµ Blue/Purple = RARE (few homes)</span>. 
 Hover for counts.
 </p>
 <iframe src="ri-scatter-price-sqft.html" style="width:100%;height:520px;border:none;border-radius:10px"></iframe>
 <div style="background:rgba(0,0,0,0.2);padding:0.75rem 1rem;border-radius:6px;margin-top:0.75rem;font-size:0.8rem;color:#94a3b8">
 <strong style="color:#f87171">üéØ Key insight:</strong> The <span style="color:#ef4444">red hot spot</span> at ~1,000 sqft / $350K is where most RI homes sell. The diagonal shows bigger = pricier. <strong>Deal hunting:</strong> Blue cells <em>above</em> the red band = larger homes at lower-than-expected prices.
 </div>
 </div>
 
 </div>
 
 <!-- Price Analysis Grid (2x2 compact squares) -->
 <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin:1.5rem 0">
 <div style="border:1px solid rgba(255,255,255,0.1);border-radius:8px;overflow:hidden">
 <iframe src="ri-price-tiers.html" style="width:100%;height:280px;border:none" scrolling="no"></iframe>
 </div>
 <div style="border:1px solid rgba(255,255,255,0.1);border-radius:8px;overflow:hidden">
 <iframe src="ri-affordability.html" style="width:100%;height:280px;border:none" scrolling="no"></iframe>
 </div>
 <div style="border:1px solid rgba(255,255,255,0.1);border-radius:8px;overflow:hidden">
 <iframe src="ri-market-share.html" style="width:100%;height:280px;border:none" scrolling="no"></iframe>
 </div>
 <div style="border:1px solid rgba(255,255,255,0.1);border-radius:8px;overflow:hidden">
 <iframe src="ri-price-log.html" style="width:100%;height:280px;border:none" scrolling="no"></iframe>
 </div>
 </div>
 
 <div class="chart-grid">
 <div class="chart-card full">
 <div class="chart-title">Monthly Sales Volume & Average Price (24 Months)</div>
 <div style="position:relative;height:200px"><canvas id="trendChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Sales by City (Top 15)</div>
 <div style="position:relative;height:300px"><canvas id="cityChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Median Price by City</div>
 <div style="position:relative;height:300px"><canvas id="priceChart"></canvas></div>
 </div>
 </div>
 
 <h2>Price Analysis</h2>
 <div class="chart-grid">
 <div class="chart-card">
 <div class="chart-title">Price Distribution (Histogram)</div>
 <div style="position:relative;height:250px"><canvas id="histogramChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Price per Sq Ft by City</div>
 <div style="position:relative;height:250px"><canvas id="ppsqftChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Property Type Breakdown</div>
 <div style="position:relative;height:250px"><canvas id="typeChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Days on Market by Price Range</div>
 <div style="position:relative;height:250px"><canvas id="domChart"></canvas></div>
 </div>
 </div>
 
 <h2>Property Characteristics</h2>
 <div class="chart-grid">
 <div class="chart-card">
 <div class="chart-title">Bedroom Distribution</div>
 <div style="position:relative;height:250px"><canvas id="bedsChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Year Built Distribution</div>
 <div style="position:relative;height:250px"><canvas id="yearBuiltChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">Square Footage Distribution</div>
 <div style="position:relative;height:250px"><canvas id="sqftChart"></canvas></div>
 </div>
 <div class="chart-card">
 <div class="chart-title">üåø Land Sales by City</div>
 <div style="position:relative;height:250px"><canvas id="landChart"></canvas></div>
 </div>
 </div>

 <!-- Deal Map Section -->
 <h2>üó∫Ô∏è Deal Map</h2>
 <div class="chart-card full" style="background:linear-gradient(135deg, rgba(34,197,94,0.08), rgba(16,185,129,0.05));border:1px solid rgba(34,197,94,0.25)">
 <div class="chart-title" style="font-size:1.1rem;color:#e2e8f0">üìç Top Deals Across Rhode Island</div>
 <p style="color:#22c55e;font-size:0.85rem;margin-bottom:0.75rem">Machine learning scored 30K properties. <strong>Click markers</strong> for details. Green = best deals (90+), yellow = great (80+).</p>
 <iframe src="ri-deal-map.html" style="width:100%;height:500px;border:none;border-radius:10px"></iframe>
 <div style="background:rgba(0,0,0,0.2);padding:0.75rem 1rem;border-radius:6px;margin-top:0.75rem;font-size:0.8rem;color:#94a3b8">
 <strong style="color:#22c55e">üéØ Deal Score:</strong> Compares actual price vs predicted price using a Random Forest model (R¬≤=0.72). Score of 90+ means property sold for ~90% below predicted value. <em>Note: Some are foreclosures, estate sales, or data anomalies ‚Äî always verify.</em>
 </div>
 </div>

 <!-- Property Type Violin Chart -->
 <div class="chart-card full" style="margin-top:1.5rem;background:linear-gradient(135deg, rgba(139,92,246,0.08), rgba(99,102,241,0.05));border:1px solid rgba(139,92,246,0.25)">
 <div class="chart-title" style="font-size:1.1rem;color:#e2e8f0">üí∞ Price Distribution by Property Type</div>
 <p style="color:#a78bfa;font-size:0.85rem;margin-bottom:0.75rem">Violin plots show where prices cluster for each property type. Wider = more properties at that price. <strong>Box inside shows median + quartiles.</strong></p>
 <iframe src="ri-violin-types.html" style="width:100%;height:470px;border:none;border-radius:10px"></iframe>
 </div>

 <h2 id="sql-tool">SQL Query Tool</h2>
    <div class="sql-section">
        <button class="filter-toggle" onclick="toggleFilters(this)">Advanced Filters</button>
        <div class="filters" id="sqlFilters">
 <div class="filter-group"><label>City</label><select id="filterCity" onchange="buildQuery()"><option value="">All Cities</option></select></div>
 <div class="filter-group"><label>Type</label><select id="filterType" onchange="buildQuery()"><option value="">All</option><option value="Single Family">Single Family</option><option value="Condo">Condo</option><option value="Multi">Multi-Family</option><option value="Land">Land</option></select></div>
 <div class="filter-group"><label>Status</label><select id="filterStatus" onchange="buildQuery()"><option value="">All</option><option value="For Sale">For Sale</option><option value="Sold">Sold</option></select></div>
 <button class="more-filters-btn" onclick="toggleMoreFilters(this)">More Filters ‚ñº</button>
 <div class="extra-filters" id="extraFilters">
 <div class="filter-group"><label>Min $</label><input type="number" id="filterMinPrice" placeholder="0" onchange="buildQuery();autoCollapseFilters()"></div>
 <div class="filter-group"><label>Max $</label><input type="number" id="filterMaxPrice" placeholder="Any" onchange="buildQuery();autoCollapseFilters()"></div>
 <div class="filter-group"><label>Beds</label><select id="filterBeds" onchange="buildQuery();autoCollapseFilters()"><option value="">Any</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option></select></div>
 <div class="filter-group"><label>Year</label><select id="filterYear" onchange="buildQuery();autoCollapseFilters()"><option value="">All</option><option value="2026">2026</option><option value="2025">2025</option><option value="2024">2024</option></select></div>
 <div class="filter-group"><label>Sort</label><select id="filterSort" onchange="buildQuery();autoCollapseFilters()"><option value="price DESC">Price ‚Üì</option><option value="price ASC">Price ‚Üë</option><option value="sqft DESC">Size ‚Üì</option><option value="dom ASC">Fastest</option></select></div>
 <div class="filter-group"><label>Limit</label><select id="filterLimit" onchange="buildQuery();autoCollapseFilters()"><option value="25">25</option><option value="50">50</option><option value="100">100</option></select></div>
 </div>
 </div>
 <div class="quick-queries">
 <button class="quick-btn" onclick="setQuery('forSale')" style="background:rgba(16,185,129,0.3);border-color:rgba(16,185,129,0.5);color:#6366f1">For Sale</button>
 <button class="quick-btn" onclick="setQuery('top')">üèÜ Top Sales</button>
 <button class="quick-btn" onclick="setQuery('land')">üåø Land</button>
 <button class="quick-btn" onclick="setQuery('under300')">üíµ Under $300K</button>
 <button class="quick-btn" onclick="setQuery('newport')">‚õµ Newport</button>
 <button class="quick-btn" onclick="setQuery('ppsqft')">üìê $/SqFt Analysis</button>
 <button class="quick-btn" onclick="setQuery('fastSales')">‚ö° Fastest Sales</button>
 <button class="quick-btn" onclick="setQuery('newConstruction')">New Construction</button>
 </div>
 <textarea id="sqlInput"></textarea>
 <div class="btn-row">
 <button onclick="runQuery()">‚ñ∂Ô∏è Run</button>
 <button class="btn-secondary" onclick="resetFilters()">Reset</button>
 <button class="btn-accent" onclick="exportCSV()">CSV</button>
 <button class="btn-accent" onclick="exportHTML()" style="background:linear-gradient(135deg,#6366f1,#6366f1)">HTML</button>
 <span id="dbStatus" style="margin-left:auto;color:#f59e0b;font-size:0.8rem">‚è≥ Loading database...</span>
 </div>
 <div id="results"></div>
 </div>

 <h2 id="price-comp">Address Comp Report</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1.5rem">Enter <strong>any</strong> Rhode Island address to get a comparable sales report. We'll look it up and find similar sales in the area.</p>
 
 <!-- Address Search -->
 <div style="position:relative;margin-bottom:1rem">
 <label style="font-size:0.75rem;color:#94a3b8;text-transform:uppercase;display:block;margin-bottom:0.5rem">Enter Any RI Address</label>
 <input type="text" id="addressSearch" placeholder="123 Main St, Providence (any RI address)" 
 style="width:100%;padding:1rem;font-size:1.1rem;background:rgba(0,0,0,0.4);border:2px solid rgba(99,102,241,0.5);border-radius:12px;color:#e2e8f0"
 oninput="searchAddress(this.value)" onkeydown="if(event.key==='Enter'){event.preventDefault();autoLookupProperty();}" autocomplete="off">
 <div id="addressResults" style="position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:8px;max-height:300px;overflow-y:auto;display:none;z-index:100"></div>
 </div>
 
 <!-- Auto Lookup Button -->
 <div style="margin-bottom:1.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center">
 <button onclick="autoLookupProperty()" style="background:linear-gradient(135deg,#10b981,#059669);font-size:1rem;padding:0.8rem 1.5rem">
 Find Comps
 </button>
 <button onclick="toggleManualEntry()" class="btn-secondary" style="font-size:1rem;padding:0.8rem 1.5rem">
 ‚úèÔ∏è Enter Details Manually
 </button>
 <span id="lookupStatus" style="color:#94a3b8;font-size:0.9rem"></span>
 </div>
 
 <!-- Manual Entry Form (hidden by default) -->
 <div id="manualEntryForm" style="display:none;background:rgba(99,102,241,0.1);padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border:1px solid rgba(99,102,241,0.25)">
 <h3 style="color:#6366f1;margin-bottom:1rem;font-size:1rem">‚úèÔ∏è Manual Property Entry</h3>
 <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem">Enter property details for accurate $/sqft comparison</p>
 <div class="filters" style="margin-bottom:1rem">
 <div class="filter-group">
 <label>Address</label>
 <input type="text" id="manualAddress" placeholder="123 Main St" style="min-width:200px">
 </div>
 <div class="filter-group">
 <label>City</label>
 <select id="manualCity" style="min-width:150px">
 <option value="">Select City</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Property Type</label>
 <select id="manualType">
 <option value="Single Family">Single Family</option>
 <option value="Condo">Condo</option>
 <option value="Townhouse">Townhouse</option>
 <option value="Multi-Family">Multi-Family</option>
 </select>
 </div>
 </div>
 <div class="filters" style="margin-bottom:1rem">
 <div class="filter-group">
 <label>Beds</label>
 <input type="number" id="manualBeds" placeholder="3" min="0" max="10" style="width:80px">
 </div>
 <div class="filter-group">
 <label>Baths</label>
 <input type="number" id="manualBaths" placeholder="2" min="0" max="10" step="0.5" style="width:80px">
 </div>
 <div class="filter-group">
 <label>Sq Ft</label>
 <input type="number" id="manualSqft" placeholder="1500" min="0" style="width:100px">
 </div>
 <div class="filter-group">
 <label>Year Built</label>
 <input type="number" id="manualYear" placeholder="1990" min="1700" max="2030" style="width:100px">
 </div>
 </div>
 <button onclick="runManualComp()" style="background:linear-gradient(135deg,#10b981,#059669)">
 Run Comp
 </button>
 </div>
 
 <!-- Subject Property Card (hidden until address selected) -->
 <div id="subjectProperty" style="display:none;background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(16,185,129,0.2));padding:1.5rem;border-radius:16px;margin-bottom:1.5rem;border:2px solid rgba(99,102,241,0.5)">
 <h3 style="color:#6366f1;margin-bottom:1rem;font-size:1.2rem">Subject Property</h3>
 <div id="subjectDetails" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem"></div>
 </div>
 
 <!-- Comp Results -->
 <div id="compReport" style="display:none">
 <h3 style="color:#6366f1;margin-bottom:1rem">Comparable Sales (Last 2 Years)</h3>
 <div class="stats-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:1.5rem">
 <div class="stat-card"><div class="stat-value" id="compCount">0</div><div class="stat-label">Comps Found</div></div>
 <div class="stat-card"><div class="stat-value" id="compMedian">$0</div><div class="stat-label">Median</div></div>
 <div class="stat-card"><div class="stat-value" id="compAvg">$0</div><div class="stat-label">Average</div></div>
 <div class="stat-card"><div class="stat-value" id="compPsf">$0</div><div class="stat-label">Avg $/SqFt</div></div>
 <div class="stat-card" style="background:rgba(99,102,241,0.15)"><div class="stat-value" id="compEstimate" style="color:#10b981">$0</div><div class="stat-label">Est. Value</div></div>
 </div>
 <div class="btn-row" style="margin-bottom:1rem">
 <button class="btn-accent" onclick="exportCompCSV()">Export CSV</button>
 <button class="btn-accent" onclick="exportCompHTML()" style="background:linear-gradient(135deg,#6366f1,#6366f1)">Export HTML</button>
 <button class="btn-secondary" onclick="clearComp()">New Search</button>
 </div>
 <div id="compResults"></div>
 <!-- Contextual FSBO CTA (appears after comp search) -->
 <div id="compFsboCta" style="display:none;margin-top:1.5rem;padding:1rem 1.5rem;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));border:1px solid rgba(99,102,241,0.25);border-radius:12px;text-align:center">
 <span style="color:#6366f1;font-weight:600">Thinking of selling?</span>
 <span style="color:#94a3b8;margin-left:0.5rem">List FSBO for just $49 ‚Äî save thousands vs 6% agent fees.</span>
 <a href="sell-your-home" style="margin-left:1rem;color:#10b981;font-weight:600;text-decoration:underline">List your home ‚Üí</a>
 </div>
 </div>
 </div>

 <!-- TAX ASSESSMENTS SECTION -->
 <h2 id="assessments"> Tax Assessment Data</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1rem">Town assessment records from 27 RI municipalities ‚Äî <strong>207,700 properties</strong> (no owner names)</p>
 
 <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1.5rem">
 <div class="stat-card"><div class="stat-value" style="color:#f59e0b">208K</div><div class="stat-label">Properties</div></div>
 <div class="stat-card"><div class="stat-value" style="color:#10b981">27</div><div class="stat-label">Towns</div></div>
 <div class="stat-card"><div class="stat-value" style="color:#6366f1">$156K</div><div class="stat-label">Avg Assessed</div></div>
 <div class="stat-card"><div class="stat-value" style="color:#00E1E6">1,754</div><div class="stat-label">Avg Sqft</div></div>
 </div>
 
 <!-- ASSESSMENT SEARCH -->
 <h3 style="color:#6366f1;margin-bottom:1rem;font-size:1.1rem">Search Assessment Records <span style="background:#10b981;color:white;font-size:0.7rem;padding:2px 8px;border-radius:10px;margin-left:0.5rem">76% GEOCODED</span></h3>
 <div style="background:rgba(0,0,0,0.2);padding:1.25rem;border-radius:12px;margin-bottom:1.5rem">
 <!-- Proximity Search -->
 <div style="background:rgba(16,185,129,0.1);padding:1rem;border-radius:10px;margin-bottom:1rem;border:1px solid rgba(99,102,241,0.25)">
 <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end">
 <div class="filter-group" style="flex:1;min-width:250px">
 <label style="color:#10b981">Find Nearby (enter full address)</label>
 <input type="text" id="assessProximityAddr" placeholder="e.g. 123 Main St, Providence, RI" style="width:100%">
 </div>
 <div class="filter-group">
 <label style="color:#10b981">Radius</label>
 <select id="assessRadius">
 <option value="0.25">0.25 mi</option>
 <option value="0.5" selected>0.5 mi</option>
 <option value="1">1 mi</option>
 <option value="2">2 mi</option>
 </select>
 </div>
 <button onclick="searchAssessProximity()" style="background:linear-gradient(135deg,#10b981,#059669)">üó∫Ô∏è Find Nearby</button>
 </div>
 </div>
 
 <!-- Standard Search -->
 <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;margin-bottom:1rem">
 <div class="filter-group" style="flex:1;min-width:200px">
 <label>Address (partial OK)</label>
 <input type="text" id="assessAddress" placeholder="e.g. Main St, Oak Ave" style="width:100%">
 </div>
 <div class="filter-group">
 <label>Town</label>
 <select id="assessCity">
 <option value="">All Towns</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min Sqft</label>
 <input type="number" id="assessMinSqft" placeholder="0" style="width:100px">
 </div>
 <div class="filter-group">
 <label>Sort By</label>
 <select id="assessSort">
 <option value="assessed-desc">Assessed ‚Üì</option>
 <option value="assessed-asc">Assessed ‚Üë</option>
 <option value="sqft-desc">Sqft ‚Üì</option>
 <option value="sqft-asc">Sqft ‚Üë</option>
 <option value="year-desc">Year ‚Üì</option>
 <option value="year-asc">Year ‚Üë</option>
 <option value="distance-asc">Distance ‚Üë</option>
 </select>
 </div>
 <button onclick="searchAssessments()" style="background:linear-gradient(135deg,#6366f1,#6366f1)">Search</button>
 </div>
 <div id="assessStatus" style="color:#94a3b8;font-size:0.85rem">Enter search criteria or use proximity search (362,160 geocoded addresses)</div>
 </div>
 <div id="assessResults" style="display:none;margin-bottom:2rem">
 <div id="assessResultsCount" style="color:#10b981;font-weight:600;margin-bottom:0.75rem"></div>
 <div id="assessResultsTable" style="max-height:400px;overflow-y:auto;border-radius:10px"></div>
 <div id="assessPagination" style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center;justify-content:center"></div>
 </div>
 
 <h3 style="color:#6366f1;margin-bottom:1rem;font-size:1.1rem">Town-by-Town Breakdown</h3>
 <div id="assessmentGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.75rem;max-height:500px;overflow-y:auto;padding-right:0.5rem">
 <!-- Populated by JS -->
 </div>
 
 <p style="color:#64748b;font-size:0.8rem;margin-top:1.5rem;text-align:center">
 Data sourced from town VGSI assessment portals ‚Ä¢ Updated Feb 2026 ‚Ä¢ Contact for bulk data access
 </p>
 </div>
 
 <!-- Property Details Lookup -->
 <h2 id="property-lookup">Property Details Lookup</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1rem">Search <strong>114,000+ properties</strong> with detailed info: beds, baths, sqft, year built, sale history, and more.</p>
 
 <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;margin-bottom:1rem">
 <div class="filter-group" style="flex:1;min-width:200px">
 <label>Address</label>
 <input type="text" id="propAddress" placeholder="e.g. 123 Main St" style="width:100%">
 </div>
 <div class="filter-group">
 <label>Town</label>
 <select id="propTown">
 <option value="">All Towns</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min Beds</label>
 <select id="propMinBeds">
 <option value="">Any</option>
 <option value="2">2+</option>
 <option value="3">3+</option>
 <option value="4">4+</option>
 </select>
 </div>
 <div class="filter-group">
 <label>Min Sqft</label>
 <input type="number" id="propMinSqft" placeholder="0" style="width:100px">
 </div>
 <button onclick="searchProperties()" style="background:linear-gradient(135deg,#6366f1,#6366f1)">Search Properties</button>
 </div>
 <div id="propStatus" style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem">Enter search criteria (114K properties with detailed assessor data)</div>
 <div id="propResults" style="display:none">
 <div id="propResultsCount" style="color:#10b981;font-weight:600;margin-bottom:0.75rem"></div>
 <div id="propResultsTable" style="max-height:500px;overflow-y:auto;border-radius:10px"></div>
 <div id="propPagination" style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center;justify-content:center"></div>
 </div>
 </div>

 <!-- City Price Heatmap -->
 <h2 id="heatmap">üó∫Ô∏è Price Heatmap by City</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1rem">Median home prices by city ‚Äî darker = more expensive</p>
 <div id="cityHeatmap" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5rem"></div>
 <div style="display:flex;justify-content:center;gap:2rem;margin-top:1.5rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.1)">
 <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:20px;height:20px;background:#10b981;border-radius:4px"></div><span style="color:#94a3b8;font-size:0.8rem">&lt;$400K</span></div>
 <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:20px;height:20px;background:#f59e0b;border-radius:4px"></div><span style="color:#94a3b8;font-size:0.8rem">$400-600K</span></div>
 <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:20px;height:20px;background:#00E1E6;border-radius:4px"></div><span style="color:#94a3b8;font-size:0.8rem">$600-800K</span></div>
 <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:20px;height:20px;background:#6366f1;border-radius:4px"></div><span style="color:#94a3b8;font-size:0.8rem">&gt;$800K</span></div>
 </div>
 </div>
 </div>

 <script>
 // ===== Anti-Scraping Protections =====
 (function() {
 // 1. Headless browser detection
 const isBot = navigator.webdriver || 
 window.__nightmare || 
 window.phantom ||
 window._phantom ||
 window.callPhantom ||
 /HeadlessChrome/.test(navigator.userAgent) ||
 /PhantomJS/.test(navigator.userAgent) ||
 !navigator.languages || navigator.languages.length === 0;
 
 if (isBot) {
 document.body.innerHTML = '<h1 style="text-align:center;margin-top:200px;">Access Denied</h1><p style="text-align:center;">Automated access is not permitted.</p>';
 throw new Error('Bot detected');
 }

 // 2. Rate limiting (max 50 page loads per hour)
 const now = Date.now();
 const hourAgo = now - 3600000;
 let visits = JSON.parse(localStorage.getItem('_ri_v') || '[]').filter(t => t > hourAgo);
 visits.push(now);
 localStorage.setItem('_ri_v', JSON.stringify(visits));
 if (visits.length > 50) {
 document.body.innerHTML = '<h1 style="text-align:center;margin-top:200px;">Rate Limited</h1><p style="text-align:center;">Please try again later.</p>';
 throw new Error('Rate limited');
 }

 // 3. Disable right-click and text selection on data tables
 document.addEventListener('contextmenu', e => {
 if (e.target.closest('table, .results-table, #query-results')) {
 e.preventDefault();
 return false;
 }
 });

 // 4. Console warning
 console.log('%cWARNING', 'color: red; font-size: 24px; font-weight: bold;');
 console.log('%cScraping this data is prohibited. All access is logged.', 'color: red; font-size: 14px;');

 // 5. Honeypot trap (hidden link that only bots follow)
 const hp = document.createElement('a');
 hp.href = '/honeypot-trap-do-not-follow';
 hp.style.cssText = 'position:absolute;left:-9999px;opacity:0;pointer-events:none;';
 hp.textContent = 'property-data-export';
 hp.setAttribute('data-hp', '1');
 document.body.appendChild(hp);

 // 6. Block F12 / DevTools keyboard shortcut (deterrent only)
 document.addEventListener('keydown', e => {
 if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J'))) {
 e.preventDefault();
 alert('Developer tools access is monitored.');
 }
 });
 })();
 // ===== End Anti-Scraping =====
 
 // ===== Mobile Menu =====
 
    // Toggle filters on mobile
    function toggleFilters(btn) {
        const filters = document.getElementById('sqlFilters');
        btn.classList.toggle('active');
        filters.classList.toggle('show');
    }
    
    function toggleMoreFilters(btn) {
        const extra = document.getElementById('extraFilters');
        btn.classList.toggle('active');
        extra.classList.toggle('show');
        btn.textContent = extra.classList.contains('show') ? 'Less Filters ‚ñ≤' : 'More Filters ‚ñº';
    }
    
    function autoCollapseFilters() {
        if (window.innerWidth <= 768) {
            const extra = document.getElementById('extraFilters');
            const btn = document.querySelector('.more-filters-btn');
            if (extra && btn && extra.classList.contains('show')) {
                setTimeout(() => {
                    extra.classList.remove('show');
                    btn.classList.remove('active');
                    btn.textContent = 'More Filters ‚ñº';
                }, 300);
            }
        }
    }

    function toggleMobileMenu() {
 const menu = document.getElementById('mobileMenu');
 menu.classList.toggle('active');
 }
 function closeMobileMenu() {
 document.getElementById('mobileMenu').classList.remove('active');
 }
 // Close menu on scroll
 window.addEventListener('scroll', closeMobileMenu);

let rawData = null;
let db, lastResults = [];

// Parallel load: fetch gzip data AND SQL.js WASM at the same time
// Cache-bust with daily version to ensure fresh data
const dataVersion = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
const t0 = performance.now();
Promise.all([
  // Load data
  fetch('ri-sales.json.gz?v=' + dataVersion).then(r => r.arrayBuffer()).then(buf => {
    const decompressed = pako.ungzip(new Uint8Array(buf), {to: 'string'});
    return JSON.parse(decompressed);
  }),
  // Load SQL.js WASM
  initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` })
]).then(([data, SQL]) => {
  rawData = data;
  console.log('Parallel load took', Math.round(performance.now() - t0), 'ms for', rawData.properties.length, 'properties');
  
  // Precompute city stats once for faster insights
  const t_precompute = performance.now();
  window.cityStats = {};
  rawData.properties.forEach(p => {
    if (!window.cityStats[p.city]) {
      window.cityStats[p.city] = { prices: [], doms: [], soldPrices: [], yearlyPrices: {} };
    }
    const cs = window.cityStats[p.city];
    if (p.price > 50000) cs.prices.push(p.price);
    if (p.dom > 0 && p.dom < 365) cs.doms.push(p.dom);
    if (p.status === 'Sold' || p.soldDate) {
      if (p.price > 50000) cs.soldPrices.push(p.price);
      if (p.soldDate) {
        const year = parseInt(p.soldDate.split('-')[0]) || parseInt(p.soldDate.split('-').pop());
        if (!cs.yearlyPrices[year]) cs.yearlyPrices[year] = [];
        cs.yearlyPrices[year].push(p.price);
      }
    }
  });
  // Compute aggregates
  Object.keys(window.cityStats).forEach(city => {
    const cs = window.cityStats[city];
    cs.count = cs.prices.length;
    cs.medianPrice = cs.prices.length ? cs.prices.sort((a,b)=>a-b)[Math.floor(cs.prices.length/2)] : 0;
    cs.avgDom = cs.doms.length ? Math.round(cs.doms.reduce((a,b)=>a+b,0) / cs.doms.length) : 999;
  });
  console.log('Precomputed stats for', Object.keys(window.cityStats).length, 'cities in', Math.round(performance.now() - t_precompute), 'ms');
  
  // Create database with batch insert (much faster than row-by-row)
  db = new SQL.Database();
  db.run(`CREATE TABLE properties (address TEXT, city TEXT, zip TEXT, price INT, propertyType TEXT, beds INT, baths REAL, sqft INT, lotSize INT, yearBuilt INT, dom INT, soldDate TEXT, url TEXT, status TEXT)`);
  
  // Batch insert in chunks of 500 for optimal performance
  const BATCH = 500;
  const t1 = performance.now();
  for (let i = 0; i < rawData.properties.length; i += BATCH) {
    const chunk = rawData.properties.slice(i, i + BATCH);
    const placeholders = chunk.map(() => '(?,?,?,?,?,?,?,?,?,?,?,?,?,?)').join(',');
    const values = chunk.flatMap(p => [p.address, p.city, p.zip, p.price, p.propertyType, p.beds, p.baths, p.sqft, p.lotSize, p.yearBuilt, p.dom, p.soldDate, p.url, p.status || 'Sold']);
    db.run(`INSERT INTO properties VALUES ${placeholders}`, values);
  }
  console.log('Batch insert took', Math.round(performance.now() - t1), 'ms');
  
  const cities = [...new Set(rawData.properties.map(p => p.city))].sort();
  const sel = document.getElementById('filterCity');
  cities.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
  buildQuery();
  
  // Update hero stats from data
  const s = rawData.summary;
  document.getElementById('statTotal').textContent = (s.total / 1000).toFixed(0) + 'K+';
  document.getElementById('statActive').textContent = s.activeCount.toLocaleString();
  document.getElementById('statSold').textContent = (s.soldCount / 1000).toFixed(0) + 'K+';
  document.getElementById('statMedian').textContent = '$' + Math.round(s.medianPrice / 1000) + 'K';
  document.getElementById('statTowns').textContent = s.citiesCovered;
  document.getElementById('heroSubtitle').textContent = (s.total / 1000).toFixed(0) + ',000+ Properties ‚Ä¢ ' + s.citiesCovered + ' Towns ‚Ä¢ Updated Daily';
  
  // Initialize everything now that data is loaded
  console.log('Data loaded, initializing...', rawData.properties.length, 'properties');
  if (typeof initCharts === 'function') initCharts();
  if (typeof initHouseHunter === 'function') {
    console.log('Calling initHouseHunter...');
    initHouseHunter();
  }
  if (typeof initLandDealFinder === 'function') {
    console.log('Calling initLandDealFinder...');
    initLandDealFinder();
  }
  if (typeof initCityHeatmap === 'function') initCityHeatmap();
  
  // Update Key Market Insights
  updateInsights();
  
  const statusEl = document.getElementById('dbStatus');
  if (statusEl) {
    statusEl.textContent = 'Database ready (' + rawData.properties.length.toLocaleString() + ' properties)';
    statusEl.style.color = '#10b981';
  }
  console.log('SQL database initialized with ' + rawData.properties.length + ' properties');
}).catch(err => {
  console.error('Initialization failed:', err);
  const statusEl = document.getElementById('dbStatus');
  if (statusEl) {
    statusEl.textContent = 'Database failed to load: ' + err.message;
    statusEl.style.color = '#00E1E6';
  }
});

function updateInsights() {
  if (!rawData || !rawData.properties || !window.cityStats) return;
  
  // Price formatter - use M for millions
  const fmtPrice = (v) => { const abs = Math.abs(v), s = v < 0 ? '-' : ''; return abs >= 1000000 ? '$' + s + (abs/1000000).toFixed(1) + 'M' : '$' + s + Math.round(abs/1000) + 'K'; };
  
  // Coastal cities to exclude for "inland" top 5
  const coastalCities = ['Newport', 'Narragansett', 'Westerly', 'Jamestown', 'Block Island', 'New Shoreham', 
    'Little Compton', 'Middletown', 'Portsmouth', 'Tiverton', 'Bristol', 'Warren', 'Barrington', 'Charlestown'];
  
  // Top 5 NON-COASTAL cities by median price (using precomputed stats)
  const topCities = Object.entries(window.cityStats)
    .filter(([c, stats]) => stats.count >= 10 && !coastalCities.includes(c))
    .map(([city, stats]) => ({ city, median: stats.medianPrice }))
    .sort((a,b) => b.median - a.median)
    .slice(0, 5);
  
  const topCitiesEl = document.getElementById('insightTopCities');
  if (topCitiesEl && topCities.length > 0) {
    topCitiesEl.innerHTML = topCities.map(c => 
      `<div style="display:flex;justify-content:space-between"><span>${c.city}</span><span style="color:#10b981;font-weight:600">${fmtPrice(c.median)}</span></div>`
    ).join('');
  }
  
  // Fastest to sell - using precomputed avgDom
  const fastestCities = Object.entries(window.cityStats)
    .filter(([c, stats]) => stats.doms.length >= 5)
    .map(([city, stats]) => ({ city, avgDom: stats.avgDom }))
    .sort((a,b) => a.avgDom - b.avgDom)
    .slice(0, 5);
  
  const fastestEl = document.getElementById('insightFastestSell');
  if (fastestEl && fastestCities.length > 0) {
    fastestEl.innerHTML = fastestCities.map(c => 
      `<div style="display:flex;justify-content:space-between"><span>${c.city}</span><span style="color:#10b981;font-weight:600">${c.avgDom} days</span></div>`
    ).join('');
  } else if (fastestEl) {
    fastestEl.innerHTML = '<div style="color:#94a3b8">No DOM data available</div>';
  }
  
  // YoY Appreciation
  const currentYear = new Date().getFullYear();
  const lastYear = currentYear - 1;
  const thisYearPrices = [];
  const lastYearPrices = [];
  
  rawData.properties.filter(p => p.soldDate && p.price > 50000).forEach(p => {
    const year = parseInt(p.soldDate.split('-').pop());
    if (year === currentYear || year === currentYear - 1) thisYearPrices.push(p.price);
    if (year === lastYear || year === lastYear - 1) lastYearPrices.push(p.price);
  });
  
  const yoyEl = document.getElementById('insightYoY');
  const yoyDescEl = document.getElementById('insightYoYDesc');
  
  if (thisYearPrices.length >= 10 && lastYearPrices.length >= 10) {
    const thisMedian = thisYearPrices.sort((a,b)=>a-b)[Math.floor(thisYearPrices.length/2)];
    const lastMedian = lastYearPrices.sort((a,b)=>a-b)[Math.floor(lastYearPrices.length/2)];
    const change = ((thisMedian - lastMedian) / lastMedian * 100).toFixed(1);
    const sign = change >= 0 ? '+' : '';
    
    if (yoyEl) yoyEl.textContent = `${sign}${change}% YoY`;
    if (yoyDescEl) yoyDescEl.textContent = `${currentYear} median ${fmtPrice(thisMedian)} vs ${lastYear} ${fmtPrice(lastMedian)}`;
  } else {
    if (yoyEl) yoyEl.textContent = 'N/A';
    if (yoyDescEl) yoyDescEl.textContent = 'Insufficient data for comparison';
  }
  
  // Update hover chart data dynamically
  updateInsightChartData(topCities, fastestCities);
  
  // Initialize hover functionality
  if (typeof initInsightHover === 'function') initInsightHover();
}

 function buildQuery() {
 const city = document.getElementById('filterCity').value;
 const type = document.getElementById('filterType').value;
 const status = document.getElementById('filterStatus').value;
 const minP = document.getElementById('filterMinPrice').value;
 const maxP = document.getElementById('filterMaxPrice').value;
 const beds = document.getElementById('filterBeds').value;
 const year = document.getElementById('filterYear').value;
 const sort = document.getElementById('filterSort').value;
 const limit = document.getElementById('filterLimit').value;
 let w = [];
 if (city) w.push(`city = '${city}'`);
 if (type) w.push(`propertyType LIKE '%${type}%'`);
 if (status) w.push(`status = '${status}'`);
 if (minP) w.push(`price >= ${minP}`);
 if (maxP) w.push(`price <= ${maxP}`);
 if (beds) w.push(`beds >= ${beds}`);
 if (year) w.push(`soldDate LIKE '%${year}'`);
 let sql = `SELECT address, city, printf("$%,d", price) as price, beds, baths, sqft, status, dom as days, url\nFROM properties`;
 if (w.length) sql += `\nWHERE ${w.join(' AND ')}`;
 sql += `\nORDER BY ${sort}\nLIMIT ${limit}`;
 document.getElementById('sqlInput').value = sql;
 }
 
 function setQuery(p) {
 const q = {
 top: `SELECT address, city, printf("$%,d", price) as price, beds, baths, sqft, status, url FROM properties ORDER BY price DESC LIMIT 20`,
 forSale: `SELECT address, city, printf("$%,d", price) as price, beds, baths, sqft, dom as days, url FROM properties WHERE status = 'For Sale' ORDER BY price DESC LIMIT 50`,
 land: `SELECT address, city, printf("$%,d", price) as price, printf("%,d", lotSize) as lot_sqft, printf("$%.2f", price*1.0/lotSize) as price_per_sqft, status, url FROM properties WHERE propertyType LIKE '%Land%' AND lotSize > 0 ORDER BY price DESC LIMIT 25`,
 under300: `SELECT address, city, printf("$%,d", price) as price, beds, baths, sqft, status, url FROM properties WHERE price < 300000 ORDER BY price DESC LIMIT 30`,
 newport: `SELECT address, printf("$%,d", price) as price, beds, baths, sqft, yearBuilt, status, dom as days, url FROM properties WHERE city = 'Newport' ORDER BY price DESC LIMIT 25`,
 ppsqft: `SELECT city, COUNT(*) as count, printf("$%.0f", AVG(price*1.0/sqft)) as avg_price_sqft, printf("$%,d", AVG(price)) as avg_price FROM properties WHERE sqft > 0 GROUP BY city ORDER BY AVG(price*1.0/sqft) DESC LIMIT 20`,
 fastSales: `SELECT address, city, printf("$%,d", price) as price, dom as days_on_market, beds, baths, url FROM properties WHERE dom > 0 AND dom < 10 ORDER BY dom ASC LIMIT 25`,
 newConstruction: `SELECT address, city, printf("$%,d", price) as price, yearBuilt, beds, baths, sqft, status, url FROM properties WHERE yearBuilt >= 2020 ORDER BY yearBuilt DESC, price DESC LIMIT 25`
 };
 document.getElementById('sqlInput').value = q[p];
 runQuery();
 }
 
 function resetFilters() {
 ['filterCity','filterType','filterStatus','filterBeds','filterYear'].forEach(id => document.getElementById(id).value = '');
 ['filterMinPrice','filterMaxPrice'].forEach(id => document.getElementById(id).value = '');
 document.getElementById('filterSort').value = 'price DESC';
 document.getElementById('filterLimit').value = '25';
 buildQuery();
 }
 
 function runQuery() {
 if (!db) { 
 document.getElementById('results').innerHTML = '<p style="color:#f59e0b">‚è≥ Database loading... please wait a moment and try again</p>'; 
 return; 
 }
 const sql = document.getElementById('sqlInput').value;
 try {
 const res = db.exec(sql);
 if (!res.length) { document.getElementById('results').innerHTML = '<p style="color:#94a3b8">No results</p>'; lastResults = []; return; }
 const { columns, values } = res[0];
 lastResults = values.map(r => { const o = {}; columns.forEach((c,i) => o[c] = r[i]); return o; });
 let html = `<p class="result-count">‚úì ${values.length} results</p><table><thead><tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>`;
 values.forEach(row => { html += '<tr>' + row.map((v,i) => columns[i]==='url' && v?.startsWith('http') ? `<td><a href="${v}" target="_blank">View‚Üí</a></td>` : `<td>${v??''}</td>`).join('') + '</tr>'; });
 document.getElementById('results').innerHTML = html + '</tbody></table>';
 } catch(e) { document.getElementById('results').innerHTML = `<p style="color:#00E1E6">Error: ${e.message}</p>`; }
 }
 
 function exportCSV() {
 if (!lastResults.length) return alert('Run query first');
 const h = Object.keys(lastResults[0]);
 let csv = h.join(',') + '\n';
 lastResults.forEach(r => { csv += h.map(k => `"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(',') + '\n'; });
 const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'ri-real-estate.csv'; a.click();
 }
 
 function exportHTML() {
 if (!lastResults.length) return alert('Run query first');
 const h = Object.keys(lastResults[0]);
 const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>RI Real Estate Export</title>
<style>body{font-family:system-ui;background:#1a1a2e;color:#eee;padding:2rem}table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:8px;text-align:left}th{background:#6366f1}tr:hover{background:rgba(255,255,255,0.05)}a{color:#10b981}</style>
</head><body><h1>Rhode Island Real Estate - ${lastResults.length} Results</h1><p>Exported: ${new Date().toLocaleString()}</p>
<table><thead><tr>${h.map(c => '<th>'+c+'</th>').join('')}</tr></thead><tbody>
${lastResults.map(r => '<tr>' + h.map(k => {
 const v = r[k] || '';
 return k === 'url' && String(v).startsWith('http') ? '<td><a href="'+v+'" target="_blank">View</a></td>' : '<td>'+v+'</td>';
}).join('') + '</tr>').join('\n')}
</tbody></table></body></html>`;
 const a = document.createElement('a'); 
 a.href = URL.createObjectURL(new Blob([html], {type:'text/html'})); 
 a.download = 'ri-real-estate-export.html'; 
 a.click();
 }
 
 // ============ ADDRESS-BASED COMP REPORT ============
 let compResults = [];
 let subjectProperty = null;
 let compPage = 1;
 const compPageSize = 15;
 
 function median(arr) {
 if (!arr.length) return 0;
 const sorted = [...arr].sort((a,b) => a - b);
 const mid = Math.floor(sorted.length / 2);
 return sorted.length % 2 ? sorted[mid] : (sorted[mid-1] + sorted[mid]) / 2;
 }
 
 function fmt(n) { return '$' + Math.round(n).toLocaleString(); }
 
 // Address search with autocomplete
 function searchAddress(query) {
 const resultsDiv = document.getElementById('addressResults');
 if (query.length < 3) { resultsDiv.style.display = 'none'; return; }
 
 const q = query.toLowerCase();
 const matches = rawData.properties.filter(p => 
 p.address.toLowerCase().includes(q) || 
 (p.city + ' ' + p.address).toLowerCase().includes(q)
 ).slice(0, 10);
 
 if (!matches.length) {
 resultsDiv.innerHTML = '<div style="padding:1rem;color:#94a3b8">No exact match in database ‚Äî click <strong style="color:#10b981">Find Comps</strong> to look up any address</div>';
 } else {
 resultsDiv.innerHTML = matches.map(p => `
 <div onclick="selectProperty('${p.address.replace(/'/g, "\\'")}', '${p.city}')" 
 style="padding:0.75rem 1rem;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.2s"
 onmouseover="this.style.background='rgba(99,102,241,0.2)'" 
 onmouseout="this.style.background='transparent'">
 <div style="color:#e2e8f0">${p.address}</div>
 <div style="color:#94a3b8;font-size:0.85rem">${p.city} ‚Ä¢ ${p.beds || '?'}bd/${p.baths || '?'}ba ‚Ä¢ ${p.sqft ? p.sqft.toLocaleString() + ' sqft' : ''} ‚Ä¢ ${fmt(p.price)}</div>
 </div>
 `).join('');
 }
 resultsDiv.style.display = 'block';
 }
 
 // Select a property and run comp analysis
 function selectProperty(address, city) {
 document.getElementById('addressResults').style.display = 'none';
 document.getElementById('addressSearch').value = address + ', ' + city;
 
 // Find the subject property
 subjectProperty = rawData.properties.find(p => p.address === address && p.city === city);
 if (!subjectProperty) return;
 
 // Show subject property details
 const details = document.getElementById('subjectDetails');
 details.innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${subjectProperty.address}, ${subjectProperty.city}</div>
 <div><strong style="color:#94a3b8">Type:</strong><br>${subjectProperty.propertyType || 'N/A'}</div>
 <div><strong style="color:#94a3b8">Beds/Baths:</strong><br>${subjectProperty.beds || '?'} bd / ${subjectProperty.baths || '?'} ba</div>
 <div><strong style="color:#94a3b8">Sq Ft:</strong><br>${subjectProperty.sqft ? subjectProperty.sqft.toLocaleString() : 'N/A'}</div>
 <div><strong style="color:#94a3b8">Year Built:</strong><br>${subjectProperty.yearBuilt || 'N/A'}</div>
 <div><strong style="color:#94a3b8">List/Sale Price:</strong><br><span style="color:#10b981;font-size:1.2rem">${fmt(subjectProperty.price)}</span></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 
 // Find comparable properties (sold in last 2 years, same city, similar beds/sqft)
 findComps();
 }
 
 // Geocode an address using Nominatim (free OpenStreetMap API)
 async function geocodeAndFindComps(address, city, statusEl) {
 try {
 const query = encodeURIComponent(address + ', ' + city + ', Rhode Island, USA');
 const url = 'https://nominatim.openstreetmap.org/search?q=' + query + '&format=json&limit=1&countrycodes=us';
 
 const response = await fetch(url, {
 headers: { 'User-Agent': 'AIBridges-RI-Report/1.0' }
 });
 
 if (!response.ok) throw new Error('Geocoding failed');
 
 const data = await response.json();
 
 if (data && data.length > 0) {
 const lat = parseFloat(data[0].lat);
 const lng = parseFloat(data[0].lon);
 
 // Create subject property with coordinates
 subjectProperty = {
 address: address,
 city: city,
 propertyType: 'Single Family',
 beds: null,
 baths: null,
 sqft: null,
 yearBuilt: null,
 price: null,
 url: null,
 lat: lat,
 lng: lng,
 isManual: false,
 isGeocoded: true
 };
 
 // Find nearby properties
 const nearby = rawData.properties.filter(p => {
 if (!p.lat || !p.lng) return false;
 const dist = getDistance(lat, lng, p.lat, p.lng);
 return dist <= 0.75; // 0.75 mile radius
 });
 
 const nearbySold = nearby.filter(p => p.saleType === 'PAST SALE' || p.status === 'Sold' || p.soldDate);
 const avgPpsf = nearbySold.filter(p => p.sqft > 0).length ?
 Math.round(nearbySold.filter(p => p.sqft > 0).reduce((a,p) => a + (p.price / p.sqft), 0) / nearbySold.filter(p => p.sqft > 0).length) : 0;
 
 document.getElementById('subjectDetails').innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${address}, ${city}</div>
 <div><strong style="color:#94a3b8">Location:</strong><br><span style="color:#10b981">Geocoded</span></div>
 <div><strong style="color:#94a3b8">Nearby Sales:</strong><br><strong>${nearbySold.length}</strong> within 0.75 mi</div>
 <div><strong style="color:#94a3b8">Avg $/SqFt:</strong><br><strong style="color:#f59e0b">${avgPpsf ? '$' + avgPpsf : 'N/A'}</strong></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 
 statusEl.innerHTML = 'Location found! <strong>' + nearbySold.length + '</strong> nearby sales for comps';
 statusEl.style.color = '#10b981';
 
 findComps();
 } else {
 // Geocoding returned no results - fall back to city
 statusEl.textContent = 'Address not found - using ' + city + ' city-wide comps';
 statusEl.style.color = '#f59e0b';
 
 subjectProperty = {
 address: address,
 city: city,
 propertyType: 'Single Family',
 beds: null,
 baths: null,
 sqft: null,
 yearBuilt: null,
 price: null,
 url: null,
 isManual: true
 };
 
 document.getElementById('subjectDetails').innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${address}, ${city}</div>
 <div><strong style="color:#94a3b8">Note:</strong><br><span style="color:#f59e0b">Using city-wide comps (address not geocoded)</span></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 
 findComps();
 }
 } catch (err) {
 console.error('Geocoding error:', err);
 statusEl.textContent = 'Geocoding unavailable - using ' + city + ' city comps';
 statusEl.style.color = '#f59e0b';
 
 // Fall back to city-based comps
 subjectProperty = {
 address: address,
 city: city,
 propertyType: 'Single Family',
 beds: null,
 baths: null,
 sqft: null,
 yearBuilt: null,
 price: null,
 url: null,
 isManual: true
 };
 
 document.getElementById('subjectDetails').innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${address}, ${city}</div>
 <div><strong style="color:#94a3b8">Note:</strong><br><span style="color:#f59e0b">Using city-wide comps</span></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 
 findComps();
 }
 }
 
 function findComps() {
 if (!subjectProperty) return;
 
 const s = subjectProperty;
 const bedRange = 1; // +/- 1 bedroom
 const sqftRange = 0.30; // +/- 30% sqft (more flexible)
 const minSqft = s.sqft ? s.sqft * (1 - sqftRange) : 0;
 const maxSqft = s.sqft ? s.sqft * (1 + sqftRange) : Infinity;
 
 // Normalize city name for matching
 const normalizeCity = c => (c || '').toLowerCase().replace(/[^a-z]/g, '');
 const subjectCity = normalizeCity(s.city);
 
 // If subject has lat/lng (geocoded), use proximity-based comps
 if (s.lat && s.lng) {
 compResults = rawData.properties.filter(p => {
 if (!p.lat || !p.lng) return false;
 if (p.address === s.address) return false;
 
 // Only sold properties
 const isSold = p.saleType === 'PAST SALE' || p.status === 'Sold' || p.soldDate;
 if (!isSold) return false;
 
 // Within 0.75 miles
 const dist = getDistance(s.lat, s.lng, p.lat, p.lng);
 if (dist > 0.75) return false;
 
 return true;
 }).map(p => ({
 ...p,
 distance: getDistance(s.lat, s.lng, p.lat, p.lng)
 })).sort((a, b) => a.distance - b.distance).slice(0, 30);
 
 // Show proximity mode indicator
 const status = document.getElementById('lookupStatus');
 if (status && compResults.length > 0) {
 status.innerHTML = 'Found <strong>' + compResults.length + '</strong> nearby sales (within 0.75 mi)';
 status.style.color = '#10b981';
 }
 } else {
 // Original city-based matching
 // Find comps: same city/area, similar size, sold properties only
 compResults = rawData.properties.filter(p => {
 if (p.address === s.address && normalizeCity(p.city) === subjectCity) return false; // Exclude subject
 
 // Only sold properties (check multiple ways)
 const isSold = p.saleType === 'PAST SALE' || p.status === 'Sold' || p.soldDate;
 if (!isSold) return false;
 
 // Same city (normalized comparison)
 if (normalizeCity(p.city) !== subjectCity) return false;
 
 // Similar beds (+/- 1) - only if subject has beds specified
 if (s.beds && p.beds && Math.abs(p.beds - s.beds) > bedRange) return false;
 
 // Similar sqft (+/- 30%) - only if subject has sqft specified
 if (s.sqft && p.sqft && (p.sqft < minSqft || p.sqft > maxSqft)) return false;
 
 // Similar property type (if available)
 if (s.propertyType && p.propertyType) {
 const sType = (s.propertyType || '').split(' ')[0].toLowerCase();
 const pType = (p.propertyType || '').split(' ')[0].toLowerCase();
 if (sType && pType && sType !== pType) return false;
 }
 
 return true;
 }).sort((a, b) => {
 // Sort by similarity score
 let aScore = 0, bScore = 0;
 
 // Closer sqft = better
 if (s.sqft) {
 aScore += Math.abs((a.sqft || 0) - s.sqft) / s.sqft;
 bScore += Math.abs((b.sqft || 0) - s.sqft) / s.sqft;
 }
 
 // Same beds = better
 if (s.beds) {
 aScore += Math.abs((a.beds || 0) - s.beds) * 0.1;
 bScore += Math.abs((b.beds || 0) - s.beds) * 0.1;
 }
 
 return aScore - bScore;
 }).slice(0, 30); // Top 30 comps
 }
 
 // Calculate stats
 const prices = compResults.map(p => p.price);
 const psfs = compResults.filter(p => p.sqft > 0).map(p => p.price / p.sqft);
 const avgPsf = psfs.length ? psfs.reduce((a,b)=>a+b,0)/psfs.length : 0;
 
 // Estimate value based on comps' $/sqft if subject has sqft
 let estimate = 0;
 if (s.sqft && avgPsf > 0) {
 estimate = s.sqft * avgPsf;
 } else if (prices.length) {
 estimate = median(prices);
 }
 
 document.getElementById('compCount').textContent = compResults.length;
 document.getElementById('compMedian').textContent = prices.length ? fmt(median(prices)) : '$0';
 document.getElementById('compAvg').textContent = prices.length ? fmt(prices.reduce((a,b)=>a+b,0)/prices.length) : '$0';
 document.getElementById('compPsf').textContent = avgPsf ? '$' + Math.round(avgPsf) : '$0';
 document.getElementById('compEstimate').textContent = estimate ? fmt(estimate) : 'N/A';
 
 document.getElementById('compReport').style.display = 'block';
 document.getElementById('compFsboCta').style.display = 'block';
 compPage = 1;
 renderCompTable();
 }
 
 function renderCompTable() {
 const start = (compPage - 1) * compPageSize;
 const end = start + compPageSize;
 const pageData = compResults.slice(start, end);
 const totalPages = Math.ceil(compResults.length / compPageSize);
 
 let html = `<table style="width:100%;border-collapse:collapse;font-size:0.8rem">
 <thead><tr style="background:rgba(99,102,241,0.3)">
 <th style="padding:0.6rem">Address</th><th>Beds</th><th>Baths</th><th>SqFt</th><th>Year</th><th>Sold Price</th><th>$/SqFt</th><th>Sold Date</th></tr></thead><tbody>`;
 
 pageData.forEach(p => {
 const psf = p.sqft ? '$' + Math.round(p.price / p.sqft) : '-';
 html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
 <td style="padding:0.5rem"><a href="${p.url}" target="_blank" style="color:#10b981">${p.address}</a></td>
 <td>${p.beds || '-'}</td>
 <td>${p.baths || '-'}</td>
 <td>${p.sqft ? p.sqft.toLocaleString() : '-'}</td>
 <td>${p.yearBuilt || '-'}</td>
 <td><strong>${fmt(p.price)}</strong></td>
 <td>${psf}</td>
 <td>${p.soldDate || '-'}</td>
 </tr>`;
 });
 
 html += '</tbody></table>';
 
 if (totalPages > 1) {
 html += `<div style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center;justify-content:center">
 <button class="btn-secondary" onclick="compGoPage(1)" ${compPage===1?'disabled':''}>¬´</button>
 <button class="btn-secondary" onclick="compGoPage(${compPage-1})" ${compPage===1?'disabled':''}>‚Äπ</button>
 <span style="color:#94a3b8">Page ${compPage} of ${totalPages}</span>
 <button class="btn-secondary" onclick="compGoPage(${compPage+1})" ${compPage===totalPages?'disabled':''}>‚Ä∫</button>
 <button class="btn-secondary" onclick="compGoPage(${totalPages})" ${compPage===totalPages?'disabled':''}>¬ª</button>
 </div>`;
 }
 
 document.getElementById('compResults').innerHTML = html;
 }
 
 function compGoPage(n) { compPage = n; renderCompTable(); }
 
 function clearComp() {
 document.getElementById('addressSearch').value = '';
 document.getElementById('subjectProperty').style.display = 'none';
 document.getElementById('compReport').style.display = 'none';
 document.getElementById('compFsboCta').style.display = 'none';
 compResults = [];
 subjectProperty = null;
 }
 
 function exportCompCSV() {
 if (!compResults.length) return alert('Search for an address first');
 let csv = 'Address,City,Beds,Baths,SqFt,Year,Price,$/SqFt,Sold Date,URL\n';
 compResults.forEach(p => {
 const psf = p.sqft ? Math.round(p.price / p.sqft) : '';
 csv += `"${p.address}","${p.city}",${p.beds||''},${p.baths||''},${p.sqft||''},${p.yearBuilt||''},${p.price},${psf},"${p.soldDate||''}","${p.url}"\n`;
 });
 const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); 
 a.download = 'comp-report-' + (subjectProperty?.address || 'export').replace(/[^a-z0-9]/gi, '-') + '.csv'; 
 a.click();
 }
 
 function exportCompHTML() {
 if (!compResults.length || !subjectProperty) return alert('Search for an address first');
 const s = subjectProperty;
 const prices = compResults.map(p => p.price);
 const psfs = compResults.filter(p => p.sqft > 0).map(p => p.price / p.sqft);
 const avgPsf = psfs.length ? psfs.reduce((a,b)=>a+b,0)/psfs.length : 0;
 const estimate = s.sqft && avgPsf ? s.sqft * avgPsf : median(prices);
 
 const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Comp Report - ${s.address}</title>
<style>body{font-family:system-ui;background:#1a1a2e;color:#eee;padding:2rem;max-width:1200px;margin:0 auto}
table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:10px;text-align:left}
th{background:#6366f1}tr:hover{background:rgba(255,255,255,0.05)}a{color:#10b981}
.subject{background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(16,185,129,0.2));padding:1.5rem;border-radius:12px;margin-bottom:2rem;border:2px solid rgba(99,102,241,0.5)}
.stats{display:flex;gap:1rem;flex-wrap:wrap;margin:1.5rem 0}
.stat{background:#2a2a4a;padding:1rem 1.5rem;border-radius:8px;text-align:center;min-width:120px}
.stat-val{font-size:1.5rem;font-weight:bold;color:#6366f1}
.stat-lbl{font-size:0.8rem;color:#888}
.estimate{background:rgba(99,102,241,0.15);border-color:rgba(16,185,129,0.5)}
.estimate .stat-val{color:#10b981}</style>
</head><body>
<h1>Comparable Sales Report</h1>
<p style="color:#888">Generated: ${new Date().toLocaleString()}</p>

<div class="subject">
<h2>Subject Property</h2>
<p><strong>${s.address}, ${s.city}</strong></p>
<p>${s.beds || '?'} bed / ${s.baths || '?'} bath ‚Ä¢ ${s.sqft ? s.sqft.toLocaleString() + ' sqft' : 'N/A'} ‚Ä¢ Built ${s.yearBuilt || 'N/A'}</p>
<p>List/Sale Price: <strong style="color:#10b981;font-size:1.3rem">${fmt(s.price)}</strong></p>
</div>

<h2>Market Analysis (${compResults.length} Comparable Sales)</h2>
<div class="stats">
<div class="stat"><div class="stat-val">${compResults.length}</div><div class="stat-lbl">Comps</div></div>
<div class="stat"><div class="stat-val">${fmt(median(prices))}</div><div class="stat-lbl">Median</div></div>
<div class="stat"><div class="stat-val">${fmt(prices.reduce((a,b)=>a+b,0)/prices.length)}</div><div class="stat-lbl">Average</div></div>
<div class="stat"><div class="stat-val">$${Math.round(avgPsf)}</div><div class="stat-lbl">Avg $/SqFt</div></div>
<div class="stat estimate"><div class="stat-val">${fmt(estimate)}</div><div class="stat-lbl">Est. Value</div></div>
</div>

<h3>Comparable Properties</h3>
<table>
<thead><tr><th>Address</th><th>Beds</th><th>Baths</th><th>SqFt</th><th>Year</th><th>Sold Price</th><th>$/SqFt</th><th>Sold Date</th></tr></thead>
<tbody>
${compResults.map(p => `<tr><td><a href="${p.url}" target="_blank">${p.address}</a></td><td>${p.beds||'-'}</td><td>${p.baths||'-'}</td><td>${p.sqft?p.sqft.toLocaleString():'-'}</td><td>${p.yearBuilt||'-'}</td><td><strong>${fmt(p.price)}</strong></td><td>${p.sqft?'$'+Math.round(p.price/p.sqft):'-'}</td><td>${p.soldDate||'-'}</td></tr>`).join('')}
</tbody></table>
<p style="margin-top:2rem;color:#666;font-size:0.9rem">Data source: Redfin MLS ‚Ä¢ Analysis by AIBridges.org</p>
</body></html>`;
 const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], {type:'text/html'})); 
 a.download = 'comp-report-' + s.address.replace(/[^a-z0-9]/gi, '-') + '.html'; 
 a.click();
 }
 
 // Close dropdown when clicking outside
 document.addEventListener('click', e => {
 if (!e.target.closest('#addressSearch') && !e.target.closest('#addressResults')) {
 document.getElementById('addressResults').style.display = 'none';
 }
 });
 
 // Toggle manual entry form
 function toggleManualEntry() {
 const form = document.getElementById('manualEntryForm');
 form.style.display = form.style.display === 'none' ? 'block' : 'none';
 }
 
 // Auto-lookup property details from Redfin
 async function autoLookupProperty() {
 const addressInput = document.getElementById('addressSearch').value.trim();
 if (!addressInput) {
 alert('Enter an address first (e.g., "77 Westfield Dr, Cranston")');
 return;
 }
 
 const status = document.getElementById('lookupStatus');
 status.textContent = 'üîÑ Looking up property...';
 status.style.color = '#f59e0b';
 
 try {
 // Parse address and city from input
 const parts = addressInput.split(',').map(s => s.trim());
 const address = parts[0];
 let city = (parts[1] || '').replace(/\s*(RI|Rhode Island)\s*/gi, '').trim();
 
 // If no city provided, try to detect from known RI cities
 if (!city) {
 const riCities = [...new Set(rawData.properties.map(p => p.city))];
 const addrLower = addressInput.toLowerCase();
 city = riCities.find(c => addrLower.includes(c.toLowerCase())) || 'Providence';
 }
 
 // First, try local database lookup
 const localMatch = rawData.properties.find(p => {
 const pAddr = p.address.toLowerCase().replace(/[^a-z0-9]/g, '');
 const searchAddr = address.toLowerCase().replace(/[^a-z0-9]/g, '');
 return pAddr.includes(searchAddr) || searchAddr.includes(pAddr);
 });
 
 if (localMatch) {
 // Found in local database!
 subjectProperty = { ...localMatch, isManual: false };
 
 const details = document.getElementById('subjectDetails');
 details.innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${localMatch.address}, ${localMatch.city}</div>
 <div><strong style="color:#94a3b8">Type:</strong><br>${localMatch.propertyType || 'N/A'}</div>
 <div><strong style="color:#94a3b8">Beds/Baths:</strong><br>${localMatch.beds || '?'} bd / ${localMatch.baths || '?'} ba</div>
 <div><strong style="color:#94a3b8">Sq Ft:</strong><br>${localMatch.sqft ? localMatch.sqft.toLocaleString() : 'N/A'}</div>
 <div><strong style="color:#94a3b8">Year Built:</strong><br>${localMatch.yearBuilt || 'N/A'}</div>
 <div><strong style="color:#94a3b8">Source:</strong><br><span style="color:#10b981">Local Database</span></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 
 status.textContent = 'Found ‚Äî ' + (localMatch.beds || '?') + 'bd/' + (localMatch.baths || '?') + 'ba, ' + (localMatch.sqft ? localMatch.sqft.toLocaleString() + ' sqft' : 'sqft N/A');
 status.style.color = '#10b981';
 
 findComps();
 return;
 }
 
 // Try to fetch from Redfin via CORS proxy
 const query = encodeURIComponent(address + ' ' + city + ' RI');
 const proxies = [
 'https://api.allorigins.win/raw?url=',
 'https://corsproxy.io/?'
 ];
 const redfinUrl = 'https://www.redfin.com/stingray/do/location-autocomplete?v=2&al=1&location=' + query;
 
 let text = null;
 for (const proxyUrl of proxies) {
 try {
 const response = await fetch(proxyUrl + encodeURIComponent(redfinUrl), { timeout: 5000 });
 if (response.ok) {
 text = await response.text();
 break;
 }
 } catch (e) { continue; }
 }
 
 if (!text) {
 // Couldn't reach any proxy - fall back to city-only comps
 throw new Error('FALLBACK_CITY');
 }
 
 // Check if we got HTML instead of JSON (proxy error pages)
 if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html') || text.trim().startsWith('<')) {
 console.log('Received HTML instead of JSON from proxy');
 throw new Error('FALLBACK_CITY');
 }
 
 // Redfin returns {}&&{...} format, strip the prefix
 const jsonStr = text.replace(/^\{\}\&\&/, '');
 
 let data;
 try {
 data = JSON.parse(jsonStr);
 } catch (parseErr) {
 console.log('JSON parse failed:', parseErr.message);
 throw new Error('FALLBACK_CITY');
 }
 
 if (data.payload && data.payload.sections) {
 // Find the property in results
 let property = null;
 for (const section of data.payload.sections) {
 if (section.rows) {
 for (const row of section.rows) {
 if (row.type === 'A' || row.name?.toLowerCase().includes(address.toLowerCase().split(' ')[0])) {
 property = row;
 break;
 }
 }
 }
 if (property) break;
 }
 
 if (property) {
 // Extract property details
 const beds = property.beds || null;
 const baths = property.baths || null;
 const sqft = property.sqFt || property.sqft || null;
 const yearBuilt = property.yearBuilt || null;
 const ptype = property.propertyType || 'Single Family';
 const url = property.url ? 'https://www.redfin.com' + property.url : null;
 
 // Create subject property
 subjectProperty = {
 address: address,
 city: city,
 propertyType: ptype,
 beds: beds,
 baths: baths,
 sqft: sqft,
 yearBuilt: yearBuilt,
 price: property.price || null,
 url: url,
 isManual: false
 };
 
 // Show subject property details
 const details = document.getElementById('subjectDetails');
 details.innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${address}, ${city}</div>
 <div><strong style="color:#94a3b8">Type:</strong><br>${ptype}</div>
 <div><strong style="color:#94a3b8">Beds/Baths:</strong><br>${beds || '?'} bd / ${baths || '?'} ba</div>
 <div><strong style="color:#94a3b8">Sq Ft:</strong><br>${sqft ? sqft.toLocaleString() : 'N/A'}</div>
 <div><strong style="color:#94a3b8">Year Built:</strong><br>${yearBuilt || 'N/A'}</div>
 <div><strong style="color:#94a3b8">Source:</strong><br><span style="color:#10b981">Redfin</span></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 
 status.textContent = 'Found ‚Äî ' + (beds || '?') + 'bd/' + (baths || '?') + 'ba, ' + (sqft ? sqft.toLocaleString() + ' sqft' : 'sqft N/A');
 status.style.color = '#10b981';
 
 // Find comps
 findComps();
 return;
 }
 }
 
 // Fallback: property not found in Redfin - geocode and find nearby
 status.textContent = 'Finding nearby properties for neighborhood comps...';
 status.style.color = '#6366f1';
 
 await geocodeAndFindComps(address, city, status);
 
 } catch (err) {
 console.error('Lookup error:', err);
 
 // Handle fallback case - geocode and find nearby comps
 if (err.message === 'FALLBACK_CITY') {
 status.textContent = 'Finding nearby properties for neighborhood comps...';
 status.style.color = '#6366f1';
 
 await geocodeAndFindComps(address, city, status);
 return;
 }
 
 status.textContent = 'Lookup failed - ' + err.message;
 status.style.color = '#00E1E6';
 }
 }
 
 // Populate manual city dropdown
 function initManualCityDropdown() {
 const cities = [...new Set(rawData.properties.map(p => p.city))].sort();
 const sel = document.getElementById('manualCity');
 sel.innerHTML = '<option value="">Select City</option>';
 cities.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
 }
 document.addEventListener('DOMContentLoaded', initManualCityDropdown);
 
 // Run comp analysis with manual entry
 function runManualComp() {
 const address = document.getElementById('manualAddress').value.trim();
 const city = document.getElementById('manualCity').value;
 const ptype = document.getElementById('manualType').value;
 const beds = parseInt(document.getElementById('manualBeds').value) || null;
 const baths = parseFloat(document.getElementById('manualBaths').value) || null;
 const sqft = parseInt(document.getElementById('manualSqft').value) || null;
 const year = parseInt(document.getElementById('manualYear').value) || null;
 
 if (!address || !city) {
 alert('Please enter at least an address and city');
 return;
 }
 
 // Create a virtual subject property
 subjectProperty = {
 address: address,
 city: city,
 propertyType: ptype,
 beds: beds,
 baths: baths,
 sqft: sqft,
 yearBuilt: year,
 price: null, // Unknown
 url: null,
 isManual: true
 };
 
 // Show subject property details
 const details = document.getElementById('subjectDetails');
 details.innerHTML = `
 <div><strong style="color:#94a3b8">Address:</strong><br>${address}, ${city}</div>
 <div><strong style="color:#94a3b8">Type:</strong><br>${ptype}</div>
 <div><strong style="color:#94a3b8">Beds/Baths:</strong><br>${beds || '?'} bd / ${baths || '?'} ba</div>
 <div><strong style="color:#94a3b8">Sq Ft:</strong><br>${sqft ? sqft.toLocaleString() : 'N/A'}</div>
 <div><strong style="color:#94a3b8">Year Built:</strong><br>${year || 'N/A'}</div>
 <div><strong style="color:#94a3b8">Your Property:</strong><br><span style="color:#f59e0b">Manual Entry</span></div>
 `;
 document.getElementById('subjectProperty').style.display = 'block';
 document.getElementById('manualEntryForm').style.display = 'none';
 document.getElementById('addressSearch').value = address + ', ' + city;
 
 // Find comps
 findComps();
 }
 
 // LAND DEAL FINDER
 // Room-based build assumptions
 const ROOM_CONFIG = {
 2: { sqft: 1200, costPsf: 160, label: '2 BR base rate' },
 3: { sqft: 1600, costPsf: 175, label: '3 BR base rate' },
 4: { sqft: 2200, costPsf: 185, label: '4 BR (more plumbing)' },
 5: { sqft: 2800, costPsf: 195, label: '5 BR (complex HVAC)' },
 6: { sqft: 3500, costPsf: 210, label: '6 BR (estate build)' }
 };
 
 // Calculate lot buildability (max sqft based on zoning)
 function getLotBuildability(lotSizeSqft) {
 // RI zoning varies by area - use lot size as proxy for urban vs rural
 // Urban lots (<10K sqft): FAR ~0.75-1.0, 2-3 story typical
 // Suburban (10K-43K sqft): FAR ~0.35-0.5
 // Rural (>1 acre): FAR ~0.25, but larger lots
 let baseFAR, maxCoverage, maxStories;
 
 if (lotSizeSqft < 5000) {
 // Dense urban - small infill lots
 baseFAR = 1.0; // Can build 2-3 story
 maxCoverage = 0.60;
 maxStories = 3;
 } else if (lotSizeSqft < 10000) {
 // Urban residential
 baseFAR = 0.75;
 maxCoverage = 0.50;
 maxStories = 2;
 } else if (lotSizeSqft < 21780) { // < 0.5 acres
 // Suburban
 baseFAR = 0.50;
 maxCoverage = 0.40;
 maxStories = 2;
 } else if (lotSizeSqft < 43560) { // < 1 acre
 // Large suburban
 baseFAR = 0.35;
 maxCoverage = 0.35;
 maxStories = 2;
 } else {
 // Rural (1+ acres)
 baseFAR = 0.25;
 maxCoverage = 0.25;
 maxStories = 2;
 }
 
 const setbackReduction = 0.85; // ~15% lost to setbacks
 const maxBuildable = lotSizeSqft * baseFAR * setbackReduction;
 const maxFootprint = lotSizeSqft * maxCoverage * setbackReduction;
 
 // Estimate room capacity (assume 450 sqft per bedroom + common areas)
 const sqftPerBedroom = 450;
 const maxRooms = Math.floor(maxBuildable / sqftPerBedroom);
 
 return {
 maxBuildableSqft: Math.round(maxBuildable),
 maxFootprint: Math.round(maxFootprint),
 recommendedRooms: Math.min(Math.max(2, maxRooms), 8), // 2-8 BR range
 canBuildMultiple: lotSizeSqft >= 87120, // 2+ acres
 stories: Math.min(maxStories, Math.ceil(maxBuildable / maxFootprint))
 };
 }
 
 function updateBuildFromRooms() {
 const roomsSelect = document.getElementById('targetRooms');
 const sqftInput = document.getElementById('targetSqft');
 const costInput = document.getElementById('buildCostPsf');
 const rooms = roomsSelect?.value;
 
 if (rooms && rooms !== 'custom' && ROOM_CONFIG[rooms]) {
 const config = ROOM_CONFIG[rooms];
 sqftInput.value = config.sqft;
 costInput.value = config.costPsf;
 updateBuildEstimateDisplay();
 }
 }
 
 function updateBuildEstimateDisplay() {
 const sqft = parseInt(document.getElementById('targetSqft')?.value) || 1600;
 const costPsf = parseInt(document.getElementById('buildCostPsf')?.value) || 175;
 const softPct = parseInt(document.getElementById('softCosts')?.value) || 15;
 const rooms = document.getElementById('targetRooms')?.value || '3';
 
 const buildCost = sqft * costPsf;
 const totalWithSoft = buildCost * (1 + softPct / 100);
 
 const displayEl = document.getElementById('buildCostDisplay');
 const noteEl = document.getElementById('roomCostNote');
 
 if (displayEl) {
 displayEl.textContent = '$' + Math.round(totalWithSoft / 1000) + 'K';
 }
 if (noteEl) {
 noteEl.textContent = rooms !== 'custom' && ROOM_CONFIG[rooms] 
 ? ROOM_CONFIG[rooms].label 
 : 'Custom build';
 }
 }
 
 // Expose to global scope
 window.updateBuildFromRooms = updateBuildFromRooms;
 window.updateBuildEstimateDisplay = updateBuildEstimateDisplay;
 window.getLotBuildability = getLotBuildability;
 window.ROOM_CONFIG = ROOM_CONFIG;

 function initLandDealFinder() {
 console.log('initLandDealFinder starting...');
 if (!rawData || !rawData.properties) {
   console.log('initLandDealFinder: No data!');
   return;
 }
 // Initialize build estimate display
 updateBuildEstimateDisplay();
 // Populate city dropdown with cities that have land
 const allLand = rawData.properties.filter(p => p.propertyType && p.propertyType.toLowerCase().includes('land'));
 const forSaleLand = allLand.filter(p => p.status === 'For Sale');
 console.log('Total land properties:', allLand.length, 'For sale:', forSaleLand.length);
 
 const landCities = [...new Set(forSaleLand.map(p => p.city))].sort();
 const sel = document.getElementById('landCity');
 if (sel) {
 landCities.forEach(c => {
 const o = document.createElement('option');
 o.value = c;
 o.textContent = c;
 sel.appendChild(o);
 });
 }
 // Initial filter
 filterLandDeals();
 }
 
 function filterLandDeals() {
 console.log('filterLandDeals called');
 if (!rawData || !rawData.properties) {
   console.log('filterLandDeals: No data yet');
   return;
 }
 
 // Update build estimate display
 if (typeof updateBuildEstimateDisplay === 'function') updateBuildEstimateDisplay();
 
 const city = document.getElementById('landCity')?.value || '';
 console.log('Land filter - city:', city);
 const minDom = parseInt(document.getElementById('landMinDom')?.value) || 0;
 const maxPrice = parseInt(document.getElementById('landMaxPrice')?.value) || Infinity;
 const minAcres = parseFloat(document.getElementById('landMinAcres')?.value) || 0;
 const targetSqft = parseInt(document.getElementById('targetSqft')?.value) || 1600;
 const buildCostPsf = parseInt(document.getElementById('buildCostPsf')?.value) || 175;
 const softCostsPct = parseInt(document.getElementById('softCosts')?.value) || 15;
 const targetProfitPct = parseInt(document.getElementById('targetProfit')?.value) || 25;
 const targetRooms = parseInt(document.getElementById('targetRooms')?.value) || 3;
 
 // Filter land deals
 let lands = rawData.properties.filter(p => {
 if (!p.propertyType || !p.propertyType.toLowerCase().includes('land')) return false;
 if (p.status !== 'For Sale') return false;
 if (city && p.city !== city) return false;
 if (p.dom < minDom) return false;
 if (p.price > maxPrice) return false;
 const acres = (p.lotSize || 0) / 43560;
 if (acres < minAcres) return false;
 return true;
 });
 
 console.log('Land parcels found:', lands.length);
 
 // Get city comps (sold single family homes)
 const cityComps = {};
 rawData.properties.filter(p => 
 p.propertyType && 
 p.propertyType.toLowerCase().includes('single family') &&
 p.status !== 'For Sale' &&
 p.sqft > 0 &&
 p.price > 0
 ).forEach(p => {
 if (!cityComps[p.city]) cityComps[p.city] = [];
 cityComps[p.city].push({ 
 price: p.price, 
 sqft: p.sqft, 
 ppsf: p.price / p.sqft,
 address: p.address,
 url: p.url,
 beds: p.beds,
 baths: p.baths,
 yearBuilt: p.yearBuilt
 });
 });
 
 // Calculate deal metrics for each land parcel with lot buildability analysis
 lands = lands.map(land => {
 const lotSizeSqft = land.lotSize || 0;
 const acres = lotSizeSqft / 43560;
 const comps = cityComps[land.city] || [];
 
 // Get lot buildability (max sqft, recommended rooms)
 let buildability;
 try {
 buildability = window.getLotBuildability ? window.getLotBuildability(lotSizeSqft) : null;
 } catch(e) {
 console.error('getLotBuildability error:', e);
 buildability = null;
 }
 if (!buildability) {
 // Fallback: simple urban estimate
 const estFAR = lotSizeSqft < 10000 ? 0.75 : 0.35;
 buildability = { 
 maxBuildableSqft: Math.round(lotSizeSqft * estFAR * 0.85), 
 recommendedRooms: Math.max(2, Math.floor(lotSizeSqft * estFAR * 0.85 / 450)), 
 stories: 2, 
 canBuildMultiple: lotSizeSqft >= 87120 
 };
 }
 
 // Check if target build fits on this lot
 const canBuildTarget = buildability.maxBuildableSqft >= targetSqft;
 const actualBuildSqft = canBuildTarget ? targetSqft : buildability.maxBuildableSqft;
 
 // Adjust rooms based on what lot can actually support
 const maxRoomsForLot = buildability.recommendedRooms;
 const actualRooms = canBuildTarget ? targetRooms : Math.min(targetRooms, maxRoomsForLot);
 
 // Use MEDIAN $/sqft (new construction commands median+ prices in most markets)
 // New homes typically sell at 10-20% premium over median comps
 const sortedPpsf = comps.map(c => c.ppsf).sort((a,b) => a - b);
 const medianIndex = Math.floor(sortedPpsf.length * 0.5);
 const avgPpsf = comps.length > 0 
 ? sortedPpsf[medianIndex] * 1.05  // Median + 5% new construction premium
 : 300; // Default for areas without comps
 
 // Adjust build cost based on actual room count (complexity factor)
 const roomCostMultiplier = {
 2: 0.91, // simpler, cheaper
 3: 1.00, // baseline
 4: 1.06, // more complex
 5: 1.11, // even more
 6: 1.20  // estate complexity
 };
 const costMultiplier = roomCostMultiplier[Math.min(actualRooms, 6)] || 1.0;
 const adjustedBuildCostPsf = Math.round(buildCostPsf * costMultiplier);
 
 const estSalePrice = avgPpsf * actualBuildSqft;
 const buildCost = adjustedBuildCostPsf * actualBuildSqft;
 const totalCost = land.price + buildCost * (1 + softCostsPct/100);
 const profit = estSalePrice - totalCost;
 const profitPct = (profit / totalCost) * 100;
 const maxOffer = estSalePrice / (1 + targetProfitPct/100) - buildCost * (1 + softCostsPct/100);
 
 // Lot capacity label
 let lotCapacity;
 if (buildability.canBuildMultiple) {
 lotCapacity = 'üèòÔ∏è Multi-home';
 } else if (maxRoomsForLot >= 6) {
 lotCapacity = 'üè∞ 6+ BR';
 } else if (maxRoomsForLot >= 4) {
 lotCapacity = 'üè† 4-5 BR';
 } else if (maxRoomsForLot >= 3) {
 lotCapacity = 'üè° 3 BR';
 } else {
 lotCapacity = 'üèöÔ∏è Small';
 }
 
 return {
 ...land,
 acres: acres.toFixed(2),
 lotSizeSqft: lotSizeSqft,
 maxBuildableSqft: buildability.maxBuildableSqft,
 recommendedRooms: maxRoomsForLot,
 actualBuildSqft: actualBuildSqft,
 actualRooms: actualRooms,
 lotCapacity: lotCapacity,
 canBuildTarget: canBuildTarget,
 stories: buildability.stories,
 compsCount: comps.length,
 avgPpsf: Math.round(avgPpsf),
 adjustedCostPsf: adjustedBuildCostPsf,
 estSalePrice: Math.round(estSalePrice),
 buildCost: Math.round(buildCost),
 totalCost: Math.round(totalCost),
 profit: Math.round(profit),
 profitPct: profitPct.toFixed(1),
 maxOffer: Math.round(Math.max(0, maxOffer)),
 dealScore: profitPct > 30 ? 'üî• Hot' : profitPct > 20 ? 'üëç Good' : profitPct > 10 ? 'üìä Fair' : profitPct > 0 ? 'üìâ Low' : '‚ö†Ô∏è Loss'
 };
 });
 
 // Sort by profit potential
 lands.sort((a, b) => b.profit - a.profit);
 
 console.log('Land deals calculated:', lands.length, lands.length > 0 ? 'First deal profit: $' + lands[0]?.profit : '');
 
 // Update stats
 document.getElementById('landCount').textContent = lands.length;
 document.getElementById('landAvgDom').textContent = lands.length > 0 
 ? Math.round(lands.reduce((s, l) => s + l.dom, 0) / lands.length) + ' days'
 : '0';
 document.getElementById('landAvgPrice').textContent = lands.length > 0
 ? '$' + Math.round(lands.reduce((s, l) => s + l.price, 0) / lands.length / 1000) + 'K'
 : '$0';
 document.getElementById('landBestDeal').textContent = lands.length > 0 && lands[0].profit > 0
 ? '$' + Math.round(lands[0].profit / 1000) + 'K profit'
 : '$0';
 
 // Render table
 const container = document.getElementById('landDealsResults');
 if (!container) return;
 
 if (lands.length === 0) {
 container.innerHTML = '<p style="color:#94a3b8;padding:1rem">No land deals found matching criteria. Try adjusting filters.</p>';
 return;
 }
 
 let html = `<table style="width:100%;border-collapse:collapse;font-size:0.75rem">
 <thead>
 <tr style="background:rgba(99,102,241,0.3)">
 <th style="padding:0.5rem;text-align:left">Deal</th>
 <th style="padding:0.5rem;text-align:left">Address</th>
 <th style="padding:0.5rem;text-align:left">City</th>
 <th style="padding:0.5rem;text-align:right">Ask</th>
 <th style="padding:0.5rem;text-align:right">Acres</th>
 <th style="padding:0.5rem;text-align:center;color:#22d3ee" title="Lot capacity based on RI zoning">üè† Capacity</th>
 <th style="padding:0.5rem;text-align:right" title="Actual build sqft for this lot">Build SqFt</th>
 <th style="padding:0.5rem;text-align:right">DOM</th>
 <th style="padding:0.5rem;text-align:right">Comps</th>
 <th style="padding:0.5rem;text-align:right">Est. Sale</th>
 <th style="padding:0.5rem;text-align:right;color:#10b981">Profit</th>
 <th style="padding:0.5rem;text-align:right;color:#f59e0b">Max Offer</th>
 <th style="padding:0.5rem;text-align:center">Eval</th>
 </tr>
 </thead>
 <tbody>`;
 
 lands.slice(0, 50).forEach((land, idx) => {
 const profitColor = land.profit > 0 ? '#10b981' : '#ef4444';
 const capacityColor = land.canBuildTarget ? '#22d3ee' : '#f59e0b';
 const buildNote = land.canBuildTarget ? '' : ' ‚ö†Ô∏è';
 html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer" onclick="toggleLandComps(${idx})">
 <td style="padding:0.4rem">${land.dealScore}</td>
 <td style="padding:0.4rem"><a href="${land.url}" target="_blank" style="color:#6366f1" onclick="event.stopPropagation()">${land.address}</a></td>
 <td style="padding:0.4rem">${land.city}</td>
 <td style="padding:0.4rem;text-align:right">$${(land.price/1000).toFixed(0)}K</td>
 <td style="padding:0.4rem;text-align:right">${land.acres}</td>
 <td style="padding:0.4rem;text-align:center;color:${capacityColor}" title="Max buildable: ${land.maxBuildableSqft?.toLocaleString() || '?'} sqft">${land.lotCapacity}</td>
 <td style="padding:0.4rem;text-align:right;color:${land.canBuildTarget ? '#94a3b8' : '#f59e0b'}" title="${land.canBuildTarget ? 'Target fits' : 'Lot limited to ' + land.maxBuildableSqft + ' sqft'}">${land.actualBuildSqft?.toLocaleString() || '?'}${buildNote}</td>
 <td style="padding:0.4rem;text-align:right;color:${land.dom > 180 ? '#f59e0b' : '#94a3b8'}">${land.dom}</td>
 <td style="padding:0.4rem;text-align:right">${land.compsCount} @ $${land.avgPpsf}/sf</td>
 <td style="padding:0.4rem;text-align:right">$${(land.estSalePrice/1000).toFixed(0)}K</td>
 <td style="padding:0.4rem;text-align:right;color:${profitColor};font-weight:bold">$${(land.profit/1000).toFixed(0)}K (${land.profitPct}%)</td>
 <td style="padding:0.4rem;text-align:right;color:#f59e0b;font-weight:bold">$${(land.maxOffer/1000).toFixed(0)}K</td>
 <td style="padding:0.4rem;text-align:center"><button onclick="event.stopPropagation();showLandEval(${idx})" style="background:#6366f1;border:none;color:white;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;font-size:0.65rem">View</button></td>
 </tr>
 <tr id="land-comps-${idx}" style="display:none;background:rgba(99,102,241,0.1)">
 <td colspan="13" style="padding:1rem" id="land-comps-content-${idx}"></td>
 </tr>`;
 });
 
 html += '</tbody></table>';
 if (lands.length > 50) {
 html += `<p style="color:#94a3b8;padding:0.5rem">Showing top 50 of ${lands.length} deals. Export CSV for full list.</p>`;
 }
 container.innerHTML = html;
 
 // Store for export and comp lookups
 window.landDealsData = lands;
 window.cityCompsData = cityComps;
 }
 
 function toggleLandComps(idx) {
 const row = document.getElementById(`land-comps-${idx}`);
 if (!row) return;
 
 if (row.style.display === 'none') {
 row.style.display = 'table-row';
 loadLandComps(idx);
 } else {
 row.style.display = 'none';
 }
 }
 
 // Format price helper (inline version) - handles negatives properly
 function fmtPrice(amt) {
 const absAmt = Math.abs(amt);
 const sign = amt < 0 ? '-' : '';
 if (absAmt >= 1000000) return '$' + sign + (absAmt/1000000).toFixed(1) + 'M';
 return '$' + sign + Math.round(absAmt/1000) + 'K';
 }
 
 function loadLandComps(idx) {
 const land = window.landDealsData[idx];
 const comps = window.cityCompsData[land.city] || [];
 const container = document.getElementById(`land-comps-content-${idx}`);
 if (!container) return;
 
 // Get top 8 comps sorted by price
 const topComps = comps
 .sort((a, b) => b.price - a.price)
 .slice(0, 8);
 
 // Lot Analysis Section
 let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">`;
 
 // Left: Lot Buildability
 html += `<div style="background:rgba(34,211,238,0.1);padding:1rem;border-radius:8px;border:1px solid rgba(34,211,238,0.25)">
 <div style="color:#22d3ee;font-weight:600;margin-bottom:0.5rem">üìê Lot Buildability Analysis</div>
 <div style="font-size:0.8rem;color:#94a3b8;line-height:1.6">
 <div>Lot Size: <strong style="color:#e2e8f0">${land.acres} acres (${land.lotSizeSqft?.toLocaleString() || '?'} sqft)</strong></div>
 <div>Max Buildable: <strong style="color:#22d3ee">${land.maxBuildableSqft?.toLocaleString() || '?'} sqft</strong></div>
 <div>Recommended: <strong style="color:#10b981">${land.recommendedRooms || '?'} bedrooms</strong></div>
 <div>Stories: <strong>${land.stories || 2}</strong> ${land.stories === 1 ? '(ranch style)' : '(two-story)'}</div>
 ${!land.canBuildTarget ? `<div style="color:#f59e0b;margin-top:0.5rem">‚ö†Ô∏è Target ${document.getElementById('targetSqft')?.value || 1600} sqft exceeds lot capacity. Using ${land.actualBuildSqft} sqft.</div>` : ''}
 </div>
 </div>`;
 
 // Right: Build Cost Breakdown
 const targetRooms = document.getElementById('targetRooms')?.value || 3;
 html += `<div style="background:rgba(99,102,241,0.1);padding:1rem;border-radius:8px;border:1px solid rgba(99,102,241,0.25)">
 <div style="color:#6366f1;font-weight:600;margin-bottom:0.5rem">üí∞ Build Cost Breakdown</div>
 <div style="font-size:0.8rem;color:#94a3b8;line-height:1.6">
 <div>Build Size: <strong style="color:#e2e8f0">${land.actualBuildSqft?.toLocaleString() || '?'} sqft</strong></div>
 <div>Adjusted $/sqft: <strong style="color:#6366f1">$${land.adjustedCostPsf || 175}</strong> (${land.actualRooms || targetRooms} BR complexity)</div>
 <div>Construction: <strong>$${Math.round((land.buildCost || 0) / 1000)}K</strong></div>
 <div>+ Land: <strong>$${Math.round(land.price / 1000)}K</strong></div>
 <div>+ Soft Costs: <strong>$${Math.round((land.totalCost - land.price - land.buildCost) / 1000)}K</strong></div>
 <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:0.5rem;margin-top:0.5rem">
 Total Investment: <strong style="color:#f59e0b;font-size:0.9rem">$${Math.round(land.totalCost / 1000)}K</strong>
 </div>
 </div>
 </div>`;
 
 html += `</div>`;
 
 // Comps Section
 html += `<div style="margin-bottom:0.5rem;color:#6366f1;font-weight:600">üèòÔ∏è ${land.city} Comparable Sales (${comps.length} total)</div>`;
 
 if (topComps.length === 0) {
 html += '<p style="color:#94a3b8">No comparable sales found in this city.</p>';
 } else {
 html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.5rem">`;
 topComps.forEach(comp => {
 html += `<div style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;font-size:0.75rem">
 <div style="color:#10b981;font-weight:600">${fmtPrice(comp.price)}</div>
 <div style="color:#94a3b8">${comp.sqft?.toLocaleString() || '?'} sqft ‚Ä¢ $${Math.round(comp.ppsf)}/sf</div>
 <a href="${comp.url}" target="_blank" style="color:#6366f1;font-size:0.7rem">${comp.address}</a>
 </div>`;
 });
 html += `</div>`;
 html += `<div style="margin-top:0.75rem;padding:0.75rem;background:rgba(16,185,129,0.15);border-radius:8px;font-size:0.8rem">
 <strong style="color:#10b981">üìä Deal Analysis:</strong> 
 Build ${land.actualBuildSqft?.toLocaleString() || '?'} sqft ${land.actualRooms || 3}BR @ <strong>$${land.avgPpsf}/sqft</strong> (median + 5% new construction) = <strong style="color:#22d3ee">${fmtPrice(land.estSalePrice)}</strong> est. value | 
 Profit: <strong style="color:${land.profit > 0 ? '#10b981' : '#ef4444'}">${fmtPrice(land.profit)} (${land.profitPct}%)</strong>
 ${land.profit < 0 ? '<br><span style="color:#f59e0b">‚ö†Ô∏è Offer $' + Math.round(land.maxOffer/1000) + 'K or below to hit ' + (document.getElementById('targetProfit')?.value || 25) + '% profit target</span>' : ''}
 </div>`;
 }
 
 container.innerHTML = html;
 }
 
 // Format price for display: $500K or $1.5M
 function formatPrice(amount) {
 const abs = Math.abs(amount);
 const sign = amount < 0 ? '-' : '';
 if (abs >= 1000000) {
 return '$' + sign + (abs / 1000000).toFixed(1) + 'M';
 } else {
 return '$' + sign + Math.round(abs / 1000) + 'K';
 }
 }
 
 function showLandEval(idx) {
 const land = window.landDealsData[idx];
 const comps = window.cityCompsData[land.city] || [];
 const targetSqft = parseInt(document.getElementById('targetSqft')?.value) || 2000;
 const buildCostPsf = parseInt(document.getElementById('buildCostPsf')?.value) || 175;
 const softCostsPct = parseInt(document.getElementById('softCosts')?.value) || 15;
 const buildTotal = Math.round(buildCostPsf * targetSqft * (1 + softCostsPct/100));
 
 // Calculate profit at asking price
 const totalAtAsk = land.price + buildTotal;
 const profitAtAsk = land.estSalePrice - totalAtAsk;
 const profitPctAtAsk = Math.round((profitAtAsk / totalAtAsk) * 100);
 
 // Calculate suggested offers (% of asking)
 const offer90 = Math.round(land.price * 0.90);
 const offer80 = Math.round(land.price * 0.80);
 const offer70 = Math.round(land.price * 0.70);
 const profit90 = land.estSalePrice - (offer90 + buildTotal);
 const profit80 = land.estSalePrice - (offer80 + buildTotal);
 const profit70 = land.estSalePrice - (offer70 + buildTotal);
 
 // Calculate confidence score (0-100)
 let confidence = 0;
 let confFactors = [];
 // Factor 1: Number of comps (max 40 pts)
 const compScore = Math.min(40, comps.length * 4);
 confidence += compScore;
 confFactors.push(comps.length >= 10 ? '‚úì Strong comp pool (' + comps.length + ')' : comps.length >= 5 ? '‚óê Moderate comps (' + comps.length + ')' : '‚ö† Few comps (' + comps.length + ')');
 // Factor 2: Price variance - coefficient of variation (max 30 pts)
 if (comps.length >= 3) {
 const prices = comps.map(c => c.ppsf);
 const mean = prices.reduce((a,b) => a+b, 0) / prices.length;
 const variance = prices.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / prices.length;
 const cv = Math.sqrt(variance) / mean;
 const varScore = Math.max(0, 30 - cv * 60);
 confidence += varScore;
 confFactors.push(cv < 0.25 ? '‚úì Low price variance' : cv < 0.4 ? '‚óê Moderate variance' : '‚ö† High price variance');
 }
 // Factor 3: DOM sanity check (max 30 pts)
 const domScore = land.dom >= 90 ? 30 : land.dom >= 60 ? 20 : land.dom >= 30 ? 10 : 5;
 confidence += domScore;
 confFactors.push(land.dom >= 90 ? '‚úì Long DOM (motivated)' : land.dom >= 60 ? '‚óê Decent DOM' : '‚ö† Fresh listing');
 confidence = Math.round(confidence);
 const confColor = confidence >= 70 ? '#10b981' : confidence >= 50 ? '#f59e0b' : '#ef4444';
 const confLabel = confidence >= 70 ? 'HIGH' : confidence >= 50 ? 'MEDIUM' : 'LOW';
 
 // Build comps HTML
 let compsHtml = '';
 comps.slice(0, 12).forEach(function(c) {
 compsHtml += '<a href="' + c.url + '" target="_blank" style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;text-decoration:none;display:block">';
 compsHtml += '<div style="color:#10b981;font-weight:600">' + formatPrice(c.price) + '</div>';
 compsHtml += '<div style="color:#94a3b8;font-size:0.75rem">' + c.sqft.toLocaleString() + ' sf ‚Ä¢ $' + Math.round(c.ppsf) + '/sf</div>';
 compsHtml += '<div style="color:#6366f1;font-size:0.7rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + c.address + '</div>';
 compsHtml += '</a>';
 });
 
 // Create modal
 const modal = document.createElement('div');
 modal.id = 'landEvalModal';
 modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center';
 modal.onclick = function() { modal.remove(); };
 
 modal.innerHTML = '<div style="background:#1e293b;padding:2rem;border-radius:16px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;position:relative" onclick="event.stopPropagation()">' +
 '<button onclick="document.getElementById(\'landEvalModal\').remove()" style="position:absolute;top:15px;right:15px;background:#ef4444;border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;font-weight:bold;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,0.3);line-height:32px;text-align:center">‚úï</button>' +
 '<div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:1.5rem;gap:0.5rem">' +
 '<h2 style="color:#6366f1;margin:0"> Deal Evaluation</h2>' +
 '<div style="display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center">' +
 '<button onclick="exportLandEval(' + idx + ')" style="background:linear-gradient(135deg,#6366f1,#818cf8);border:none;color:white;padding:0.6rem 1.25rem;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:600;box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.2s" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'none\'">Export</button>' +
 '<button onclick="exportLandPDF(' + idx + ')" style="background:linear-gradient(135deg,#10b981,#34d399);border:none;color:white;padding:0.6rem 1.25rem;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:600;box-shadow:0 4px 12px rgba(16,185,129,0.4);transition:all 0.2s" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'none\'">PDF</button>' +
 '</div>' +
 '</div>' +
 '<div style="background:rgba(99,102,241,0.2);padding:1rem;border-radius:12px;margin-bottom:1.5rem">' +
 '<h3 style="color:#e2e8f0;margin:0 0 0.5rem 0">' + land.address + ', ' + land.city + '</h3>' +
 '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;font-size:0.85rem">' +
 '<div><span style="color:#94a3b8">Ask Price:</span><br><strong style="color:#00E1E6">$' + land.price.toLocaleString() + '</strong></div>' +
 '<div><span style="color:#94a3b8">Lot Size:</span><br><strong>' + land.acres + ' acres</strong></div>' +
 '<div><span style="color:#94a3b8">Days Listed:</span><br><strong>' + land.dom + ' days</strong></div>' +
 '<div><span style="color:#94a3b8">Deal Score:</span><br><strong style="font-size:1.5rem">' + land.dealScore + '</strong></div>' +
 '</div>' +
 '<div style="margin-top:0.75rem;display:flex;justify-content:space-between;align-items:center">' +
 '<a href="' + land.url + '" target="_blank" style="color:#6366f1">üîó View on Redfin</a>' +
 '<div style="background:rgba(0,0,0,0.3);padding:0.5rem 1rem;border-radius:8px;display:flex;align-items:center;gap:0.5rem">' +
 '<span style="color:#94a3b8;font-size:0.8rem">Confidence:</span>' +
 '<span style="color:' + confColor + ';font-weight:bold;font-size:1.1rem">' + confidence + '%</span>' +
 '<span style="background:' + confColor + ';color:black;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:bold">' + confLabel + '</span>' +
 '</div>' +
 '</div>' +
 '</div>' +
 '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:12px">' +
 '<h4 style="color:#94a3b8;margin:0 0 0.5rem 0">üîß Build Assumptions <span style="font-size:0.7rem;font-weight:normal">(editable)</span></h4>' +
 '<div style="font-size:0.85rem">' +
 '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem">Target Home: <input type="number" id="modalTargetSqft" value="' + targetSqft + '" style="width:70px;background:#1e293b;border:1px solid #334155;color:#f8fafc;padding:0.25rem 0.5rem;border-radius:4px;text-align:right" onchange="recalcLandModal(' + idx + ')"> sqft</div>' +
 '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem">Build Cost: $<input type="number" id="modalBuildCost" value="' + buildCostPsf + '" style="width:60px;background:#1e293b;border:1px solid #334155;color:#f8fafc;padding:0.25rem 0.5rem;border-radius:4px;text-align:right" onchange="recalcLandModal(' + idx + ')">/sqft</div>' +
 '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem">Soft Costs: <input type="number" id="modalSoftCosts" value="' + softCostsPct + '" style="width:50px;background:#1e293b;border:1px solid #334155;color:#f8fafc;padding:0.25rem 0.5rem;border-radius:4px;text-align:right" onchange="recalcLandModal(' + idx + ')">%</div>' +
 '<div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:0.5rem;padding-top:0.5rem">Total Build: <strong style="color:#00E1E6" id="modalBuildTotal">$' + Math.round(buildTotal/1000) + 'K</strong></div>' +
 '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:12px">' +
 '<h4 style="color:#94a3b8;margin:0 0 0.5rem 0"> Market Analysis</h4>' +
 '<div style="font-size:0.85rem">' +
 '<div>City Comps: <strong>' + comps.length + ' sales</strong></div>' +
 '<div>Avg $/sqft: <strong>$' + land.avgPpsf + '</strong></div>' +
 '<div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:0.5rem;padding-top:0.5rem">Est. Sale Price: <strong style="color:#10b981">' + formatPrice(land.estSalePrice) + '</strong></div>' +
 '</div>' +
 '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.2);padding:1rem;border-radius:12px;margin-bottom:1.5rem;border-left:4px solid ' + confColor + '">' +
 '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">' +
 '<h4 style="color:#94a3b8;margin:0"> Confidence Score</h4>' +
 '<div style="display:flex;align-items:center;gap:0.5rem"><span style="color:' + confColor + ';font-size:1.8rem;font-weight:bold">' + confidence + '%</span><span style="background:' + confColor + ';color:black;padding:0.2rem 0.6rem;border-radius:4px;font-size:0.75rem;font-weight:bold">' + confLabel + '</span></div>' +
 '</div>' +
 '<div style="font-size:0.8rem;color:#94a3b8">' + confFactors.join(' ‚Ä¢ ') + '</div>' +
 '</div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Profit at Asking Price</h4>' +
 '<div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:12px;text-align:center;margin-bottom:1.5rem;border:2px solid #10b981">' +
 '<div style="color:#94a3b8;font-size:0.9rem">If you pay asking price of <strong style="color:#00E1E6">$' + land.price.toLocaleString() + '</strong></div>' +
 '<div style="color:#10b981;font-size:2.5rem;font-weight:bold;margin:0.5rem 0" id="modalProfitAtAsk">' + formatPrice(profitAtAsk) + ' Profit</div>' +
 '<div style="color:#6366f1;font-size:1.1rem"><span id="modalProfitPct">' + profitPctAtAsk + '</span>% Return on <span id="modalTotalInvest">' + formatPrice(totalAtAsk) + '</span> investment</div>' +
 '</div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Projected Sale Value After Build</h4>' +
 '<div style="background:rgba(99,102,241,0.1);padding:1rem;border-radius:12px;margin-bottom:1.5rem;border:1px solid rgba(99,102,241,0.25)">' +
 '<div style="color:#94a3b8;font-size:0.85rem;margin-bottom:0.75rem">Based on ' + land.city + ' avg <strong style="color:#6366f1">$' + land.avgPpsf + '/sqft</strong> from ' + comps.length + ' comparable sales:</div>' +
 '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem">' +
 '<div style="background:rgba(0,0,0,0.2);padding:0.75rem;border-radius:8px;text-align:center">' +
 '<div style="color:#64748b;font-size:0.7rem">1,500 sqft</div>' +
 '<div style="color:#10b981;font-size:1.1rem;font-weight:bold">' + formatPrice(Math.round(1500 * land.avgPpsf)) + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.2);padding:0.75rem;border-radius:8px;text-align:center">' +
 '<div style="color:#64748b;font-size:0.7rem">2,000 sqft</div>' +
 '<div style="color:#10b981;font-size:1.1rem;font-weight:bold">' + formatPrice(Math.round(2000 * land.avgPpsf)) + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.2);padding:0.75rem;border-radius:8px;text-align:center">' +
 '<div style="color:#64748b;font-size:0.7rem">2,500 sqft</div>' +
 '<div style="color:#10b981;font-size:1.1rem;font-weight:bold">' + formatPrice(Math.round(2500 * land.avgPpsf)) + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.2);padding:0.75rem;border-radius:8px;text-align:center">' +
 '<div style="color:#64748b;font-size:0.7rem">3,000 sqft</div>' +
 '<div style="color:#10b981;font-size:1.1rem;font-weight:bold">' + formatPrice(Math.round(3000 * land.avgPpsf)) + '</div>' +
 '</div>' +
 '</div>' +
 '<div style="color:#64748b;font-size:0.75rem;margin-top:0.75rem;text-align:center" id="modalTargetLine">Your target: <strong style="color:#f59e0b">' + targetSqft.toLocaleString() + ' sqft</strong> ‚Üí Est. sale <strong style="color:#10b981">' + formatPrice(land.estSalePrice) + '</strong></div>' +
 '</div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Suggested Offers</h4>' +
 '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1.5rem">' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:12px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">90% of Ask</div>' +
 '<div style="color:#f59e0b;font-size:1.5rem;font-weight:bold">' + formatPrice(offer90) + '</div>' +
 '<div style="color:#64748b;font-size:0.7rem;margin:0.25rem 0">+ ' + formatPrice(buildTotal) + ' build = <strong style="color:#6366f1">' + formatPrice(offer90 + buildTotal) + '</strong></div>' +
 '<div style="color:#10b981;font-size:0.8rem">‚Üí ' + formatPrice(profit90) + ' profit</div>' +
 '</div>' +
 '<div style="background:rgba(245,158,11,0.2);padding:1rem;border-radius:12px;text-align:center;border:2px solid #f59e0b">' +
 '<div style="color:#94a3b8;font-size:0.75rem">80% of Ask (Recommended)</div>' +
 '<div style="color:#f59e0b;font-size:1.5rem;font-weight:bold">' + formatPrice(offer80) + '</div>' +
 '<div style="color:#64748b;font-size:0.7rem;margin:0.25rem 0">+ ' + formatPrice(buildTotal) + ' build = <strong style="color:#6366f1">' + formatPrice(offer80 + buildTotal) + '</strong></div>' +
 '<div style="color:#10b981;font-size:0.8rem">‚Üí ' + formatPrice(profit80) + ' profit</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:12px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">70% of Ask (Aggressive)</div>' +
 '<div style="color:#f59e0b;font-size:1.5rem;font-weight:bold">' + formatPrice(offer70) + '</div>' +
 '<div style="color:#64748b;font-size:0.7rem;margin:0.25rem 0">+ ' + formatPrice(buildTotal) + ' build = <strong style="color:#6366f1">' + formatPrice(offer70 + buildTotal) + '</strong></div>' +
 '<div style="color:#10b981;font-size:0.8rem">‚Üí ' + formatPrice(profit70) + ' profit</div>' +
 '</div>' +
 '</div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem">üèòÔ∏è Top Comparable Sales (' + comps.length + ' total)</h4>' +
 '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.5rem;max-height:200px;overflow-y:auto">' +
 compsHtml +
 '</div>' +
 '<div style="margin-top:1.5rem;text-align:center">' +
 '<button onclick="showLandNeighborhood(' + idx + ')" style="background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem">üó∫Ô∏è Explore Neighborhood</button>' +
 '</div>' +
 '</div>';
 
 document.body.appendChild(modal);
 }
 
 // Recalculate land modal when build assumptions change
 function recalcLandModal(idx) {
 const land = window.landDealsData[idx];
 const targetSqft = parseInt(document.getElementById('modalTargetSqft')?.value) || 2000;
 const buildCostPsf = parseInt(document.getElementById('modalBuildCost')?.value) || 175;
 const softCostsPct = parseInt(document.getElementById('modalSoftCosts')?.value) || 15;
 const buildTotal = Math.round(buildCostPsf * targetSqft * (1 + softCostsPct/100));
 
 // Recalculate estimated sale price based on new sqft
 const estSalePrice = land.avgPpsf * targetSqft;
 
 // Recalculate profit at asking price
 const totalAtAsk = land.price + buildTotal;
 const profitAtAsk = estSalePrice - totalAtAsk;
 const profitPctAtAsk = Math.round((profitAtAsk / totalAtAsk) * 100);
 
 // Update display elements
 document.getElementById('modalBuildTotal').textContent = '$' + Math.round(buildTotal/1000) + 'K';
 document.getElementById('modalProfitAtAsk').innerHTML = formatPrice(profitAtAsk) + ' Profit';
 document.getElementById('modalProfitPct').textContent = profitPctAtAsk;
 document.getElementById('modalTotalInvest').textContent = formatPrice(totalAtAsk);
 document.getElementById('modalTargetLine').innerHTML = 'Your target: <strong style="color:#f59e0b">' + targetSqft.toLocaleString() + ' sqft</strong> ‚Üí Est. sale <strong style="color:#10b981">' + formatPrice(estSalePrice) + '</strong>';
 
 // Update the main global inputs too so they stay in sync
 if (document.getElementById('targetSqft')) document.getElementById('targetSqft').value = targetSqft;
 if (document.getElementById('buildCostPsf')) document.getElementById('buildCostPsf').value = buildCostPsf;
 if (document.getElementById('softCosts')) document.getElementById('softCosts').value = softCostsPct;
 }
 
 // Neighborhood exploration for land deals
 function showLandNeighborhood(idx) {
 const land = window.landDealsData[idx];
 if (!land.lat || !land.lng) {
 // Fall back to city-level view with message
 showCityComps(land.city, land.address + ' (No coordinates - showing city-wide data)');
 return;
 }
 
 // Get nearby sold properties (0.75 mile radius for land)
 const nearby = getNearbyProperties(land.lat, land.lng, 0.75, land.address);
 const nearbySold = nearby.filter(p => p.saleType === 'PAST SALE' || p.status === 'Sold' || p.soldDate);
 const nearbyHouses = nearby.filter(p => p.propertyType && !p.propertyType.includes('Land'));
 
 // Calculate neighborhood stats from sold houses
 const soldPrices = nearbyHouses.filter(p => p.price > 0 && (p.saleType === 'PAST SALE' || p.status === 'Sold')).map(p => p.price);
 const avgPrice = soldPrices.length ? Math.round(soldPrices.reduce((a,b) => a+b, 0) / soldPrices.length) : 0;
 const avgPpsf = nearbyHouses.filter(p => p.sqft > 0 && (p.saleType === 'PAST SALE' || p.status === 'Sold')).length ?
 Math.round(nearbyHouses.filter(p => p.sqft > 0 && (p.saleType === 'PAST SALE' || p.status === 'Sold'))
 .reduce((a,p) => a + (p.price / p.sqft), 0) / nearbyHouses.filter(p => p.sqft > 0 && (p.saleType === 'PAST SALE' || p.status === 'Sold')).length) : 0;
 
 // Build nearby HTML
 let nearbyHtml = '';
 nearby.slice(0, 15).forEach(p => {
 const isLand = p.propertyType && p.propertyType.includes('Land');
 const isSold = p.saleType === 'PAST SALE' || p.status === 'Sold';
 const typeColor = isLand ? '#f59e0b' : '#10b981';
 nearbyHtml += '<a href="' + p.url + '" target="_blank" style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;text-decoration:none;display:block">';
 nearbyHtml += '<div style="display:flex;justify-content:space-between;align-items:center">';
 nearbyHtml += '<span style="color:' + typeColor + ';font-weight:600">' + formatPrice(p.price) + '</span>';
 nearbyHtml += '<span style="color:#94a3b8;font-size:0.7rem">' + (p.distance * 5280).toFixed(0) + ' ft</span>';
 nearbyHtml += '</div>';
 nearbyHtml += '<div style="color:#94a3b8;font-size:0.75rem">' + (isLand ? (p.lotSize ? (p.lotSize/43560).toFixed(2) + ' acres' : '?') : (p.beds || '?') + 'bd/' + (p.baths || '?') + 'ba') + '</div>';
 nearbyHtml += '<div style="color:#6366f1;font-size:0.7rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + p.address + '</div>';
 nearbyHtml += '<div style="font-size:0.65rem;color:' + (isSold ? '#10b981' : '#6366f1') + '">' + (isLand ? 'üå≥ Land' : ' House') + ' ‚Ä¢ ' + (isSold ? 'SOLD' : 'FOR SALE') + '</div>';
 nearbyHtml += '</a>';
 });
 
 // Close previous modal
 const prevModal = document.getElementById('landEvalModal');
 if (prevModal) prevModal.remove();
 
 const modal = document.createElement('div');
 modal.id = 'landNeighborhoodModal';
 modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1001;display:flex;align-items:center;justify-content:center';
 modal.onclick = function() { modal.remove(); };
 
 modal.innerHTML = '<div style="background:#1e293b;padding:2rem;border-radius:16px;max-width:900px;width:95%;max-height:95vh;overflow-y:auto;position:relative" onclick="event.stopPropagation()">' +
 '<button onclick="document.getElementById(\'landNeighborhoodModal\').remove()" style="position:absolute;top:15px;right:15px;background:#ef4444;border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;font-weight:bold;z-index:10;line-height:32px;text-align:center">‚úï</button>' +
 '<h2 style="color:#6366f1;margin:0 0 1rem 0">üó∫Ô∏è Land Neighborhood Explorer</h2>' +
 '<div style="background:rgba(245,158,11,0.2);padding:1rem;border-radius:12px;margin-bottom:1.5rem">' +
 '<h3 style="color:#6366f1;margin:0 0 0.25rem 0">' + land.address + ', ' + land.city + '</h3>' +
 '<div style="color:#94a3b8;font-size:0.9rem"> ' + land.acres + ' acres ‚Ä¢ Showing nearby within 0.75 miles (' + nearby.length + ' properties)</div>' +
 '</div>' +
 
 '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem">' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Houses Sold</div>' +
 '<div style="color:#10b981;font-size:1.5rem;font-weight:bold">' + nearbyHouses.filter(p => p.saleType === 'PAST SALE' || p.status === 'Sold').length + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Avg House Price</div>' +
 '<div style="color:#00E1E6;font-size:1.5rem;font-weight:bold">' + (avgPrice ? formatPrice(avgPrice) : 'N/A') + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Avg $/SqFt</div>' +
 '<div style="color:#f59e0b;font-size:1.5rem;font-weight:bold">' + (avgPpsf ? '$' + avgPpsf : 'N/A') + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Total Nearby</div>' +
 '<div style="color:#6366f1;font-size:1.5rem;font-weight:bold">' + nearby.length + '</div>' +
 '</div>' +
 '</div>' +
 
 '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">' +
 '<div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Nearby Properties</h4>' +
 '<div style="display:grid;gap:0.5rem;max-height:400px;overflow-y:auto">' +
 nearbyHtml +
 '</div>' +
 '</div>' +
 '<div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Build Potential</h4>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1.25rem;border-radius:12px">' +
 '<p style="color:#94a3b8;font-size:0.9rem;margin-bottom:1rem">If nearby homes are selling for <strong style="color:#10b981">' + (avgPpsf ? '$' + avgPpsf + '/sqft' : 'N/A') + '</strong>, here\'s what you could build:</p>' +
 '<div style="display:grid;gap:0.75rem">' +
 (avgPpsf ? [1500, 2000, 2500, 3000].map(sq => 
 '<div style="display:flex;justify-content:space-between;padding:0.5rem;background:rgba(255,255,255,0.03);border-radius:6px">' +
 '<span style="color:#94a3b8">' + sq.toLocaleString() + ' sqft home:</span>' +
 '<span style="color:#10b981;font-weight:600">' + formatPrice(sq * avgPpsf) + '</span>' +
 '</div>'
 ).join('') : '<div style="color:#94a3b8">Insufficient nearby sales data</div>') +
 '</div>' +
 '</div>' +
 
 '<h4 style="color:#6366f1;margin:1.25rem 0 0.75rem"> Assessment</h4>' +
 '<div style="background:' + (avgPpsf && avgPpsf > 200 ? 'rgba(16,185,129,0.2)' : 'rgba(245,158,11,0.2)') + ';padding:1rem;border-radius:12px;border:2px solid ' + (avgPpsf && avgPpsf > 200 ? '#10b981' : '#f59e0b') + '">' +
 '<div style="font-size:1.1rem;font-weight:bold;color:' + (avgPpsf && avgPpsf > 200 ? '#10b981' : '#f59e0b') + '">' +
 (avgPpsf && avgPpsf > 250 ? 'Premium Neighborhood' : avgPpsf && avgPpsf > 200 ? 'Good Value Area' : 'Moderate Value Area') +
 '</div>' +
 '<div style="color:#94a3b8;font-size:0.9rem;margin-top:0.5rem">' +
 (nearbyHouses.length >= 5 ? 
 'Based on ' + nearbyHouses.filter(p => p.saleType === 'PAST SALE' || p.status === 'Sold').length + ' nearby house sales. ' +
 (avgPpsf > 250 ? 'High-demand area with strong resale potential.' : avgPpsf > 200 ? 'Solid neighborhood with steady appreciation.' : 'Consider carefully - moderate price per sqft.')
 : 'Limited nearby sales data. Research city-wide comparables for ' + land.city + '.') +
 '</div>' +
 '</div>' +
 '</div>' +
 '</div>' +
 '</div>';
 
 document.body.appendChild(modal);
 }
 
 function exportLandEval(idx) {
 const land = window.landDealsData[idx];
 const comps = window.cityCompsData[land.city] || [];
 const targetSqft = parseInt(document.getElementById('targetSqft')?.value) || 2000;
 const buildCostPsf = parseInt(document.getElementById('buildCostPsf')?.value) || 175;
 const softCostsPct = parseInt(document.getElementById('softCosts')?.value) || 15;
 const buildTotal = Math.round(buildCostPsf * targetSqft * (1 + softCostsPct/100));
 const totalAtAsk = land.price + buildTotal;
 const profitAtAsk = land.estSalePrice - totalAtAsk;
 const profitPctAtAsk = Math.round((profitAtAsk / totalAtAsk) * 100);
 const offer90 = Math.round(land.price * 0.90);
 const offer80 = Math.round(land.price * 0.80);
 const offer70 = Math.round(land.price * 0.70);
 const profit90 = land.estSalePrice - (offer90 + buildTotal);
 const profit80 = land.estSalePrice - (offer80 + buildTotal);
 const profit70 = land.estSalePrice - (offer70 + buildTotal);
 
 // Calculate confidence score (same as showLandEval)
 let confidence = 0;
 let confFactors = [];
 const compScore = Math.min(40, comps.length * 4);
 confidence += compScore;
 confFactors.push(comps.length >= 10 ? '‚úì Strong comp pool' : comps.length >= 5 ? '‚óê Moderate comps' : '‚ö† Few comps');
 if (comps.length >= 3) {
 const prices = comps.map(c => c.ppsf);
 const mean = prices.reduce((a,b) => a+b, 0) / prices.length;
 const variance = prices.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / prices.length;
 const cv = Math.sqrt(variance) / mean;
 confidence += Math.max(0, 30 - cv * 60);
 confFactors.push(cv < 0.25 ? '‚úì Low variance' : cv < 0.4 ? '‚óê Moderate variance' : '‚ö† High variance');
 }
 confidence += land.dom >= 90 ? 30 : land.dom >= 60 ? 20 : land.dom >= 30 ? 10 : 5;
 confFactors.push(land.dom >= 90 ? '‚úì Motivated seller' : land.dom >= 60 ? '‚óê Decent DOM' : '‚ö† Fresh listing');
 confidence = Math.round(confidence);
 const confLabel = confidence >= 70 ? 'HIGH' : confidence >= 50 ? 'MEDIUM' : 'LOW';
 const confColor = confidence >= 70 ? '#48bb78' : confidence >= 50 ? '#ed8936' : '#fc8181';
 
 let compsHtml = comps.slice(0, 12).map(c => 
 '<div style="background:#2d3748;padding:1rem;border-radius:8px;margin-bottom:0.5rem">' +
 '<a href="' + c.url + '" style="color:#48bb78;font-weight:bold;text-decoration:none">$' + c.price.toLocaleString() + '</a> ‚Ä¢ ' +
 c.sqft.toLocaleString() + ' sf ‚Ä¢ $' + Math.round(c.ppsf) + '/sf<br>' +
 '<span style="color:#a0aec0">' + c.address + '</span></div>'
 ).join('');
 
 const html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Deal Eval: ' + land.address + '</title>' +
 '<style>body{font-family:-apple-system,system-ui,sans-serif;background:#1a202c;color:#e2e8f0;padding:2rem;max-width:800px;margin:0 auto}' +
 'h1{color:#b794f4}h2{color:#90cdf4;border-bottom:1px solid #4a5568;padding-bottom:0.5rem}' +
 '.grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.card{background:#2d3748;padding:1.5rem;border-radius:12px}' +
 '.profit{background:linear-gradient(135deg,#276749,#1a3d2e);padding:2rem;border-radius:12px;text-align:center;margin:1.5rem 0}' +
 '.big{font-size:2.5rem;color:#48bb78;font-weight:bold}.offers{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin:1rem 0}' +
 '.offer{background:#2d3748;padding:1rem;border-radius:8px;text-align:center}.rec{border:2px solid #ed8936}' +
 'a{color:#63b3ed}@media print{body{background:white;color:black}.card,.offer{border:1px solid #ccc}}</style></head><body>' +
 '<h1> Deal Evaluation</h1>' +
 '<h2>' + land.address + ', ' + land.city + '</h2>' +
 '<div class="grid">' +
 '<div class="card"><strong>Ask Price:</strong> $' + land.price.toLocaleString() + '<br>' +
 '<strong>Lot Size:</strong> ' + land.acres + ' acres<br>' +
 '<strong>Days Listed:</strong> ' + land.dom + ' days<br>' +
 '<strong>Deal Score:</strong> <span style="font-size:1.5rem">' + land.dealScore + '</span><br>' +
 '<strong>Confidence:</strong> <span style="color:' + confColor + ';font-weight:bold">' + confidence + '% ' + confLabel + '</span></div>' +
 '<div class="card"><strong>Build:</strong> ' + targetSqft.toLocaleString() + ' sqft @ $' + buildCostPsf + '/sf<br>' +
 '<strong>Soft Costs:</strong> ' + softCostsPct + '%<br>' +
 '<strong>Total Build:</strong> $' + buildTotal.toLocaleString() + '<br>' +
 '<strong>Est. Sale:</strong> <span style="color:#48bb78">$' + land.estSalePrice.toLocaleString() + '</span></div>' +
 '</div>' +
 '<div style="background:#2d3748;padding:1rem;border-radius:12px;margin:1rem 0;border-left:4px solid ' + confColor + '">' +
 '<strong>Confidence Factors:</strong> ' + confFactors.join(' ‚Ä¢ ') + '</div>' +
 '<div class="profit"><div style="color:#a0aec0">Profit at Asking Price</div>' +
 '<div class="big">$' + profitAtAsk.toLocaleString() + '</div>' +
 '<div style="color:#90cdf4">' + profitPctAtAsk + '% Return on $' + totalAtAsk.toLocaleString() + '</div></div>' +
 '<h2> Projected Sale Value After Build</h2>' +
 '<div style="background:#2d3748;padding:1rem;border-radius:8px;margin-bottom:1rem">' +
 '<div style="color:#a0aec0;margin-bottom:0.5rem">Based on ' + land.city + ' avg <strong>$' + land.avgPpsf + '/sqft</strong>:</div>' +
 '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;text-align:center">' +
 '<div><span style="color:#718096">1,500sf</span><br><strong style="color:#48bb78">$' + Math.round(1500 * land.avgPpsf).toLocaleString() + '</strong></div>' +
 '<div><span style="color:#718096">2,000sf</span><br><strong style="color:#48bb78">$' + Math.round(2000 * land.avgPpsf).toLocaleString() + '</strong></div>' +
 '<div><span style="color:#718096">2,500sf</span><br><strong style="color:#48bb78">$' + Math.round(2500 * land.avgPpsf).toLocaleString() + '</strong></div>' +
 '<div><span style="color:#718096">3,000sf</span><br><strong style="color:#48bb78">$' + Math.round(3000 * land.avgPpsf).toLocaleString() + '</strong></div>' +
 '</div></div>' +
 '<h2> Suggested Offers</h2><div class="offers">' +
 '<div class="offer"><div style="color:#a0aec0">90%</div><div style="font-size:1.3rem;color:#ed8936">$' + offer90.toLocaleString() + '</div><div style="color:#718096;font-size:0.8rem">Total: $' + (offer90 + buildTotal).toLocaleString() + '</div><div style="color:#48bb78">‚Üí $' + profit90.toLocaleString() + '</div></div>' +
 '<div class="offer rec"><div style="color:#a0aec0">80% (Rec)</div><div style="font-size:1.3rem;color:#ed8936">$' + offer80.toLocaleString() + '</div><div style="color:#718096;font-size:0.8rem">Total: $' + (offer80 + buildTotal).toLocaleString() + '</div><div style="color:#48bb78">‚Üí $' + profit80.toLocaleString() + '</div></div>' +
 '<div class="offer"><div style="color:#a0aec0">70%</div><div style="font-size:1.3rem;color:#ed8936">$' + offer70.toLocaleString() + '</div><div style="color:#718096;font-size:0.8rem">Total: $' + (offer70 + buildTotal).toLocaleString() + '</div><div style="color:#48bb78">‚Üí $' + profit70.toLocaleString() + '</div></div></div>' +
 '<h2>üèòÔ∏è Comparable Sales (' + comps.length + ')</h2>' + compsHtml +
 '<p style="margin-top:2rem;color:#718096">Generated: ' + new Date().toLocaleString() + ' ‚Ä¢ <a href="' + land.url + '">View on Redfin</a></p>' +
 '</body></html>';
 
 const w = window.open('', '_blank');
 w.document.write(html);
 w.document.close();
 }
 
 function printLandEval() {
 const modal = document.getElementById('landEvalModal');
 if (!modal) return;
 const content = modal.querySelector('div > div').innerHTML;
 const w = window.open('', '_blank');
 w.document.write('<!DOCTYPE html><html><head><title>Deal Evaluation</title>' +
 '<style>body{font-family:-apple-system,system-ui,sans-serif;padding:2rem;max-width:800px;margin:0 auto}' +
 'h2,h3,h4{color:#333}a{color:#4299e1}</style></head><body>' + content + '</body></html>');
 w.document.close();
 w.print();
 }
 
 function exportLandPDF(idx) {
 const land = window.landDealsData[idx];
 const comps = window.cityCompsData[land.city] || [];
 const targetSqft = parseInt(document.getElementById('targetSqft')?.value) || 2000;
 const buildCostPsf = parseInt(document.getElementById('buildCostPsf')?.value) || 175;
 const softCostsPct = parseInt(document.getElementById('softCosts')?.value) || 15;
 const buildTotal = Math.round(buildCostPsf * targetSqft * (1 + softCostsPct/100));
 const totalAtAsk = land.price + buildTotal;
 const profitAtAsk = land.estSalePrice - totalAtAsk;
 const profitPctAtAsk = Math.round((profitAtAsk / totalAtAsk) * 100);
 const offer90 = Math.round(land.price * 0.90);
 const offer80 = Math.round(land.price * 0.80);
 const offer70 = Math.round(land.price * 0.70);
 const profit90 = land.estSalePrice - (offer90 + buildTotal);
 const profit80 = land.estSalePrice - (offer80 + buildTotal);
 const profit70 = land.estSalePrice - (offer70 + buildTotal);
 
 // Confidence calc
 let confidence = 0, confFactors = [];
 confidence += Math.min(40, comps.length * 4);
 confFactors.push(comps.length >= 10 ? '‚úì Strong comps' : comps.length >= 5 ? '‚óê Moderate comps' : '‚ö† Few comps');
 if (comps.length >= 3) {
 const prices = comps.map(c => c.ppsf);
 const mean = prices.reduce((a,b) => a+b, 0) / prices.length;
 const variance = prices.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / prices.length;
 const cv = Math.sqrt(variance) / mean;
 confidence += Math.max(0, 30 - cv * 60);
 confFactors.push(cv < 0.25 ? '‚úì Low variance' : cv < 0.4 ? '‚óê Moderate variance' : '‚ö† High variance');
 }
 confidence += land.dom >= 90 ? 30 : land.dom >= 60 ? 20 : land.dom >= 30 ? 10 : 5;
 confFactors.push(land.dom >= 90 ? '‚úì Motivated seller' : land.dom >= 60 ? '‚óê Decent DOM' : '‚ö† Fresh listing');
 confidence = Math.round(confidence);
 const confLabel = confidence >= 70 ? 'HIGH' : confidence >= 50 ? 'MEDIUM' : 'LOW';
 const confColorPrint = confidence >= 70 ? '#22863a' : confidence >= 50 ? '#b08800' : '#cb2431';
 
 let compsRows = comps.slice(0, 8).map(c => 
 '<tr><td>$' + c.price.toLocaleString() + '</td><td>' + c.sqft.toLocaleString() + '</td><td>$' + Math.round(c.ppsf) + '</td><td style="font-size:0.8em">' + c.address + '</td></tr>'
 ).join('');
 
 const html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Deal Eval - ' + land.address + '</title>' +
 '<style>@page{size:letter;margin:0.5in}' +
 '*{box-sizing:border-box}body{font-family:Georgia,serif;margin:0;padding:0.5in;font-size:11pt;color:#1a1a1a;line-height:1.4}' +
 'h1{font-size:18pt;margin:0 0 4pt;border-bottom:2px solid #333}h2{font-size:13pt;margin:12pt 0 6pt;color:#444}' +
 '.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12pt}' +
 '.badge{background:' + confColorPrint + ';color:white;padding:2pt 8pt;border-radius:3pt;font-size:10pt;font-weight:bold}' +
 '.grid{display:grid;grid-template-columns:1fr 1fr;gap:12pt;margin:12pt 0}' +
 '.card{border:1px solid #ddd;padding:10pt;border-radius:4pt;background:#fafafa}' +
 '.card strong{display:inline-block;width:100pt}' +
 '.profit-box{background:linear-gradient(135deg,#d4edda,#c3e6cb);border:2px solid #28a745;padding:16pt;text-align:center;border-radius:6pt;margin:12pt 0}' +
 '.profit-box .big{font-size:28pt;color:#155724;font-weight:bold}' +
 '.offers{display:grid;grid-template-columns:repeat(3,1fr);gap:8pt;margin:8pt 0}' +
 '.offer{border:1px solid #ddd;padding:8pt;text-align:center;border-radius:4pt}.offer.rec{border:2px solid #fd7e14;background:#fff3cd}' +
 '.offer .price{font-size:14pt;color:#d63384;font-weight:bold}' +
 '.offer .profit{color:#28a745;font-size:10pt}' +
 'table{width:100%;border-collapse:collapse;font-size:9pt;margin-top:6pt}' +
 'th,td{border:1px solid #ddd;padding:4pt;text-align:left}th{background:#f0f0f0}' +
 '.conf-bar{background:#f0f0f0;padding:6pt 10pt;border-left:4px solid ' + confColorPrint + ';margin:8pt 0;font-size:10pt}' +
 '.footer{margin-top:16pt;padding-top:8pt;border-top:1px solid #ccc;font-size:9pt;color:#666}' +
 '</style></head><body>' +
 '<div class="header"><div><h1> Land Deal Evaluation</h1><div style="font-size:14pt;color:#444">' + land.address + ', ' + land.city + '</div></div>' +
 '<div style="text-align:right"><div class="badge">' + confLabel + ' CONFIDENCE</div><div style="font-size:20pt;font-weight:bold;margin-top:4pt">' + confidence + '%</div></div></div>' +
 '<div class="grid">' +
 '<div class="card"><strong>Asking Price:</strong> $' + land.price.toLocaleString() + '<br><strong>Lot Size:</strong> ' + land.acres + ' acres<br><strong>Days on Market:</strong> ' + land.dom + '<br><strong>Deal Score:</strong> ' + land.dealScore + '</div>' +
 '<div class="card"><strong>Target Build:</strong> ' + targetSqft.toLocaleString() + ' sqft<br><strong>Build Cost:</strong> $' + buildCostPsf + '/sqft<br><strong>Soft Costs:</strong> ' + softCostsPct + '%<br><strong>Total Build:</strong> $' + buildTotal.toLocaleString() + '</div></div>' +
 '<div class="conf-bar"><strong>Confidence Factors:</strong> ' + confFactors.join(' &nbsp;‚Ä¢&nbsp; ') + '</div>' +
 '<div class="profit-box"><div>Profit at Asking Price ($' + land.price.toLocaleString() + ' + $' + buildTotal.toLocaleString() + ' build)</div>' +
 '<div class="big">$' + profitAtAsk.toLocaleString() + '</div>' +
 '<div>' + profitPctAtAsk + '% return on $' + totalAtAsk.toLocaleString() + ' total investment ‚Ä¢ Est. sale: $' + land.estSalePrice.toLocaleString() + '</div></div>' +
 '<h2> Suggested Offers</h2><div class="offers">' +
 '<div class="offer"><div style="color:#666">90% of Ask</div><div class="price">$' + offer90.toLocaleString() + '</div><div class="profit">‚Üí $' + profit90.toLocaleString() + ' profit</div></div>' +
 '<div class="offer rec"><div style="color:#666">80% (Recommended)</div><div class="price">$' + offer80.toLocaleString() + '</div><div class="profit">‚Üí $' + profit80.toLocaleString() + ' profit</div></div>' +
 '<div class="offer"><div style="color:#666">70% (Aggressive)</div><div class="price">$' + offer70.toLocaleString() + '</div><div class="profit">‚Üí $' + profit70.toLocaleString() + ' profit</div></div></div>' +
 '<h2>üèòÔ∏è Comparable Sales (' + comps.length + ' in ' + land.city + ')</h2>' +
 '<table><tr><th>Sale Price</th><th>Sqft</th><th>$/Sqft</th><th>Address</th></tr>' + compsRows + '</table>' +
 '<div class="footer">Generated: ' + new Date().toLocaleString() + ' &nbsp;|&nbsp; Source: Redfin &nbsp;|&nbsp; <a href="' + land.url + '">' + land.url + '</a></div>' +
 '</body></html>';
 
 // Use jsPDF to auto-download
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF({ unit: 'pt', format: 'letter' });
 const margin = 40;
 let y = margin;
 
 // Helper functions
 const addText = (text, size, style, color) => {
 doc.setFontSize(size);
 doc.setFont('helvetica', style || 'normal');
 doc.setTextColor(color || '#000000');
 };
 const fmt = (n) => '$' + n.toLocaleString();
 
 // Header
 addText('', 20, 'bold');
 doc.text('Land Deal Evaluation', margin, y);
 doc.setDrawColor(50);
 doc.setLineWidth(1.5);
 doc.line(margin, y + 5, 572 - margin, y + 5);
 y += 25;
 
 addText('', 14, 'normal', '#444444');
 doc.text(land.address + ', ' + land.city, margin, y);
 
 // Confidence badge (right side)
 const confBg = confidence >= 70 ? [34, 134, 58] : confidence >= 50 ? [176, 136, 0] : [203, 36, 49];
 doc.setFillColor(...confBg);
 doc.roundedRect(450, margin - 10, 85, 45, 4, 4, 'F');
 doc.setTextColor(255, 255, 255);
 doc.setFontSize(11);
 doc.text(confLabel + ' CONF.', 460, margin + 5);
 doc.setFontSize(22);
 doc.setFont('helvetica', 'bold');
 doc.text(confidence + '%', 465, margin + 28);
 y += 30;
 
 // Property & Build info boxes
 doc.setTextColor(0);
 doc.setFillColor(248, 248, 248);
 doc.roundedRect(margin, y, 240, 80, 4, 4, 'F');
 doc.roundedRect(margin + 255, y, 240, 80, 4, 4, 'F');
 
 doc.setFontSize(10);
 doc.setFont('helvetica', 'bold');
 doc.text('PROPERTY', margin + 10, y + 15);
 doc.setFont('helvetica', 'normal');
 doc.text('Ask Price: ' + fmt(land.price), margin + 10, y + 32);
 doc.text('Lot Size: ' + land.acres + ' acres', margin + 10, y + 47);
 doc.text('Days on Market: ' + land.dom, margin + 10, y + 62);
 doc.text('Deal Score: ' + land.dealScore, margin + 10, y + 77);
 
 doc.setFont('helvetica', 'bold');
 doc.text('BUILD ASSUMPTIONS', margin + 265, y + 15);
 doc.setFont('helvetica', 'normal');
 doc.text('Target: ' + targetSqft.toLocaleString() + ' sqft', margin + 265, y + 32);
 doc.text('Build Cost: $' + buildCostPsf + '/sqft', margin + 265, y + 47);
 doc.text('Soft Costs: ' + softCostsPct + '%', margin + 265, y + 62);
 doc.text('Total Build: ' + fmt(buildTotal), margin + 265, y + 77);
 y += 95;
 
 // Confidence factors bar
 doc.setFillColor(240, 240, 240);
 doc.setDrawColor(...confBg);
 doc.setLineWidth(3);
 doc.rect(margin, y, 495, 22, 'FD');
 doc.setFontSize(9);
 doc.setTextColor(80);
 doc.text('Confidence: ' + confFactors.join(' ‚Ä¢ '), margin + 10, y + 14);
 y += 35;
 
 // Profit box
 doc.setFillColor(212, 237, 218);
 doc.setDrawColor(40, 167, 69);
 doc.setLineWidth(2);
 doc.roundedRect(margin, y, 495, 70, 6, 6, 'FD');
 doc.setTextColor(80);
 doc.setFontSize(10);
 doc.text('Profit at Asking Price (' + fmt(land.price) + ' + ' + fmt(buildTotal) + ' build)', margin + 130, y + 18);
 doc.setTextColor(21, 87, 36);
 doc.setFontSize(32);
 doc.setFont('helvetica', 'bold');
 doc.text(fmt(profitAtAsk), margin + 170, y + 48);
 doc.setFontSize(11);
 doc.setFont('helvetica', 'normal');
 doc.text(profitPctAtAsk + '% return on ' + fmt(totalAtAsk) + ' ‚Ä¢ Est. sale: ' + fmt(land.estSalePrice), margin + 100, y + 63);
 y += 85;
 
 // Projected Sale Values section
 doc.setTextColor(0);
 doc.setFontSize(13);
 doc.setFont('helvetica', 'bold');
 doc.text('Projected Sale Value After Build', margin, y);
 y += 15;
 doc.setFillColor(245, 245, 250);
 doc.roundedRect(margin, y, 495, 50, 4, 4, 'F');
 doc.setFontSize(9);
 doc.setFont('helvetica', 'normal');
 doc.setTextColor(100);
 doc.text('Based on ' + land.city + ' avg $' + land.avgPpsf + '/sqft from ' + comps.length + ' comps:', margin + 10, y + 14);
 const sizes = [1500, 2000, 2500, 3000];
 sizes.forEach((sz, i) => {
 const x = margin + 10 + i * 120;
 doc.setTextColor(100);
 doc.setFontSize(9);
 doc.text(sz.toLocaleString() + ' sqft', x, y + 28);
 doc.setTextColor(40, 167, 69);
 doc.setFontSize(12);
 doc.setFont('helvetica', 'bold');
 doc.text(fmt(Math.round(sz * land.avgPpsf)), x, y + 42);
 doc.setFont('helvetica', 'normal');
 });
 y += 60;
 
 // Offers section
 doc.setTextColor(0);
 doc.setFontSize(13);
 doc.setFont('helvetica', 'bold');
 doc.text('Suggested Offers', margin, y);
 y += 18;
 
 const offers = [
 { label: '90% of Ask', price: offer90, total: offer90 + buildTotal, profit: profit90 },
 { label: '80% (Recommended)', price: offer80, total: offer80 + buildTotal, profit: profit80, rec: true },
 { label: '70% (Aggressive)', price: offer70, total: offer70 + buildTotal, profit: profit70 }
 ];
 offers.forEach((o, i) => {
 const x = margin + i * 168;
 if (o.rec) {
 doc.setFillColor(255, 243, 205);
 doc.setDrawColor(253, 126, 20);
 doc.setLineWidth(2);
 } else {
 doc.setFillColor(250, 250, 250);
 doc.setDrawColor(200);
 doc.setLineWidth(0.5);
 }
 doc.roundedRect(x, y, 160, 68, 4, 4, 'FD');
 doc.setTextColor(100);
 doc.setFontSize(9);
 doc.text(o.label, x + 50, y + 12);
 doc.setTextColor(214, 51, 132);
 doc.setFontSize(16);
 doc.setFont('helvetica', 'bold');
 doc.text(fmt(o.price), x + 45, y + 28);
 doc.setTextColor(100, 100, 140);
 doc.setFontSize(8);
 doc.setFont('helvetica', 'normal');
 doc.text('Total: ' + fmt(o.total), x + 45, y + 40);
 doc.setTextColor(40, 167, 69);
 doc.setFontSize(10);
 doc.setFont('helvetica', 'normal');
 doc.text('‚Üí ' + fmt(o.profit), x + 45, y + 55);
 });
 y += 82;
 
 // Comps table
 doc.setTextColor(0);
 doc.setFontSize(13);
 doc.setFont('helvetica', 'bold');
 doc.text('Comparable Sales (' + comps.length + ' in ' + land.city + ')', margin, y);
 y += 15;
 
 // Table header
 doc.setFillColor(240, 240, 240);
 doc.rect(margin, y, 495, 16, 'F');
 doc.setFontSize(9);
 doc.setFont('helvetica', 'bold');
 doc.text('Sale Price', margin + 5, y + 11);
 doc.text('Sqft', margin + 80, y + 11);
 doc.text('$/Sqft', margin + 130, y + 11);
 doc.text('Address', margin + 180, y + 11);
 y += 16;
 
 // Table rows
 doc.setFont('helvetica', 'normal');
 comps.slice(0, 8).forEach(c => {
 doc.setDrawColor(220);
 doc.line(margin, y + 12, 535, y + 12);
 doc.text(fmt(c.price), margin + 5, y + 10);
 doc.text(c.sqft.toLocaleString(), margin + 80, y + 10);
 doc.text('$' + Math.round(c.ppsf), margin + 130, y + 10);
 doc.text(c.address.substring(0, 45), margin + 180, y + 10);
 y += 14;
 });
 y += 10;
 
 // Footer
 doc.setDrawColor(180);
 doc.line(margin, y, 535, y);
 doc.setFontSize(8);
 doc.setTextColor(120);
 doc.text('Generated: ' + new Date().toLocaleString() + ' | Source: Redfin | ' + land.url, margin, y + 12);
 
 // Auto-download
 doc.save('deal-eval-' + land.address.replace(/[^a-z0-9]/gi, '-').substring(0, 30) + '.pdf');
 }
 
 function exportLandDealsCSV() {
 if (!window.landDealsData || window.landDealsData.length === 0) {
 alert('No land deals to export');
 return;
 }
 const headers = ['Deal Score','Address','City','Ask Price','Acres','DOM','City $/sf','Est Sale Price','Build Cost','Total Cost','Profit','Profit %','Max Offer','URL'];
 const rows = window.landDealsData.map(l => [
 l.dealScore, l.address, l.city, l.price, l.acres, l.dom, l.avgPpsf, 
 l.estSalePrice, l.buildCost, l.totalCost, l.profit, l.profitPct, l.maxOffer, l.url
 ]);
 const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
 const blob = new Blob([csv], { type: 'text/csv' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'ri-land-deals.csv';
 a.click();
 }
 
 // ========== HOUSE HUNTER DEAL REPORT ==========
 window.houseDealsData = [];
 window.houseCityComps = {};
 
 function initHouseHunter() {
 console.log('initHouseHunter starting...');
 if (!rawData || !rawData.properties) {
   console.log('initHouseHunter: No data!');
   return;
 }
 
 // Build city comps from SOLD properties (include lat/lng for proximity matching)
 const soldProps = rawData.properties.filter(p => (p.status === 'Sold' || p.saleType === 'PAST SALE') && p.sqft > 500 && p.price > 50000);
 window.houseCityComps = {};
 window.allSoldComps = []; // For proximity-based matching
 soldProps.forEach(p => {
 const comp = {
 price: p.price,
 sqft: p.sqft,
 ppsf: p.price / p.sqft,
 beds: p.beds,
 baths: p.baths,
 address: p.address,
 url: p.url,
 lat: p.lat,
 lng: p.lng,
 city: p.city,
 propertyType: p.propertyType
 };
 if (!window.houseCityComps[p.city]) window.houseCityComps[p.city] = [];
 window.houseCityComps[p.city].push(comp);
 if (p.lat && p.lng) window.allSoldComps.push(comp);
 });
 
 // Populate city dropdown
 const cities = Object.keys(window.houseCityComps).sort();
 const select = document.getElementById('houseCity');
 if (select) {
 cities.forEach(c => {
 const opt = document.createElement('option');
 opt.value = c;
 opt.textContent = c + ' (' + window.houseCityComps[c].length + ' comps)';
 select.appendChild(opt);
 });
 }
 
 filterHouseDeals();
 }
 
 function filterHouseDeals() {
 console.log('filterHouseDeals called');
 if (!rawData || !rawData.properties) {
   console.log('filterHouseDeals: No data');
   return;
 }
 
 const city = document.getElementById('houseCity')?.value || '';
 const minDom = parseInt(document.getElementById('houseMinDom')?.value) || 0;
 const maxPrice = parseInt(document.getElementById('houseMaxPrice')?.value) || Infinity;
 const minBeds = parseInt(document.getElementById('houseMinBeds')?.value) || 0;
 const minDiscount = parseInt(document.getElementById('houseMinDiscount')?.value) || -10;
 
 console.log('Filters:', { city, minDom, maxPrice, minBeds, minDiscount });
 
 // Get active (for sale) houses with sqft
 let houses = rawData.properties.filter(p => {
 const isForSale = p.status === 'For Sale' || p.saleType === 'MLS Listing' || p.saleType === 'For-Sale-by-Owner Listing' || p.saleType === 'New Construction Home';
 return isForSale && 
 p.sqft > 500 && 
 p.price > 50000 &&
 (p.propertyType || '').indexOf('Land') === -1 &&
 (p.dom || 0) >= minDom &&
 p.price <= maxPrice &&
 (p.beds || 0) >= minBeds &&
 (!city || p.city === city);
 });
 
 console.log('Houses found for sale:', houses.length);
 
 // Calculate market value and discount for each house
 const deals = houses.map(h => {
 // IMPROVED: Use nearby comps (within 0.5 mi) instead of city-wide
 let comps = [];
 if (h.lat && h.lng && window.allSoldComps) {
 // Find sold homes within 0.5 miles, same property type preferred
 const nearbyComps = window.allSoldComps.filter(c => {
 if (!c.lat || !c.lng) return false;
 const dist = getDistance(h.lat, h.lng, c.lat, c.lng);
 c.distance = dist; // Store distance for weighting
 return dist <= 0.5; // 0.5 miles
 });
 // Prefer same property type
 const sameType = nearbyComps.filter(c => c.propertyType === h.propertyType);
 comps = sameType.length >= 5 ? sameType : nearbyComps;
 }
 // Fallback to city comps if not enough nearby
 if (comps.length < 5) {
 comps = window.houseCityComps[h.city] || [];
 }
 if (comps.length < 3) return null;
 
 // STEP 1: Remove outliers - exclude comps way outside subject's price range
 // If subject < $500K, exclude comps > $1M (million dollar homes skew averages)
 // Otherwise exclude comps > 2x subject price
 const outlierCap = h.price < 500000 ? 1000000 : h.price * 2;
 const outlierFloor = h.price * 0.3; // Also exclude if way cheaper (teardowns)
 const noOutliers = comps.filter(c => c.price >= outlierFloor && c.price <= outlierCap);
 
 // Filter comps to similar size (+/- 25% tighter than before)
 const similarComps = noOutliers.filter(c => 
 c.sqft >= h.sqft * 0.75 && c.sqft <= h.sqft * 1.25
 );
 let useComps = similarComps.length >= 3 ? similarComps : (noOutliers.length >= 3 ? noOutliers : comps);
 
 // STEP 2: Weight nearby comps heavily (closest 3-5 get 70% weight)
 // Sort by distance if available
 useComps.sort((a, b) => (a.distance || 999) - (b.distance || 999));
 
 // Calculate weighted $/sqft - closest comps matter most
 let weightedPpsf;
 if (useComps.length >= 5 && useComps[0].distance !== undefined) {
   // Closest 5 comps get 70% weight, rest get 30%
   const closest = useComps.slice(0, 5);
   const others = useComps.slice(5);
   const closestAvg = closest.reduce((sum, c) => sum + c.ppsf, 0) / closest.length;
   const othersAvg = others.length > 0 
     ? others.reduce((sum, c) => sum + c.ppsf, 0) / others.length 
     : closestAvg;
   weightedPpsf = closestAvg * 0.7 + othersAvg * 0.3;
 } else {
   // No distance data - use simple average
   weightedPpsf = useComps.reduce((sum, c) => sum + c.ppsf, 0) / useComps.length;
 }
 
 // STEP 3: Calculate percentiles for range estimates (still useful for bounds)
 const sortedPpsf = useComps.map(c => c.ppsf).sort((a, b) => a - b);
 const p20Index = Math.floor(sortedPpsf.length * 0.20);
 const p25Index = Math.floor(sortedPpsf.length * 0.25);
 const p33Index = Math.floor(sortedPpsf.length * 0.33);
 
 const bottomPpsf = sortedPpsf[p20Index]; // 20th percentile - worst comps
 const conservativePpsf = sortedPpsf[p25Index]; // 25th percentile
 const realisticPpsf = sortedPpsf[p33Index]; // 33rd percentile
 
 // Range values: low to high estimate
 const lowValue = Math.round(h.sqft * bottomPpsf * 0.85); // 20th percentile - 15% haircut
 const highValue = Math.round(h.sqft * conservativePpsf * 0.94); // 25th percentile - 6% haircut
 
 // PRIMARY ESTIMATE: Middle of the range (what user sees)
 const marketValue = Math.round((lowValue + highValue) / 2);
 
 const avgPpsf = Math.round(weightedPpsf); // Show weighted avg for display
 let discount = Math.round((1 - h.price / marketValue) * 100);
 let instantEquity = marketValue - h.price;
 
 // Let the conservative methodology (weighted comps, outlier removal) produce natural estimates
 // Only cap extreme negative equity for display purposes
 if (instantEquity < -50000) {
   instantEquity = -50000; // Very overpriced - cap display at -$50K
 }
 
 // Low/high equity from range values
 let lowEquityRaw = lowValue - h.price;
 let highEquityRaw = highValue - h.price;
 const lowEquityCapped = Math.max(-50000, lowEquityRaw);
 const highEquityCapped = highEquityRaw; // No upper cap - let natural estimates show
 
 // Deal score: discount % + DOM factor
 const domBonus = Math.min(20, Math.floor(h.dom / 15));
 const dealScore = Math.min(discount + domBonus, 40); // Cap deal score too
 
 // Scenario values for toggle (all more conservative, all capped)
 const worstValue = lowValue; // 20th pct - 15%
 const expectedValue = Math.round(h.sqft * conservativePpsf * 0.90); // 25th - 10%
 const bestValue = Math.round(h.sqft * realisticPpsf * 0.94); // 33rd - 6%
 
 return {
 address: h.address,
 city: h.city,
 price: h.price,
 sqft: h.sqft,
 beds: h.beds || 0,
 baths: h.baths || 0,
 dom: h.dom,
 lat: h.lat,
 lng: h.lng,
 ppsf: Math.round(h.price / h.sqft),
 avgPpsf: Math.round(avgPpsf),
 marketValue: marketValue,
 discount: discount,
 instantEquity: instantEquity,
 dealScore: dealScore,
 compCount: useComps.length,
 url: h.url,
 // Range values
 lowValue: lowValue,
 highValue: highValue,
 lowEquity: lowEquityCapped,
 highEquity: highEquityCapped,
 // Scenario values
 worstValue: worstValue,
 worstEquity: worstValue - h.price,
 expectedValue: expectedValue,
 expectedEquity: expectedValue - h.price,
 bestValue: bestValue,
 bestEquity: bestValue - h.price
 };
 });
 
 console.log('Deals before filter:', deals.length, 'non-null:', deals.filter(d => d !== null).length);
 const filteredDeals = deals.filter(d => d && d.discount >= minDiscount);
 console.log('Deals after filter (discount >=', minDiscount, '):', filteredDeals.length);
 
 // Sort by deal score
 filteredDeals.sort((a, b) => b.dealScore - a.dealScore);
 window.houseDealsData = filteredDeals;
 
 // Update stats
 document.getElementById('houseCount').textContent = filteredDeals.length;
 if (filteredDeals.length > 0) {
 const avgDiscount = Math.round(filteredDeals.reduce((s, d) => s + d.discount, 0) / filteredDeals.length);
 const avgEquity = Math.round(filteredDeals.reduce((s, d) => s + d.instantEquity, 0) / filteredDeals.length);
 const bestEquity = Math.max(...filteredDeals.map(d => d.instantEquity));
 document.getElementById('houseAvgDiscount').textContent = avgDiscount + '%';
 document.getElementById('houseAvgEquity').textContent = formatPrice(avgEquity);
 document.getElementById('houseBestDeal').textContent = formatPrice(bestEquity);
 } else {
 document.getElementById('houseAvgDiscount').textContent = '0%';
 document.getElementById('houseAvgEquity').textContent = '$0';
 document.getElementById('houseBestDeal').textContent = '$0';
 }
 
 // Render results
 renderHouseDeals(filteredDeals);
 }
 
 function renderHouseDeals(deals) {
 const container = document.getElementById('houseDealsResults');
 if (!container) return;
 
 if (deals.length === 0) {
 container.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:2rem">No deals found matching criteria. Try adjusting filters.</p>';
 return;
 }
 
 let html = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem">';
 html += '<thead><tr style="background:rgba(99,102,241,0.2)">';
 html += '<th style="padding:0.75rem;text-align:left">Score</th>';
 html += '<th style="padding:0.75rem;text-align:left">Address</th>';
 html += '<th style="padding:0.75rem;text-align:left">City</th>';
 html += '<th style="padding:0.75rem;text-align:right">Ask Price</th>';
 html += '<th style="padding:0.75rem;text-align:right">Market Value</th>';
 html += '<th style="padding:0.75rem;text-align:right">Instant Equity</th>';
 html += '<th style="padding:0.75rem;text-align:center">Discount</th>';
 html += '<th style="padding:0.75rem;text-align:center">DOM</th>';
 html += '<th style="padding:0.75rem;text-align:center">Beds/Bath</th>';
 html += '<th style="padding:0.75rem;text-align:center">SqFt</th>';
 html += '<th style="padding:0.75rem;text-align:center">Action</th>';
 html += '</tr></thead><tbody>';
 
 deals.slice(0, 50).forEach((d, idx) => {
 const scoreColor = d.dealScore >= 25 ? '#10b981' : d.dealScore >= 15 ? '#f59e0b' : '#94a3b8';
 const discountColor = d.discount >= 20 ? '#10b981' : d.discount >= 10 ? '#f59e0b' : '#94a3b8';
 
 html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.1)">';
 const scoreEmoji = d.dealScore >= 25 ? 'üî• ' : d.dealScore >= 15 ? 'üëç ' : 'üìä ';
 html += '<td style="padding:0.75rem"><span style="background:' + scoreColor + ';color:black;padding:0.25rem 0.5rem;border-radius:4px;font-weight:bold">' + scoreEmoji + d.dealScore + '</span></td>';
 html += '<td style="padding:0.75rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + d.address + '">' + d.address + '</td>';
 html += '<td style="padding:0.75rem;color:#6366f1">' + d.city + '</td>';
 html += '<td style="padding:0.75rem;text-align:right;color:#00E1E6;font-weight:600">' + formatPrice(d.price) + '</td>';
 html += '<td style="padding:0.75rem;text-align:right;color:#94a3b8">' + formatPrice(d.marketValue) + '</td>';
 html += '<td style="padding:0.75rem;text-align:right;color:#10b981;font-weight:bold">' + formatPrice(d.instantEquity) + '</td>';
 html += '<td style="padding:0.75rem;text-align:center;color:' + discountColor + ';font-weight:bold">' + d.discount + '%</td>';
 html += '<td style="padding:0.75rem;text-align:center">' + d.dom + '</td>';
 html += '<td style="padding:0.75rem;text-align:center">' + d.beds + '/' + d.baths + '</td>';
 html += '<td style="padding:0.75rem;text-align:center">' + d.sqft.toLocaleString() + '</td>';
 html += '<td style="padding:0.75rem;text-align:center"><button onclick="showHouseEval(' + idx + ')" style="background:#6366f1;border:none;color:white;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;font-size:0.75rem"> Eval</button> <a href="' + d.url + '" target="_blank" style="color:#6366f1;font-size:0.75rem">üîó</a></td>';
 html += '</tr>';
 });
 
 html += '</tbody></table>';
 if (deals.length > 50) {
 html += '<p style="color:#94a3b8;text-align:center;padding:1rem">Showing top 50 of ' + deals.length + ' deals. Export CSV for full list.</p>';
 }
 container.innerHTML = html;
 
 // Show contextual FSBO CTA when deals found
 const fsboCta = document.getElementById('houseFsboCta');
 if (fsboCta && deals.length > 0) fsboCta.style.display = 'block';
 }
 
 function showHouseEval(idx) {
 const house = window.houseDealsData[idx];
 const comps = window.houseCityComps[house.city] || [];
 const similarComps = comps.filter(c => c.sqft >= house.sqft * 0.7 && c.sqft <= house.sqft * 1.3).slice(0, 12);
 
 let compsHtml = '';
 similarComps.forEach(c => {
 compsHtml += '<a href="' + c.url + '" target="_blank" style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;text-decoration:none;display:block">';
 compsHtml += '<div style="color:#10b981;font-weight:600">' + formatPrice(c.price) + '</div>';
 compsHtml += '<div style="color:#94a3b8;font-size:0.75rem">' + c.sqft.toLocaleString() + ' sf ‚Ä¢ $' + Math.round(c.ppsf) + '/sf</div>';
 compsHtml += '<div style="color:#6366f1;font-size:0.7rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + c.address + '</div>';
 compsHtml += '</a>';
 });
 
 const modal = document.createElement('div');
 modal.id = 'houseEvalModal';
 modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center';
 modal.onclick = function() { modal.remove(); };
 
 modal.innerHTML = '<div style="background:#1e293b;padding:2rem;border-radius:16px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;position:relative" onclick="event.stopPropagation()">' +
 '<button onclick="document.getElementById(\'houseEvalModal\').remove()" style="position:absolute;top:15px;right:15px;background:#ef4444;border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;font-weight:bold;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,0.3);line-height:32px;text-align:center">‚úï</button>' +
 '<div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:1.5rem;gap:0.5rem">' +
 '<h2 style="color:#6366f1;margin:0"> House Deal Evaluation</h2>' +
 '</div>' +
 '<div style="background:rgba(99,102,241,0.2);padding:1rem;border-radius:12px;margin-bottom:1.5rem">' +
 '<h3 style="color:#e2e8f0;margin:0 0 0.5rem 0">' + house.address + ', ' + house.city + '</h3>' +
 '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;font-size:0.85rem">' +
 '<div><span style="color:#94a3b8">Ask Price:</span><br><strong style="color:#00E1E6">' + formatPrice(house.price) + '</strong></div>' +
 '<div><span style="color:#94a3b8">Size:</span><br><strong>' + house.sqft.toLocaleString() + ' sqft</strong></div>' +
 '<div><span style="color:#94a3b8">Beds/Baths:</span><br><strong>' + house.beds + ' / ' + house.baths + '</strong></div>' +
 '<div><span style="color:#94a3b8">Deal Score:</span><br><strong style="font-size:1.5rem">' + house.dealScore + '</strong></div>' +
 '</div>' +
 '<div style="margin-top:0.75rem"><a href="' + house.url + '" target="_blank" style="color:#6366f1">üîó View on Redfin</a></div>' +
 '</div>' +
 '<div style="background:rgba(99,102,241,0.15);padding:1.5rem;border-radius:12px;text-align:center;margin-bottom:1.5rem;border:2px solid #10b981">' +
 '<div style="color:#94a3b8;font-size:0.85rem;margin-bottom:0.5rem">Estimated Market Value</div>' +
 '<div style="color:#6366f1;font-size:1.5rem;font-weight:bold;margin-bottom:0.25rem">' + formatPrice(house.lowValue) + ' ‚àí ' + formatPrice(house.highValue) + '</div>' +
 '<div style="color:#64748b;font-size:0.75rem;margin-bottom:1rem">Based on ' + house.compCount + ' nearby sales ‚Ä¢ Median: $' + house.avgPpsf + '/sqft</div>' +
 '<div id="scenario-equity-' + idx + '" style="color:#10b981;font-size:2.5rem;font-weight:bold;margin:0.5rem 0">' + formatPrice(house.instantEquity) + ' Est. Equity</div>' +
 '<div style="color:#64748b;font-size:0.75rem">(Using median value ' + formatPrice(house.marketValue) + ' minus asking price)</div>' +
 '<div style="color:#f59e0b;font-size:1.1rem;margin-top:0.5rem">' + house.discount + '% below market ‚Ä¢ ' + house.dom + ' days listed</div>' +
 '<div style="margin-top:0.75rem;display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;font-size:0.8rem">' +
 '<div style="background:rgba(0,0,0,0.2);padding:0.5rem;border-radius:6px">Low Estimate<br><span style="color:#f87171">' + formatPrice(house.lowEquity) + ' equity</span></div>' +
 '<div style="background:rgba(0,0,0,0.2);padding:0.5rem;border-radius:6px">High Estimate<br><span style="color:#10b981">' + formatPrice(house.highEquity) + ' equity</span></div>' +
 '</div>' +
 '</div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Offer Strategy</h4>' +
 '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1.5rem">' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:12px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Fire Sale (95%)</div>' +
 '<div style="color:#f59e0b;font-size:1.3rem;font-weight:bold">' + formatPrice(Math.round(house.price * 0.95)) + '</div>' +
 '<div style="color:#10b981;font-size:0.8rem">‚Üí ' + formatPrice(house.marketValue - Math.round(house.price * 0.95)) + ' equity</div>' +
 '</div>' +
 '<div style="background:rgba(245,158,11,0.2);padding:1rem;border-radius:12px;text-align:center;border:2px solid #f59e0b">' +
 '<div style="color:#94a3b8;font-size:0.75rem">As-Is (90%)</div>' +
 '<div style="color:#f59e0b;font-size:1.3rem;font-weight:bold">' + formatPrice(Math.round(house.price * 0.90)) + '</div>' +
 '<div style="color:#10b981;font-size:0.8rem">‚Üí ' + formatPrice(house.marketValue - Math.round(house.price * 0.90)) + ' equity</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:12px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Aggressive (85%)</div>' +
 '<div style="color:#f59e0b;font-size:1.3rem;font-weight:bold">' + formatPrice(Math.round(house.price * 0.85)) + '</div>' +
 '<div style="color:#10b981;font-size:0.8rem">‚Üí ' + formatPrice(house.marketValue - Math.round(house.price * 0.85)) + ' equity</div>' +
 '</div>' +
 '</div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem">üèòÔ∏è Similar Comparable Sales (' + similarComps.length + ')</h4>' +
 '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.5rem;max-height:200px;overflow-y:auto">' +
 compsHtml +
 '</div>' +
 '<div style="margin-top:1.5rem;text-align:center">' +
 '<button onclick="showNeighborhood(' + idx + ')" style="background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem">üó∫Ô∏è Explore Neighborhood</button>' +
 '</div>' +
 '</div>';
 
 document.body.appendChild(modal);
 }
 
 // Neighborhood Exploration Feature
 function getDistance(lat1, lng1, lat2, lng2) {
 // Haversine formula for distance in miles
 const R = 3959; // Earth's radius in miles
 const dLat = (lat2 - lat1) * Math.PI / 180;
 const dLng = (lng2 - lng1) * Math.PI / 180;
 const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
 Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
 Math.sin(dLng/2) * Math.sin(dLng/2);
 const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
 return R * c;
 }
 
 // Fallback function when lat/lng missing - shows city-wide comps
 function showCityComps(city, titleNote) {
   const cityProps = rawData.properties.filter(p => p.city === city && p.price > 0);
   const soldProps = cityProps.filter(p => p.status === 'Sold' || p.soldDate);
   const houses = soldProps.filter(p => p.propertyType && !p.propertyType.includes('Land'));
   
   const avgPrice = houses.length ? Math.round(houses.reduce((a,p) => a + p.price, 0) / houses.length) : 0;
   const avgPpsf = houses.filter(p => p.sqft > 0).length 
     ? Math.round(houses.filter(p => p.sqft > 0).reduce((a,p) => a + (p.price / p.sqft), 0) / houses.filter(p => p.sqft > 0).length) 
     : 0;
   
   // Build HTML for top 15 recent sales
   const recentSales = houses.slice(0, 15);
   let salesHtml = recentSales.map(p => 
     `<a href="${p.url}" target="_blank" style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;text-decoration:none;display:block">
       <div style="display:flex;justify-content:space-between"><span style="color:#10b981;font-weight:600">${formatPrice(p.price)}</span><span style="color:#94a3b8;font-size:0.7rem">${p.sqft ? '$' + Math.round(p.price/p.sqft) + '/sf' : ''}</span></div>
       <div style="color:#94a3b8;font-size:0.75rem">${p.beds || '?'}bd/${p.baths || '?'}ba ‚Ä¢ ${p.sqft ? p.sqft.toLocaleString() + ' sf' : '?'}</div>
       <div style="color:#6366f1;font-size:0.7rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.address}</div>
     </a>`
   ).join('');
   
   const modal = document.createElement('div');
   modal.id = 'cityCompsModal';
   modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1001;display:flex;align-items:center;justify-content:center';
   modal.onclick = () => modal.remove();
   
   modal.innerHTML = `<div style="background:#1e293b;padding:2rem;border-radius:16px;max-width:700px;width:95%;max-height:90vh;overflow-y:auto" onclick="event.stopPropagation()">
     <button onclick="this.closest('#cityCompsModal').remove()" style="position:absolute;top:15px;right:15px;background:#ef4444;border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem">‚úï</button>
     <h2 style="color:#f59e0b;margin:0 0 0.5rem 0">üìç ${city} Market Data</h2>
     <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1.5rem">${titleNote}</p>
     
     <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem">
       <div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">
         <div style="color:#94a3b8;font-size:0.75rem">Total Sold</div>
         <div style="color:#10b981;font-size:1.5rem;font-weight:bold">${houses.length}</div>
       </div>
       <div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">
         <div style="color:#94a3b8;font-size:0.75rem">Avg Price</div>
         <div style="color:#00E1E6;font-size:1.5rem;font-weight:bold">${avgPrice ? formatPrice(avgPrice) : 'N/A'}</div>
       </div>
       <div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">
         <div style="color:#94a3b8;font-size:0.75rem">Avg $/SqFt</div>
         <div style="color:#f59e0b;font-size:1.5rem;font-weight:bold">${avgPpsf ? '$' + avgPpsf : 'N/A'}</div>
       </div>
     </div>
     
     <h4 style="color:#6366f1;margin-bottom:0.75rem">üè† Recent Sales in ${city}</h4>
     <div style="display:grid;gap:0.5rem;max-height:350px;overflow-y:auto">${salesHtml || '<p style="color:#94a3b8">No sales data available</p>'}</div>
   </div>`;
   
   document.body.appendChild(modal);
 }
 
 // Scenario Toggle Handler
 function setScenario(idx, scenario) {
 const house = window.houseDealsData[idx];
 if (!house) return;
 
 const scenarios = {
 worst: {
 value: house.worstValue,
 equity: house.worstEquity,
 label: 'Fire Sale',
 desc: '20th percentile ‚àí 15% (distressed sale)',
 color: '#ef4444',
 icon: 'üî•'
 },
 conservative: {
 value: house.marketValue,
 equity: house.instantEquity,
 label: 'As-Is',
 desc: '20th percentile ‚àí 10% (no renovations)',
 color: '#10b981',
 icon: 'üè†'
 },
 expected: {
 value: house.expectedValue,
 equity: house.expectedEquity,
 label: 'Minor Updates',
 desc: '25th percentile ‚àí 10% (paint, floors)',
 color: '#818cf8',
 icon: 'üîß'
 },
 best: {
 value: house.bestValue,
 equity: house.bestEquity,
 label: 'Renovated',
 desc: '33rd percentile ‚àí 6% (full reno)',
 color: '#f59e0b',
 icon: '‚ú®'
 }
 };
 
 const s = scenarios[scenario];
 
 // Update display
 document.getElementById('scenario-label-' + idx).innerHTML = 
 s.label + ' Value: <strong style="color:' + s.color + '">' + formatPrice(s.value) + '</strong>';
 document.getElementById('scenario-equity-' + idx).innerHTML = 
 '<span style="color:' + s.color + '">' + formatPrice(s.equity) + '</span> Est. Equity';
 document.getElementById('scenario-desc-' + idx).textContent = '(' + s.desc + ')';
 
 // Update button styles
 ['worst', 'conservative', 'expected', 'best'].forEach(sc => {
 const btn = document.getElementById('btn-' + sc + '-' + idx);
 if (btn) {
 const isActive = sc === scenario;
 btn.style.fontWeight = isActive ? 'bold' : 'normal';
 btn.style.borderWidth = isActive ? '2px' : '1px';
 btn.style.background = isActive ? 
 'rgba(' + (sc === 'worst' ? '239,68,68' : sc === 'conservative' ? '16,185,129' : sc === 'expected' ? '59,130,246' : '245,158,11') + ',0.3)' :
 'rgba(' + (sc === 'worst' ? '239,68,68' : sc === 'conservative' ? '16,185,129' : sc === 'expected' ? '59,130,246' : '245,158,11') + ',0.1)';
 }
 });
 }
 
 function getNearbyProperties(lat, lng, radiusMiles, excludeAddress) {
 if (!lat || !lng) return [];
 return rawData.properties.filter(p => {
 if (!p.lat || !p.lng) return false;
 if (p.address === excludeAddress) return false;
 const dist = getDistance(lat, lng, p.lat, p.lng);
 return dist <= radiusMiles;
 }).map(p => ({
 ...p,
 distance: getDistance(lat, lng, p.lat, p.lng)
 })).sort((a, b) => a.distance - b.distance);
 }
 
 function showNeighborhood(idx) {
 const house = window.houseDealsData[idx];
 if (!house.lat || !house.lng) {
 // Fall back to city-level view with message
 showCityComps(house.city, house.address + ' (No coordinates - showing city-wide data)');
 return;
 }
 
 // Get nearby properties (0.5 mile radius)
 const nearby = getNearbyProperties(house.lat, house.lng, 0.5, house.address);
 
 // Separate sold vs active
 const nearbySold = nearby.filter(p => p.saleType === 'PAST SALE' || p.status === 'Sold' || p.soldDate);
 const nearbyActive = nearby.filter(p => p.status === 'For Sale' || p.saleType === 'MLS Listing');
 
 // Calculate neighborhood stats
 const soldPrices = nearbySold.map(p => p.price).filter(p => p > 0);
 const avgPrice = soldPrices.length ? Math.round(soldPrices.reduce((a,b) => a+b, 0) / soldPrices.length) : 0;
 const medianPrice = soldPrices.length ? soldPrices.sort((a,b) => a-b)[Math.floor(soldPrices.length/2)] : 0;
 const avgPpsf = nearbySold.filter(p => p.sqft > 0).length ? 
 Math.round(nearbySold.filter(p => p.sqft > 0).reduce((a,p) => a + (p.price / p.sqft), 0) / nearbySold.filter(p => p.sqft > 0).length) : 0;
 
 // Price trend - group by month
 const priceTrend = {};
 nearbySold.filter(p => p.soldDate).forEach(p => {
 const month = p.soldDate.substring(0, 7); // YYYY-MM
 if (!priceTrend[month]) priceTrend[month] = [];
 priceTrend[month].push(p.price);
 });
 const trendLabels = Object.keys(priceTrend).sort().slice(-12);
 const trendData = trendLabels.map(m => Math.round(priceTrend[m].reduce((a,b)=>a+b,0) / priceTrend[m].length));
 
 // Build nearby properties HTML
 let nearbyHtml = '';
 nearby.slice(0, 15).forEach(p => {
 const isSold = p.saleType === 'PAST SALE' || p.status === 'Sold';
 const statusColor = isSold ? '#10b981' : '#6366f1';
 const statusText = isSold ? 'SOLD' : 'FOR SALE';
 nearbyHtml += '<a href="' + p.url + '" target="_blank" style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;text-decoration:none;display:block">';
 nearbyHtml += '<div style="display:flex;justify-content:space-between;align-items:center">';
 nearbyHtml += '<span style="color:' + statusColor + ';font-weight:600">' + formatPrice(p.price) + '</span>';
 nearbyHtml += '<span style="color:#94a3b8;font-size:0.7rem">' + (p.distance * 5280).toFixed(0) + ' ft</span>';
 nearbyHtml += '</div>';
 nearbyHtml += '<div style="color:#94a3b8;font-size:0.75rem">' + (p.beds || '?') + 'bd/' + (p.baths || '?') + 'ba ‚Ä¢ ' + (p.sqft ? p.sqft.toLocaleString() : '?') + ' sf</div>';
 nearbyHtml += '<div style="color:#6366f1;font-size:0.7rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + p.address + '</div>';
 nearbyHtml += '<div style="font-size:0.65rem;color:' + statusColor + '">' + statusText + (p.soldDate ? ' ' + p.soldDate : '') + '</div>';
 nearbyHtml += '</a>';
 });
 
 // Close previous modal if exists
 const prevModal = document.getElementById('houseEvalModal');
 if (prevModal) prevModal.remove();
 
 const modal = document.createElement('div');
 modal.id = 'neighborhoodModal';
 modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1001;display:flex;align-items:center;justify-content:center';
 modal.onclick = function() { modal.remove(); };
 
 modal.innerHTML = '<div style="background:#1e293b;padding:2rem;border-radius:16px;max-width:900px;width:95%;max-height:95vh;overflow-y:auto;position:relative" onclick="event.stopPropagation()">' +
 '<button onclick="document.getElementById(\'neighborhoodModal\').remove()" style="position:absolute;top:15px;right:15px;background:#ef4444;border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;font-weight:bold;z-index:10;line-height:32px;text-align:center">‚úï</button>' +
 '<h2 style="color:#6366f1;margin:0 0 1rem 0">üó∫Ô∏è Neighborhood Explorer</h2>' +
 '<div style="background:rgba(99,102,241,0.2);padding:1rem;border-radius:12px;margin-bottom:1.5rem">' +
 '<h3 style="color:#e2e8f0;margin:0 0 0.25rem 0">' + house.address + ', ' + house.city + '</h3>' +
 '<div style="color:#94a3b8;font-size:0.9rem"> Showing properties within 0.5 miles (' + nearby.length + ' found)</div>' +
 '</div>' +
 
 '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem">' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Nearby Sold</div>' +
 '<div style="color:#10b981;font-size:1.5rem;font-weight:bold">' + nearbySold.length + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Avg Sale Price</div>' +
 '<div style="color:#00E1E6;font-size:1.5rem;font-weight:bold">' + (avgPrice ? formatPrice(avgPrice) : 'N/A') + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Avg $/SqFt</div>' +
 '<div style="color:#f59e0b;font-size:1.5rem;font-weight:bold">' + (avgPpsf ? '$' + avgPpsf : 'N/A') + '</div>' +
 '</div>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1rem;border-radius:10px;text-align:center">' +
 '<div style="color:#94a3b8;font-size:0.75rem">Active Listings</div>' +
 '<div style="color:#6366f1;font-size:1.5rem;font-weight:bold">' + nearbyActive.length + '</div>' +
 '</div>' +
 '</div>' +
 
 (trendLabels.length > 2 ? 
 '<div style="margin-bottom:1.5rem">' +
 '<h4 style="color:#6366f1;margin-bottom:0.5rem"> Neighborhood Price Trend</h4>' +
 '<div style="height:150px;position:relative"><canvas id="neighborhoodTrendChart"></canvas></div>' +
 '</div>' : '') +
 
 '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">' +
 '<div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Nearby Properties (' + nearby.length + ')</h4>' +
 '<div style="display:grid;gap:0.5rem;max-height:350px;overflow-y:auto">' +
 nearbyHtml +
 '</div>' +
 '</div>' +
 '<div>' +
 '<h4 style="color:#6366f1;margin-bottom:0.75rem"> Your Property vs Neighborhood</h4>' +
 '<div style="background:rgba(0,0,0,0.3);padding:1.25rem;border-radius:12px">' +
 '<div style="display:grid;gap:0.75rem">' +
 '<div style="display:flex;justify-content:space-between;padding-bottom:0.5rem;border-bottom:1px solid rgba(255,255,255,0.1)">' +
 '<span style="color:#94a3b8">Your Ask Price:</span>' +
 '<span style="color:#00E1E6;font-weight:600">' + formatPrice(house.price) + '</span>' +
 '</div>' +
 '<div style="display:flex;justify-content:space-between">' +
 '<span style="color:#94a3b8">Neighborhood Avg:</span>' +
 '<span style="color:#10b981;font-weight:600">' + (avgPrice ? formatPrice(avgPrice) : 'N/A') + '</span>' +
 '</div>' +
 '<div style="display:flex;justify-content:space-between">' +
 '<span style="color:#94a3b8">Difference:</span>' +
 '<span style="color:' + (house.price < avgPrice ? '#10b981' : '#f59e0b') + ';font-weight:600">' + 
 (avgPrice ? (house.price < avgPrice ? '‚Üì ' : '‚Üë ') + formatPrice(Math.abs(house.price - avgPrice)) + ' (' + Math.round(((house.price - avgPrice) / avgPrice) * 100) + '%)' : 'N/A') +
 '</span>' +
 '</div>' +
 '<div style="display:flex;justify-content:space-between;padding-top:0.5rem;border-top:1px solid rgba(255,255,255,0.1)">' +
 '<span style="color:#94a3b8">Your $/SqFt:</span>' +
 '<span style="color:#f59e0b;font-weight:600">$' + house.ppsf + '</span>' +
 '</div>' +
 '<div style="display:flex;justify-content:space-between">' +
 '<span style="color:#94a3b8">Neighborhood Avg:</span>' +
 '<span style="color:#10b981;font-weight:600">' + (avgPpsf ? '$' + avgPpsf : 'N/A') + '</span>' +
 '</div>' +
 '</div>' +
 '</div>' +
 
 '<h4 style="color:#6366f1;margin:1.25rem 0 0.75rem"> Verdict</h4>' +
 '<div style="background:' + (house.price < avgPrice ? 'rgba(16,185,129,0.2)' : 'rgba(245,158,11,0.2)') + ';padding:1rem;border-radius:12px;border:2px solid ' + (house.price < avgPrice ? '#10b981' : '#f59e0b') + '">' +
 '<div style="font-size:1.2rem;font-weight:bold;color:' + (house.price < avgPrice ? '#10b981' : '#f59e0b') + '">' +
 (house.price < avgPrice ? ' Below Neighborhood Average' : ' Above Neighborhood Average') +
 '</div>' +
 '<div style="color:#94a3b8;font-size:0.9rem;margin-top:0.5rem">' +
 (avgPrice && nearbySold.length >= 3 ? 
 'Based on ' + nearbySold.length + ' recent sales within 0.5 miles. ' +
 (house.price < avgPrice ? 'This property appears competitively priced.' : 'Consider negotiating or comparing with similar homes.')
 : 'Limited nearby sales data. Consider checking comparable properties in ' + house.city + '.') +
 '</div>' +
 '</div>' +
 '</div>' +
 '</div>' +
 '</div>';
 
 document.body.appendChild(modal);
 
 // Render price trend chart if we have data
 if (trendLabels.length > 2) {
 setTimeout(() => {
 const ctx = document.getElementById('neighborhoodTrendChart');
 if (ctx) {
 new Chart(ctx, {
 type: 'line',
 data: {
 labels: trendLabels.map(l => l.substring(5)), // Just show MM
 datasets: [{
 label: 'Avg Sale Price',
 data: trendData,
 borderColor: '#10b981',
 backgroundColor: 'rgba(16,185,129,0.1)',
 fill: true,
 tension: 0.3
 }]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: { legend: { display: false } },
 scales: {
 y: { 
 ticks: { 
 callback: v => '$' + (v/1000).toFixed(0) + 'K',
 color: '#94a3b8'
 },
 grid: { color: 'rgba(255,255,255,0.1)' }
 },
 x: { 
 ticks: { color: '#94a3b8' },
 grid: { color: 'rgba(255,255,255,0.1)' }
 }
 }
 }
 });
 }
 }, 100);
 }
 }
 
 function exportHouseDealsCSV() {
 if (!window.houseDealsData || window.houseDealsData.length === 0) {
 alert('No house deals to export');
 return;
 }
 const headers = ['Deal Score','Address','City','Ask Price','Market Value','Instant Equity','Discount %','DOM','Beds','Baths','SqFt','$/SqFt','Avg $/SqFt','Comps','URL'];
 const rows = window.houseDealsData.map(h => [
 h.dealScore, h.address, h.city, h.price, h.marketValue, h.instantEquity, h.discount, 
 h.dom, h.beds, h.baths, h.sqft, h.ppsf, h.avgPpsf, h.compCount, h.url
 ]);
 const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
 const blob = new Blob([csv], { type: 'text/csv' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'ri-house-deals.csv';
 a.click();
 }
 
 // Land deals, house hunter, and heatmap initialized after data loads (see loadPropertyData().then())
 
 // City Price Heatmap
 function initCityHeatmap() {
 const container = document.getElementById('cityHeatmap');
 if (!container) return;
 
 // Calculate median price per city (sold properties only)
 const cityPrices = {};
 rawData.properties.filter(p => p.saleType === 'PAST SALE' || p.status === 'Sold' || p.soldDate).forEach(p => {
 if (!cityPrices[p.city]) cityPrices[p.city] = [];
 cityPrices[p.city].push(p.price);
 });
 
 // Get median for each city
 const cityData = Object.entries(cityPrices).map(([city, prices]) => {
 prices.sort((a, b) => a - b);
 const mid = Math.floor(prices.length / 2);
 const median = prices.length % 2 ? prices[mid] : (prices[mid - 1] + prices[mid]) / 2;
 return { city, median, count: prices.length };
 }).filter(c => c.count >= 5).sort((a, b) => b.median - a.median);
 
 // Color function
 const getColor = (price) => {
 if (price >= 800000) return { bg: 'rgba(139,92,246,0.4)', border: '#6366f1', text: '#c4b5fd' };
 if (price >= 600000) return { bg: 'rgba(236,72,153,0.4)', border: '#00E1E6', text: '#f9a8d4' };
 if (price >= 400000) return { bg: 'rgba(245,158,11,0.4)', border: '#f59e0b', text: '#fcd34d' };
 return { bg: 'rgba(16,185,129,0.4)', border: '#10b981', text: '#6ee7b7' };
 };
 
 container.innerHTML = cityData.map(c => {
 const color = getColor(c.median);
 return `<div onclick="window.location.href='city-detail.html?city=${encodeURIComponent(c.city)}';" 
 style="background:${color.bg};border:1px solid ${color.border};border-radius:8px;padding:0.75rem;text-align:center;cursor:pointer;transition:transform 0.2s"
 onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
 <div style="color:${color.text};font-weight:700;font-size:1rem">${c.median >= 1000000 ? '$' + (c.median/1000000).toFixed(1) + 'M' : '$' + Math.round(c.median/1000) + 'K'}</div>
 <div style="color:#e2e8f0;font-size:0.8rem;margin-top:0.25rem">${c.city}</div>
 <div style="color:#64748b;font-size:0.7rem">${c.count} sales</div>
 </div>`;
 }).join('');
 }
 
 // CHARTS - Initialize after DOM ready
 function initCharts() {
 try {
 const chartColors = { purple: '#6366f1', pink: '#00E1E6', green: '#10b981', amber: '#f59e0b', cyan: '#06b6d4' };
 const chartOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } } } };
 
 // Monthly trend - compute from properties if not in summary
 const monthly = rawData.summary.monthlyTrends || (() => {
 const monthNum = { 'January':1, 'February':2, 'March':3, 'April':4, 'May':5, 'June':6, 
 'July':7, 'August':8, 'September':9, 'October':10, 'November':11, 'December':12 };
 const byMonth = {};
 rawData.properties.filter(p => p.soldDate && p.soldDate.length > 0).forEach(p => {
 const parts = p.soldDate.split('-');
 if (parts.length === 3 && monthNum[parts[0]]) {
 const key = parts[2] + '-' + String(monthNum[parts[0]]).padStart(2, '0');
 if (!byMonth[key]) byMonth[key] = { count: 0, total: 0 };
 byMonth[key].count++;
 byMonth[key].total += p.price || 0;
 }
 });
 return Object.entries(byMonth).sort((a,b) => a[0].localeCompare(b[0]))
 .map(([month, d]) => ({ month, sales: d.count, avgPrice: Math.round(d.total / d.count) }));
 })();
 new Chart(document.getElementById('trendChart'), {
 type: 'line',
 data: { labels: monthly.map(m => m.month), datasets: [
 { label: 'Sales', data: monthly.map(m => m.sales), borderColor: chartColors.purple, backgroundColor: 'rgba(99,102,241,0.2)', fill: true, tension: 0.4, yAxisID: 'y' },
 { label: 'Avg Price ($K)', data: monthly.map(m => Math.round(m.avgPrice/1000)), borderColor: chartColors.pink, borderDash: [5,5], tension: 0.4, yAxisID: 'y1' }
 ]},
 options: { ...chartOpts, scales: { ...chartOpts.scales, y1: { position: 'right', grid: { display: false }, ticks: { color: '#00E1E6' } } } }
 });
 
 // City charts - compute from properties
 const cityStats = {};
 rawData.properties.forEach(p => {
   if (!cityStats[p.city]) cityStats[p.city] = { count: 0, prices: [], landCount: 0 };
   cityStats[p.city].count++;
   if (p.price > 0) cityStats[p.city].prices.push(p.price);
   if (p.propertyType && p.propertyType.includes('Land')) cityStats[p.city].landCount++;
 });
 const cityData = Object.entries(cityStats)
   .map(([city, s]) => ({
     city,
     count: s.count,
     medianPrice: s.prices.length ? s.prices.sort((a,b)=>a-b)[Math.floor(s.prices.length/2)] : 0,
     landCount: s.landCount
   }))
   .sort((a,b) => b.count - a.count)
   .slice(0, 15);
 // Store for later use
 window.computedCityStats = cityStats;
 
 new Chart(document.getElementById('cityChart'), { type: 'bar', data: { labels: cityData.map(c => c.city), datasets: [{ data: cityData.map(c => c.count), backgroundColor: cityData.map((_,i) => `hsl(${250+i*7},70%,60%)`), borderRadius: 6 }] }, options: { indexAxis: 'y', ...chartOpts, plugins: { legend: { display: false } } } });
 new Chart(document.getElementById('priceChart'), { type: 'bar', data: { labels: cityData.map(c => c.city), datasets: [{ data: cityData.map(c => Math.round(c.medianPrice/1000)), backgroundColor: cityData.map((_,i) => `hsl(${330+i*5},70%,55%)`), borderRadius: 6 }] }, options: { indexAxis: 'y', ...chartOpts, plugins: { legend: { display: false } }, scales: { ...chartOpts.scales, x: { ...chartOpts.scales.x, ticks: { ...chartOpts.scales.x.ticks, callback: v => '$'+v+'K' } } } } });
 
 // Price histogram
 const priceRanges = ['<$300K', '$300-400K', '$400-500K', '$500-600K', '$600-750K', '$750K-1M', '$1M+'];
 const priceBuckets = [0,0,0,0,0,0,0];
 rawData.properties.forEach(p => {
 if (p.price < 300000) priceBuckets[0]++;
 else if (p.price < 400000) priceBuckets[1]++;
 else if (p.price < 500000) priceBuckets[2]++;
 else if (p.price < 600000) priceBuckets[3]++;
 else if (p.price < 750000) priceBuckets[4]++;
 else if (p.price < 1000000) priceBuckets[5]++;
 else priceBuckets[6]++;
 });
 new Chart(document.getElementById('histogramChart'), { type: 'bar', data: { labels: priceRanges, datasets: [{ data: priceBuckets, backgroundColor: [chartColors.cyan, chartColors.green, chartColors.green, chartColors.amber, chartColors.amber, chartColors.pink, chartColors.purple], borderRadius: 6 }] }, options: { ...chartOpts, plugins: { legend: { display: false } } } });
 
 // Price per sqft by city
 const ppsqft = {};
 rawData.properties.filter(p => p.sqft > 0).forEach(p => { if (!ppsqft[p.city]) ppsqft[p.city] = []; ppsqft[p.city].push(p.price / p.sqft); });
 const ppsqftData = Object.entries(ppsqft).map(([city, vals]) => ({ city, avg: vals.reduce((a,b)=>a+b,0)/vals.length })).sort((a,b) => b.avg - a.avg).slice(0, 12);
 new Chart(document.getElementById('ppsqftChart'), { type: 'bar', data: { labels: ppsqftData.map(d => d.city), datasets: [{ data: ppsqftData.map(d => Math.round(d.avg)), backgroundColor: chartColors.green, borderRadius: 6 }] }, options: { indexAxis: 'y', ...chartOpts, plugins: { legend: { display: false } }, scales: { ...chartOpts.scales, x: { ...chartOpts.scales.x, ticks: { ...chartOpts.scales.x.ticks, callback: v => '$'+v } } } } });
 
 // Property type
 const types = {};
 rawData.properties.forEach(p => { const t = p.propertyType.split(' ')[0]; types[t] = (types[t]||0) + 1; });
 const typeData = Object.entries(types).sort((a,b) => b[1] - a[1]).slice(0, 6);
 new Chart(document.getElementById('typeChart'), { type: 'doughnut', data: { labels: typeData.map(t => t[0]), datasets: [{ data: typeData.map(t => t[1]), backgroundColor: [chartColors.purple, chartColors.pink, chartColors.green, chartColors.amber, chartColors.cyan, '#6366f1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '50%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 12, padding: 8, font: { size: 11 } } } } } });
 
 // DOM by price range
 const domByPrice = { '<$300K': [], '$300-500K': [], '$500-750K': [], '$750K-1M': [], '$1M+': [] };
 rawData.properties.filter(p => p.dom > 0).forEach(p => {
 if (p.price < 300000) domByPrice['<$300K'].push(p.dom);
 else if (p.price < 500000) domByPrice['$300-500K'].push(p.dom);
 else if (p.price < 750000) domByPrice['$500-750K'].push(p.dom);
 else if (p.price < 1000000) domByPrice['$750K-1M'].push(p.dom);
 else domByPrice['$1M+'].push(p.dom);
 });
 const domAvg = Object.entries(domByPrice).map(([k,v]) => ({ range: k, avg: v.length ? Math.round(v.reduce((a,b)=>a+b,0)/v.length) : 0 }));
 new Chart(document.getElementById('domChart'), { type: 'bar', data: { labels: domAvg.map(d => d.range), datasets: [{ data: domAvg.map(d => d.avg), backgroundColor: [chartColors.cyan, chartColors.green, chartColors.amber, chartColors.pink, chartColors.purple], borderRadius: 6 }] }, options: { ...chartOpts, plugins: { legend: { display: false } } } });
 
 // Bedrooms
 const beds = {};
 rawData.properties.filter(p => p.beds != null && p.beds >= 0).forEach(p => { const b = p.beds > 5 ? '6+' : p.beds.toString(); beds[b] = (beds[b]||0) + 1; });
 new Chart(document.getElementById('bedsChart'), { type: 'bar', data: { labels: ['0','1','2','3','4','5','6+'], datasets: [{ data: ['0','1','2','3','4','5','6+'].map(b => beds[b]||0), backgroundColor: chartColors.purple, borderRadius: 6 }] }, options: { ...chartOpts, plugins: { legend: { display: false } } } });
 
 // Year built
 const decades = { 'Pre-1900': 0, '1900-1950': 0, '1950-1980': 0, '1980-2000': 0, '2000-2010': 0, '2010-2020': 0, '2020+': 0 };
 rawData.properties.filter(p => p.yearBuilt > 0).forEach(p => {
 if (p.yearBuilt < 1900) decades['Pre-1900']++;
 else if (p.yearBuilt < 1950) decades['1900-1950']++;
 else if (p.yearBuilt < 1980) decades['1950-1980']++;
 else if (p.yearBuilt < 2000) decades['1980-2000']++;
 else if (p.yearBuilt < 2010) decades['2000-2010']++;
 else if (p.yearBuilt < 2020) decades['2010-2020']++;
 else decades['2020+']++;
 });
 new Chart(document.getElementById('yearBuiltChart'), { type: 'bar', data: { labels: Object.keys(decades), datasets: [{ data: Object.values(decades), backgroundColor: chartColors.amber, borderRadius: 6 }] }, options: { ...chartOpts, plugins: { legend: { display: false } } } });
 
 // Sqft distribution
 const sqftRanges = { '<1000': 0, '1000-1500': 0, '1500-2000': 0, '2000-2500': 0, '2500-3000': 0, '3000+': 0 };
 rawData.properties.filter(p => p.sqft > 0).forEach(p => {
 if (p.sqft < 1000) sqftRanges['<1000']++;
 else if (p.sqft < 1500) sqftRanges['1000-1500']++;
 else if (p.sqft < 2000) sqftRanges['1500-2000']++;
 else if (p.sqft < 2500) sqftRanges['2000-2500']++;
 else if (p.sqft < 3000) sqftRanges['2500-3000']++;
 else sqftRanges['3000+']++;
 });
 new Chart(document.getElementById('sqftChart'), { type: 'bar', data: { labels: Object.keys(sqftRanges), datasets: [{ data: Object.values(sqftRanges), backgroundColor: chartColors.pink, borderRadius: 6 }] }, options: { ...chartOpts, plugins: { legend: { display: false } } } });
 
 // Land by city
 // Use computed city stats for land chart
 const landCities = Object.entries(window.computedCityStats || cityStats || {})
   .map(([city, s]) => ({ city, landCount: s.landCount }))
   .filter(c => c.landCount > 0)
   .sort((a,b) => b.landCount - a.landCount)
   .slice(0, 10);
 new Chart(document.getElementById('landChart'), { type: 'bar', data: { labels: landCities.map(c => c.city), datasets: [{ data: landCities.map(c => c.landCount), backgroundColor: chartColors.green, borderRadius: 6 }] }, options: { ...chartOpts, plugins: { legend: { display: false } } } });
 } catch(e) { console.error('Chart init error:', e); }
 }
 // Charts initialized after data loads (see loadPropertyData().then())
 </script>
 <script>
 // Add click handlers to existing charts after page loads
 document.addEventListener('DOMContentLoaded', function() {
 setTimeout(function() {
 // Get chart instances
 const charts = Chart.instances;
 
 Object.values(charts).forEach(chart => {
 const canvas = chart.canvas;
 const chartId = canvas.id;
 
 canvas.style.cursor = 'pointer';
 
 function handleChartClick(evt) {
 // Handle both mouse and touch events
 const event = evt.touches ? evt.touches[0] : evt;
 const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
 if (points.length === 0) return;
 
 const idx = points[0].index;
 const label = chart.data.labels[idx];
 
 let filterType = '';
 let filterValue = label;
 
 if (chartId === 'cityChart' || chartId === 'priceChart' || chartId === 'ppsqftChart') {
 filterType = 'city';
 } else if (chartId === 'histogramChart') {
 filterType = 'price';
 } else if (chartId === 'bedsChart') {
 filterType = 'beds';
 } else if (chartId === 'landChart') {
 filterType = 'land';
 } else if (chartId === 'domChart' || chartId === 'yearBuiltChart') {
 filterType = 'year';
 } else if (chartId === 'typeChart') {
 filterType = 'type';
 }
 
 if (filterType) {
 window.location.href = `ri-results.html?type=${encodeURIComponent(filterType)}&value=${encodeURIComponent(filterValue)}`;
 }
 }
 
 canvas.addEventListener('click', handleChartClick);
 canvas.addEventListener('touchend', function(evt) {
 evt.preventDefault();
 handleChartClick(evt);
 }, { passive: false });
 });
 
 console.log(' Click handlers added to charts');
 }, 1000); // Wait for charts to initialize
 });
 
 // Assessment Data Rendering
 document.addEventListener('DOMContentLoaded', function() {
 const assessData = [{"n":"Providence","c":44372,"a":874137,"s":0,"y":0,"b":0,"sp":0,"ws":0},{"n":"Cranston","c":31442,"a":133570,"s":2154,"y":1926,"b":3.7,"sp":296722,"ws":3820},{"n":"Cumberland","c":14889,"a":0,"s":2038,"y":1962,"b":3.3,"sp":275356,"ws":10679},{"n":"South Kingstown","c":12701,"a":0,"s":0,"y":0,"b":0,"sp":0,"ws":0},{"n":"Coventry","c":11581,"a":351095,"s":2074,"y":1749,"b":2.5,"sp":353014,"ws":6997},{"n":"Woonsocket","c":10167,"a":86056,"s":2811,"y":1920,"b":4.8,"sp":301554,"ws":1426},{"n":"North Kingstown","c":10061,"a":0,"s":0,"y":0,"b":0,"sp":0,"ws":0},{"n":"Tiverton","c":8429,"a":486745,"s":1838,"y":1647,"b":2.8,"sp":337800,"ws":5408},{"n":"Portsmouth","c":8135,"a":0,"s":0,"y":0,"b":0,"sp":0,"ws":0},{"n":"Smithfield","c":7616,"a":81,"s":2011,"y":1953,"b":3,"sp":438135,"ws":3014},{"n":"Bristol","c":6774,"a":414102,"s":2600,"y":1669,"b":2.7,"sp":435313,"ws":2922},{"n":"Charlestown","c":5873,"a":0,"s":1486,"y":1976,"b":2.9,"sp":334361,"ws":3940},{"n":"Middletown","c":5701,"a":0,"s":2492,"y":1963,"b":3.2,"sp":729640,"ws":1504},{"n":"Scituate","c":4794,"a":524940,"s":2390,"y":1669,"b":2.6,"sp":229782,"ws":2944},{"n":"Burrillville","c":4761,"a":413904,"s":2380,"y":1654,"b":2.6,"sp":296863,"ws":2559},{"n":"Barrington","c":4130,"a":549412,"s":2390,"y":1827,"b":3,"sp":546245,"ws":2435},{"n":"Lincoln","c":3990,"a":161885,"s":2563,"y":1939,"b":3.5,"sp":281078,"ws":3990},{"n":"Exeter","c":3115,"a":0,"s":1621,"y":1978,"b":2.9,"sp":283221,"ws":3106},{"n":"Little Compton","c":2939,"a":0,"s":1826,"y":1956,"b":3.4,"sp":755024,"ws":680},{"n":"Foster","c":2329,"a":124497,"s":1458,"y":1955,"b":3,"sp":286846,"ws":2326},{"n":"Westerly","c":1610,"a":160191,"s":1859,"y":1967,"b":3.3,"sp":256864,"ws":1610},{"n":"Jamestown","c":1057,"a":1296142,"s":2263,"y":1537,"b":2.2,"sp":854592,"ws":416},{"n":"Johnston","c":672,"a":0,"s":1917,"y":1944,"b":3.3,"sp":225356,"ws":672},{"n":"Hopkinton","c":407,"a":0,"s":2067,"y":1967,"b":2.9,"sp":340813,"ws":407},{"n":"Pawtucket","c":80,"a":144490,"s":1204,"y":1948,"b":2.9,"sp":174419,"ws":80},{"n":"New Shoreham","c":50,"a":1153003,"s":1049,"y":1955,"b":3.2,"sp":967408,"ws":50},{"n":"Warren","c":25,"a":351244,"s":1687,"y":1918,"b":2.1,"sp":240500,"ws":14}];
 
 const grid = document.getElementById('assessmentGrid');
 if (!grid) return;
 
 grid.innerHTML = assessData.map(t => {
 const avgAss = t.a > 0 ? '$' + (t.a/1000).toFixed(0) + 'K' : 'N/A';
 const avgSale = t.sp > 0 ? '$' + (t.sp/1000).toFixed(0) + 'K' : 'N/A';
 const color = t.a > 500000 ? '#6366f1' : t.a > 300000 ? '#00E1E6' : t.a > 100000 ? '#f59e0b' : '#10b981';
 return '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:0.75rem">' +
 '<div style="font-weight:600;color:#e2e8f0;margin-bottom:0.25rem">' + t.n + '</div>' +
 '<div style="font-size:0.75rem;color:#94a3b8">' + t.c.toLocaleString() + ' properties</div>' +
 '<div style="display:flex;gap:0.5rem;margin-top:0.5rem;font-size:0.7rem">' +
 '<span style="color:' + color + '">Avg: ' + avgAss + '</span>' +
 (t.s > 0 ? '<span style="color:#6366f1">' + t.s.toLocaleString() + ' sqft</span>' : '') +
 '</div>' +
 (t.sp > 0 ? '<div style="font-size:0.7rem;color:#94a3b8;margin-top:0.25rem">Avg sale: ' + avgSale + '</div>' : '') +
 '</div>';
 }).join('');
 
 // Populate assessment city dropdown
 const assessCities = assessData.map(t => t.n).sort();
 const assessCitySel = document.getElementById('assessCity');
 if (assessCitySel) {
 assessCities.forEach(c => {
 const opt = document.createElement('option');
 opt.value = c;
 opt.textContent = c;
 assessCitySel.appendChild(opt);
 });
 }
 });
 
 // Insight Card Hover Charts (Desktop Only)
 let insightChart = null;
 let insightChartData = {};
 
 function updateInsightChartData(topCities, fastestCities) {
   const colors = ['#10b981', '#6366f1', '#f59e0b', '#00E1E6', '#6366f1'];
   
   // Build yearly price data for top cities
   const yearlyData = {};
   const currentYear = new Date().getFullYear();
   const years = [currentYear-4, currentYear-3, currentYear-2, currentYear-1, currentYear];
   
   topCities.forEach(c => {
     yearlyData[c.city] = {};
     years.forEach(y => yearlyData[c.city][y] = []);
   });
   
   rawData.properties.filter(p => p.soldDate && p.price > 50000).forEach(p => {
     const year = parseInt(p.soldDate.split('-').pop());
     if (yearlyData[p.city] && yearlyData[p.city][year]) {
       yearlyData[p.city][year].push(p.price);
     }
   });
   
   // Calculate median for each year
   const priceDatasets = topCities.map((c, i) => ({
     label: c.city,
     data: years.map(y => {
       const ps = yearlyData[c.city][y];
       if (ps.length === 0) return null;
       ps.sort((a,b) => a-b);
       return Math.round(ps[Math.floor(ps.length/2)] / 1000);
     }),
     color: colors[i]
   }));
   
   // DOM data for fastest cities - bar chart of current active listings
   // Note: DOM only exists for active listings, not sold properties
   const domLabels = fastestCities.map(c => c.city);
   const domValues = fastestCities.map(c => Math.round(c.avgDom));
   const domColors = fastestCities.map((_, i) => colors[i]);
   
   // YoY growth data
   const yearlyMedians = years.map(y => {
     const ps = rawData.properties.filter(p => p.soldDate && parseInt(p.soldDate.split('-').pop()) === y && p.price > 50000).map(p => p.price);
     if (ps.length === 0) return null;
     ps.sort((a,b) => a-b);
     return Math.round(ps[Math.floor(ps.length/2)] / 1000);
   });
   
   insightChartData = {
     inland: {
       title: 'Top 5 Inland - Median Price Trend ($K)',
       labels: years.map(String),
       multiLine: true,
       datasets: priceDatasets
     },
     dom: {
       title: 'Avg Days on Market (Active Listings)',
       labels: domLabels,
       data: domValues,
       colors: domColors,
       type: 'bar'
     },
     growth: {
       title: 'RI Median Home Price ($K)',
       labels: years.map(String),
       data: yearlyMedians,
       color: '#10b981',
       type: 'line'
     }
   };
 }
 
 let hoverTimeout = null;
 let currentHoverCard = null;
 
 let insightHoverInitialized = false;
 
 function initInsightHover() {
 if (window.innerWidth <= 768) return; // Desktop only
 if (insightHoverInitialized) return; // Prevent duplicate listeners
 insightHoverInitialized = true;
 
 const cards = document.querySelectorAll('.insight-hover');
 
 cards.forEach(card => {
 card.addEventListener('mouseenter', function() {
 const self = this;
 currentHoverCard = self;
 // Small delay to prevent flicker on quick mouse movements
 clearTimeout(hoverTimeout);
 hoverTimeout = setTimeout(function() {
 if (currentHoverCard === self) {
 const chartType = self.dataset.chart;
 const data = insightChartData[chartType];
 showInsightChart(data, self);
 }
 }, 100);
 });
 
 card.addEventListener('mouseleave', function() {
 currentHoverCard = null;
 clearTimeout(hoverTimeout);
 hideInsightChart();
 });
 });
 }
 
 function showInsightChart(data, cardEl) {
 if (!data || !data.labels || data.labels.length === 0) return;
 
 const modal = document.getElementById('insightChartModal');
 const canvas = document.getElementById('insightChart');
 if (!modal || !canvas) return;
 
 // Position modal below the card
 const rect = cardEl.getBoundingClientRect();
 const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
 
 // Calculate position
 let leftPos = rect.left + rect.width/2 - 350;
 const topPos = rect.bottom + scrollTop + 25;
 
 // Keep modal in viewport
 if (leftPos < 20) leftPos = 20;
 if (leftPos + 700 > window.innerWidth) leftPos = window.innerWidth - 720;
 
 modal.style.position = 'absolute';
 modal.style.left = leftPos + 'px';
 modal.style.top = topPos + 'px';
 
 // Destroy existing chart first
 if (insightChart) {
 insightChart.destroy();
 insightChart = null;
 }
 
 // Reset canvas dimensions
 canvas.width = 600;
 canvas.height = 300;
 const ctx = canvas.getContext('2d');
 
 const isLine = data.type === 'line' || data.multiLine;
 const isMulti = data.multiLine;
 
 let datasets;
 if (isMulti) {
 datasets = data.datasets.map(ds => ({
 label: ds.label,
 data: ds.data,
 borderColor: ds.color,
 backgroundColor: 'transparent',
 borderWidth: 3,
 tension: 0.3,
 pointBackgroundColor: ds.color,
 pointRadius: 5,
 pointHoverRadius: 7
 }));
 } else {
 // Support per-bar colors via data.colors array
 const bgColors = data.colors ? data.colors.map(c => c + '80') : (isLine ? 'transparent' : data.color + '80');
 const borderColors = data.colors || data.color;
 datasets = [{
 label: data.title,
 data: data.data,
 backgroundColor: bgColors,
 borderColor: borderColors,
 borderWidth: isLine ? 3 : 2,
 borderRadius: isLine ? 0 : 6,
 fill: false,
 tension: 0.3,
 pointBackgroundColor: data.color,
 pointRadius: isLine ? 5 : 0,
 pointHoverRadius: isLine ? 7 : 0
 }];
 }
 
 insightChart = new Chart(ctx, {
 type: isLine ? 'line' : 'bar',
 data: { labels: data.labels, datasets: datasets },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: {
 title: { display: true, text: data.title, color: '#e2e8f0', font: { size: 16, weight: 'bold' } },
 legend: { display: isMulti, labels: { color: '#e2e8f0' } }
 },
 scales: {
 y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
 x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
 }
 }
 });
 
 modal.classList.add('active');
 }
 
 function hideInsightChart() {
 const modal = document.getElementById('insightChartModal');
 if (modal) modal.classList.remove('active');
 }
 
 // Note: initInsightHover() is called from updateInsights() after data loads

 // Property Details Search (VGSI data - no owner names)
 let propertyData = null;
 let propFilteredData = [];
 let propPage = 1;
 let propPageSize = 25;
 
 function setPageSize(size) {
  propPageSize = size;
  propPage = 1;
  renderPropResults();
 }
 
 async function searchProperties() {
 const status = document.getElementById('propStatus');
 const resultsDiv = document.getElementById('propResults');
 
 if (!propertyData) {
 status.textContent = '‚è≥ Loading 114K property records...';
 status.style.color = '#f59e0b';
 
 try {
 const response = await fetch('ri-vgsi-assessments.json.gz');
 if (!response.ok) throw new Error('Failed to load');
 const compressed = await response.arrayBuffer();
 const decompressed = pako.ungzip(new Uint8Array(compressed), { to: 'string' });
 propertyData = JSON.parse(decompressed);
 
 // Populate town dropdown
 const towns = [...new Set(propertyData.map(p => p.town_name))].sort();
 const townSelect = document.getElementById('propTown');
 towns.forEach(t => {
 const opt = document.createElement('option');
 opt.value = t;
 opt.textContent = t;
 townSelect.appendChild(opt);
 });
 
 status.textContent = '‚úì Loaded ' + propertyData.length.toLocaleString() + ' properties';
 status.style.color = '#10b981';
 } catch (err) {
 console.error('Load error:', err);
 status.textContent = '‚úó Failed to load property data';
 status.style.color = '#ef4444';
 return;
 }
 }
 
 const addressFilter = document.getElementById('propAddress').value.trim().toUpperCase();
 const townFilter = document.getElementById('propTown').value;
 const minBeds = parseInt(document.getElementById('propMinBeds').value) || 0;
 const minSqft = parseInt(document.getElementById('propMinSqft').value) || 0;
 
 propFilteredData = propertyData.filter(p => {
 if (townFilter && p.town_name !== townFilter) return false;
 if (addressFilter && !p.address.toUpperCase().includes(addressFilter)) return false;
 if (minBeds > 0 && (!p.bedrooms || p.bedrooms < minBeds)) return false;
 if (minSqft > 0 && (!p.living_area_sqft || p.living_area_sqft < minSqft)) return false;
 return true;
 });
 
 propFilteredData.sort((a, b) => (b.living_area_sqft || 0) - (a.living_area_sqft || 0));
 
 status.innerHTML = 'Found <strong>' + propFilteredData.length.toLocaleString() + '</strong> matching properties';
 status.style.color = '#10b981';
 
 resultsDiv.style.display = 'block';
 propPage = 1;
 renderPropResults();
 }
 
 function renderPropResults() {
 const start = (propPage - 1) * propPageSize;
 const end = start + propPageSize;
 const pageData = propFilteredData.slice(start, end);
 
 const countDiv = document.getElementById('propResultsCount');
 countDiv.textContent = 'Showing ' + (start + 1) + '-' + Math.min(end, propFilteredData.length) + ' of ' + propFilteredData.length.toLocaleString();
 
 const table = document.getElementById('propResultsTable');
 let html = '<table style="width:100%;border-collapse:collapse;font-size:0.8rem">';
 html += '<thead><tr style="background:rgba(99,102,241,0.3)">';
 html += '<th style="padding:0.6rem;text-align:left">Address</th>';
 html += '<th style="padding:0.6rem;text-align:left">Town</th>';
 html += '<th style="padding:0.6rem;text-align:right">Beds</th>';
 html += '<th style="padding:0.6rem;text-align:right">Baths</th>';
 html += '<th style="padding:0.6rem;text-align:right">Sqft</th>';
 html += '<th style="padding:0.6rem;text-align:right">Year</th>';
 html += '<th style="padding:0.6rem;text-align:right">Last Sale</th>';
 html += '<th style="padding:0.6rem;text-align:right">Sale Date</th>';
 html += '</tr></thead><tbody>';
 
 pageData.forEach(p => {
 const lastSale = p.last_sale_price ? '$' + p.last_sale_price.toLocaleString() : '-';
 const baths = (p.full_baths || 0) + (p.half_baths ? p.half_baths * 0.5 : 0);
 html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">';
 html += '<td style="padding:0.5rem">' + p.address + '</td>';
 html += '<td style="padding:0.5rem">' + p.town_name + '</td>';
 html += '<td style="padding:0.5rem;text-align:right">' + (p.bedrooms || '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:right">' + (baths || '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:right">' + (p.living_area_sqft ? p.living_area_sqft.toLocaleString() : '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:right">' + (p.year_built || '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:right;color:#10b981">' + lastSale + '</td>';
 html += '<td style="padding:0.5rem;text-align:right">' + (p.last_sale_date || '-') + '</td>';
 html += '</tr>';
 });
 
 html += '</tbody></table>';
 table.innerHTML = html;
 
 // Pagination
 const totalPages = Math.ceil(propFilteredData.length / propPageSize);
 const pagination = document.getElementById('propPagination');
 if (propFilteredData.length > 0) {
 const pageSizeSelect = '<select onchange="setPageSize(parseInt(this.value))" style="padding:0.4rem;background:#1e293b;border:1px solid rgba(99,102,241,0.4);color:#6366f1;border-radius:6px;margin-right:0.5rem">' +
  [25, 50, 75, 100].map(n => '<option value="' + n + '"' + (propPageSize === n ? ' selected' : '') + '>' + n + '</option>').join('') +
  '<option value="9999"' + (propPageSize === 9999 ? ' selected' : '') + '>All</option>' +
 '</select>';
 pagination.innerHTML = 
 '<div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;justify-content:center">' +
 '<span style="color:#94a3b8;font-size:0.85rem">Show:</span>' + pageSizeSelect +
 (totalPages > 1 ? (
  '<button onclick="propPage=1;renderPropResults()" ' + (propPage === 1 ? 'disabled' : '') + ' style="padding:0.4rem 0.8rem;background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);color:#6366f1;border-radius:6px;cursor:pointer">First</button>' +
  '<button onclick="propPage--;renderPropResults()" ' + (propPage === 1 ? 'disabled' : '') + ' style="padding:0.4rem 0.8rem;background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);color:#6366f1;border-radius:6px;cursor:pointer">Prev</button>' +
  '<span style="color:#94a3b8">Page ' + propPage + ' of ' + totalPages + ' (' + propFilteredData.length + ' total)</span>' +
  '<button onclick="propPage++;renderPropResults()" ' + (propPage === totalPages ? 'disabled' : '') + ' style="padding:0.4rem 0.8rem;background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);color:#6366f1;border-radius:6px;cursor:pointer">Next</button>' +
  '<button onclick="propPage=' + totalPages + ';renderPropResults()" ' + (propPage === totalPages ? 'disabled' : '') + ' style="padding:0.4rem 0.8rem;background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);color:#6366f1;border-radius:6px;cursor:pointer">Last</button>'
 ) : '<span style="color:#94a3b8">(' + propFilteredData.length + ' results)</span>') +
 '</div>';
 } else {
 pagination.innerHTML = '';
 }
 }

 // Assessment Search Functionality
 let assessmentData = null;
 let assessFilteredData = [];
 let assessPage = 1;
 const assessPageSize = 50;
 
 async function searchAssessments() {
 const status = document.getElementById('assessStatus');
 const resultsDiv = document.getElementById('assessResults');
 
 // Load data if not already loaded
 if (!assessmentData) {
 status.textContent = '‚è≥ Loading 362K geocoded addresses...';
 status.style.color = '#f59e0b';
 
 try {
 const response = await fetch('ri-all-geocoded.json.gz');
 if (!response.ok) throw new Error('Failed to load');
 const compressed = await response.arrayBuffer();
 const decompressed = pako.ungzip(new Uint8Array(compressed), { to: 'string' });
 assessmentData = JSON.parse(decompressed);
 const geocodedCount = assessmentData.filter(p => p.lat && p.lng).length;
 status.textContent = '‚úì Loaded ' + assessmentData.length.toLocaleString() + ' addresses (' + geocodedCount.toLocaleString() + ' geocoded)';
 status.style.color = '#10b981';
 } catch (err) {
 console.error('Load error:', err);
 status.textContent = ' Failed to load geocoded data';
 status.style.color = '#ef4444';
 return;
 }
 }
 
 // Get filter values
 const addressFilter = document.getElementById('assessAddress').value.trim().toUpperCase();
 const cityFilter = document.getElementById('assessCity').value;
 const minSqft = parseInt(document.getElementById('assessMinSqft').value) || 0;
 const sortBy = document.getElementById('assessSort').value;
 
 // Filter data
 assessFilteredData = assessmentData.filter(p => {
 if (cityFilter && p.city !== cityFilter) return false;
 if (addressFilter && !p.address.toUpperCase().includes(addressFilter)) return false;
 if (minSqft > 0 && (!p.sqft || p.sqft < minSqft)) return false;
 return true;
 });
 
 // Sort data
 const [sortField, sortDir] = sortBy.split('-');
 assessFilteredData.sort((a, b) => {
 let aVal = a[sortField] || 0;
 let bVal = b[sortField] || 0;
 return sortDir === 'desc' ? bVal - aVal : aVal - bVal;
 });
 
 // Show results
 status.innerHTML = 'Found <strong>' + assessFilteredData.length.toLocaleString() + '</strong> matching properties';
 status.style.color = '#10b981';
 
 resultsDiv.style.display = 'block';
 assessPage = 1;
 renderAssessResults();
 }
 
 function renderAssessResults() {
 const start = (assessPage - 1) * assessPageSize;
 const end = start + assessPageSize;
 const pageData = assessFilteredData.slice(start, end);
 const totalPages = Math.ceil(assessFilteredData.length / assessPageSize);
 
 document.getElementById('assessResultsCount').textContent = 
 'Showing ' + (start + 1) + '-' + Math.min(end, assessFilteredData.length) + ' of ' + assessFilteredData.length.toLocaleString();
 
 let html = '<table style="width:100%;border-collapse:collapse;font-size:0.8rem">';
 html += '<thead><tr style="background:rgba(99,102,241,0.3)">';
 html += '<th style="padding:0.6rem;text-align:left">Address</th>';
 html += '<th style="padding:0.6rem">City</th>';
 html += '<th style="padding:0.6rem">Assessed</th>';
 html += '<th style="padding:0.6rem">SqFt</th>';
 html += '<th style="padding:0.6rem">Year</th>';
 html += '<th style="padding:0.6rem">Beds</th>';
 html += '<th style="padding:0.6rem">Lot</th>';
 html += '</tr></thead><tbody>';
 
 pageData.forEach(p => {
 const assessed = p.assessed ? '$' + (p.assessed / 100).toLocaleString() : '-';
 html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">';
 html += '<td style="padding:0.5rem;color:#10b981">' + p.address + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + p.city + '</td>';
 html += '<td style="padding:0.5rem;text-align:center;color:#f59e0b;font-weight:600">' + assessed + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + (p.sqft ? p.sqft.toLocaleString() : '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + (p.year || '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + (p.beds || '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:center;font-size:0.75rem">' + (p.lot || '-') + '</td>';
 html += '</tr>';
 });
 
 html += '</tbody></table>';
 document.getElementById('assessResultsTable').innerHTML = html;
 
 // Pagination
 if (totalPages > 1) {
 let pagHtml = '<button class="btn-secondary" onclick="assessGoPage(1)" ' + (assessPage===1?'disabled':'') + '>¬´</button>';
 pagHtml += '<button class="btn-secondary" onclick="assessGoPage(' + (assessPage-1) + ')" ' + (assessPage===1?'disabled':'') + '>‚Äπ</button>';
 pagHtml += '<span style="color:#94a3b8">Page ' + assessPage + ' of ' + totalPages + '</span>';
 pagHtml += '<button class="btn-secondary" onclick="assessGoPage(' + (assessPage+1) + ')" ' + (assessPage===totalPages?'disabled':'') + '>‚Ä∫</button>';
 pagHtml += '<button class="btn-secondary" onclick="assessGoPage(' + totalPages + ')" ' + (assessPage===totalPages?'disabled':'') + '>¬ª</button>';
 document.getElementById('assessPagination').innerHTML = pagHtml;
 } else {
 document.getElementById('assessPagination').innerHTML = '';
 }
 }
 
 function assessGoPage(page) {
 assessPage = page;
 renderAssessResults();
 }
 
 // Proximity search for assessments
 async function searchAssessProximity() {
 const address = document.getElementById('assessProximityAddr').value.trim();
 const radius = parseFloat(document.getElementById('assessRadius').value);
 const status = document.getElementById('assessStatus');
 
 if (!address) {
 alert('Enter a full address (e.g., "123 Main St, Providence, RI")');
 return;
 }
 
 status.textContent = 'Finding nearby properties...';
 status.style.color = '#f59e0b';
 
 // Load assessment data if not loaded
 if (!assessmentData) {
 status.textContent = '‚è≥ Loading assessment data...';
 try {
 const response = await fetch('ri-assessments-geocoded.json');
 assessmentData = await response.json();
 } catch (err) {
 status.textContent = ' Failed to load data';
 status.style.color = '#ef4444';
 return;
 }
 }
 
 // Geocode the address using Nominatim
 try {
 const query = encodeURIComponent(address + ', Rhode Island, USA');
 const response = await fetch('https://nominatim.openstreetmap.org/search?q=' + query + '&format=json&limit=1', {
 headers: { 'User-Agent': 'AIBridges-RI-Report/1.0' }
 });
 const data = await response.json();
 
 if (!data || data.length === 0) {
 status.textContent = ' Could not geocode address. Try a more specific address.';
 status.style.color = '#ef4444';
 return;
 }
 
 const lat = parseFloat(data[0].lat);
 const lng = parseFloat(data[0].lon);
 
 status.textContent = 'üó∫Ô∏è Finding nearby properties...';
 
 // Find nearby assessments
 assessFilteredData = assessmentData.filter(p => {
 if (!p.lat || !p.lng) return false;
 const dist = getDistance(lat, lng, p.lat, p.lng);
 return dist <= radius;
 }).map(p => ({
 ...p,
 distance: getDistance(lat, lng, p.lat, p.lng)
 })).sort((a, b) => a.distance - b.distance);
 
 if (assessFilteredData.length === 0) {
 status.innerHTML = ' No geocoded properties within ' + radius + ' miles. Try a larger radius.';
 status.style.color = '#f59e0b';
 document.getElementById('assessResults').style.display = 'none';
 return;
 }
 
 status.innerHTML = 'Found <strong>' + assessFilteredData.length + '</strong> properties within ' + radius + ' mi of your location';
 status.style.color = '#10b981';
 
 document.getElementById('assessResults').style.display = 'block';
 assessPage = 1;
 renderAssessResultsWithDistance();
 
 } catch (err) {
 console.error('Proximity search error:', err);
 status.textContent = ' Geocoding failed: ' + err.message;
 status.style.color = '#ef4444';
 }
 }
 
 function renderAssessResultsWithDistance() {
 const start = (assessPage - 1) * assessPageSize;
 const end = start + assessPageSize;
 const pageData = assessFilteredData.slice(start, end);
 const totalPages = Math.ceil(assessFilteredData.length / assessPageSize);
 
 document.getElementById('assessResultsCount').textContent = 
 'Showing ' + (start + 1) + '-' + Math.min(end, assessFilteredData.length) + ' of ' + assessFilteredData.length.toLocaleString() + ' (sorted by distance)';
 
 let html = '<table style="width:100%;border-collapse:collapse;font-size:0.8rem">';
 html += '<thead><tr style="background:rgba(16,185,129,0.3)">';
 html += '<th style="padding:0.6rem">Dist</th>';
 html += '<th style="padding:0.6rem;text-align:left">Address</th>';
 html += '<th style="padding:0.6rem">City</th>';
 html += '<th style="padding:0.6rem">Assessed</th>';
 html += '<th style="padding:0.6rem">SqFt</th>';
 html += '<th style="padding:0.6rem">Year</th>';
 html += '<th style="padding:0.6rem">Lot</th>';
 html += '</tr></thead><tbody>';
 
 pageData.forEach(p => {
 const assessed = p.assessed ? '$' + (p.assessed / 100).toLocaleString() : '-';
 const distFt = Math.round(p.distance * 5280);
 const distStr = distFt < 1000 ? distFt + ' ft' : (p.distance).toFixed(2) + ' mi';
 html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">';
 html += '<td style="padding:0.5rem;text-align:center;color:#10b981;font-weight:600">' + distStr + '</td>';
 html += '<td style="padding:0.5rem;color:#6366f1">' + p.address + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + p.city + '</td>';
 html += '<td style="padding:0.5rem;text-align:center;color:#f59e0b;font-weight:600">' + assessed + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + (p.sqft ? p.sqft.toLocaleString() : '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:center">' + (p.year || '-') + '</td>';
 html += '<td style="padding:0.5rem;text-align:center;font-size:0.75rem">' + (p.lot || '-') + '</td>';
 html += '</tr>';
 });
 
 html += '</tbody></table>';
 document.getElementById('assessResultsTable').innerHTML = html;
 
 // Pagination
 if (totalPages > 1) {
 let pagHtml = '<button class="btn-secondary" onclick="assessPage=' + 1 + ';renderAssessResultsWithDistance()" ' + (assessPage===1?'disabled':'') + '>¬´</button>';
 pagHtml += '<button class="btn-secondary" onclick="assessPage=' + (assessPage-1) + ';renderAssessResultsWithDistance()" ' + (assessPage===1?'disabled':'') + '>‚Äπ</button>';
 pagHtml += '<span style="color:#94a3b8">Page ' + assessPage + ' of ' + totalPages + '</span>';
 pagHtml += '<button class="btn-secondary" onclick="assessPage=' + (assessPage+1) + ';renderAssessResultsWithDistance()" ' + (assessPage===totalPages?'disabled':'') + '>‚Ä∫</button>';
 pagHtml += '<button class="btn-secondary" onclick="assessPage=' + totalPages + ';renderAssessResultsWithDistance()" ' + (assessPage===totalPages?'disabled':'') + '>¬ª</button>';
 document.getElementById('assessPagination').innerHTML = pagHtml;
 } else {
 document.getElementById('assessPagination').innerHTML = '';
 }
 }
 
 // Allow Enter key to trigger search
 document.addEventListener('DOMContentLoaded', function() {
 const assessAddr = document.getElementById('assessAddress');
 const assessProx = document.getElementById('assessProximityAddr');
 if (assessProx) {
 assessProx.addEventListener('keypress', function(e) {
 if (e.key === 'Enter') searchAssessProximity();
 });
 }
 if (assessAddr) {
 assessAddr.addEventListener('keypress', function(e) {
 if (e.key === 'Enter') searchAssessments();
 });
 }
 });
 </script>
 
 <!-- About the Data Section -->
 <div class="container" style="padding-bottom:100px">
 <h2 id="about-data"> About the Data</h2>
 <div class="sql-section">
 <p style="color:#94a3b8;margin-bottom:1.5rem">This report uses <strong>different data for different purposes</strong>:</p>
 
 <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-bottom:2rem">
 <div style="background:rgba(236,72,153,0.1);padding:1.5rem;border-radius:12px;border-left:4px solid #00E1E6">
 <h3 style="color:#6366f1;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem"> MLS Sales Data <span style="background:#00E1E6;color:white;font-size:0.7rem;padding:2px 8px;border-radius:10px">COMPS</span></h3>
 <div style="font-size:2rem;font-weight:800;color:#00E1E6;margin-bottom:0.5rem">11,000+</div>
 <p style="color:#94a3b8;font-size:0.9rem;margin-bottom:0.75rem"><strong>Real sale prices</strong> ‚Äî active listings + sold properties (past 2 years) from 33 cities. This is what powers Price Comps, House Hunter, and Land Deal Finder.</p>
 <p style="color:#64748b;font-size:0.8rem">Source: Redfin MLS ‚Ä¢ Used for: valuations</p>
 </div>
 
 <div style="background:rgba(99,102,241,0.1);padding:1.5rem;border-radius:12px;border-left:4px solid #6366f1">
 <h3 style="color:#6366f1;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem"> Tax Assessments <span style="background:#6366f1;color:white;font-size:0.7rem;padding:2px 8px;border-radius:10px">INFO</span></h3>
 <div style="font-size:2rem;font-weight:800;color:#6366f1;margin-bottom:0.5rem">196,000+</div>
 <p style="color:#94a3b8;font-size:0.9rem;margin-bottom:0.75rem"><strong>Property details only</strong> ‚Äî sqft, year built, lot size, zoning. From 27 towns (VGSI + Providence). <em>Not used for price estimates</em> ‚Äî assessments ‚â† market value.</p>
 <p style="color:#64748b;font-size:0.8rem">Source: Town portals ‚Ä¢ Used for: property info</p>
 </div>
 </div>
 
 <div style="background:rgba(245,158,11,0.1);padding:1rem 1.5rem;border-radius:12px;border:1px solid rgba(99,102,241,0.25);margin-bottom:1.5rem">
 <p style="color:#6366f1;font-weight:600;margin-bottom:0.25rem"> Important: Assessments ‚â† Market Value</p>
 <p style="color:#94a3b8;font-size:0.9rem">Tax assessments are what towns use for property taxes ‚Äî they're often 10-30% different from actual sale prices. Our <strong>Price Comps use only real MLS sales data</strong> for accurate valuations.</p>
 </div>
 
 <div style="background:rgba(255,255,255,0.03);padding:1.5rem;border-radius:12px;border:1px solid rgba(255,255,255,0.08)">
 <h3 style="color:#6366f1;margin-bottom:1rem;font-size:1rem">‚ùì Frequently Asked Questions</h3>
 <div style="display:grid;gap:1rem">
 <div>
 <p style="color:#e2e8f0;font-weight:600;margin-bottom:0.25rem">Why no owner names?</p>
 <p style="color:#94a3b8;font-size:0.9rem">Privacy. Assessment data includes property details but we don't publish owner info.</p>
 </div>
 <div>
 <p style="color:#e2e8f0;font-weight:600;margin-bottom:0.25rem">How often is this updated?</p>
 <p style="color:#94a3b8;font-size:0.9rem">MLS data updates weekly. Assessment data updates quarterly or when towns refresh their systems.</p>
 </div>
 <div>
 <p style="color:#e2e8f0;font-weight:600;margin-bottom:0.25rem">Why isn't my town included?</p>
 <p style="color:#94a3b8;font-size:0.9rem">Towns like Newport, Barrington, and Bristol use different assessment systems (not VGSI). We're working on adding them.</p>
 </div>
 <div>
 <p style="color:#e2e8f0;font-weight:600;margin-bottom:0.25rem">Can I export the data?</p>
 <p style="color:#94a3b8;font-size:0.9rem">Yes! Use the SQL tool or export buttons on any table. For bulk API access, <a href="https://aibridges.org/#contact" style="color:#10b981">contact us</a>.</p>
 </div>
 </div>
 </div>
 
 <p style="color:#64748b;font-size:0.8rem;margin-top:1.5rem;text-align:center">
 Built by <a href="https://aibridges.org" style="color:#6366f1">AIBridges</a> ‚Ä¢ Last updated: Feb 2026 ‚Ä¢ <a href="https://aibridges.org/#contact" style="color:#6366f1">Request custom data</a>
 </p>
 </div>
 </div>
 
 <!-- Subtle FSBO Footer Banner -->
 <!-- FSBO banner (hidden on mobile) -->
 <div class="fsbo-banner" style="position:fixed;bottom:0;left:0;right:0;background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);border-top:1px solid rgba(245,158,11,0.3);padding:0.75rem 2rem;display:flex;justify-content:center;align-items:center;gap:1rem;z-index:99">
 <span style="color:#94a3b8;font-size:0.9rem">üè∑Ô∏è Selling your home?</span>
 <a href="sell-your-home" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:0.5rem 1rem;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.9rem">List FSBO ‚Äî $49 flat fee</a>
 </div>
 
 <!-- Mobile bottom nav -->
 <div class="bottom-nav">
 <div class="bottom-nav-inner">
 <a href="#house-hunter"><span></span>Homes</a>
 <a href="#land-deals"><span></span>Land</a>
 <a href="#price-comp"><span></span>Comps</a>
 <a href="#sql-tool"><span></span>Search</a>
 <a href="#market-stats"><span></span>Stats</a>
 </div>
 </div>
 
 <style>
 @media (max-width: 768px) { .fsbo-banner { display: none !important; } }
 </style>
</body></html>
// cache bust 1771097517
