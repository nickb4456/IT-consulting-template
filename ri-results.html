<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RI Real Estate Results</title>
    <style>
        :root { --primary: #6366f1; --secondary: #ec4899; --accent: #10b981; --dark: #0f172a; --darker: #020617; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(180deg, var(--dark) 0%, #1e293b 50%, var(--dark) 100%); color: #e2e8f0; line-height: 1.6; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        
        /* Stats Cards - matching main page style */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .stat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 1.25rem; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 800; color: #f8fafc; }
        .stat-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.25rem; }
        
        /* Section Headers */
        .section-header { display: flex; align-items: center; gap: 1rem; margin: 2.5rem 0 1.5rem; }
        .section-header h2 { font-size: 1.25rem; color: #94a3b8; font-weight: 600; }
        .section-header::after { content: ''; flex: 1; height: 2px; background: linear-gradient(90deg, rgba(99,102,241,0.5), transparent); border-radius: 1px; }
        
        /* Charts Grid */
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; align-items: start; }
        .chart-card { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 1rem; transition: all 0.3s; }
        .chart-card:hover { border-color: rgba(99,102,241,0.3); }
        .chart-card.full-width { grid-column: span 2; }
        .chart-title { color: #a5b4fc; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .chart-title .emoji { font-size: 1.2rem; }
        .chart-insight { display: none; margin-top: 0.75rem; padding: 0.6rem 0.8rem; background: rgba(99,102,241,0.1); border-radius: 8px; font-size: 0.8rem; color: #94a3b8; line-height: 1.4; }
        .chart-insight strong { color: #a5b4fc; }
        @media (min-width: 769px) { .chart-insight { display: block; } }
        
        /* Box Plot */
        .boxplot-container { margin-top: 0.5rem; }
        .boxplot { height: 50px; position: relative; background: rgba(255,255,255,0.02); border-radius: 12px; margin: 0.5rem 0; }
        .boxplot-whisker { position: absolute; top: 50%; height: 3px; background: linear-gradient(90deg, #64748b, #94a3b8); border-radius: 2px; }
        .boxplot-box { position: absolute; top: 15%; height: 70%; background: linear-gradient(135deg, rgba(99,102,241,0.4), rgba(139,92,246,0.4)); border: 2px solid #6366f1; border-radius: 8px; }
        .boxplot-median { position: absolute; top: 10%; height: 80%; width: 4px; background: linear-gradient(180deg, #ec4899, #f472b6); border-radius: 2px; box-shadow: 0 0 10px rgba(236,72,153,0.5); }
        .boxplot-labels { display: flex; justify-content: space-between; color: #64748b; font-size: 0.75rem; padding: 0 0.5rem; }
        
        .quartile-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-top: 0.5rem; }
        .quartile-item { text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .quartile-value { font-weight: 700; font-size: 1.1rem; color: #f8fafc; }
        .quartile-label { font-size: 0.65rem; color: #64748b; margin-top: 0.25rem; }
        
        /* Table */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: rgba(255,255,255,0.02); border-radius: 16px; overflow: hidden; }
        .results-table th { background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(99,102,241,0.2)); padding: 1rem; text-align: left; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #a5b4fc; }
        .results-table td { padding: 0.875rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .results-table tr:hover { background: rgba(99,102,241,0.1); }
        .results-table a { color: #10b981; text-decoration: none; }
        .results-table a.view-btn { color: white; }
        
        .view-btn { display: inline-flex; align-items: center; gap: 0.3rem; background: linear-gradient(135deg, #10b981, #059669); color: #ffffff !important; padding: 0.4rem 0.8rem; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
        .view-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(16,185,129,0.4); color: #ffffff !important; }
        
        .price { font-weight: 700; color: #6366f1; }
        
        /* Loading */
        .loading { text-align: center; padding: 4rem 2rem; color: #94a3b8; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(99,102,241,0.2); border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Pagination */
        .pagination { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; margin: 1rem 0; }
        .pagination button { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 0.6rem 1.25rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .pagination button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(99,102,241,0.4); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination select { background: var(--dark); color: #e2e8f0; border: 1px solid rgba(99,102,241,0.3); padding: 0.5rem 1rem; border-radius: 10px; cursor: pointer; font-weight: 500; }
        .pagination select:focus { outline: none; border-color: #6366f1; }
        .page-info { color: #64748b; font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .chart-card.full-width { grid-column: span 1; }
            .header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .quartile-grid { grid-template-columns: repeat(3, 1fr); }
            .results-table { font-size: 0.8rem; display: block; overflow-x: auto; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- Nav Bar (matches main page) -->
    <nav style="position:fixed;top:0;left:0;right:0;background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.08);z-index:1000;padding:0.75rem 2rem;">
        <div style="max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:1.5rem;">
                <a href="https://aibridges.org" style="display:flex;align-items:center;gap:0.5rem;text-decoration:none;">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="6" fill="#6366f1"/>
                        <path d="M6 22h20M9 22v-6l7-8 7 8v6M13 22v-5h6v5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span style="font-weight:700;font-size:1.1rem;color:#f8fafc">Bridges</span>
                </a>
                <span style="color:#475569">|</span>
                <h1 id="title" style="font-size:1.1rem;font-weight:600;color:#94a3b8;margin:0;">Loading...</h1>
            </div>
            <div style="display:flex;gap:1.5rem;align-items:center;">
                <a href="ri-report.html" style="color:#10b981;text-decoration:none;font-size:0.9rem;font-weight:600;transition:color 0.2s;">‚Üê Back to Report</a>
                <a href="ri-report.html#house-hunter" style="color:#a1afc4;text-decoration:none;font-size:0.9rem;transition:color 0.2s;">House Hunter</a>
                <a href="ri-report.html#land-deals" style="color:#a1afc4;text-decoration:none;font-size:0.9rem;transition:color 0.2s;">Land Deals</a>
                <a href="ri-report.html#sql-tool" style="color:#a1afc4;text-decoration:none;font-size:0.9rem;transition:color 0.2s;">SQL Search</a>
                <a href="https://aibridges.org" style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;padding:0.5rem 1rem;border-radius:8px;text-decoration:none;font-size:0.9rem;font-weight:600;">üè† Home</a>
            </div>
        </div>
    </nav>
    
    <div class="container" style="padding-top:5rem;">
        <!-- Stats Cards (moved up, no header box) -->
        <div class="stats-grid" id="statsGrid" style="display:none;">
            <div class="stat-card"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Properties</div></div>
            <div class="stat-card"><div class="stat-value" id="medianPrice">$0</div><div class="stat-label">Median Price</div></div>
            <div class="stat-card"><div class="stat-value" id="avgPrice">$0</div><div class="stat-label">Average Price</div></div>
            <div class="stat-card"><div class="stat-value" id="avgPpsf">$0</div><div class="stat-label">Avg $/SqFt</div></div>
            <div class="stat-card"><div class="stat-value" id="avgDom">0</div><div class="stat-label">Avg Days on Market</div></div>
            <div class="stat-card"><div class="stat-value" id="forSaleCount">0</div><div class="stat-label">For Sale Now</div></div>
        </div>
        
        <!-- Charts Section -->
        <div class="section-header" id="chartsHeader" style="display:none;">
            <h2>üìä Market Analytics</h2>
        </div>
        
        <div class="charts-grid" id="chartsGrid" style="display:none;">
            <!-- Box Plot -->
            <div class="chart-card">
                <div class="chart-title"><span class="emoji">üì¶</span> Price Distribution (Box Plot)</div>
                <div class="boxplot-container">
                    <div class="boxplot" id="boxplot"></div>
                    <div class="boxplot-labels"><span id="minLabel">$0</span><span id="maxLabel">$0</span></div>
                </div>
                <div class="quartile-grid">
                    <div class="quartile-item"><div class="quartile-value" id="q0">$0</div><div class="quartile-label">Min</div></div>
                    <div class="quartile-item"><div class="quartile-value" id="q1">$0</div><div class="quartile-label">Q1 (25%)</div></div>
                    <div class="quartile-item"><div class="quartile-value" id="q2">$0</div><div class="quartile-label">Median</div></div>
                    <div class="quartile-item"><div class="quartile-value" id="q3">$0</div><div class="quartile-label">Q3 (75%)</div></div>
                    <div class="quartile-item"><div class="quartile-value" id="q4">$0</div><div class="quartile-label">Max</div></div>
                </div>
            </div>
            
            <!-- Price Histogram -->
            <div class="chart-card">
                <div class="chart-title"><span class="emoji">üìà</span> Price Distribution</div>
                <canvas id="histogramChart" height="160"></canvas>
            </div>
            
            <!-- Property Types -->
            <div class="chart-card">
                <div class="chart-title"><span class="emoji">üè†</span> Property Types</div>
                <canvas id="typeChart" height="160"></canvas>
                <div class="chart-insight" id="typeInsight"></div>
            </div>
            
            <!-- Bedrooms -->
            <div class="chart-card">
                <div class="chart-title"><span class="emoji">üõèÔ∏è</span> Bedrooms Distribution</div>
                <canvas id="bedsChart" height="160"></canvas>
                <div class="chart-insight" id="bedsInsight"></div>
            </div>
            
            <!-- DOM Distribution -->
            <div class="chart-card">
                <div class="chart-title"><span class="emoji">‚è±Ô∏è</span> Days on Market</div>
                <canvas id="domChart" height="160"></canvas>
                <div class="chart-insight" id="domInsight"></div>
            </div>
            
            <!-- Year Built -->
            <div class="chart-card">
                <div class="chart-title"><span class="emoji">üèóÔ∏è</span> Year Built</div>
                <canvas id="yearChart" height="160"></canvas>
                <div class="chart-insight" id="yearInsight"></div>
            </div>
            
            <!-- Monthly Trend (full width) -->
            <div class="chart-card full-width">
                <div class="chart-title"><span class="emoji">üìÖ</span> Monthly Sales Trend</div>
                <canvas id="trendChart" height="120"></canvas>
            </div>
        </div>
        
        <!-- Comp Analysis Scatter (Plotly) -->
        <div class="section-header" id="scatterHeader" style="display:none;">
            <h2>üéØ Comp Analysis</h2>
        </div>
        <div class="chart-card full-width" id="scatterCard" style="display:none;">
            <div class="chart-title"><span class="emoji">üìä</span> Price vs Square Footage <span style="font-weight:400;color:#64748b;margin-left:0.5rem">(hover for details)</span></div>
            <div id="scatterPlot" style="height:400px;"></div>
            <div class="chart-insight" id="scatterInsight"></div>
        </div>
        
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading property data...</p>
        </div>
        
        <!-- Results Section -->
        <div class="section-header" id="resultsHeader" style="display:none;">
            <h2>üìã Property Listings</h2>
        </div>
        
        <div id="paginationTop"></div>
        
        <table class="results-table" id="resultsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Address</th>
                    <th>City</th>
                    <th>Price</th>
                    <th>Beds</th>
                    <th>Baths</th>
                    <th>Sq Ft</th>
                    <th>Type</th>
                    <th>Sold</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
        
        <div id="paginationBottom"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
        const DATA_URL = 'ri-sales.json.gz?v=' + new Date().toISOString().split('T')[0];
        
        // Chart.js defaults for dark theme
        Chart.defaults.color = '#64748b';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        
        const params = new URLSearchParams(window.location.search);
        const filterType = params.get('type');
        const filterValue = params.get('value');
        
        const titles = {
            city: v => `Properties in ${v}`,
            price: v => `Properties: ${v}`,
            beds: v => `${v} Bedroom Properties`,
            land: v => `Land Sales in ${v}`,
            year: v => `Sales in ${v}`,
            type: v => `${v} Properties`,
            all: () => 'All Properties'
        };
        
        const fmt = v => { const abs = Math.abs(v), s = v < 0 ? '-' : ''; return abs >= 1000000 ? '$' + s + (abs/1000000).toFixed(1) + 'M' : '$' + s + Math.round(abs/1000) + 'K'; };
        
        async function loadData() {
            try {
                const res = await fetch(DATA_URL);
                const buffer = await res.arrayBuffer();
                const decompressed = pako.ungzip(new Uint8Array(buffer), {to: 'string'});
                const data = JSON.parse(decompressed);
                
                let filtered = data.properties;
                let titleText = 'All Properties';
                
                if (filterType && filterValue) {
                    titleText = titles[filterType]?.(filterValue) || filterValue;
                    
                    switch (filterType) {
                        case 'city':
                            filtered = filtered.filter(p => p.city === filterValue);
                            break;
                        case 'price':
                            const priceRanges = {
                                '<$300K': p => p.price < 300000,
                                '$300-400K': p => p.price >= 300000 && p.price < 400000,
                                '$400-500K': p => p.price >= 400000 && p.price < 500000,
                                '$500-600K': p => p.price >= 500000 && p.price < 600000,
                                '$600-750K': p => p.price >= 600000 && p.price < 750000,
                                '$750K-1M': p => p.price >= 750000 && p.price < 1000000,
                                '$1M+': p => p.price >= 1000000
                            };
                            filtered = filtered.filter(priceRanges[filterValue] || (() => true));
                            break;
                        case 'beds':
                            const beds = filterValue === '6+' ? 6 : parseInt(filterValue);
                            filtered = filtered.filter(p => beds >= 6 ? p.beds >= beds : p.beds === beds);
                            break;
                        case 'land':
                            filtered = filtered.filter(p => p.propertyType?.toLowerCase().includes('land') || p.propertyType?.toLowerCase().includes('vacant'));
                            if (filterValue !== 'all') filtered = filtered.filter(p => p.city === filterValue);
                            break;
                        case 'year':
                            filtered = filtered.filter(p => p.soldDate?.includes(filterValue));
                            break;
                        case 'type':
                            filtered = filtered.filter(p => p.propertyType?.includes(filterValue));
                            break;
                    }
                }
                
                filtered.sort((a, b) => (b.price || 0) - (a.price || 0));
                
                document.getElementById('title').textContent = titleText;
                document.getElementById('loading').style.display = 'none';
                
                if (filtered.length === 0) {
                    document.getElementById('loading').innerHTML = '<div style="font-size:4rem;margin-bottom:1rem;">üè†</div><p>No properties found</p>';
                    document.getElementById('loading').style.display = 'block';
                    return;
                }
                
                // Calculate comprehensive stats
                const prices = filtered.map(p => p.price).filter(p => p > 0).sort((a, b) => a - b);
                const median = prices[Math.floor(prices.length / 2)] || 0;
                const avg = prices.reduce((a, b) => a + b, 0) / prices.length || 0;
                const withSqft = filtered.filter(p => p.sqft > 0);
                const avgPpsf = withSqft.length ? withSqft.reduce((a, p) => a + p.price / p.sqft, 0) / withSqft.length : 0;
                const withDom = filtered.filter(p => p.dom > 0 && p.dom < 365);
                const avgDom = withDom.length ? Math.round(withDom.reduce((a, p) => a + p.dom, 0) / withDom.length) : 0;
                const forSale = filtered.filter(p => p.status === 'For Sale').length;
                
                // Update stats
                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('totalCount').textContent = filtered.length.toLocaleString();
                document.getElementById('medianPrice').textContent = fmt(median);
                document.getElementById('avgPrice').textContent = fmt(avg);
                document.getElementById('avgPpsf').textContent = '$' + Math.round(avgPpsf);
                document.getElementById('avgDom').textContent = avgDom + ' days';
                document.getElementById('forSaleCount').textContent = forSale;
                
                // Render charts
                if (prices.length >= 5) {
                    document.getElementById('chartsHeader').style.display = 'flex';
                    document.getElementById('chartsGrid').style.display = 'grid';
                    renderAllCharts(filtered, prices);
                }
                
                // Setup pagination & table
                document.getElementById('resultsHeader').style.display = 'flex';
                setupPagination(filtered);
                
            } catch (err) {
                console.error('Error:', err);
                document.getElementById('loading').innerHTML = '<div style="font-size:4rem;margin-bottom:1rem;">‚ö†Ô∏è</div><p>Error loading data</p>';
            }
        }
        
        function renderAllCharts(filtered, prices) {
            // Box plot
            const n = prices.length;
            const q0 = prices[0], q1 = prices[Math.floor(n*0.25)], q2 = prices[Math.floor(n*0.5)], q3 = prices[Math.floor(n*0.75)], q4 = prices[n-1];
            const iqr = q3 - q1;
            const displayMin = Math.max(q0, q1 - 1.5*iqr);
            const displayMax = Math.min(q4, q3 + 1.5*iqr);
            
            document.getElementById('q0').textContent = fmt(q0);
            document.getElementById('q1').textContent = fmt(q1);
            document.getElementById('q2').textContent = fmt(q2);
            document.getElementById('q3').textContent = fmt(q3);
            document.getElementById('q4').textContent = fmt(q4);
            document.getElementById('minLabel').textContent = fmt(displayMin);
            document.getElementById('maxLabel').textContent = fmt(displayMax);
            
            const range = displayMax - displayMin;
            if (range > 0) {
                const toP = v => Math.max(0, Math.min(100, (v - displayMin) / range * 100));
                document.getElementById('boxplot').innerHTML = `
                    <div class="boxplot-whisker" style="left:0;width:${toP(q1)}%"></div>
                    <div class="boxplot-whisker" style="left:${toP(q3)}%;width:${100-toP(q3)}%"></div>
                    <div class="boxplot-box" style="left:${toP(q1)}%;width:${Math.max(2,toP(q3)-toP(q1))}%"></div>
                    <div class="boxplot-median" style="left:${toP(q2)}%"></div>
                `;
            }
            
            // Histogram
            const buckets = Array(12).fill(0);
            const bSize = range / 12 || 1;
            prices.forEach(p => { if (p >= displayMin && p <= displayMax) buckets[Math.min(11, Math.floor((p - displayMin) / bSize))]++; });
            new Chart(document.getElementById('histogramChart'), {
                type: 'bar',
                data: { labels: buckets.map((_, i) => fmt(displayMin + i * bSize)), datasets: [{ data: buckets, backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 6 }] },
                options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { maxRotation: 45, font: { size: 9 } } } } }
            });
            
            // Property Types
            const types = {};
            filtered.forEach(p => { const t = (p.propertyType || 'Unknown').split(' ')[0]; types[t] = (types[t] || 0) + 1; });
            const typeData = Object.entries(types).sort((a, b) => b[1] - a[1]).slice(0, 6);
            new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: { labels: typeData.map(t => t[0]), datasets: [{ data: typeData.map(t => t[1]), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#06b6d4', '#8b5cf6'], borderWidth: 0 }] },
                options: { plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } } } }
            });
            // Type insight
            const topType = typeData[0];
            const topTypePct = Math.round(topType[1] / filtered.length * 100);
            document.getElementById('typeInsight').innerHTML = `<strong>${topType[0]}</strong> dominates at ${topTypePct}% of listings. ${typeData.length > 1 ? `<strong>${typeData[1][0]}</strong> is second with ${Math.round(typeData[1][1]/filtered.length*100)}%.` : ''}`;
            
            // Bedrooms
            const beds = {};
            filtered.filter(p => p.beds != null).forEach(p => { const b = p.beds > 5 ? '6+' : String(p.beds); beds[b] = (beds[b] || 0) + 1; });
            new Chart(document.getElementById('bedsChart'), {
                type: 'bar',
                data: { labels: ['0', '1', '2', '3', '4', '5', '6+'], datasets: [{ data: ['0', '1', '2', '3', '4', '5', '6+'].map(b => beds[b] || 0), backgroundColor: ['#06b6d4', '#10b981', '#22c55e', '#84cc16', '#f59e0b', '#ec4899', '#6366f1'], borderRadius: 6 }] },
                options: { plugins: { legend: { display: false } } }
            });
            // Beds insight
            const mostCommonBeds = Object.entries(beds).sort((a,b) => b[1] - a[1])[0];
            const familySize = (beds['3'] || 0) + (beds['4'] || 0) + (beds['5'] || 0) + (beds['6+'] || 0);
            const familyPct = Math.round(familySize / filtered.filter(p => p.beds != null).length * 100);
            document.getElementById('bedsInsight').innerHTML = `<strong>${mostCommonBeds[0]} bedrooms</strong> most common. Family-sized homes (3+ beds) make up <strong>${familyPct}%</strong> of the market.`;
            
            // DOM Distribution
            const domBuckets = { '0-30': 0, '31-60': 0, '61-90': 0, '91-180': 0, '180+': 0 };
            filtered.filter(p => p.dom > 0).forEach(p => {
                if (p.dom <= 30) domBuckets['0-30']++;
                else if (p.dom <= 60) domBuckets['31-60']++;
                else if (p.dom <= 90) domBuckets['61-90']++;
                else if (p.dom <= 180) domBuckets['91-180']++;
                else domBuckets['180+']++;
            });
            new Chart(document.getElementById('domChart'), {
                type: 'bar',
                data: { labels: Object.keys(domBuckets), datasets: [{ data: Object.values(domBuckets), backgroundColor: ['#10b981', '#22c55e', '#f59e0b', '#f97316', '#ef4444'], borderRadius: 6 }] },
                options: { plugins: { legend: { display: false } } }
            });
            // DOM insight
            const fastSales = domBuckets['0-30'] + domBuckets['31-60'];
            const totalDom = Object.values(domBuckets).reduce((a,b) => a+b, 0);
            const fastPct = totalDom ? Math.round(fastSales / totalDom * 100) : 0;
            const slowPct = totalDom ? Math.round(domBuckets['180+'] / totalDom * 100) : 0;
            document.getElementById('domInsight').innerHTML = totalDom ? `<strong>${fastPct}%</strong> sell within 60 days. ${slowPct > 10 ? `‚ö†Ô∏è <strong>${slowPct}%</strong> sit 180+ days ‚Äî potential negotiation opportunities.` : 'Market moving at healthy pace.'}` : 'No DOM data for active listings.';
            
            // Year Built
            const decades = { 'Pre-1900': 0, '1900-50': 0, '1950-80': 0, '1980-00': 0, '2000-20': 0, '2020+': 0 };
            filtered.filter(p => p.yearBuilt > 0).forEach(p => {
                if (p.yearBuilt < 1900) decades['Pre-1900']++;
                else if (p.yearBuilt < 1950) decades['1900-50']++;
                else if (p.yearBuilt < 1980) decades['1950-80']++;
                else if (p.yearBuilt < 2000) decades['1980-00']++;
                else if (p.yearBuilt < 2020) decades['2000-20']++;
                else decades['2020+']++;
            });
            new Chart(document.getElementById('yearChart'), {
                type: 'bar',
                data: { labels: Object.keys(decades), datasets: [{ data: Object.values(decades), backgroundColor: '#f59e0b', borderRadius: 6 }] },
                options: { plugins: { legend: { display: false } } }
            });
            // Year insight
            const totalYears = Object.values(decades).reduce((a,b) => a+b, 0);
            const historic = decades['Pre-1900'] + decades['1900-50'];
            const newBuild = decades['2000-20'] + decades['2020+'];
            const historicPct = totalYears ? Math.round(historic / totalYears * 100) : 0;
            const newPct = totalYears ? Math.round(newBuild / totalYears * 100) : 0;
            document.getElementById('yearInsight').innerHTML = totalYears ? `<strong>${historicPct}%</strong> pre-1950 (character homes). <strong>${newPct}%</strong> built since 2000. ${decades['2020+'] > 0 ? `<strong>${decades['2020+']} new constructions</strong> available.` : ''}` : 'No year built data available.';
            
            // Monthly trend
            const monthNum = { 'January': 1, 'February': 2, 'March': 3, 'April': 4, 'May': 5, 'June': 6, 'July': 7, 'August': 8, 'September': 9, 'October': 10, 'November': 11, 'December': 12 };
            const byMonth = {};
            filtered.filter(p => p.soldDate).forEach(p => {
                const parts = p.soldDate.split('-');
                if (parts.length === 3 && monthNum[parts[0]]) {
                    const key = parts[2] + '-' + String(monthNum[parts[0]]).padStart(2, '0');
                    if (!byMonth[key]) byMonth[key] = { count: 0, total: 0 };
                    byMonth[key].count++;
                    byMonth[key].total += p.price || 0;
                }
            });
            const monthly = Object.entries(byMonth).sort((a, b) => a[0].localeCompare(b[0])).slice(-24);
            
            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: { 
                    labels: monthly.map(m => m[0]),
                    datasets: [
                        { label: 'Sales', data: monthly.map(m => m[1].count), borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4, yAxisID: 'y' },
                        { label: 'Avg Price ($K)', data: monthly.map(m => Math.round(m[1].total / m[1].count / 1000)), borderColor: '#ec4899', borderDash: [5, 5], tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: { 
                    plugins: { legend: { labels: { boxWidth: 12 } } },
                    scales: { 
                        x: { ticks: { maxRotation: 45, font: { size: 9 } } },
                        y: { position: 'left', title: { display: true, text: 'Sales', color: '#6366f1' } },
                        y1: { position: 'right', grid: { display: false }, title: { display: true, text: 'Avg Price ($K)', color: '#ec4899' } }
                    }
                }
            });
            
            // Plotly Scatter Plot - Comp Analysis
            // Filter out extreme outliers for cleaner visualization
            const withSqftData = filtered.filter(p => 
                p.sqft > 0 && p.sqft < 10000 &&  // Reasonable home size
                p.price > 50000 && p.price < 5000000  // $50K - $5M
            );
            if (withSqftData.length >= 10) {
                document.getElementById('scatterHeader').style.display = 'flex';
                document.getElementById('scatterCard').style.display = 'block';
                
                const sold = withSqftData.filter(p => p.soldDate);
                const forSale = withSqftData.filter(p => !p.soldDate && p.status === 'For Sale');
                
                const traces = [];
                
                if (sold.length > 0) {
                    traces.push({
                        x: sold.map(p => p.sqft),
                        y: sold.map(p => p.price),
                        mode: 'markers',
                        type: 'scatter',
                        name: 'Sold',
                        marker: { color: '#6366f1', size: 8, opacity: 0.7 },
                        text: sold.map(p => `<b>${p.address}</b><br>${p.beds}bd/${p.baths}ba ‚Ä¢ ${p.sqft?.toLocaleString()} sqft<br>$${p.price?.toLocaleString()} ‚Ä¢ $${Math.round(p.price/p.sqft)}/sqft<br>${p.soldDate || ''}`),
                        hoverinfo: 'text'
                    });
                }
                
                if (forSale.length > 0) {
                    traces.push({
                        x: forSale.map(p => p.sqft),
                        y: forSale.map(p => p.price),
                        mode: 'markers',
                        type: 'scatter',
                        name: 'For Sale',
                        marker: { color: '#10b981', size: 10, symbol: 'diamond', opacity: 0.9 },
                        text: forSale.map(p => `<b>${p.address}</b><br>${p.beds}bd/${p.baths}ba ‚Ä¢ ${p.sqft?.toLocaleString()} sqft<br>$${p.price?.toLocaleString()} ‚Ä¢ $${Math.round(p.price/p.sqft)}/sqft<br>üü¢ Active ‚Ä¢ ${p.dom || 0} days`),
                        hoverinfo: 'text'
                    });
                }
                
                // Add trendline
                if (sold.length > 5) {
                    const avgPpsf = sold.reduce((a, p) => a + p.price/p.sqft, 0) / sold.length;
                    const minSqft = Math.min(...sold.map(p => p.sqft));
                    const maxSqft = Math.max(...sold.map(p => p.sqft));
                    traces.push({
                        x: [minSqft, maxSqft],
                        y: [minSqft * avgPpsf, maxSqft * avgPpsf],
                        mode: 'lines',
                        name: `Avg $${Math.round(avgPpsf)}/sqft`,
                        line: { color: '#f59e0b', width: 2, dash: 'dash' }
                    });
                }
                
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0.2)',
                    font: { color: '#94a3b8' },
                    xaxis: { title: 'Square Footage', gridcolor: 'rgba(255,255,255,0.1)', tickformat: ',d' },
                    yaxis: { title: 'Price', gridcolor: 'rgba(255,255,255,0.1)', tickprefix: '$', tickformat: ',d' },
                    legend: { x: 0, y: 1.1, orientation: 'h' },
                    margin: { t: 30, r: 20, b: 50, l: 70 },
                    hovermode: 'closest'
                };
                
                Plotly.newPlot('scatterPlot', traces, layout, { responsive: true, displayModeBar: false });
                
                // Scatter insight
                const avgPpsf = withSqftData.reduce((a, p) => a + p.price/p.sqft, 0) / withSqftData.length;
                const outliers = withSqftData.filter(p => p.price/p.sqft > avgPpsf * 1.5 || p.price/p.sqft < avgPpsf * 0.5).length;
                document.getElementById('scatterInsight').innerHTML = `<strong>${withSqftData.length}</strong> properties plotted. Avg <strong>$${Math.round(avgPpsf)}/sqft</strong>. ${outliers > 0 ? `<strong>${outliers} outliers</strong> may indicate unique features or pricing opportunities.` : 'Pricing appears consistent across sizes.'}`;
            }
        }
        
        function setupPagination(filtered) {
            let pageSize = 25;
            let currentPage = 0;
            const tbody = document.getElementById('resultsBody');
            
            function renderPage() {
                const size = pageSize === 'all' ? filtered.length : pageSize;
                const start = currentPage * size;
                const end = Math.min(start + size, filtered.length);
                
                tbody.innerHTML = filtered.slice(start, end).map(p => `
                    <tr>
                        <td>${p.address || 'N/A'}</td>
                        <td>${p.city || 'N/A'}</td>
                        <td class="price">$${(p.price || 0).toLocaleString()}</td>
                        <td>${p.beds ?? '-'}</td>
                        <td>${p.baths ?? '-'}</td>
                        <td>${p.sqft?.toLocaleString() ?? '-'}</td>
                        <td>${(p.propertyType || '').replace('Residential', '').trim() || '-'}</td>
                        <td>${p.soldDate || (p.status === 'For Sale' ? 'üü¢ Active' : '-')}</td>
                        <td>${p.url ? `<a href="${p.url}" target="_blank" class="view-btn">View üîó</a>` : '-'}</td>
                    </tr>
                `).join('');
                
                const totalPages = pageSize === 'all' ? 1 : Math.ceil(filtered.length / size);
                const info = pageSize === 'all' ? `Showing all ${filtered.length}` : `Page ${currentPage + 1} of ${totalPages} (${start + 1}-${end} of ${filtered.length})`;
                document.querySelectorAll('.page-info').forEach(el => el.textContent = info);
                document.querySelectorAll('.prev-btn').forEach(el => el.disabled = currentPage === 0 || pageSize === 'all');
                document.querySelectorAll('.next-btn').forEach(el => el.disabled = end >= filtered.length || pageSize === 'all');
            }
            
            const paginationHTML = `
                <div class="pagination">
                    <div style="display:flex;gap:0.75rem;align-items:center;">
                        <button class="prev-btn" onclick="window.prevPage()">‚Üê Prev</button>
                        <span class="page-info"></span>
                        <button class="next-btn" onclick="window.nextPage()">Next ‚Üí</button>
                    </div>
                    <div style="display:flex;gap:0.75rem;align-items:center;">
                        <span style="color:#64748b;font-size:0.85rem;">Show:</span>
                        <select onchange="window.changeSize(this.value)">
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="75">75</option>
                            <option value="100">100</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('paginationTop').innerHTML = paginationHTML;
            document.getElementById('paginationBottom').innerHTML = paginationHTML;
            
            window.prevPage = () => { if (currentPage > 0) { currentPage--; renderPage(); window.scrollTo(0, 0); } };
            window.nextPage = () => { if (pageSize !== 'all' && (currentPage + 1) * pageSize < filtered.length) { currentPage++; renderPage(); window.scrollTo(0, 0); } };
            window.changeSize = (val) => { pageSize = val === 'all' ? 'all' : parseInt(val); currentPage = 0; document.querySelectorAll('select').forEach(s => s.value = val); renderPage(); };
            
            renderPage();
            document.getElementById('resultsTable').style.display = 'table';
        }
        
        loadData();
    </script>
</body>
</html>
